function initPlugin(){var n=$dateFormatByUser.toUpperCase(),t=moment($("#txtFilterDaterange").data("maxdate"),n).toDate();$(".daterange").daterangepicker({autoUpdateInput:!1,cancelClass:"btn-danger",opens:"right",maxDate:t,locale:{cancelLabel:"Clear",format:n}});$(".daterange").on("apply.daterangepicker",function(n,t){$(this).val(t.startDate.format($dateFormatByUser.toUpperCase())+" - "+t.endDate.format($dateFormatByUser.toUpperCase()))});$(".daterange").on("cancel.daterangepicker",function(){$(this).val(null)})}function initSearch(){$("#filters-contacts input[name=search]").keyup(delay(function(){_b2cQbiceId=0;loadB2CQbicleContent(!0)},500));$("#filters-contacts select[name=orderBy]").change(function(){loadB2CQbicleContent()});$("#connection-shown-type li").click(function(){$(this).hasClass("active")||(_b2cQbiceId=0,$("#connection-shown-type li").removeClass("active"),$(this).addClass("active"),loadB2CQbicleContent(!0))})}function loadB2CQbicleContent(n){var t={keyword:$("#filters-contacts input[name=search]").val(),orderby:$("#filters-contacts select[name=orderBy]").val(),typeShown:$("#connection-shown-type .active").attr("connectiontype"),b2cQbiceKey:_b2cQbiceId};$("#dashboard-page-display").html("");$("#dashboard-page-display").LoadingOverlay("show");$(".widget-contacts").empty();$(".widget-contacts").LoadingOverlay("show");$(".widget-contacts").load("/B2C/LoadB2CQbiclesContent",t,function(){initB2CQbicleEventClick();updateB2CConnectionTypeNum();$(".widget-contacts").LoadingOverlay("hide");$("#dashboard-page-display").LoadingOverlay("hide");n?$("ul.widget-contacts > li.active > a").click():$("ul.widget-contacts > li:first-child > a").click()})}function updateB2CConnectionTypeNum(){$.ajax({method:"GET",dataType:"JSON",url:"/B2C/GetB2CConnectionNumberByTypes",success:function(n){$("#all-connection-tab a").text("All ("+n.NonBlockedConnectionNumber+")");$("#new-connection-tab a span label").text(n.NewConnectionNumber);$("#blocked-connection-tab a").text("Blocked ("+n.BlockedConnectionNumber+")")}})}function initB2CQbicleEventClick(){$("ul.widget-contacts > li > a").click(function(){var n,t;$("ul.widget-contacts li").removeClass("active");$(this).closest("li").addClass("active");$("html").scrollTop(0);$(".b2bcommsmain").show();n=$("ul.widget-contacts li.active");_b2cQbiceId=n.data("b2cqbicleid");$("#hdfCurrentQbicleId").val(_b2cQbiceId);t=n.data("status");t=="Approved"?$(".b2c-not-blocked").show():t=="Blocked"&&$(".b2c-not-blocked").hide();$commonName=n.data("forename");$.ajax({type:"post",url:"/B2C/CheckExistB2cOrders",data:{qbicleKey:_b2cQbiceId},dataType:"json",success:function(n){n==!0&&$(".order-context-flyout-div").show()},error:function(){}}).always(function(){});updateAsViewedConnection(_b2cQbiceId);loadDataDashboardB2B(!0);viewProfileByB2CQbicle(n)})}function triggerClickB2CQbicleActive(n){n?$("ul.widget-contacts > li:first-child > a").click():$("ul.widget-contacts > li.active > a").click();updateAsViewedConnection($("#hdfCurrentQbicleId").val())}function updateAsViewedConnection(n){$(".order-context-flyout-div").hide();$.post("/B2C/SetB2BConnectionViewedStatus",{key:n},function(t){if(t.result){var i=_.toNumber($("#count").text())-1;$("#count").text(i);$('li[data-b2cqbicleid="'+n+'"] span.newnots').remove();$('li[data-b2cqbicleid="'+n+'"] .comms-newstuff').attr("hidden","hidden")}}).done(function(){$("#new-connection-tab").hasClass("active")&&$("#all-connection-tab").click()})}function setStatusBy(n,t){$.post("/B2C/SetStatusBy",{key:n,status:t},function(t){t.result?(cleanBookNotification.success(_L("UPDATE_MSG_SUCCESS"),"Community"),loadB2CQbicleContent(),$("#hdfCurrentQbicleId").val()==n&&triggerClickB2CQbicleActive(!0)):!t.result&&t.msg?cleanBookNotification.error(_L(t.msg),"Community"):cleanBookNotification.error(_L("ERROR_MSG_EXCEPTION_SYSTEM"),"Community")})}function viewProfileByB2CQbicle(n){var t=n.data("forename");$("span.txt-fullname").text(t)}function blockB2CContact(n,t){var i=confirm("Are you sure you want to block "+t+"?");i==!0&&setStatusBy(n,"Blocked")}function updateManagers(){$.post("/B2C/UpdateRelationshipManagers",{key:_b2cQbiceId,UserIds:$("#slrelationshipmanagers").val()},function(n){n.result?($("#b2c-managers").modal("hide"),cleanBookNotification.success(_L("UPDATE_MSG_SUCCESS"),"Community"),delay(function(){loadModalActivities()},50)):!n.result&&n.msg?cleanBookNotification.error(_L(n.msg),"Community"):cleanBookNotification.error(_L("ERROR_MSG_EXCEPTION_SYSTEM"),"Community")})}function removeB2CQbicleById(n,t){var i=confirm("Are you sure you want to remove "+t+"?");i===!0&&$.post("/B2C/RemoveB2CQbicleById",{key:n},function(n){n.result?(_b2cQbiceId="0",cleanBookNotification.success(_L("UPDATE_MSG_SUCCESS"),"Community"),loadB2CQbicleContent(!0)):!n.result&&n.msg?cleanBookNotification.error(_L(n.msg),"Community"):cleanBookNotification.error(_L("ERROR_MSG_EXCEPTION_SYSTEM"),"Community")})}function loadStatusInfo(){var n=$("#dashboard-page-display");n.load("/B2C/LoadB2CQbicleStatusInfo",{key:_b2cQbiceId},function(){})}function loadModalOrderCreation(){var n=$("#b2c-order-add");n.load("/B2C/LoadOrderCreationContent",function(){$("#b2c-order-add .select2").select2({placeholder:"Please select"});var t=$("#frmordercreation");t.submit(function(i){i.preventDefault();t.valid()&&(isDisplayFlicker(!0),$.LoadingOverlay("show"),$.ajax({type:this.method,cache:!1,url:this.action,data:$(this).serialize(),dataType:"json",beforeSend:function(){isBusy=!0},success:function(t){t.result?(n.modal("hide"),t.msg!=""&&(isDisplayFlicker(!1),htmlActivityRender(t.msg,0))):!t.result&&t.msg?cleanBookNotification.error(t.msg,"Trader"):cleanBookNotification.error(_L("ERROR_MSG_EXCEPTION_SYSTEM"),"Qbicles");isBusy=!1;LoadingOverlayEnd()},error:function(){isBusy=!1;cleanBookNotification.error(_L("ERROR_MSG_EXCEPTION_SYSTEM"),"Qbicles");LoadingOverlayEnd()}}))})})}function timeline(){$(window).scrollTop(0);$(window).scroll(function(){if($(window).scrollTop()>=$(document).height()-$(window).height()-100&&$("ul.subapps-nav li.active.tab-activities").length>0&&previousShown==!1)return loadingNewB2B(),previousShown=!0});var n=$(".contained-sidebar");n.css("overscroll-behavior","contain")}function loadMoreActivitiesB2B(n){var i,r;if(!isBusy&&!($totalConnected<=0)){var t=[];$("#select-activity").val()!="0"&&t.push($("#select-activity").val());i={Key:_b2cQbiceId,Size:loadCountActivity*qbiclePageSize,ActivityTypes:t,TopicIds:[],Apps:[],Daterange:$("#txtFilterDaterange").val()};r="/B2C/LoadMoreActivities";$.ajax({url:r,data:{fillterModel:i},type:"POST","async":!1,beforeSend:function(){isBusy=!0},success:function(t){var i,r;if(isBusy=!1,t.isHidden){_b2cQbiceId="0";loadB2CQbicleContent(!0);cleanBookNotification.warning(_L("WARNING_MSG_REMOVECONTACT"),"Community");return}isFirstLoad==0&&(loadModalActivities(),isFirstLoad=1,$("#first-load-icon:visible").length>0&&(showQbicleStream(),$(window).scrollTop(0)));t.length!==0?(n?($("#dashboard-page-display").html(""),$("#dashboard-page-display").append('<div id="previous"><\/div>'),$(t.ModelString).insertBefore("#previous").fadeIn(250)):$(t.ModelString).insertBefore("#previous").fadeIn(250),i=$("#dashboard-date-today"),i.length>0&&($("#dashboard-date-today .day-date").first().addClass("day-date-first"),i.addClass("day-block-first")),removeDom()):(n&&($("#dashboard-page-display").html(""),$("#dashboard-page-display").append('<div id="previous"><\/div>')),previousShown=!0);t.ModelCount&&(r=t.ModelCount-loadCountActivity*qbiclePageSize,previousShown=r<=0?!0:!1);$(".op-forward").remove()},error:function(){isBusy=!1;showQbicleStream()}}).always(function(){isBusy=!1;$("#first-load-icon").hide()});loadCountActivity=loadCountActivity+1}}function showQbicleStream(){$("#first-load-icon").hide();$("#latch").show();$("#dashboard-page-display").show()}function loadingNewB2B(){$("#previous div.text-center")&&$("#previous").html('<div class="text-center"><img src="/Content/DesignStyle/img/loading-new.gif" style="width: 180px; height: auto;"><\/div><br />');setTimeout(function(){loadMoreActivitiesB2B()},500)}function loadDataDashboardB2B(n){n&&($(window).scrollTop(0),loadCountActivity=0,isFirstLoad=0,$("#dashboard-page-display").hide(),$("#first-load-icon").show());setTimeout(function(){loadMoreActivitiesB2B(n)},200)}function removeDom(){$("#comms-activities .day-block").each(function(){$(this).find("article").length==0&&$(this).remove()})}function addTopicToFilter(n,t){if($('#select-topic option[value="'+n+'"]').length<=0){$("#select-topic").append($("<option>",{value:n,text:t})).select2({placeholder:"Please select"});$("#select-topic").on("change.select2",function(){LoadDataDashboard(!0)})}$('#toppic-value option[value="'+n+'"]').length<=0&&$("#toppic-value").append($("<option>",{value:n,text:t})).select2()}function resetFilters(){$(".removefilters").hide();$("#select-activity").val("0").trigger("change");$("#txtFilterDaterange").val("");loadDataDashboardB2B(!0)}function loadModalActivities(){var n=$("ul.widget-contacts li.active");n.length>0&&n.data("status")=="Approved"?(n.find(".counter").css("display","none").text(0),$("#modal-activities").load("/B2C/LoadModalActivities",function(){$("#modal-activities select.select2").not("select.select2-hidden-accessible").select2({placeholder:"Please select"});$('#modal-activities input[data-toggle="toggle"]').bootstrapToggle();$("#b2c-managers").length>0?$("li.b2c-relationship-manager").show():$("li.b2c-relationship-manager").hide();sharemenu()})):$("#modal-activities").empty()}function initNextPreviousTab(n,t){$(n+" .btnNext").click(function(){var n=$(this).closest(".modal");$(n).find(t+" .active").next("li").find("a").trigger("click")});$(n+" .btnPrevious").click(function(){var n=$(this).closest(".modal");$(n).find(t+" .active").prev("li").find("a").trigger("click")})}function latchformobile(){$(document).width()<1200&&$(".interact").waypoint(function(n){n=="down"&&($(".interact").addClass("mobile-top"),$(".block-container").addClass("compensate-sticky"));n=="up"&&($(".block-container").removeClass("compensate-sticky"),$(".interact").removeClass("mobile-top"))},{offset:"25%"})}function sharemenu(){var n=$("#frmShareMenu");n.validate({ignore:"",rules:{location:{required:!0},menu:{required:!0},description:{required:!0,minlength:3,maxlength:500}}});n.submit(function(t){if(t.preventDefault(),n.valid()){isDisplayFlicker(!0);$.LoadingOverlay("show");var i={MenuId:$("#frmShareMenu select[name=menu]").val(),OpeningComment:$("#frmShareMenu textarea[name=description]").val()};$.post(this.action,i,function(t){LoadingOverlayEnd();t.result?($("#b2c-menu-add").modal("hide"),t.msg!=""&&(htmlActivityRender(t.msg,0),isDisplayFlicker(!1)),cleanBookNotification.success(_L("ERROR_MSG_398"),"Qbicles"),n.trigger("reset"),$("#frmShareMenu select[name=location]").val("").trigger("change"),$("#frmShareMenu select[name=menu]").val("").trigger("change"),n.validate().resetForm()):!t.result&&t.msg?cleanBookNotification.error(_L(t.msg),"Qbicles"):cleanBookNotification.error(_L("ERROR_MSG_EXCEPTION_SYSTEM"),"Qbicles")})}})}function loadMenusByLocationId(){if(!(_.toNumber($("#menu-add-location-select").val())<=0)){var n=$("#frmShareMenu select[name=menu]");$.get("/B2C/GetMenusByLocationId?lid="+$("#menu-add-location-select").val(),function(t){n.select2("destroy");n.empty();n.select2({placeholder:"Please select",data:t})})}}function applyFilters(){$("#filter-b2b-stream").modal("hide");loadDataDashboardB2B(!0)}function deletePost(n,t){bootbox.confirm({show:!0,backdrop:!0,closeButton:!0,animate:!0,title:"Qbicles",message:_L("WARNING_MSG_DELETEPOST"),callback:function(i){if(i){$.LoadingOverlay("show");$.post("/Posts/DeletePost",{key:t},function(t){$.LoadingOverlay("hide");t.result?($("#"+n).remove(),cleanBookNotification.success("Your post was successfully deleted.")):!t.result&&t.msg?cleanBookNotification.error("There was an issue deleting this post. Please try again","Qbicles"):cleanBookNotification.error(_L("ERROR_MSG_EXCEPTION_SYSTEM"),"Qbicles")});return}}})}function addPostToDiscuss(n){$.LoadingOverlay("show");$.get("/Posts/GetMessageOfPost?key="+n,function(n){$("#create-discussion-qb").modal("show");$("#discussion-summary").val(n.message);$.LoadingOverlay("hide")})}function loadEditPostModal(n,t){$("#edit-post").modal("show");$.LoadingOverlay("show");$("#edit-post").load("/Qbicles/GenerateEditPostModal",{postKey:t},function(){$("#edit-post select[name=topic]").select2({placeholder:"Please select"});$("#frmEditPost").submit(function(t){if(t.preventDefault(),$(this).valid()){$.LoadingOverlay("show");var i={key:$("#frmEditPost input[name=PostKey]").val(),message:$("#frmEditPost textarea[name=postcontent]").val(),topicId:$("#frmEditPost select[name=topic]").val()};$.post("/QbicleComments/UpdatePost",i,function(t){if(t.result){$("#edit-post").modal("hide");var r=$("#frmEditPost select[name=topic] option:selected").text();$("#"+n+" .topic-label").html('<span class="label label-info">'+fixQuoteCode(r)+"<\/span>");$("#"+n+" .activity-overview p").text(i.message);$("#"+n+" .post-event").text("Edited post");cleanBookNotification.success(_L("UPDATE_MSG_SUCCESS"),"Qbicles")}else!t.result&&t.msg?cleanBookNotification.error(_L(t.msg),"Qbicles"):cleanBookNotification.error(_L("ERROR_MSG_EXCEPTION_SYSTEM"),"Qbicles");$.LoadingOverlay("hide")})}else return});$.LoadingOverlay("hide")})}var _b2cQbiceId="0",loadCountActivity=0,isFirstLoad=0,previousShown=!1,isBusy=!1,$totalConnected=0,$commonName;$(document).ready(function(){timeline();initSearch();initB2CQbicleEventClick();triggerClickB2CQbicleActive(!1);initPlugin();$totalConnected=document.getElementById("b2c-connected").getElementsByTagName("li").length;$totalConnected>0?$(".connected-action").show():$(".connected-action").hide()});$commonName="";