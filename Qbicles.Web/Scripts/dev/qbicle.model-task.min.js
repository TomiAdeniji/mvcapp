function show_recur(n){if(n!=""){var t=$("input[name=recur-start]").val(),i=$("input[name=recur-final]"),r=".task-recur-"+n;$("#TaskRecur").show();$(".task-recurtype").hide();$(r).show();n=="daily"?($("#hdTaskRecurrenceType").val(0),i.daterangepicker({singleDatePicker:!0,showDropdowns:!0,autoUpdateInput:!0,cancelClass:"btn-danger",opens:"left",maxDate:moment(t,$dateTimeFormatByUser).add(1,"months"),locale:{cancelLabel:"Clear",format:$dateFormatByUser.toUpperCase()}})):n=="weekly"?($("#hdTaskRecurrenceType").val(1),i.daterangepicker({singleDatePicker:!0,showDropdowns:!0,autoUpdateInput:!0,cancelClass:"btn-danger",opens:"left",maxDate:moment(t,$dateTimeFormatByUser).add(6,"months"),locale:{cancelLabel:"Clear",format:$dateFormatByUser.toUpperCase()}})):n=="monthly"&&($("#hdTaskRecurrenceType").val(2),i.daterangepicker({singleDatePicker:!0,showDropdowns:!0,autoUpdateInput:!0,cancelClass:"btn-danger",opens:"left",maxDate:moment(t,$dateTimeFormatByUser).add(24,"months"),locale:{cancelLabel:"Clear",format:$dateFormatByUser.toUpperCase()}}))}else $("#TaskRecur").hide();$("#task-exclusion-list").css({display:"none"});GenarateDateTable()}function update_recurrence(){$("#task-restricted").hide();var n=$("#taskDuration").val(),t=$("#taskDurationUnit :selected").text().toLowerCase().trim();$("#dailyopt").removeAttr("disabled");$("#weeklyopt").removeAttr("disabled");n!=""&&parseInt(n)>24&&t=="hours"&&($("#task-indicated-duration").html(n+" "+t),$("#task-indicated-duration").val(n+" "+t),$("#task-restricted").show(),$("#dailyopt").attr("disabled",!0));n!=""&&parseInt(n)>1&&t=="days"&&($("#task-indicated-duration").html(n+" "+t),$("#task-indicated-duration").val(n+" "+t),$("#task-restricted").show(),$("#dailyopt").attr("disabled",!0));n!=""&&parseInt(n)>7&&t=="days"&&($("#task-indicated-duration").html(n+" "+t),$("#task-indicated-duration").val(n+" "+t),$("#task-restricted").show(),$("#dailyopt").attr("disabled",!0),$("#weeklyopt").attr("disabled",!0));n!=""&&parseInt(n)>1&&t=="weeks"&&($("#task-indicated-duration").html(n+" "+t),$("#task-indicated-duration").val(n+" "+t),$("#task-restricted").show(),$("#dailyopt").attr("disabled",!0),$("#weeklyopt").attr("disabled",!0));$("input[name='recur-start']").val($("#taskProgrammedStart").val());$("input[name='duration']").val($("#taskDuration").val()+" "+$("#taskDurationUnit :selected").text().trim().toLowerCase())}function TaskRecursCheck(n){$(n).is(":checked")?($(n).prop("checked",!0),$(n).val(!0),$("#TaskRecurrence").css({display:"block"})):($(n).prop("checked",!1),$(n).val(!1),$("#TaskRecurrence").css({display:"none"}))}function task_validtabs(){return $("#create-task-overview input.error").length>0||$("#create-task-overview textarea.error").length>0?($('#taskTabs a[href="#create-task-overview"]').tab("show"),!1):($("#create-task-checklist input.error").length>0||$("#create-task-checklist textarea.error").length>0)&&$("input[name=isSteps]").prop("checked")?($('#taskTabs a[href="#create-task-checklist"]').tab("show"),!1):!0}function ValidateStepsWeight(){var n=SumStepsWeight();return n>100?!1:n<100?!1:(cleanBookNotification.clearmessage(),!0)}function ValidateSteps(){var i=!0,t,n,r,u,f;if($("input[name=isSteps]").prop("checked"))for(t=$("#sortable div.ui-sortable-handle"),n=0;n<t.length;n++){if(r=$(t[n]).find("div.row-options input.fieldName"),r.val()===""){i=!1;break}if(u=$(t[n]).find("div.row-options textarea.fieldDescription"),u.val()===""){i=!1;break}if(f=$(t[n]).find("div.row-options input.fieldWeight"),f.val()===""){i=!1;break}}return i}function NextTab_Task(){var n=ValidateSteps();if(n){if(!ValidateStepsWeight()){cleanBookNotification.error(_L("ERROR_MSG_360"),"Task");return}$("#taskTabs > .active").next("li").find("a").trigger("click")}else $form_task_addedit.valid()}function PrevTab_Task(){$("#taskTabs > .active").prev("li").find("a").trigger("click")}function NextTab_Overview(){if(!$form_task_addedit.valid()){task_validtabs();return}$("#taskTabs > .active").next("li").find("a").trigger("click")}function SumStepsWeight(){var n=0;return $("input.fieldWeight").each(function(){n+=parseInt($(this).val())}),n}function SaveQbicleTask(){var i;if($("#form_task_addedit").LoadingOverlay("show"),lstDate=[],$("#taskName").val()==""||$("#taskProgrammedStart").val()==""||$("#taskDuration").val()=="0"){cleanBookNotification.error(_L("ERROR_MSG_361"),"Task");$("#form_task_addedit").LoadingOverlay("hide",!0);return}if(i=task_validtabs(),i){if(!ValidateStepsWeight()){cleanBookNotification.error(_L("ERROR_MSG_360"),"Task");$('#taskTabs a[href="#create-task-checklist"]').tab("show");$("#form_task_addedit").LoadingOverlay("hide",!0);return}$("#hdTaskLastOccurrence").val($("input[name='recur-final']").val());var t="",n="",r=$("#hdTaskRecurrenceType").val();if(r=="0"?(t="",n="",$(".daily").each(function(){t+=$(this).attr("att-checked");$(this).is(":checked")&&(n==""?n=$(this).val():n+=","+$(this).val())})):r=="1"?(t="",n="",$(".weekly").each(function(){t+=$(this).attr("att-checked");$(this).is(":checked")&&(n==""?n=$(this).val():n+=","+$(this).val())})):(t="",n="",$(".monthTask").each(function(){t+=$(this).attr("att-checked");$(this).is(":checked")&&(n==""?n=$(this).val():n+=","+$(this).val())})),$("#create-task-recurrence").find("input[name=isRecurs]").is(":checked")&&$("#lstDate tbody tr").find("input[type='checkbox']").each(function(){$(this).is(":checked")&&lstDate.push($(this).attr("att-date"))}),$("#create-task-recurrence").find("input[name=isRecurs]").is(":checked")&&lstDate.length<=0){cleanBookNotification.error(_L("ERROR_MSG_110"),"Task");$("#form_task_addedit").LoadingOverlay("hide",!0);return}$("#hdTaskDayOrMonth").val(t);$("#hdTaskDayOfWeek").val(n);$form_task_addedit.valid()?(ReDataStep(),$.ajax({url:"/Tasks/DuplicateTaskNameCheck",data:{cubeId:$("#taskQbicleId").val(),taskKey:$("#taskKey").val(),taskName:$("#taskName").val()},type:"GET",dataType:"json","async":!1}).done(function(n){n.result?($form_task_addedit.validate().showErrors({Name:_L("ERROR_MSG_111")}),task_validtabs(),$("#form_task_addedit").LoadingOverlay("hide",!0)):TaskSubmit()}).fail(function(){$("#form_task_addedit").validate().showErrors({Name:_L("ERROR_MSG_112")});$("#form_task_addedit").LoadingOverlay("hide",!0)})):task_validtabs()}}function AddStep(){var u=$("#sortable div.ui-sortable-handle").length,f="Steplst["+u+"].Name",e="Steplst["+u+"].Description",v="Steplst["+u+"].Weight",l=100-SumStepsWeight(),n=$("#sortable div:first").clone(),o,s,t,h,i,c,r,a;n.removeClass("first-step");o=UniqueId()+"_title";s=$(n).find("h5 i.stepTitle");s.attr("id",o);s.text("Click to configure this step");t=$(n).find("div.row-options input.fieldName");t.attr("onkeyup","$('#"+o+"').html($(this).val());");t.attr("name",f);t.removeClass("valid");t.val("");h=$(n).find("div.row-options label.lblErrorName");h.attr("id",f+"-error");h.attr("for",f);i=$(n).find("div.row-options textarea.fieldDescription");i.attr("name",e);i.removeClass("valid");i.val("");c=$(n).find("div.row-options label.lblErrorDescription");c.attr("id",e+"-error");c.attr("for",e);r=$(n).find("div.row-options input.fieldWeight");r.attr("name",v);r.removeClass("valid");r.val(l>0?l:0);a=$(n).find("div.row-options input.fieldId");a.val("0");$("#sortable #btnAddStep").before(n)}function ReOrderStep(){$("#sortable div.ui-sortable-handle + .row-options").each((n,t)=>{$(t).find("[name]").each((t,i)=>{var r=$(i).attr("name");r=r.replace(/[\d+]/g,n);$(i).attr("name",r)}),$(t).find(".error").each((t,i)=>{var r=$(i).attr("id"),u=$(i).attr("for");r=r.replace(/[\d+]/g,n);u=u.replace(/[\d+]/g,n);$(i).attr("id",r);$(i).attr("for",u)})})}function RemoveStep(n){$("#sortable div.ui-sortable-handle").length>1&&confirm("Are you sure you want to delete this step?")&&$(n).parent().parent().parent().remove();ReOrderStep()}function ReDataStep(){for(var i,r,u,f,e,t=$("#sortable div.ui-sortable-handle"),n=0;n<t.length;n++)i=$(t[n]).find("div.row-options input.fieldOrder"),i.attr("name","Steplst["+n+"].Order"),i.val(n),r=$(t[n]).find("div.row-options input.fieldName"),r.attr("name","Steplst["+n+"].Name"),u=$(t[n]).find("div.row-options textarea.fieldDescription"),u.attr("name","Steplst["+n+"].Description"),f=$(t[n]).find("div.row-options input.fieldWeight"),f.attr("name","Steplst["+n+"].Weight"),e=$(t[n]).find("div.row-options input.fieldId"),e.attr("name","Steplst["+n+"].Id")}function ResetTask(){var r,t,n,i;for($('#taskTabs a[href="#create-task-overview"]').click(),r=$("#taskProgrammedStart").val(),$form_task_addedit.trigger("reset"),$("#taskProgrammedStart").val(r),$("select[name=Assignee]").val("").change(),$("select[name=Watchers]").val("").change(),$("input[name=isSteps]").bootstrapToggle("off"),t=$("#sortable div.ui-sortable-handle"),n=0;n<t.length;n++)i=$(t[n]),n==0||i.hasClass(".first-step")||i.remove();$("#q1title").text("Click to configure this step");$("#create-task-checklist .checklist").hide();$("#create-task-recurrence").find("input[name=isRecurs]").prop("checked",!1).change();$("#create-task-recurrence").find("input[name=isRecurs]").val(!1);$("#create-task-related select[name=ActivitiesRelate]").val("").change();$("#create-task-related .chktoggle").bootstrapToggle("off");$taskId=0;ClearError()}function GetListDate(n,t,i,r,u,f){return $.ajax({url:"/Qbicles/GetListDate",type:"POST",dataType:"json",data:{dayofweek:n,type:t,Pattern:i,customDate:r,LastOccurenceDate:u,firstOccurenceDate:f}})}function GenarateDateTable(n){var i=$("#hdTaskRecurrenceType").val(),r=$("#pattern :selected").val(),f=$("input[name='recur-final']").val(),e=$("input[name='recur-start']").val(),u="",t,o;r==""&&(r="0");t="";o=0;u=r=="2"?$("#month-dates :selected").val():"0";i=="0"?$(".daily").each(function(){$(this).is(":checked")&&(t==""?t=$(this).val():t+=","+$(this).val())}):i=="1"?$(".weekly").each(function(){$(this).is(":checked")&&(t==""?t=$(this).val():t+=","+$(this).val())}):$(".monthTask").each(function(){$(this).is(":checked")&&(t==""?t=$(this).val():t+=","+$(this).val())});GetListDate(t,i,r,u,f,e).done(function(t){var u,f,r;if(t!=""){for(u="",$("#lstDate tbody tr").remove(),f="",r=0;r<t.length;r++)u+="<tr>",u+="<td>"+t[r].Name+"<\/td>",u+='<td><input type="checkbox" '+(t[r].selected?"checked":"")+' value="'+t[r].Value+'" onclick="OnCheckType(this,\''+t[r].ShortName+'\')"  att-date="'+t[r].Date+'"  ><\/td>',u+=" <\/tr>",f+=t[r].ShortName+",";$("#lstDate tbody").append(u)}n||$("#task-exclusion-list").attr("style").indexOf("display: block;")>0?$("#task-exclusion-list").css({display:"block"}):$("#task-exclusion-list").css({display:"none"});i==2&&$(".monthTask").each(function(){f!=null&&f.indexOf($(this).val())>-1?$(this).prop("checked",!0):$(this).prop("checked",!1)})})}function OnCheckType(n,t){var i=$("#hdEventRecurrenceType").val();i==0?$(n).is(":checked")?$(".daily").each(function(){$(this).val()==t&&$(this).prop("checked",!1)}):$(".daily").each(function(){$(this).val()==t&&$(this).prop("checked",!0)}):i==1?$(n).is(":checked")?$(".weekly").each(function(){$(this).val()==t&&$(this).prop("checked",!1)}):$(".weekly").each(function(){$(this).val()==t&&$(this).prop("checked",!0)}):$(n).is(":checked")?$(".monthTask").each(function(){$(this).val()==t&&$(this).prop("checked",!1)}):$(".monthTask").each(function(){$(this).val()==t&&$(this).prop("checked",!0)})}function ChangeTaskCheckItem(n){$(n).is(":checked")?$(n).attr("att-checked",1):$(n).attr("att-checked",0)}function changePattern(){$("#pattern :selected").val()=="2"?($("#customDate").show(),$("#hdTaskcustomDate").val($("#month-dates :selected").val())):$("#customDate").hide();GenarateDateTable()}function AddRemoveAtvRelated(n,t,i){$(i).prop("checked")?$('#create-task-related select[name=ActivitiesRelate] option[value="'+n+'"]').length<=0&&$("#create-task-related select[name=ActivitiesRelate]").append('<option selected value="'+n+'">'+t+"<\/option>").select2():($('#create-task-related select[name=ActivitiesRelate] option[value="'+n+'"]').remove(),$("#create-task-related select[name=ActivitiesRelate]").select2())}function CountCanTasksDelete(n){$.getJSON("/Tasks/CountCanTasksDelete",{ctaskId:n},function(t){var i=confirm(_L("ERROR_MSG_362",[t]));i&&($.LoadingOverlay("show"),$.ajax({method:"POST",url:"/Tasks/RecurringTasksDelete",data:{ctaskId:n}}).done(function(n){LoadingOverlayEnd();n.result?($("#stop-recurring").prop("disabled",!0),cleanBookNotification.success(_L("ERROR_MSG_94"),"Qbicles")):cleanBookNotification.error(_L("ERROR_MSG_EXCEPTION_SYSTEM"),"Qbicles")}))})}var isBusyAddTaskForm=!1,$form_task_addedit=$("#form_task_addedit"),lstDate=[];TaskSubmit=function(){var n=new FormData($form_task_addedit[0]),t;n.append("listDate",lstDate);$.ajax({type:"post",cache:!1,url:"/Tasks/SaveQbicleTask",enctype:"multipart/form-data",data:n,processData:!1,contentType:!1,beforeSend:function(){},success:function(n){var t,i;n.result?($("#create-task").modal("toggle"),$("#taskKey").val()!=""?location.reload():(ResetTask(),t=$(".calendar-view-dashboard").datepicker().data("datepicker"),t&&(i=t.currentDate,CalTabActive(i.getFullYear(),i.getMonth()+1))),n.msg!=""&&(htmlActivityRender(n.msg,0),isDisplayFlicker(!1))):cleanBookNotification.error(n.msg?n.msg:"Have an error!","Qbicles")},error:function(){cleanBookNotification.error(_L("ERROR_MSG_EXCEPTION_SYSTEM"),"Qbicles");isDisplayFlicker(!1)}}).always(function(){$("#form_task_addedit").LoadingOverlay("hide",!0)});t=setInterval(function(){if(document.readyState=="complete"){$("#taskDurationUnit").val($("#taskDurationUnit :selected").val()).trigger("change");var n=$("#hdTaskRecurrenceType").val();n==0?$("#TaskRecurtype").val("daily").trigger("change"):n==1?$("#TaskRecurtype").val("weekly").trigger("change"):$("#TaskRecurtype").val("monthly").trigger("change");clearInterval(t);return}},200)};$(document).ready(function(){function n(n){if(!n.id)return n.text;var t=n.element.attributes.avatarUrl.value;return $('<div class="select2imgwrap"><div class="select2img" style="background-image: url(\''+t.toLowerCase()+'\');"><\/div> <span class="select2text">'+n.text+"<\/span><\/div>")}function t(n){if(!n.id)return n.text;var t=n.element.attributes.avatarUrl.value;return $('<div class="select2imgwrap"><div class="select2img mini" style="background-image: url(\''+t.toLowerCase()+'\');"><\/div> <span class="select2text">'+n.text+"<\/span><\/div>")}$("#create-task-related select[name=ActivitiesRelate]").on("select2:unselect",function(n){var t=n.params.data.id,i="input[value="+t+"]";$(i).bootstrapToggle("off")});setTimeout(function(){$("#rlActivities").dataTable({destroy:!0,serverSide:!0,processing:!0,paging:!0,searching:!0,ajax:{url:"/Tasks/AtivitiesRelated",data:function(n){return $.extend({},n,{currentQbicleId:$("#taskQbicleId").val(),currentActivityKey:$("#taskKey").val()})}},columns:[{title:"Name",data:"Name",searchable:!0},{title:"Type",data:"Type",searchable:!0},null],columnDefs:[{targets:2,data:"Id",render:function(n,t,i){return'<input class="chktoggle" data-toggle="toggle" data-on="Yes" data-off="No" data-onstyle="success" onchange="AddRemoveAtvRelated('+n+",'"+i.Name.replace("'","")+'\',this)"  type="checkbox" value="'+n+'">'}}]})},2e3);$("#rlActivities").on("draw.dt",function(){$.each($(".chktoggle"),function(n,t){var i=$("#create-task-related select[name=ActivitiesRelate]").val(),r=$(t).val();i!=null&&i.indexOf(r)>=0?$(t).bootstrapToggle("on"):$(t).bootstrapToggle("off")})});$(".select2avatartask").select2({placeholder:"Please select",templateResult:n,templateSelection:t});$(".single-date").daterangepicker({singleDatePicker:!0,timePicker:!0,autoApply:!0,showDropdowns:!0,autoUpdateInput:!0,cancelClass:"btn-danger",opens:"left",locale:{cancelLabel:"Clear",format:$dateTimeFormatByUser},minDate:moment()});$(".scroll-basket").slimScroll({height:"300px",railOpacity:1,railVisible:!0,alwaysVisible:!0,wheelStep:30,touchStep:30,color:"#989696",railColor:"#e1e1e1"});var i=setInterval(function(){document.readyState=="complete"&&($("input[name='recur-start']").val($("#taskProgrammedStart").val()),$("input[name='duration']").val($("#taskDuration").val()+" "+$("#taskDurationUnit :selected").text().trim().toLowerCase()),clearInterval(i))},200)});