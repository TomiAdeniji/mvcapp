function initTable(){var n=$("#accountdomain_id").val();$("#community-list").on("processing.dt",function(n,t,i){$("#processingIndicator").css("display","none");i?$("#table_transaction").LoadingOverlay("show",{minSize:"70x60px"}):$("#table_transaction").LoadingOverlay("hide",!0)}).DataTable({destroy:!0,dom:'<"top"fl<"clear">>rt<"bottomtable"ip<"clear">>',processing:!0,serverSide:!0,info:!1,stateSave:!1,bLengthChange:!0,paging:!0,searching:!1,responsive:!0,scrollX:!1,autoWidth:!0,deferLoading:30,pageLength:10,lengthMenu:[[10,20,50,100],[10,20,50,100]],ajax:{url:"/TraderCashBank/LoadPaymentTransaction",type:"POST",data:function(n){return $.extend({},n,{search:$("#search_trans").val(),fromDate:$("#date_range").val()!==""?$("#date_range").val().split(" - ")[0]:"",toDate:$("#date_range").val()!==""?$("#date_range").val().split(" - ")[1]:"",id:$("#tradercashaccount_id").val()})}},columns:[{data:"Id",orderable:!0},{data:"Date",orderable:!0},{data:"Reference",orderable:!0},{data:"Source",orderable:!0},{data:"PaymentMethod",orderable:!0},{data:"Destination",orderable:!0},{data:"Type",orderable:!0,render:function(n){return'<span class="label label-lg label-primary">'+n+"<\/span>"}},{data:"InOut",orderable:!0},{data:"For",orderable:!0,render:function(n){return n}},{data:"Amount",orderable:!0},{data:"Status",orderable:!0,render:function(n){var t="";return n=="Pending Review"?t='<span class="label label-lg label-info">'+n+"<\/span>":n==="Pending Approval"?t='<span class="label label-lg label-primary">'+n+"<\/span>":n==="Approved"?t='<span class="label label-lg label-success">'+n+"<\/span>":n==="Denied"?t='<span class="label label-lg label-danger">'+n+"<\/span>":n==="Draft"?t='<span class="label label-lg label-primary">'+n+"<\/span>":n==="Discarded"&&(t='<span class="label label-lg label-danger">'+n+"<\/span>"),t}},{data:null,orderable:!1,width:"250px",render:function(n,t,i){var r="";return i.Type!=="Transfer"?i.Status==="Draft"?r='<button class="btn btn-info" onclick="EditPayment('+$("#tradercashaccount_id").val()+","+i.Id+')"><i class="fa fa-pencil"><\/i> &nbsp; Continue<\/button>':r+=r='<button class="btn btn-primary" onclick="window.location.href=\'/TraderPayments/PaymentManage?id='+i.Id+'\'"><i class="fa fa-eye"><\/i> &nbsp; Manage<\/button>':i.Status==="Draft"?r='<button class="btn btn-info" onclick="EditTranfer('+$("#tradercashaccount_id").val()+","+i.Id+')"><i class="fa fa-pencil"><\/i> &nbsp; Continue<\/button>':r+=r='<button class="btn btn-primary" onclick="window.location.href=\'/TraderPayments/PaymentManage?id='+i.Id+'\'"><i class="fa fa-eye"><\/i> &nbsp; Manage<\/button>',r}},],initComplete:function(){$("#community-list").DataTable().ajax.reload()},order:[[1,"asc"],[2,"asc"],[3,"asc"],[4,"asc"],[5,"asc"],[6,"asc"],[7,"asc"],[8,"asc"],[9,"asc"],[10,"asc"],[11,"asc"]]})}function clearValue(){$("#search_invoice").val(null);$("#search_date_range").val(null)}function AddPayment(n){$("#cashbank-transfer").empty();var t="/TraderCashBank/AddPayment?id="+n+"&locationid="+$locationId;AjaxElementShowModal(t,"cashbank-payment")}function EditPayment(n,t){$("#cashbank-transfer").empty();var i="/TraderCashBank/AddPayment?id="+n+"&locationid="+$locationId+"&transactionId="+t;AjaxElementShowModal(i,"cashbank-payment")}function AddTranfer(n){$("#cashbank-payment").empty();var t="/TraderCashBank/AddTransfer?id="+n+"&locationid="+$locationId;AjaxElementShowModal(t,"cashbank-transfer")}function EditTranfer(n,t){$("#cashbank-payment").empty();var i="/TraderCashBank/AddTransfer?id="+n+"&locationid="+$locationId+"&transactionId="+t;AjaxElementShowModal(i,"cashbank-transfer")}function ShowTransactionAttachments(){setTimeout(function(){$("#attachments-view-payment").modal("toggle")},500)}function paymentforChange(n){var t=$(n).val();$("#payment-specifics").show();t=="invoice"?($("#contact-selector").hide(),$("#invoice-selector").fadeIn(),$("#tblInvoices").DataTable().ajax.reload()):($("#invoice-selector").hide(),$("#contact-selector").fadeIn())}function selectInvoice(n){var i=$(n).closest("tr"),t=$("#tblInvoices").DataTable().row(i).data();$(".invoice-select").hide();$(".selected-invoice").show();$("#invoice_id").text(t.Id);$("#invoice_date").text(t.Date);$("#invoice_contact").empty();let r='<a href="/TraderContact/ContactMaster?key='+t.ContactKey+'">'+fixQuoteCode(t.Contact)+"<\/a>";$("#invoice_contact").append(r);$("#invoice_amount").text(t.Amount);$("#invoice_paayment").text(t.Payments)}function initBKAccount(n,t){BKAccount.Id=n;BKAccount.Name=t}function selectAccount(n,t){var i=$(".accountid-"+t).data("name");$(".selectaccount").removeClass("selectaccount");$(n).addClass("selectaccount");$("#accountId").val(t);BKAccount.Id=t;BKAccount.Name=i;$("#accountId").val(t);closeSelected();$("#app-bookkeeping-treeview").modal("hide")}function closeSelected(){$("#app-bookkeeping-treeview").modal("hide");BKAccount.Id?($(".accountInfo").empty(),$(".accountInfo").append(BKAccount.Name)):$(".accountInfo").empty();$(".accountInfo").text().length>0?($(".addbtnaccount").attr("style","display:none;"),$(".editbtnaccount").removeAttr("style")):$(".accountInfo").text().length===0&&($(".editbtnaccount").attr("style","display:none;"),$(".addbtnaccount").removeAttr("style"))}function showChangeAccount(){setTimeout(function(){CollapseAccount()},1)}function CollapseAccount(){$(".jstree").jstree("close_all")}function initSelectedAccount(){setTimeout(function(){$(".selectaccount").removeClass("selectaccount");$(".accountid-"+BKAccount.Id).addClass("selectaccount")},1)}function SaveCashBankPayment(n){if(validatePayment()){var i=$("#payment-for").val(),t={Id:$("#cashaccounttransaction_id").val(),Workgroup:{Id:$("#transfer-workgroup-select").val()},Type:$("#payment_income").val()=="in"?"PaymentIn":"PaymentOut",DestinationAccount:{Id:$("#payment_income").val()=="in"?$("#tradercashaccount_id").val():0},OriginatingAccount:{Id:$("#payment_income").val()=="out"?$("#tradercashaccount_id").val():0},Amount:$("#payment_amount").val().replace(/\,/g,""),Description:$("#payment_description").val(),Status:n,Contact:{Id:$("#payment_contact").val()},AssociatedInvoice:{Id:$("#invoice_id").text()},PaymentMethod:{Id:$("#payment-method").val()},Reference:$("#reference").val()};if((t.AssociatedInvoice.Id==""||t.AssociatedInvoice.Id=="0")&&(t.AssociatedInvoice=null),(t.Contact.Id==""||t.Contact.Id=="0")&&(t.Contact=null),i!=="poa"?t.Contact={}:t.AssociatedInvoice={},i!=="poa"||t.Contact){if(i!=="poa"&&!t.AssociatedInvoice)return cleanBookNotification.error(_L("ERROR_MSG_620"),"Qbicles"),!1}else return cleanBookNotification.error(_L("ERROR_MSG_619"),"Qbicles"),!1;CashBankPaymentTransferProcessMedia(t,"payment")}}function validatePayment(){var n=!0,t={Id:$("#transfer-workgroup-select").val()};return(t.Id===""||t.Id==null)&&($("#form_workgroup").validate().showErrors({workgroup:"Workgroup is required."}),n=!1),$("#payment_income").val()===""&&($("#form_content").validate().showErrors({type:"Type of payment is required."}),n=!1),$("#reference").val()===""&&($("#form_content").validate().showErrors({reference:"Reference is required."}),n=!1),$("#payment-for").val()!=="poa"||$("#payment_contact").val()&&$("#payment-for").val()!==""?$("#payment_contact + label").remove():($("#form_content").validate().showErrors({contact:"Contact is required."}),n=!1),n}function saveTransfer(n){var i=$("#reference").val(),t;if(i==""&&n.toLowerCase()!="draft"){$("#form-create-transfer").validate().showErrors({reference:"Reference is required."});return}if(t={Id:$("#transfer-workgroup-select").val()},t.Id===""||t.Id==null){$("#form_workgroup").validate().showErrors({workgroup:"Workgroup is required."});return}var r=$("#transfer_destination").val(),u=$("#tradercashaccount_id").val(),f={Id:$("#transfer_id").val(),Workgroup:t,Type:$("#transfer_type").val(),DestinationAccount:{Id:r},OriginatingAccount:{Id:u},Amount:$("#transfer_amount").val().replace(/\,/g,""),Charges:$("#transfer_charges").val().replace(/\,/g,""),Description:$("#transfer_desciption").val(),Status:n,Reference:i};CashBankPaymentTransferProcessMedia(f,"transfer")}function WorkGroupSelectedChange(){$(".preview-workgroup").show();var n=$("#transfer-workgroup-select").val();n&&n!==""?($.LoadingOverlay("show"),$.ajax({type:"get",url:"/TraderTransfers/getworkgroup?id="+n,dataType:"json",success:function(n){$.LoadingOverlay("hide");n.result?($("#workgroup-location-id").val(n.Object.LocationId),$(".preview-workgroup table tr td.location_name").text(n.Object.Location),$(".preview-workgroup table tr td.workgroup_process").text(n.Object.Process),$(".preview-workgroup table tr td.workgroup_qbicle").text(n.Object.Qbicle),$(".preview-workgroup table tr td.workgroup_member span").text(n.Object.Members)):($("#workgroup-location-id").val(0),$(".preview-workgroup table tr td.location_name").text(""),$(".preview-workgroup table tr td.workgroup_process").text(""),$(".preview-workgroup table tr td.workgroup_qbicle").text(""),$(".preview-workgroup table tr td.workgroup_member span").text(""));$("#tblInvoices").DataTable().ajax.reload()},error:function(){$.LoadingOverlay("hide");cleanBookNotification.error(_L("ERROR_MSG_EXCEPTION_SYSTEM"),"Qbicles")}})):($("#workgroup-location-id").val(0),$(".preview-workgroup table tr td.location_name").text(""),$(".preview-workgroup table tr td.workgroup_process").text(""),$(".preview-workgroup table tr td.workgroup_qbicle").text(""),$(".preview-workgroup table tr td.workgroup_member span").text(""))}function ShowGroupMember(){var n="/TraderTransfers/ShowListMemberForWorkGroup?wgId="+$("#transfer-workgroup-select").val();AjaxElementLoad(n,"app-trader-workgroup-preview")}function SaveCashBankContactAdd(){var n={Id:$("#group-contact-id").val()},t={ContactGroup:n,Name:$("#contact-name").val(),Id:$("#contact-id").val()};$("#form_contact_add").valid()&&$.ajax({url:"/TraderContact/TraderContactNameCheck",data:{contact:t},type:"POST",dataType:"json"}).done(function(n){n.result?$("#form_contact_add").validate().showErrors({Name:_L("ERROR_MSG_251")}):SaveCashBankAddPaymentContact()}).fail(function(){$("#form_contact_add").validate().showErrors({Name:_L("ERROR_MSG_252")})})}function SaveCashBankAddPaymentContact(){$.LoadingOverlay("show");var n=document.getElementById("trader-contact-avatar-upload").files;n&&n.length>0?UploadMediaS3ClientSide("trader-contact-avatar-upload").then(function(n){if(n.objectKey==="no_image"||n.objectKey==="no-image"){LoadingOverlayEnd("hide");cleanBookNotification.error(_L("ERROR_MSG_S3_UPLOAD"),"Qbicles");return}$("#trader-contact-object-key").val(n.objectKey);$("#trader-contact-object-name").val(n.fileName);$("#trader-contact-object-size").val(n.fileSize);SubmitCashBankAddPaymentContact()}):SubmitCashBankAddPaymentContact()}function SubmitCashBankAddPaymentContact(){var n=new FormData($("#form_contact_add")[0]);$.ajax({type:"post",cache:!1,url:"/TraderContact/SaveTraderContact",enctype:"multipart/form-data",data:n,processData:!1,contentType:!1,beforeSend:function(){},success:function(n){n.result&&($("#app-trader-add-contact").modal("hide"),cleanBookNotification.updateSuccess(),$("#payment-contact-select").append(n.msg))},error:function(){cleanBookNotification.error(_L("ERROR_MSG_EXCEPTION_SYSTEM"),"Qbicles")}}).always(function(){LoadingOverlayEnd()})}function initModalAddPayment(){WorkGroupSelectedChange();$("#cashbank-payment .modal-body .select-modal").select2({placeholder:"Please select"});var n=$dateFormatByUser.toUpperCase();$("#search_date_range").daterangepicker({autoUpdateInput:!1,cancelClass:"btn-danger",opens:"left",locale:{cancelLabel:"Clear",format:n}});$("#search_invoice").keyup(delay(function(){$("#tblInvoices").DataTable().ajax.reload()},700));$("#search_date_range").change(function(){$("#tblInvoices").DataTable().ajax.reload()});$("#search_date_range").on("apply.daterangepicker",function(n,t){$(this).val(t.startDate.format($dateFormatByUser.toUpperCase())+" - "+t.endDate.format($dateFormatByUser.toUpperCase()));$(this).change()});$(".daterange").on("cancel.daterangepicker",function(){$(this).val(null);$(this).change()});loadDataInvoices()}function loadDataInvoices(){var n=$("#tblInvoices");n.on("processing.dt",function(n,t,i){$("#processingIndicator").css("display","none");i&&$(".loadingoverlay").length===0?$(n.currentTarget).LoadingOverlay("show"):$(n.currentTarget).LoadingOverlay("hide",!0)}).dataTable({destroy:!0,serverSide:!0,paging:!0,searching:!0,deferLoading:30,order:[[1,"desc"]],ajax:{url:"/TraderCashBank/GetInvoicesInOutByLocation",type:"POST",dataType:"json",data:function(n){var t={keyword:$("#search_invoice").val(),isIN:$("#payment_income").val()=="in"?!0:!1,searchDate:$("#search_date_range").val(),locationId:$("#workgroup-location-id").val()};return $.extend({},n,t)}},columns:[{data:"Ref",searchable:!0,orderable:!0},{data:"Date",searchable:!0,orderable:!0},{data:"Contact",searchable:!1,orderable:!0,render:function(n,t,i){return'<a href="/TraderContact/ContactMaster?key='+i.ContactKey+'">'+fixQuoteCode(n)+"<\/a>"}},{data:"Amount",searchable:!0,orderable:!0},{data:"Payments",searchable:!1,orderable:!1},{data:"Id",searchable:!1,orderable:!1,render:function(){return'<button type="button" class="btn btn-success" onclick="selectInvoice(this)"><i class="fa fa-check"><\/i><\/button>'}},],initComplete:function(){$(".invoice-select").show()}})}function checkSendTransferToReviewCondition(){var t=$("#reference").val(),i=$("#transfer_destination").val(),r=$("#transfer-workgroup-select").val(),n=$("#transfer_amount").val();t==""||i==""||r==""||n==""||n<=0?$("#sendToReviewBtn").attr("disabled","disabled"):$("#sendToReviewBtn").removeAttr("disabled")}var $qbiclesFileTypes=[],$traderCashBankAttachments=[],$traderCashBankAttachmentExisted={AssociatedFiles:[]},$cashAccountId=0,BKAccount={Id:0,Name:""},$locationId,isProcessing;$.fn.dataTable.ext.search.push(function(n,t){var f=$dateFormatByUser.toUpperCase();if($("#date_range").val().toString().trim()==="")return!0;var i=moment(($("#date_range").val().split("-")[0]+"").trim(),f),r=moment(($("#date_range").val().split("-")[1]+"").trim(),f),u=moment((t[1]+"").trim(),f);return i==null&&r==null?!0:i==null&&u<=r?!0:r==null&&u>=i?!0:u<=r&&u>=i?!0:!1});$(".daterange").on("apply.daterangepicker",function(n,t){var i=$dateFormatByUser.toUpperCase();$(this).val(t.startDate.format(i)+" - "+t.endDate.format(i));$("#date_range").html(t.startDate.format(i)+" - "+t.endDate.format(i));$("#community-list").DataTable().ajax.reload()});$(".daterange").on("cancel.daterangepicker",function(){$(this).val(null);$("#date_range").html("full history");$("#community-list").DataTable().ajax.reload()});$locationId=$("#manager_location").val();CloseAddContact=function(){$("#app-trader-add-contact").modal("hide")};isProcessing=!1;CashBankPaymentTransferProcessMedia=function(n,t){$.LoadingOverlay("show");$traderCashBankAttachments.length>0?UploadBatchMediasS3ClientSide($traderCashBankAttachments).then(function(){SubmitCashBankPaymentTransfer(n,t)}):SubmitCashBankPaymentTransfer(n,t)};SubmitCashBankPaymentTransfer=function(n,t){if(!isProcessing){isProcessing=!0;CashBankAttachmentMediaBind(0);var i=[];_.forEach($traderCashBankAttachments,function(n){n.File={};i.push(n)});$.ajax({url:"/TraderCashBank/SaveCashAccountPayment",data:{payment:n,traderCashBankAssociatedFiles:$traderCashBankAttachmentExisted,traderCashBankAttachments:i},type:"POST",dataType:"json",success:function(){var i,r;if(t=="transfer"){var u=Number($("#transfer_amount").val().replace(/\,/g,"")),f=Number($("#transfer_charges").val().replace(/\,/g,"")),i=$("#available-amount").val();n.Status.toLowerCase()!="draft"&&i<u+f&&cleanBookNotification.warning("The total of the Transfer Amount and Charges is larger than the Available amount.")}else t=="payment"&&(i=Number($("#available-amount").val()),r=$("#payment_income").val()=="out",r&&n.Status=="PendingReview"&&i<Number(n.Amount)&&cleanBookNotification.warning("The Amount of the outgoing payment is larger than the Available amount."));$.LoadingOverlay("hide");$("#community-list").DataTable().ajax.reload();t==="transfer"?$("#cashbank-transfer").modal("hide"):$("#cashbank-payment").modal("hide")},error:function(){$.LoadingOverlay("hide");cleanBookNotification.error(_L("ERROR_MSG_EXCEPTION_SYSTEM"),"Qbicles")}}).always(function(){isProcessing=!1;LoadingOverlayEnd()})}};$(document).ready(function(){initTable()});