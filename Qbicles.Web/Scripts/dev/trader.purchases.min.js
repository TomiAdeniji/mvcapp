function onSelectWorkgroup(){CallBackFilterDataPurchaseServeSide()}function onKeySearchChanged(n){filter.Key=$(n).val();setTimeout(function(){searchOnTable()},200)}function addPurchase(){LoadingOverlay();$("#app-trader-purchase-add").empty();$("#app-trader-purchase-add").load("/TraderPurchases/TraderPurchaseAdd?locationId="+$("#local-manage-select").val());LoadingOverlayEnd()}function editPurchase(n){LoadingOverlay();$("#app-trader-purchase-add").empty();$("#app-trader-purchase-add").load("/TraderPurchases/TraderPurchaseAdd?locationId="+$("#local-manage-select").val()+"&purchaseId="+n);$("#app-trader-purchase-add").modal("toggle");LoadingOverlayEnd()}function changeContact(n){$(n).val()!==""&&$.ajax({type:"get",url:"/TraderSales/GetContactById?id="+$(n).val(),dataType:"json",success:function(n){var t=n.Name+",<\/br>";n.Address&&($("#contact_address_id").val(n.Address.Id),n.Address.AddressLine1&&(t+=",<\/br>"+n.Address.AddressLine1),n.Address.City&&(t+=",<\/br>"+n.Address.City),n.Address.AddressLine2&&(t+=",<\/br>"+n.Address.AddressLine2),n.Address.State&&(t+=",<\/br>"+n.Address.State),n.Address.Country&&(t+=",<\/br>"+n.Address.Country.CommonName),n.Address.PostCode&&(t+=",<\/br>"+n.Address.PostCode));$("#address_info").empty();$("#address_info").append(t)},error:function(){cleanBookNotification.error(_L("ERROR_MSG_EXCEPTION_SYSTEM"),"Qbicles")}})}function WorkGroupSelectedChange(){$(".preview-workgroup").show();$workgroupId=$("#trader_purchase_add_workgroup").val();$workgroupId!==""?($.LoadingOverlay("show"),$.ajax({type:"get",url:"/TraderTransfers/getworkgroup?id="+$workgroupId,dataType:"json",success:function(n){LoadingOverlayEnd();n.result?($(".preview-workgroup table tr td.location_name").text(n.Object.Location),$(".preview-workgroup table tr td.workgroup_process").text(n.Object.Process),$(".preview-workgroup table tr td.workgroup_qbicle").text(n.Object.Qbicle),$(".preview-workgroup table tr td.workgroup_member span").text(n.Object.Members)):($(".preview-workgroup table tr td.location_name").text(""),$(".preview-workgroup table tr td.workgroup_process").text(""),$(".preview-workgroup table tr td.workgroup_qbicle").text(""),$(".preview-workgroup table tr td.workgroup_member span").text(""));EnableNextButton()},error:function(){LoadingOverlayEnd();cleanBookNotification.error(_L("ERROR_MSG_EXCEPTION_SYSTEM"),"Qbicles")}})):(DisableNextButton(),$(".preview-workgroup table tr td.location_name").text(""),$(".preview-workgroup table tr td.workgroup_process").text(""),$(".preview-workgroup table tr td.workgroup_qbicle").text(""),$(".preview-workgroup table tr td.workgroup_member span").text(""))}function ShowGroupMember(){$("#app-trader-workgroup-preview").empty();$("#app-trader-workgroup-preview").load("/TraderTransfers/ShowListMemberForWorkGroup?wgId="+$workgroupId);$("#app-trader-workgroup-preview").modal("toggle")}function changeDelivery(){$("#contact_address_id").val(0)}function nextToItems(){$("#trader_purchase_add_workgroup").val()&&$("#form_sale_contact").val()?($("#form_add_transaction")[0].reset(),ResetItemSelected("tb_form_item","item-select-manage",$("#trader_purchase_add_workgroup").val(),undefined,$("#local-manage-select").val(),!1,!1,!0)):(arrayUpdate.push(1),setTimeout(function(){arrayUpdate.length>1&&($('.admintabs a[href="#sale-1"]').tab("show"),$("#form_sale_contact").val()||$("#form_specifics").validate().showErrors({contact:"Contact is required"}),$("#trader_purchase_add_workgroup").val()||$("#form_specifics").validate().showErrors({workgroup:"Workgroup is required"}),arrayUpdate=[])},500))}function resetPurchaseForm(){$("#cpu").attr("disabled",!0);$("#addNowForm").attr("disabled",!0);$("#label_cost").text("Cost per <selected unit>")}function ChangeSelectedUnit(){$("#item_selected").empty();$.LoadingOverlay("show");var n=$("#item-select-manage").find(":selected").attr("itemId");$("#item_selected").load("/Trader/TraderSaleSelectUnit?idLocation="+$("#local-manage-select").val()+"&idTraderItem="+n,function(){LoadingOverlayEnd();$("#item-select-manage").val()!==""&&$("#item-select-manage").val()!=="0"&&($("#label_cost").text("Cost per <selected unit>"),$("#cpu").removeAttr("disabled"))})}function quantityChange(){var n=$("#form_item_quantity").val(),t=$("#cpu").val(),i=$("#conversionsunitid").val(),r=$("#form_item_discount").val();parseFloat(n).toString()!=="NaN"&&parseFloat(r)>100&&$("#form_item_discount").val(100);parseFloat(n).toString()!=="NaN"&&parseFloat(n)>0&&parseFloat(t).toString()!=="NaN"&&parseFloat(t)>0&&i!=""?$("#addNowForm").removeAttr("disabled"):$("#addNowForm").attr("disabled","true")}function selectedUnit(n){var t=$(n);t?$("#label_cost").text("Cost per "+$(t.find("option:selected")).text()):$("#label_cost").text("Cost per <selected unit>")}function removeRowItem(n){$("#tb_form_item tbody tr.tr_id_"+n).remove();ResetItemSelected("tb_form_item","item-select-manage",$("#trader_purchase_add_workgroup").val(),undefined,$("#local-manage-select").val(),!1,!1,!0)}function addRowItem(){var s=UniqueId(),u=$("#form_item_dimensions").val(),n,e,o;u||(u=[]);var h=$("#item_selected select").val(),r=$("#item-select-manage").find(":selected"),i=r.attr("itemId"),c=r.attr("itemName"),l=r.attr("itemImage"),a=r.attr("taxName"),v=r.attr("taxRate"),y=r.attr("costUnit"),t={Id:s,TraderItem:{Id:i,TaxName:a,ImageUri:l,Name:c,TaxRate:v,CostUnit:y},Discount:isNaN(parseFloat($("#form_item_discount").val()))?0:parseFloat($("#form_item_discount").val()),Dimensions:[],Quantity:parseFloat($("#form_item_quantity").val()),Unit:{},CostPerUnit:parseFloat($("#cpu").val()),Cost:0},f=parseFloat(t.CostPerUnit)*parseFloat(t.Quantity)*(1-parseFloat(t.Discount)/100)*(1+parseFloat(t.TraderItem.TaxRate)/100),p=f/(1+t.TraderItem.TaxRate/100),w=parseFloat(f-p).toFixed($decimalPlace);t.Cost=f.toFixed($decimalPlace);n=$("#tb_form_template tbody tr").clone();$(n).addClass("tr_id_"+i);$($(n).find("td.row_image div")).attr("style","background-image: url('"+$("#api_url").val()+t.TraderItem.ImageUri+"&size=T');");$($(n).find("td.row_name")).text(t.TraderItem.Name);$($(n).find("td.row_unit")).empty();e=$("#item_selected select").clone();$($(n).find("td.row_unit")).append(e);$($(n).find("td.row_unit select")).val(h);$($(n).find("td.row_unit select")).attr("onchange","rowUnitChange('"+i+"')");$($(n).find("td.row_costperunit input")).val(t.CostPerUnit);$($(n).find("td.row_costperunit input")).attr("onchange","updateCost('"+i+"')");$($(n).find("td.row_quantity input")).val(t.Quantity);$($(n).find("td.row_quantity input")).attr("onchange","updateCost('"+i+"')");$($(n).find("td.row_discount input")).val(t.Discount);$($(n).find("td.row_discount input")).attr("onchange","updateCost('"+i+"')");$($(n).find("td.row_taxrate")).text(t.TraderItem.TaxRate);$($(n).find("td.row_taxname")).html(showTaxRatesDetail(t.CostPerUnit,t.Quantity,t.Discount,t.TraderItem.TaxName));$($(n).find("td.row_dimensions select")).val(u);$($(n).find("td.row_cost input")).val(t.Cost).attr("onchange","updateTotalCost("+i+")");$($(n).find("td.row_button button")).attr("onclick","removeRowItem('"+i+"')");$($(n).find("td.row_button input.traderItem")).val(i);$($(n).find("td.row_button input.row_id")).val(i);$($(n).find("td select")).not(".multi-select").select2();o=$("#tb_form_item tbody tr.tr_id_"+i);o.length===0?$("#tb_form_item tbody").append(n):cleanBookNotification.error(_L("ERROR_MSG_646"),"Qbicles");setTimeout(function(){$("#form_add_transaction")[0].reset();$("#form_add_transaction select").not(".multi-select").not('[name="traderitem"]').select2();resetPurchaseForm()},100);ResetItemSelected("tb_form_item","item-select-manage",undefined,undefined,$("#local-manage-select").val(),!1,!1,!0)}function rowUnitChange(n){var i=$("#tb_form_item tbody tr.tr_id_"+n+" td.row_button input.traderItem").val().split(":"),t=$("#tb_form_item tbody tr.tr_id_"+n+" td.row_unit select").val().split(":");t[1]==="BaseUnit"?$("#tb_form_item tbody tr.tr_id_"+n+" td.row_costperunit input").val(i[3]):t[1]==="Conversion Unit"&&$("#tb_form_item tbody tr.tr_id_"+n+" td.row_costperunit input").val(parseFloat(i[3])*parseFloat(t[3]));updateCost(n)}function updateCost(n){var t=$("#tb_form_item tbody tr.tr_id_"+n+" td.row_costperunit input").val(),i=$("#tb_form_item tbody tr.tr_id_"+n+" td.row_quantity input").val(),r=$("#tb_form_item tbody tr.tr_id_"+n+" td.row_discount input").val(),u=$("#tb_form_item tbody tr.tr_id_"+n+" td.row_taxrate").text(),f,e;isNaN(parseFloat(t))||isNaN(parseFloat(i))||isNaN(parseFloat(r))||isNaN(parseFloat(u))||(f=parseFloat(t)*parseFloat(i)*(1-parseFloat(r)/100)*(1+parseFloat(u)/100),$("#tb_form_item tbody tr.tr_id_"+n+" td.row_cost input").val(f.toFixed($decimalPlace)).attr("onchange","updateTotalCost("+n+")"),e=$("#tb_form_item tbody tr.tr_id_"+n+" td.row_taxname input.txt-taxname").val(),$("#tb_form_item tbody tr.tr_id_"+n+" td.row_taxname").html(showTaxRatesDetail(t,i,r,e)))}function validateSendToReview(){var i=$("#form_sale_contact").val(),n=$("#tb_form_item tbody tr"),t=$("#tb_form_item tbody tr td");n.length>0&&t.length>1?($("#a_send_toreview_purchase").removeAttr("disabled"),$("#a_send_toreview_purchase").removeClass("disabled")):($("#a_send_toreview_purchase").attr("disabled"),$("#a_send_toreview_purchase").addClass("disabled"))}function nextToConfirm(){var n,e,i,r,u;$("#tb_confirm tbody").empty();var t=$("#tb_form_item tbody tr"),o=$("#tb_form_item tbody tr td"),f=0;if(t.length!==1||o.length!==1){for(n=0;n<t.length;n++){if(e=stringToNumber($($(t[n]).find("td.row_cost input")).val()),f+=e,i="<tr> <td>"+$($(t[n]).find("td.row_image")).html()+"<\/td>",i+="<td>"+$($(t[n]).find("td.row_name")).text()+"<\/td> <td>"+$($(t[n]).find("td.row_unit select option:selected")).text()+"<\/td>",i+=" <td>"+$($(t[n]).find("td.row_quantity input")).val()+"<\/td> <td>"+$($(t[n]).find("td.row_discount input")).val()+"%<\/td> <td>"+$($(t[n]).find("td.row_taxname")).html()+"<\/td>",i+="<td>",r=$($(t[n]).find("td.row_dimensions select option:selected")),r.length>0)for(u=0;u<r.length;u++)i+='<span class="label label-info label-lg">'+$(r[u]).text()+"<\/span> ";i+="<\/td>";i+="<td>"+$($(t[n]).find("td.row_cost input")).val()+"<\/td> <\/tr>";$("#tb_confirm tbody").append(i)}$("#total_id").text(toCurrencySymbol(f));validateSendToReview()}}function SavePurchaseDraft(){SavePurchase("Draft")}function SavePurchaseReview(){SavePurchase("PendingReview")}function SavePurchase(n){var h=[],i=$("#tb_form_item tbody tr"),t,s,u,r,f,e,c,o,l,a;if(i.length>0)for(t=0;t<i.length;t++){if(s=parseInt($($(i[t]).find("td.row_button input.row_id")).val()),u={Id:0},$($(i[t]).find("td.row_button input.traderItem")).val()!==null?u.Id=$($(i[t]).find("td.row_button input.traderItem")).val():u=null,r=$($(i[t]).find("td.row_dimensions select")).val(),f=[],r&&r.length>0)for(e=0;e<r.length;e++)f.push({Id:r[e]});if(n==="PendingReview"&&f.length===0)return cleanBookNotification.error(_L("ERROR_MSG_635"),"Qbicles"),$('.admintabs a[href="#sale-2"]').tab("show"),!1;if(c=$($(i[t]).find("td.row_unit select")).val().split("|"),o={Id:isNaN(s)?0:s,TraderItem:u,Discount:$($(i[t]).find("td.row_discount input")).val(),Dimensions:f,Quantity:$($(i[t]).find("td.row_quantity input")).val(),Unit:{Id:c[1]},CostPerUnit:stringToNumber($($(i[t]).find("td.row_costperunit input")).val()),Cost:stringToNumber($($(i[t]).find("td.row_cost input")).val())},parseFloat(o.Quantity).toString()==="NaN")return $.LoadingOverlay("hide"),cleanBookNotification.error(_L("ERROR_MSG_636"),"Qbicles"),!1;if(parseFloat(o.Quantity)<=0)return $.LoadingOverlay("hide"),cleanBookNotification.error(_L("ERROR_MSG_637"),"Qbicles"),!1;h.push(o)}l={Id:$("#reference_id").val(),NumericPart:parseFloat($("#refedit").text()),Type:$("#reference_type").val(),Prefix:$("#reference_prefix").val(),Suffix:$("#reference_suffix").val(),Delimeter:$("#reference_delimeter").val(),FullRef:$("#reference_fullref").val()};a={Key:$("#tradersale_form_key").val(),Location:{Id:$("#local-manage-select").val()},PurchaseItems:h,Status:n,Reference:l,Workgroup:{Id:$("#trader_purchase_add_workgroup").val()},PurchaseTotal:stringToNumber($("#total_id").text()),Vendor:{Id:$("#form_sale_contact").val()},DeliveryMethod:$("#sales_delivery").val()};$.LoadingOverlay("show");$.ajax({type:"post",url:"/TraderPurchases/SaveTraderPurchase",data:{traderPurchase:a},dataType:"json",success:function(n){n.actionVal===1?($("#app-trader-purchase-add").modal("toggle"),cleanBookNotification.createSuccess(),setTimeout(function(){ShowTablePurchaseValue(!0)},500)):n.actionVal===2?($("#app-trader-purchase-add").modal("toggle"),cleanBookNotification.updateSuccess(),setTimeout(function(){ShowTablePurchaseValue(!0)},500)):n.actionVal===3&&cleanBookNotification.error(n.msg,"Qbicles");LoadingOverlayEnd()},error:function(){cleanBookNotification.error(_L("ERROR_MSG_EXCEPTION_SYSTEM"),"Qbicles");LoadingOverlayEnd()}})}function ShowTablePurchaseValue(n){n||$("#trader-purchase-content").LoadingOverlay("show");$("#trader-purchase-content").load("/TraderPurchases/TraderPurchaseTable",function(){$('.manage-columns input[type="checkbox"]').on("change",function(){var t=$("#community-list").DataTable(),n=t.column($(this).attr("data-column"));n.visible(!n.visible())});$("#trader-purchase-content").LoadingOverlay("hide")})}function LoadTableDataPurchase(n,t,i,r){r||(r=1);$("#"+n).on("processing.dt",function(t,i,r){$("#processingIndicator").css("display","none");r&&$(".loadingoverlay").length===0?$("#"+n).LoadingOverlay("show",{minSize:"70x60px"}):$("#"+n).LoadingOverlay("hide",!0)}).DataTable({destroy:!0,dom:'<"top"fl<"clear">>rt<"bottomtable"ip<"clear">>',language:{infoFiltered:""},serverSide:!0,info:!1,stateSave:!1,bLengthChange:!0,paging:!0,searching:!1,responsive:!0,scrollX:!1,autoWidth:!0,deferLoading:30,lengthMenu:[[10,20,50,100],[10,20,50,100]],pageLength:10,ajax:{url:t,type:"GET",dataType:"json",data:function(n){return $.extend({},n,{keysearch:$("#search_dt").val(),groupid:$("#filterworkgroup").val()})}},columns:i,order:[[r,"asc"]]})}function FilterDataByServerSide(){var n=[{name:"FullRef",data:"FullRef",orderable:!1},{name:"WorkGroupName",data:"WorkGroupName",orderable:!0},{name:"CreatedDate",data:"CreatedDate",orderable:!0},{name:"Contact",data:"Contact",orderable:!1},{name:"ReportingFilter",data:"ReportingFilter",orderable:!1},{name:"Total",data:"Total",orderable:!1},{name:"Status",data:"Status",orderable:!1,width:"50px",render:function(n,t,i){var r="";switch(i.Status){case"Draft":r+='<span class="label label-lg label-primary">Draft<\/span>';break;case"PendingReview":r+='<span class="label label-lg label-warning">Awaiting Review<\/span>';break;case"PendingApproval":r+='<span class="label label-lg label-info">Awaiting Approval<\/span>';break;case"PurchaseDenied":r+='<span class="label label-lg label-danger">Denied<\/span>';break;case"PurchaseApproved":r+='<span class="label label-lg label-success">Approved<\/span>';break;case"PurchaseDiscarded":r+='<span class="label label-lg label-danger">Discarded<\/span>';break;case"PurchaseOrderIssued":r+='<span class="label label-lg label-success">Order Issued<\/span>'}return r}},{data:null,orderable:!1,width:"100px",render:function(n,t,i){return""+(i.Status==="Draft"?i.AllowEdit?'<button class="btn btn-info" onclick="editPurchase(\''+i.Id+'\')"><i class="fa fa-pencil"><\/i> &nbsp; Continue<\/button>':'<button class="btn btn-info hidden" onclick="editPurchase(\''+i.Id+'\')"><i class="fa fa-pencil"><\/i> &nbsp; Continue<\/button>':'<button class="btn btn-primary" onclick="window.location.href=\'/TraderPurchases/PurchaseMaster?id='+i.Id+'\';"><i class="fa fa-eye"><\/i> &nbsp; Manage<\/button>')}}];LoadTableDataPurchase("community-list","/TraderPurchases/TraderPurchaseDataTable",n,2);CallBackFilterDataPurchaseServeSide()}function CallBackFilterDataPurchaseServeSide(){$("#community-list").DataTable().ajax.reload()}function updateTotalCost(n){var t=parseFloat($("#tb_form_item tbody tr.tr_id_"+n+" .row_quantity input").val()),i=isNaN(parseFloat($("#tb_form_item tbody tr.tr_id_"+n+" .row_discount input").val()))?0:parseFloat($("#tb_form_item tbody tr.tr_id_"+n+" .row_discount input").val()),u=parseFloat($("#tb_form_item tbody tr.tr_id_"+n+" .row_taxrate").text()),e=$("#tb_form_item tbody tr.tr_id_"+n+" .row_taxname .txt-taxname").val(),f=parseFloat($("#tb_form_item tbody tr.tr_id_"+n+" .row_cost input").val()),r;isNaN(t)||isNaN(i)||isNaN(f)||t==0||i==100||u==-100||(r=parseFloat(f/(t*(1-i/100)*(1+u/100))).toFixed(5),$("#tb_form_item tbody tr.tr_id_"+n+" .row_costperunit input").val(r),$("#tb_form_item tbody tr.tr_id_"+n+" .row_taxname").html(showTaxRatesDetail(r,t,i,e)))}var filter={Workgroup:"",Key:""},arrayUpdate;EnableNextButton=function(){$workgroupId!==""&&$(".btnNext").removeAttr("Disabled")};DisableNextButton=function(){$(".btnNext").attr("Disabled","Disabled")};ChangeWorkgroup=function(n){WorkGroupSelectedChange();$("#item-select-manage").empty().trigger("change");var t=$(n).val();ResetItemSelected("tb_form_item","item-select-manage",t,t,$("#local-manage-select").val(),!1,!1,!0)};arrayUpdate=[];$(function(){ShowTablePurchaseValue()});