function changeavatar(){if(!$(frmProfileId).valid()){$("#commerce-logo").val(null);return}var n=document.getElementById("commerce-logo").files,t=$("#commerce-logo-object-key").val();$(".box-shadow-dark").LoadingOverlay("show");t?saveProfileB2B():n&&n.length>0&&UploadMediaS3ClientSide("commerce-logo").then(function(n){if(n.objectKey==="no_image"||n.objectKey==="no-image"){$(".business-logo").LoadingOverlay("hide",!0);cleanBookNotification.error(_L("ERROR_MSG_S3_UPLOAD"),"Qbicles");return}$("#commerce-logo-object-key").val(n.objectKey);saveProfileB2B()})}function saveProfileB2B(){if($(frmProfileId).valid()){var n=new FormData($(frmProfileId)[0]);LoadingOverlay();$.ajax({type:"post",cache:!1,url:"/Commerce/SaveProfileB2B",enctype:"multipart/form-data",processData:!1,contentType:!1,dataType:"json",data:n,beforeSend:function(){isBusy=!0},success:function(n){var t,i;isBusy=!1;n.result?(cleanBookNotification.success(_L("UPDATE_MSG_SUCCESS"),"Commerce"),t=$("#commerce-logo-object-key").val(),t&&(i=$("#api-uri").val(),$(".business-logo").css("background-image","url("+i+t+")"),$("#commerce-logo-object-key").val(""),$("#commerce-logo").val(null)),$("#business-name-display").text(n.msgName),$("#domain-name-navigation").text(n.msgName),$("#hdfProfileId").val(n.Object),$("div.social-links input, select[name=tags]").removeAttr("disabled"),$("#domainType").val()=="Premium"&&$("div.business-options a").removeAttr("disabled"),$("#btnAddFeauturedPost").removeAttr("disabled")):!n.result&&n.msg?cleanBookNotification.error(_L(n.msg),"Commerce"):cleanBookNotification.error(_L("ERROR_MSG_EXCEPTION_SYSTEM"),"Commerce");LoadingOverlayEnd();$(".box-shadow-dark").LoadingOverlay("hide",!0)},error:function(){isBusy=!1;LoadingOverlayEnd();cleanBookNotification.error(_L("ERROR_MSG_EXCEPTION_SYSTEM"),"Commerce")}});LoadingOverlayEnd()}}function initFormPost(){var n=$("#frmCommerePost");n.validate({ignore:"",rules:{Title:{required:!0,maxlength:150},Content:{required:!0,maxlength:500}}});n.submit(function(t){if((t.preventDefault(),!isBusy)&&n.valid()){$.LoadingOverlay("show");var i=document.getElementById("commerce-post-feature").files;i.length>0?UploadMediaS3ClientSide("commerce-post-feature").then(function(n){if(n.objectKey==="no_image"||n.objectKey==="no-image"){LoadingOverlayEnd();cleanBookNotification.error(_L("ERROR_MSG_S3_UPLOAD"),"Qbicles");return}$("#commerce-post-feature-object-key").val(n.objectKey);SavePostB2B()}):($("#commerce-post-feature-object-key").val(""),SavePostB2B())}});$("#txtFilterFeaturedSearch").keyup(delay(function(){reloadPosts(!0)},800));$("#txtFilterOtherSearch").keyup(delay(function(){reloadPosts(!1)}));$("#frmB2BProfile input,#frmB2BProfile textarea").change(function(){$("#btnConfigCancel").attr("disabled",!1)})}function SavePostB2B(){var t=$("#frmB2BProfile input[name=Id]").val(),n;t>0&&(n=new FormData($("#frmCommerePost")[0]),n.append("ProfileId",t),$.ajax({type:"post",cache:!1,url:"/Commerce/SavePostB2B",enctype:"multipart/form-data",processData:!1,contentType:!1,dataType:"json",data:n,beforeSend:function(){isBusy=!0},success:function(n){isBusy=!1;n.result?($("#app-commerce-post-add").modal("hide"),reloadPosts($("#hdfIsFeatured").val()=="true"?!0:!1),jumpTo("content-featured-posts"),cleanBookNotification.success(_L("UPDATE_MSG_SUCCESS"),"Commerce")):!n.result&&n.msg?cleanBookNotification.error(_L(n.msg),"Commerce"):cleanBookNotification.error(_L("ERROR_MSG_EXCEPTION_SYSTEM"),"Commerce");LoadingOverlayEnd()},error:function(){isBusy=!1;LoadingOverlayEnd();cleanBookNotification.error(_L("ERROR_MSG_EXCEPTION_SYSTEM"),"Commerce")}}))}function initModalPost(n,t){$("#frmCommerePost").validate().resetForm();$("#hdfPostId").val(0);$("#hdfIsFeatured").val(t?"true":"false");$("#frmCommerePost input[name=Title]").val("");$("#frmCommerePost textarea[name=Content]").val("");$("#frmCommerePost input[name=FeaturedImage]").val("");n&&n>0&&$.get("/Commerce/GetPostById",{id:n}).done(function(n){if(n.result){var t=n.Object;$("#frmCommerePost input[name=Title]").val(t.Title);$("#frmCommerePost textarea[name=Content]").val(t.Content);$("#hdfPostId").val(t.Id)}else cleanBookNotification.error(_L("ERROR_MSG_EXCEPTION_SYSTEM"),"Commerce")});n&&n>0&&t?$("#app-commerce-post-add h5.modal-title").text("Edit Featured Post"):n&&n>0&&!t?$("#app-commerce-post-add h5.modal-title").text("Edit Profile Post"):!n&&t?$("#app-commerce-post-add h5.modal-title").text("Add a Featured Post"):$("#app-commerce-post-add h5.modal-title").text("Add a Profile Post");$("#app-commerce-post-add").modal("show")}function reloadPosts(n,t){if(!t){var i={profileId:$("#frmB2BProfile input[name=Id]").val(),search:"",isfeatured:n};n?(i.search=$("#txtFilterFeaturedSearch").val(),setTimeout(function(){var n=$(".featured-posts");n.LoadingOverlay("show");n.load("/Commerce/LoadPostsContent",i,function(){n.LoadingOverlay("hide")})},100)):(i.search=$("#txtFilterOtherSearch").val(),setTimeout(function(){var n=$("#b2b-profile-2 .from-community");n.LoadingOverlay("show");n.load("/Commerce/LoadPostsContent",i,function(){n.LoadingOverlay("hide")})},100))}}function deletePost(n,t){bootbox.confirm({show:!0,backdrop:!0,centerVertical:!0,closeButton:!0,animate:!0,title:"Posts",message:_L("ERROR_MSG_708"),callback:function(i){if(i){$.post("/Commerce/DeletePostById",{id:n},function(n){n.result?(reloadPosts(t),jumpTo("content-featured-posts")):cleanBookNotification.error(_L("ERROR_MSG_EXCEPTION_SYSTEM"),"Commerce")});return}}})}function initEventStoreProfile(){$("div.social-links input").change(function(){saveSocialLinks()});$("#frmB2BProfile textarea[name=BusinessSummary], #frmB2BProfile select[name=BusinessEmail]").change(delay(function(){saveProfileB2B()},1e3));$("#frmB2BProfile select[name=AreasOfOperation]").change(function(){clearTimeout(wto);wto=setTimeout(function(){saveProfileB2B()},1500)});$("select[name=interests]").change(function(){clearTimeout(wto);wto=setTimeout(function(){saveCategories()},1e3)});$("select[name=tags]").change(function(){clearTimeout(wto);wto=setTimeout(function(){saveTags()},2500)});$("#frmsociallinks").validate({rules:{FacebookUrl:{url:!0},LinkedInUrl:{url:!0},TwitterUrl:{url:!0},YoutubeUrl:{url:!0},InstagramUrl:{url:!0}}});$("#profile-pages input[name=keyword]").keyup(delay(function(){reloadBusinessProfilePages()},1e3));$("#profile-pages select[name=status]").change(function(){reloadBusinessProfilePages()})}function saveSocialLinks(){var i=$("#hdfProfileId").val();if(i>0&&$("#frmsociallinks").valid()){var r=$("#frmsociallinks input[name=FacebookUrl]"),u=$("#frmsociallinks input[name=InstagramUrl]"),f=$("#frmsociallinks input[name=LinkedInUrl]"),e=$("#frmsociallinks input[name=TwitterUrl]"),o=$("#frmsociallinks input[name=YoutubeUrl]"),t={Id:i},s={Url:r.val(),Type:r.data("type"),B2BProfile:t},h={Url:u.val(),Type:u.data("type"),B2BProfile:t},c={Url:f.val(),Type:f.data("type"),B2BProfile:t},l={Url:e.val(),Type:e.data("type"),B2BProfile:t},a={Url:o.val(),Type:o.data("type"),B2BProfile:t},n=[];n.push(s);n.push(h);n.push(c);n.push(l);n.push(a);$.post("/Commerce/UpdateSocialLinks",{socialLinks:n},function(n){n.result?cleanBookNotification.success(_L("UPDATE_MSG_SUCCESS"),"Qbicles"):!n.result&&n.msg?cleanBookNotification.error(n.msg,"Qbicles"):cleanBookNotification.error(_L("ERROR_MSG_EXCEPTION_SYSTEM"),"Qbicles")})}}function saveTags(){var t=$("#hdfProfileId").val(),n;t>0&&$("#frmB2BProfile").valid()&&(n=$("select[name=tags]").val(),$.post("/Commerce/UpdateTags",{tags:n?n:[],profileId:t},function(n){n.result?cleanBookNotification.success(_L("UPDATE_MSG_SUCCESS"),"Qbicles"):!n.result&&n.msg?cleanBookNotification.error(n.msg,"Qbicles"):cleanBookNotification.error(_L("ERROR_MSG_EXCEPTION_SYSTEM"),"Qbicles")}))}function saveCategories(){var t=$("#hdfProfileId").val(),n;t>0&&$("#frmB2BProfile").valid()&&(n=$("select[name=interests]").val(),$.post("/Commerce/UpdateCategories",{categories:n?n:[],profileId:t},function(n){n.result?cleanBookNotification.success(_L("UPDATE_MSG_SUCCESS"),"Qbicles"):!n.result&&n.msg?cleanBookNotification.error(n.msg,"Qbicles"):cleanBookNotification.error(_L("ERROR_MSG_EXCEPTION_SYSTEM"),"Qbicles")}))}function jumpTo(n){var t=document.getElementById(n);$(window).scrollTop(t.offsetTop)}function getBusinessLocations(){var n=$("#tblBusinessLocations");n.on("processing.dt",function(t,i,r){if($("#processingIndicator").css("display","none"),r)n.LoadingOverlay("show");else{n.LoadingOverlay("hide",!0);var u=$("#tblBusinessLocations").DataTable().page.info();u&&u.recordsTotal>0?$(".locations-highlighted-text").hide():$(".locations-highlighted-text").show()}}).dataTable({destroy:!0,serverSide:!0,paging:!0,searching:!0,autoWidth:!0,searchDelay:800,pageLength:10,deferLoading:30,order:[[0,"asc"]],ajax:{url:"/Commerce/GetBusinessLocations"},columns:[{data:"Name",orderable:!0},{data:"Address",orderable:!0},{data:"Geolocated",orderable:!0,render:function(n){return n?"Yes":"No"}},{data:"IsIncludeInProfile",orderable:!0,render:function(n,t,i){return'<input class="chktoggle" data-toggle="toggle" data-onstyle="success" onchange="includeLocationInProfile('+i.Id+',this)" '+(n?"checked":"")+'  type="checkbox">'}}],drawCallback:function(){$(".chktoggle").bootstrapToggle()}})}function reloadBusinessLocations(){$.fn.DataTable.isDataTable("#tblBusinessLocations")?$("#tblBusinessLocations").DataTable().ajax.reload():wto=setInterval(function(){$.fn.DataTable.isDataTable("#tblBusinessLocations")&&($("#tblBusinessLocations").DataTable().ajax.reload(),clearInterval(wto))},1e3)}function includeLocationInProfile(n,t){$.post("/Commerce/SetLocationIncludeInProfile",{locationId:n,isIncludeInProfile:$(t).prop("checked")},function(n){n.result?cleanBookNotification.success(_L("UPDATE_MSG_SUCCESS"),"Profile & config"):!n.result&&n.msg?cleanBookNotification.success(_L(n.msg),"Profile & config"):cleanBookNotification.error(_L("ERROR_MSG_EXCEPTION_SYSTEM"),"Profile & config")})}function loadB2CBusinessCatalogues(n){var t=$("#business-catalogues");t.empty();t.LoadingOverlay("show");t.load("/B2C/LoadB2CBusinessCatalogues",{domainKey:n,isLoadAll:!0,view:"_TableBusinesCatalogues"},function(){$("#tblBusinessCatalogues").DataTable({responsive:!0,order:[[0,"asc"]],language:{lengthMenu:"_MENU_ &nbsp; per page"},drawCallback:function(){$('#tblBusinessCatalogues input[data-toggle="toggle"]').bootstrapToggle()}});t.LoadingOverlay("hide",!0);var n=$("#tblBusinessCatalogues").DataTable().page.info();n&&n.recordsTotal>0?$(".catalogues-highlighted-text").hide():$(".catalogues-highlighted-text").show()})}function includeCatalogInProfile(n,t){$.post("/Commerce/SetCatalogIncludeInProfile",{catId:n,isIncludeInProfile:$(t).prop("checked")},function(n){n.result?cleanBookNotification.success(_L("UPDATE_MSG_SUCCESS"),"Profile & config"):!n.result&&n.msg?cleanBookNotification.success(_L(n.msg),"Profile & config"):cleanBookNotification.error(_L("ERROR_MSG_EXCEPTION_SYSTEM"),"Profile & config")})}function getBusinessProfilePages(){var n=$("#tblBusinessProfilePages");n.on("processing.dt",function(t,i,r){$("#processingIndicator").css("display","none");r?n.LoadingOverlay("show"):n.LoadingOverlay("hide",!0)}).dataTable({destroy:!0,serverSide:!0,paging:!0,searching:!1,autoWidth:!0,searchDelay:800,pageLength:10,deferLoading:30,ajax:{url:"/ProfilePage/GetBusinessProfilePages",type:"Get",dataType:"json",data:function(n){var t={keyword:$("#profile-pages input[name=keyword]").val(),status:$("#profile-pages select[name=status]").val()};return $.extend({},n,t)}},columns:[{data:"PageTitle",orderable:!1},{data:"Created",orderable:!1},{data:"DisplayOrder",orderable:!0},{data:"Status",orderable:!0,render:function(n){return""+(n=="IsActive"?'<span class="label label-lg label-success">Active<\/span>':n=="IsInActive"?'<span class="label label-lg label-warning">Inactive<\/span>':'<span class="label label-lg label-info">Draft<\/span>')}},{data:"Key",orderable:!1,render:function(n,t,i,r){var u='<div class="btn-group"><button type="button" class="btn btn-primary dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">';return u+='Options &nbsp; <i class="fa fa-angle-down"><\/i><\/button>',u+='<ul class="dropdown-menu dropdown-menu-right primary" style="right: 0;">',u+='<li><a href="/ProfilePage/BusinessPageBuilder?pageKey='+n+'">Edit<\/a><\/li>',r.row>0&&(u+='<li class="dtMoveUp"><a href="javascript:void(0)">Move up<\/a><\/li>'),u+='<li class="dtMoveDown"><a href="javascript:void(0)">Move down<\/a><\/li>',i.Status=="IsActive"?(u+='<li><a href="/ProfilePage/BusinessPagePreview?pageKey='+n+'" target="_blank">Preview<\/a><\/li>',u+='<li><a href="javascript:void(0)" onclick="setBusinessPageStatus(\''+n+"','IsInActive')\">Unpublish<\/a><\/li>"):u+='<li><a href="javascript:void(0)" onclick="setBusinessPageStatus(\''+n+"','IsActive')\">Publish<\/a><\/li>",u+='<li><a href="javascript:void(0)" onclick="deleteProfilePage(\''+n+"');\">Delete<\/a><\/li>",u+"<\/div>"}}],drawCallback:function(){$("#tblBusinessProfilePages tr:last .dtMoveDown").remove();$(".dtMoveUp").unbind("click");$(".dtMoveDown").unbind("click");$(".dtMoveUp").click(moveUp);$(".dtMoveDown").click(moveDown)}})}function moveUp(){var n=$(this).parents("tr");moveRow(n,"up")}function moveDown(){var n=$(this).parents("tr");moveRow(n,"down")}function moveRow(n,t){var i=$("#tblBusinessProfilePages").DataTable(),f=i.row(n).index(),r=-1,u;t==="down"&&(r=1);u=i.row(f).data();$.post("/ProfilePage/UpdateDisplayOrderPageBuilder",{key:u.Key,direction:r},function(n){n.result?(i.page(0).draw(!1),cleanBookNotification.success(_L("UPDATE_MSG_SUCCESS"),"Qbicles")):!n.result&&n.msg?cleanBookNotification.error(n.msg,"Qbicles"):cleanBookNotification.error(_L("ERROR_MSG_EXCEPTION_SYSTEM"),"Qbicles")})}function reloadBusinessProfilePages(){$.fn.DataTable.isDataTable("#tblBusinessProfilePages")?$("#tblBusinessProfilePages").DataTable().ajax.reload():wto=setInterval(function(){$.fn.DataTable.isDataTable("#tblBusinessProfilePages")&&($("#tblBusinessProfilePages").DataTable().ajax.reload(),clearInterval(wto))},2e3)}function setBusinessPageStatus(n,t){$.post("/ProfilePage/SetBusinessPageStatus",{pageKey:n,status:t},function(n){n.result?(reloadBusinessProfilePages(),cleanBookNotification.success(_L("UPDATE_MSG_SUCCESS"),"Qbicles")):!n.result&&n.msg?cleanBookNotification.error(n.msg,"Qbicles"):cleanBookNotification.error(_L("ERROR_MSG_EXCEPTION_SYSTEM"),"Qbicles")})}function deleteProfilePage(n){var t=confirm("Are you sure you want to delete this page?");t&&$.post("/ProfilePage/DeleteProfilePage",{pageKey:n},function(n){n.result?reloadBusinessProfilePages():!n.result&&n.msg?cleanBookNotification.error(n.msg,"Qbicles"):cleanBookNotification.error(_L("ERROR_MSG_EXCEPTION_SYSTEM"),"Qbicles")})}function updateDefaultManagers(){var n=$("#hdfProfileId").val(),t=$("select[name=UserIdB2BRelationshipManagers]").val(),i=$("select[name=UserIdB2CRelationshipManagers]").val(),r=$("input[name=IsDisplayedInB2BListings]").prop("checked"),u=$("input[name=IsDisplayedInB2CListings]").prop("checked"),f={Id:n,IsDisplayedInB2BListings:r,IsDisplayedInB2CListings:u,UserIdB2BRelationshipManagers:t?t:[],UserIdB2CRelationshipManagers:i?i:[]};n>0?($.LoadingOverlay("show"),$.post("/Commerce/UpdateDefaultManagers",f,function(n){LoadingOverlayEnd();n.result?cleanBookNotification.success(_L("UPDATE_MSG_SUCCESS"),"Profile & config"):!data.result&&data.msg?cleanBookNotification.error(_L(data.msg),"Profile & config"):cleanBookNotification.error(_L("ERROR_MSG_EXCEPTION_SYSTEM"),"Profile & config")})):cleanBookNotification.warning(_L("WARNING_MSG_SAVEBUSINESSPROFILE"),"Profile & config")}function initSelectedAccount(){}function closeSelected(){BKAccount.Id?($(".accountInfo").empty(),$(".accountInfo").append(BKAccount.Name)):$(".accountInfo").empty();$(".accountInfo").text().length>0?($(".addbtnaccount").attr("style","display:none;"),$(".editbtnaccount").removeAttr("style")):$(".accountInfo").text().length===0&&($(".editbtnaccount").attr("style","display:none;"),$(".addbtnaccount").removeAttr("style"))}function selectAccount(n,t){var i=$(".accountid-"+t).data("name");$(".selectaccount").removeClass("selectaccount");$(n).addClass("selectaccount");BKAccount.Id=t;BKAccount.Name=i;$("#accountId").length>0&&$("#accountId").val(t);$("#hdfAccountId").length>0&&$("#hdfAccountId").val(t);$("#hdfcontactaccountId").length>0&&$("#hdfcontactaccountId").val(t);closeSelected();$("#app-bookkeeping-treeview").modal("hide")}function showChangeAccount(){setTimeout(function(){CollapseAccount()},1)}function CollapseAccount(){$(".jstree").jstree("close_all")}function initSelectedAccount(){setTimeout(function(){$(".selectaccount").removeClass("selectaccount");$(".accountid-"+BKAccount.Id).addClass("selectaccount")},1)}function PublishCatalogInProfile(n,t){$.post("/Commerce/PublishCatalogInProfile",{catId:n,isPublish:$(t).prop("checked")},function(n){n.result?cleanBookNotification.success(_L("UPDATE_MSG_SUCCESS"),"Profile & config"):!n.result&&n.msg?cleanBookNotification.success(_L(n.msg),"Profile & config"):cleanBookNotification.error(_L("ERROR_MSG_EXCEPTION_SYSTEM"),"Profile & config")})}var isBusy=!1,frmProfileId="#frmB2BProfile",wto;$(function(){getBusinessLocations();getBusinessProfilePages();$("#profile-b2c select[name=UserIdB2CRelationshipManagers], #profile-b2b select[name=UserIdB2BRelationshipManagers], #profile-b2b input[name=IsDisplayedInB2BListings], #profile-b2c input[name=IsDisplayedInB2CListings]").change(function(){clearTimeout(wto);wto=setTimeout(function(){updateDefaultManagers()},1e3)})});$(document).ready(function(){reloadPosts(!0,!1);initFormPost();initEventStoreProfile();$(".select2tag").select2({tags:!0});var n=getQuerystring("tab");switch(n){case"profile-pages":$("a[href=#"+n+"]").click()}$(frmProfileId).validate({validClass:"valid-no-border"})});