function InvoicePaymentAddAnother(n){var i=GenerateUUID(),r=$(".attachments_"+n+" input.inputfile"),t="<div id='manage-id-"+i+"' class=\"row attachment_row att-id-"+i+'"> <div class="col-xs-12">';t+='<input type="hidden" class="file-id-input-'+(r.length+1)+'" value="'+i+'"/>';t+='<div class="form-group"> <label for="name">Name<\/label> <input type="text" name="name" class="form-control inputfilename'+(r.length+1)+'">';t+='<\/div> <\/div> <div class="col-xs-12"> <div class="form-group"> <label for="file">File<\/label>';t+='<input type="file" name="file" onchange="InvoicePaymentChangeFile(this,'+(r.length+1)+","+n+')" class="form-control inputfile">  <\/div>  <\/div> <\/div>';$(".attachments_"+n+" div.repeater_wrap").append(t)}function InvoicePaymentChangeFile(n,t,i){var r=$(".attachments_"+i+" input.inputfilename"+t).val(),u,f;for($(n).length>0&&$(n)[0].files.length>0&&r.length===0&&(r=$(n)[0].files[0].name.split(".")[0]),u=$(".attachments_"+i+" input.inputfile"),f=0;f<u.length;f++)u[0]!==n&&$(u[0]).val()===$(n).val()&&($(n).val(""),cleanBookNotification.error(_L("ERROR_MSG_351",[r]),"Qbicles"),r="");$(".attachments_"+i+" .inputfilename"+t).val(r)}function InvoicePaymentConfirmAddViewer(n){InvoicepaymentMediaBind(n);$("#invoice-attachments ul.domain-change-list").empty();var t=$traderInvoiceAttachmentExisted.AssociatedFiles.length+$traderInvoiceAttachments.length;$("#trader-invoice-attachment-manage").text(" Attachments ("+t+")");t>0&&$("#trader-invoice-attachment-icon").removeClass("fa fa-plus").addClass("fa fa-paperclip");_.forEach($traderInvoiceAttachmentExisted.AssociatedFiles,function(n){var t=" <li id='att-"+n.Id+"'><button class='btn btn-danger' onclick=\"InvoicePaymentRemoveAttachment('"+n.Id+"')\"><i class='fa fa-trash'><\/i><\/button> <a href='javascript:void(0)'>";t+='<img src="'+n.IconPath+'" style="max-width: 80px; height: auto; padding-right: 10px;">';t+=n.Name+" <\/a> <\/li>";$("#invoice-attachments ul.domain-change-list").append(t)});_.forEach($traderInvoiceAttachments,function(n){var t=" <li id='att-"+n.Id+"'><button class='btn btn-danger' onclick=\"InvoicePaymentRemoveAttachment('"+n.Id+"')\"><i class='fa fa-trash'><\/i><\/button> <a href='javascript:void(0)'>";t+='<img src="'+n.IconPath+'" style="max-width: 80px; height: auto; padding-right: 10px;">';t+=n.Name+" <\/a> <\/li>";$("#invoice-attachments ul.domain-change-list").append(t)})}function InvoicePaymentRemoveAttachment(n){$("#att-"+n).remove();$("#manage-id-"+n).remove();_.remove($traderInvoiceAttachments,function(t){return t.Id==n});_.remove($traderInvoiceAttachmentExisted.AssociatedFiles,function(t){return t.Id==n});var t=$traderInvoiceAttachmentExisted.AssociatedFiles.length+$traderInvoiceAttachments.length;$("#trader-invoice-attachment-manage").text(" Attachments ("+t+")")}function CloseModalMedia(){$("#attachments-view").modal("hide")}function SaveInvoicePayment(n,t){if($("#reference").val()===""){$("#cash-account-payment").validate().showErrors({reference:"Reference is required."});return}if($("#workgroup-select").val()===""||$("#workgroup-select").val()==null){cleanBookNotification.error("Work group is required","Qbicles");return}InvoiceProcessMedia(n,t)}var $qbiclesFileTypes=[],$traderInvoiceAttachments=[],$traderInvoiceAttachmentExisted={AssociatedFiles:[]};$(document).ready(function(){$qbiclesFileTypes=[];$.ajax({type:"post",url:"/FileTypes/GetFileTypes",dataType:"json",success:function(n){$qbiclesFileTypes=n},error:function(){}}).always(function(){LoadingOverlayEnd()})});InvoicepaymentMediaBind=function(n){var i,t,f,r,e,u;for($traderInvoiceAttachmentExisted={AssociatedFiles:[]},$traderInvoiceAttachments=[],i=$(".attachments_"+n+" input.inputfile"),t=0;t<i.length;t++)$(".attachments_"+n+" .inputfilename"+(t+1)).val()===""&&i[t].files.length>0&&$(".attachments_"+n+" .inputfilename"+(t+1)).val(i[t].files[0].name.substr(0,i[t].files[0].name.lastIndexOf("."))),f=$(".file-id-input-"+(t+1)).val(),i[t].files.length>0?(r=i[t].files[0],fileExtension=r.name.split(".").pop(),e=_.find($qbiclesFileTypes,function(n){return n.Extension===fileExtension}),u={Id:f,Name:r.name,Extension:r.name.split(".").pop(),Size:r.size,IconPath:e.IconPath,File:r},$("div.attachments_"+n+" .inputfilename"+(t+1)).val()!==""&&(u.Name=$("div.attachments_"+n+" .inputfilename"+(t+1)).val()+"."+fileExtension),$traderInvoiceAttachments.push(u)):$("#file_id_"+(t+1)).length>0&&$traderInvoiceAttachmentExisted.AssociatedFiles.push({Id:parseInt($("#file_id_"+(t+1)).val()),Name:$(".inputfilename"+(t+1)).val(),IconPath:$("#inputiconpath_edit"+(t+1)).val()})};InvoiceProcessMedia=function(n,t){$traderInvoiceAttachments.length>0?UploadBatchMediasS3ClientSide($traderInvoiceAttachments).then(function(){SubmitInvoicePayment(n,t)}):SubmitInvoicePayment(n,t)};SubmitInvoicePayment=function(n,t){var r,u,i,h;$.LoadingOverlay("show");InvoicepaymentMediaBind($paymentId);r=[];_.forEach($traderInvoiceAttachments,function(n){n.File={};r.push(n)});var f={},e={},o={},s={};switch(t){case"PaymentIn":f={Id:$("#model-id").val()};break;case"PaymentOut":o={Id:$("#model-id").val()}}u=$("#cashorbank").val();u!=null&&(i=u.split("-"),i[1]==="PaymentIn"?e={Id:i[0]}:i[1]==="PaymentOut"&&(s={Id:i[0]}));h={Id:$paymentId,Description:$("#description").val(),Amount:$("#amount").val(),AssociatedSale:f,AssociatedPurchase:o,Status:n,Workgroup:{Id:$("#workgroup-select").val()},AssociatedInvoice:{Id:$("#invoice-id").val()},Type:t,OriginatingAccount:s,DestinationAccount:e,PaymentMethod:{Id:$("#payment-method").val()},Reference:$("#reference").val()};$.ajax({type:"post",url:"/TraderPayments/SaveInvoicePayment",data:{invoicePayment:h,traderInvoiceAssociatedFiles:$traderInvoiceAttachmentExisted,traderInvoiceAttachments:r},dataType:"json",success:function(){ReloadInvoicePayment();$("#app-trader-invoice-payment").modal("toggle");cleanBookNotification.updateSuccess()},error:function(){cleanBookNotification.error(_L("ERROR_MSG_EXCEPTION_SYSTEM"),"Qbicles")}}).always(function(){LoadingOverlayEnd()})};