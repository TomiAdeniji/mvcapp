function loadModalTranferItems(n){$.LoadingOverlay("show");$("#app-spannered-asset-transfer").empty();$("#app-spannered-asset-transfer").modal("show");$("#app-spannered-asset-transfer").load("/Spanneredfree/LoadModalTransferItems?locationId="+$slLocation.val()+"&aiId="+(n?n:0),function(){initFormTransfer();LoadingOverlayEnd()})}function workGroupTransferChange(n){$(".preview-workgroup").show();$workgroupId=$(n).val();$workgroupId!==""?($.LoadingOverlay("show"),$.ajax({type:"get",url:"/TraderTransfers/getworkgroup?id="+$workgroupId,dataType:"json",success:function(n){LoadingOverlayEnd();n.result?($(".preview-workgroup table tr td.location_name").text(n.Object.Location),$(".preview-workgroup table tr td.workgroup_process").text(n.Object.Process),$(".preview-workgroup table tr td.workgroup_qbicle").text(n.Object.Qbicle),$(".preview-workgroup table tr td.workgroup_member span").text(n.Object.Members)):($(".preview-workgroup table tr td.location_name").text(""),$(".preview-workgroup table tr td.workgroup_process").text(""),$(".preview-workgroup table tr td.workgroup_qbicle").text(""),$(".preview-workgroup table tr td.workgroup_member span").text(""))},error:function(){LoadingOverlayEnd();cleanBookNotification.error(_L("ERROR_MSG_EXCEPTION_SYSTEM"),"Qbicles")}}),$.ajax({type:"get",url:"/Spanneredfree/GetItemProductByWorkgroupIsBought?wgid="+$workgroupId+"&locationId="+$slLocation.val()+"&assetId="+($("#assetId").val()?$("#assetId").val():0),dataType:"json",success:function(n){n.result&&(lstTransferTraderItems=n.Object,ResetTransferItems("tbl_transfer_items","transfer-items",$("#transfer-workgroup-select").val()))},error:function(){}})):($(".preview-workgroup table tr td.location_name").text(""),$(".preview-workgroup table tr td.workgroup_process").text(""),$(".preview-workgroup table tr td.workgroup_qbicle").text(""),$(".preview-workgroup table tr td.workgroup_member span").text(""))}function ShowGroupMember(){$("#app-trader-workgroup-preview").empty();$("#app-trader-workgroup-preview").load("/TraderTransfers/ShowListMemberForWorkGroup?wgId="+$workgroupId+"&title=Transfers team members");$("#app-trader-workgroup-preview").modal("show")}function validateItemsInTable(){var n=$("#tbl_transfer_items tbody tr");if(n===null||n.length===0)$("#app-spannered-asset-transfer .btnNextConfirm").attr("Disabled","Disabled"),$("#app-spannered-asset-transfer .btnNextConfirm").off();else{$("#app-spannered-asset-transfer .btnNextConfirm").removeAttr("Disabled");$("#app-spannered-asset-transfer .btnNextConfirm").on("click",function(){var n=$(this).closest(".modal");$("#frmTransferItems").valid()&&$(n).find("#tabTransferItemsNav .active").next("li").find("a").trigger("click")})}}function changeTransferItemUnit(){var n=$("#transfer-items").val();if(!n){resetFrmTransfer();ResetTransferItems("tbl_transfer_items","transfer-items",$("#transfer-workgroup-select").val());return}$("#transfer-item-units").empty();$.get("/Spanneredfree/GetUnitByItemId?itemId="+n,function(n){$("#transfer-item-units").select2({data:n?n:[]})})}function removeRowTransferItem(n){$("#tbl_transfer_items tbody tr.tr_id_"+n).remove();validateItemsInTable();ResetTransferItems("tbl_transfer_items","transfer-items",$("#transfer-workgroup-select").val())}function addRowTransferItem(){var u,f,t,n,i,r,e;setRequiredFrmTransferItem(!0);$("#transfer-items").valid()&&$("#transfer-item-units").valid()&&$("#transfer-item-quantity").valid()&&(u=UniqueId(),f=$("#transfer-item-units").val(),checkQuantityTransItem($("#transfer-item-quantity")),t={Id:u,TraderItem:{Id:$("#transfer-items").val().split(":")[0],ImageUri:$("#transfer-items option:selected").attr("itemimage"),Name:$("#transfer-items option:selected").text()},Quantity:parseFloat($("#transfer-item-quantity").val()),Fee:parseFloat($("#transfer-item-fee").val())},n=$("#tb_form_template_tranferitems tbody tr").clone(),$(n).addClass("tr_id_"+t.Id),$($(n).find("td.row_image div")).attr("style","background-image: url('"+$("#api-uri").val()+t.TraderItem.ImageUri+"&size=T');"),$($(n).find("td.row_name")).text(t.TraderItem.Name),$($(n).find("td.row_unit")).empty(),i=$("#transfer-item-units").clone(),i=$(i).removeAttr("id"),$($(n).find("td.row_unit")).append(i),$($(n).find("td.row_unit select")).val(f),r=$($(n).find("td.row_quantity input")),r.val(t.Quantity),r.attr("onchange","checkQuantityTransItem(this,"+t.TraderItem.Id+")"),e=$($(n).find("td.row_fee input")),e.val(t.Fee),$($(n).find("td.row_button button")).attr("onclick","removeRowTransferItem('"+t.Id+"')"),$($(n).find("td.row_button input.traderItem")).val($("#transfer-items").val()),$($(n).find("td.row_button input.row_id")).val(t.Id),$($(n).find("td select")).not(".multi-select").select2(),$("#tbl_transfer_items tbody").append(n),validateItemsInTable(),ResetTransferItems("tbl_transfer_items","transfer-items",$("#transfer-workgroup-select").val()),resetFrmTransfer());setRequiredFrmTransferItem(!1)}function checkQuantityTransItem(n,t){var r=$("#transfer_type").val();if(r==="#outbound"){var u=$slLocation.val(),f=$(n).val(),i=$("#transfer-items").val();i=i&&!t?i.split(":")[0]:t;$.ajax({type:"post",url:"/TraderTransfers/GetCurrentInventory",data:{locationId:u,itemId:i},dataType:"json","async":!1,success:function(t){if(t&&t.currentInventory<f)return cleanBookNotification.error(_L("ERROR_MSG_382",[t.currentInventory]),"Qbicles"),$(n).val(t.currentInventory),$(n).focus(),LoadingOverlayEnd(),!1}})}}function initFormTransfer(){var n=$("#frmTransferItems");n.validate({ignore:"",rules:{workgourptransfer:{required:!0}},invalidHandler:function(){$('##transfer-1 label.error:not([style*="display: none"])').length!=0?$('#tabTransferItemsNav a[href="#transfer-1"]').tab("show"):$('#transfer-2 label.error:not([style*="display: none"])').length!=0&&$('#tabTransferItemsNav a[href="#transfer-2"]').tab("show")}});n.submit(function(t){var e,o,s,i,r,h,f,u,c,l,a,v;if(t.preventDefault(),!isBusy)if(n.valid()){if($.LoadingOverlay("show"),e={},o={},$("#transfer_type").val()==="#outbound"?(e={Id:$slLocation.val()},o={Id:$("#in-out-location").val()}):$("#transfer_type").val()==="#inbound"&&(o={Id:$slLocation.val()},e={Id:$("#in-out-location").val()}),s=[],i=$("#tbl_transfer_items tbody tr"),i===null||i.length===0){LoadingOverlayEnd();cleanBookNotification.error(_L("ERROR_MSG_654"),"Qbicles");$('a[href="#transfer-2"]').trigger("click");return}if(i.length>0)for(r=0;r<i.length;r++){if(h=parseInt($($(i[r]).find("td.row_button input.row_id")).val()),f={Id:0},$($(i[r]).find("td.row_button input.traderItem")).val().split(":").length>=1?f.Id=$($(i[r]).find("td.row_button input.traderItem")).val().split(":")[0]:f=null,u=$(i[r]).find("td.row_quantity input"),c=$(u).val(),checkQuantityTransItem(u,f.Id),c!==$(u).val()){$(u).focus();$('a[href="#transfer-2"]').trigger("click");return}l=$($(i[r]).find("td.row_unit select")).val();a={Id:isNaN(h)?0:h,TraderItem:f,QuantityAtPickup:$(u).val(),Unit:{Id:l}};s.push(a)}v={Status:"PendingPickup",OriginatingLocation:e,DestinationLocation:o,Workgroup:{Id:$("#transfer-workgroup-select").val()},TransferItems:s};$.ajax({type:"post",url:"/Spanneredfree/SaveTransferAsset",data:{transfer:v},dataType:"json",success:function(n){$.LoadingOverlay("hide");$("#app-spannered-asset-transfer").modal("hide");n.result?cleanBookNotification.createSuccess():cleanBookNotification.error(n.msg,"Spannered")},error:function(){$.LoadingOverlay("hide");cleanBookNotification.error(_L("ERROR_MSG_EXCEPTION_SYSTEM"),"Spannered")}})}else{$("#frmTransferItemsAsset ul.app_subnav a[href=#transfer-1]").tab("show");return}});$("#frmTransferItems .select2").not(".multi-select").select2();$("#transfer_type").on("change",function(){$(this).valid();var n=$(this).val();$("#inbound-lbl").hide();$("#outbound-lbl").hide();$("#block-in-out").show();$(n+"-lbl").toggle();$("#in-out-location").trigger("change")});$("#frmTransferItems .btnNext").click(function(){var t=$(this).closest(".modal");n.valid()&&$(t).find("#tabTransferItemsNav .active").next("li").find("a").trigger("click")});$("#frmTransferItems .btnPrevious").click(function(){var n=$(this).closest(".modal");$(n).find("#tabTransferItemsNav .active").prev("li").find("a").trigger("click")})}function ResetTransferItems(n,t,i){var h,f,u,o,r;if((typeof i=="undefined"||i!==null)&&(h=!isNaN(i),$("#"+n)&&$("#"+t))){var e=$("#"+n+" tbody tr"),c=$("#"+n+" tbody tr td"),s=[];if(e.length>0&&c.length>1)for(f=0;f<e.length;f++)s.push($($(e[f]).find(" td input.traderItem")).val().split(":")[0]);for(u=jQuery.map(lstTransferTraderItems,function(n){if(s.indexOf(n.Id.toString())===-1)return n}),o="<option value=''><\/option>",r=0;r<u.length;r++)o+="<option itemId='"+u[r].Id+"' itemName='"+u[r].Name+"' itemImage='"+u[r].ImageUri+"' taxName='"+u[r].TaxRateName+"' taxRate='"+u[r].TaxRateValue+"' costUnit ='"+u[r].CostUnit+"'value=\""+u[r].Id+'">'+u[r].Name+"<\/option>";$("#"+t).empty();$("#"+t).append(o);$("#"+t).not(".multi-select").select2({placeholder:"Please select"});qbicleLog("ResetItemSelected")}}function resetFrmTransfer(){$("#transfer-item-units").empty();$("#transfer-item-units").append("<option><\/option>");$("#transfer-item-units").not(".multi-select").select2({placeholder:"Please select"});$("#transfer-item-quantity").val("");$("#transfer-item-fee").val("")}function setRequiredFrmTransferItem(n){n?($("#transfer-items").attr("required",!0),$("#transfer-item-units").attr("required",!0),$("#transfer-item-quantity").attr("required",!0)):($("#transfer-items").removeAttr("required"),$("#transfer-item-units").removeAttr("required"),$("#transfer-item-quantity").removeAttr("required"))}function nextToTransferConfirm(){$("#confirm-tranfer-type").text($("#transfer_type :selected").text());$("#div-confirm").empty();loadDataTableConfirm();$("#contact-source").empty();$("#contact-destination").empty();$("#transfer_type").val()==="#inbound"?($("#source-destination-manage").text("Destination"),$("#source-destination-select").text("Source"),$("#location-in-out-selected").clone().removeAttr("id").appendTo("#contact-source"),$("#location-manage-confirm").clone().removeAttr("id").appendTo("#contact-destination")):$("#transfer_type").val()==="#outbound"&&($("#source-destination-manage").text("Source"),$("#source-destination-select").text("Destination"),$("#location-in-out-selected").clone().removeAttr("id").appendTo("#contact-destination"),$("#location-manage-confirm").clone().removeAttr("id").appendTo("#contact-source"))}function loadDataTableConfirm(){var n="<table id='tb_confirm' class='datatable table-hover' style='width: 100%; background: #fff;' data-order='[[1, \"asc\"]]'>",t,r,i;if(n+="<thead><tr><th data-orderable='false'><\/th><th>Name<\/th><th>Unit<\/th><th>Quantity<\/th><\/tr><\/thead><tbody>",t=$("#tbl_transfer_items tbody tr"),r=$("#tbl_transfer_items tbody tr td"),t.length!==1||r.length!==1){for(i=0;i<t.length;i++)n+="<tr> <td>"+$($(t[i]).find("td.row_image")).html()+"<\/td>",n+="<td>"+$($(t[i]).find("td.row_name")).text()+"<\/td> ",n+="<td>"+$($(t[i]).find("td.row_unit select option:selected")).text()+"<\/td>",n+=" <td>"+$($(t[i]).find("td.row_quantity input")).val()+"<\/td> ",n+="<\/tr>";n+="<\/tbody><\/table>";$("#div-confirm").append(n)}}function locationInOuChange(){$("#location-in-out-selected").empty();var n=$("#in-out-location").val();n&&n>0&&$.ajax({type:"post",url:"/TraderTransfers/LocationSelectToHtml",data:{id:n},dataType:"json",success:function(n){$("#location-in-out-selected").append(n.msg)},error:function(){cleanBookNotification.error(_L("ERROR_MSG_EXCEPTION_SYSTEM"),"Qbicles")}}).always(function(){})}function saveTransferItems(n){statusTranferItems=n;statusTranferItems&&$("#frmTransferItems").trigger("submit")}var lstTransferTraderItems=[],statusTranferItems="";