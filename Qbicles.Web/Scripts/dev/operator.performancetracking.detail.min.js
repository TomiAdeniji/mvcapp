function formatOptions(n){if(!n.id)return n.text;return $('<div class="select2imgwrap"><div class="select2img" style="background-image: url(\''+($(n.element).attr("avataruri")===""?"/Content/DesignStyle/img/icon_domain_default.png":$(n.element).attr("api")+""+$(n.element).attr("avataruri"))+'\');"><\/div> <span class="select2text">'+n.text+"<\/span><\/div>")}function formatSelected(n){return $('<div class="select2imgwrap" style="padding: 0px; "><div class="select2img mini" style="background-image: url(\''+($(n.element).attr("avataruri")===""?"/Content/DesignStyle/img/icon_domain_default.png":$(n.element).attr("api")+""+$(n.element).attr("avataruri"))+'\');"><\/div> <span class="select2text">'+n.text+"<\/span><\/div>")}function ChangeWorkgroup(n){$(".preview-workgroup").show();$.get("/Operator/GetWorkgroupInfor",{id:$(n).val()},function(n){var i,t;if($("#WGLocation").text(n.Location),$("#WGProcess").text(n.Process),$("#WGMember").text(n.Members),$("#WGQbicle").text(n.Qbicle),i='<option value=""><\/option>',n.Persons)for(t=0;t<n.Persons.length;t++)i+='<option avataruri="'+n.Persons[t].ProfilePic+'&size=T" api="'+$("#api-uri").val()+'" value="'+n.Persons[t].Id+'">'+n.Persons[t].Name+"<\/option>";$("#trackingPersons").html(i);$("#trackingPersons").select2({placeholder:"Please select",templateResult:formatOptions,templateSelection:formatSelected})})}function AddMeasure(){if($("#slMeasureToAdd").val()&&$("#txtWeightPercent").val()){var t=$("#slMeasureToAdd option[value="+$("#slMeasureToAdd").val()+"]").first(),f=$("#slMeasureToAdd").val(),i=t.text(),r=t.data("description"),n=parseInt($("#txtWeightPercent").val()),u=n;n&&n!=0&&($("#tblTrackingMeasures tbody tr").each(function(){u+=parseInt($(this).data("weight"))}),u<=100?($("#tblTrackingMeasures tbody").append('<tr data-id="'+f+'" data-name="'+i+'" data-description="'+r+'" data-weight="'+n+'"><td>'+i+"<\/td><td>"+r+"<\/td><td>"+n+'%<\/td><td><button class="btn btn-danger" onclick="RemoveMeasure(this)"><i class="fa fa-trash"><\/i><\/button><\/td><\/tr>'),t.remove(),$("#slMeasureToAdd").val(""),$("#slMeasureToAdd").trigger("change.select2")):cleanBookNotification.error(_L("ERROR_MSG_703"),"Operator"))}}function RemoveMeasure(n){var t=$(n).parent().parent();$("#slMeasureToAdd").append('<option value="'+t.data("id")+'" data-description="'+t.data("description")+'">'+t.data("name")+"<\/option>");$("#slMeasureToAdd").val("");$("#slMeasureToAdd").trigger("change.select2");t.remove()}function LoadPerformanceTrackingModal(n){$.LoadingOverlay("show");$("#app-operator-performance-addedit").load("/Operator/LoadPerformanceTrackingModal",{id:n},function(){var n=$("#frmOperatorPerformance");$("#performanceWorkgroup, #slMeasureToAdd").select2({placeholder:"Please select"});n.validate({ignore:"",rules:{TeamPersonId:{required:!0},WorkgroupId:{required:!0}}});n.submit(function(t){var i,r;t.preventDefault();n.valid()?($.LoadingOverlay("show"),i=getAllMeasureWithWeights(),i.length>0?(r=new FormData(n[0]),r.append("TrackingMeasures",JSON.stringify(i)),$.ajax({type:"POST",cache:!1,url:"/Operator/SavePerformanceTracking",enctype:"multipart/form-data",data:r,processData:!1,contentType:!1,beforeSend:function(){isBusy=!0},success:function(n){isBusy=!1;n.result?($("#app-operator-performance-addedit").modal("hide"),location.reload(),cleanBookNotification.success(_L("UPDATE_MSG_SUCCESS"),"Operator")):!n.result&&n.msg&&cleanBookNotification.error(_L(n.msg),"Operator");LoadingOverlayEnd()},error:function(){isBusy=!1;LoadingOverlayEnd();cleanBookNotification.error(_L("ERROR_MSG_EXCEPTION_SYSTEM"),"Operator")}})):(cleanBookNotification.error(_L("ERROR_MSG_806"),"Operator"),LoadingOverlayEnd())):$("li a[href=#perf-1]").trigger("click");LoadingOverlayEnd()});$(".btnNext").click(function(){var n=$(this).closest(".modal");$(n).find(".admintabs .active").next("li").find("a").trigger("click")});$(".btnPrevious").click(function(){var n=$(this).closest(".modal");$(n).find(".admintabs .active").prev("li").find("a").trigger("click")});LoadingOverlayEnd()})}function getAllMeasureWithWeights(){var n=[];return $("#tblTrackingMeasures tbody tr").each(function(){var t=$(this).data("id"),i=$(this).data("weight");n.push({MeasureId:t,Weight:i})}),n}function initDateRange(){var n=$dateFormatByUser.toUpperCase();$("#txtCustomDate").daterangepicker({autoUpdateInput:!1,cancelClass:"btn-danger",opens:"right",locale:{cancelLabel:"Clear",format:n}});$("#txtCustomDate").on("apply.daterangepicker",function(t,i){$(this).val(i.startDate.format(n)+" - "+i.endDate.format(n));$(this).trigger("change")})}function LoadMedias(n){$.LoadingOverlay("show");var i=$("#mediaFolderId").val(),n=$("#qbicleId").val(),t=$("#sl-media-type").val();$.ajax({type:"post",url:"/Operator/LoadMedia",datatype:"json",data:{fid:i,qid:n,fileType:t=="All"?"":t,rs:""},success:function(n){if(n){var t=$("#performance-resources .flex-grid-thirds-lg");t.html(n);totop();LoadingOverlayEnd()}},error:function(n){cleanBookNotification.error(n.responseText,"Qbicles");LoadingOverlayEnd()}})}function initModalMedia(){var n=$("#form_media_smresource");n.validate({rules:{name:{required:!0,minlength:5},description:{required:!0}}});n.submit(function(t){if((t.preventDefault(),!isBusy)&&n.valid()){$.LoadingOverlay("show");var i=document.getElementById("performancetracking-resource-input").files;i.length>0?UploadMediaS3ClientSide("performancetracking-resource-input").then(function(t){if(t.objectKey==="no_image"||t.objectKey==="no-image"){LoadingOverlayEnd();cleanBookNotification.error(_L("ERROR_MSG_S3_UPLOAD"),"Qbicles");return}$("#performancetracking-resource-object-key").val(t.objectKey);$("#performancetracking-resource-object-name").val(t.fileName);$("#performancetracking-resource-object-size").val(t.fileSize);var i=new FormData(n[0]);$.ajax({type:"POST",cache:!1,url:"/Operator/SaveResource",enctype:"multipart/form-data",data:i,processData:!1,contentType:!1,beforeSend:function(){isBusy=!0},success:function(t){t.result?($("#create-resource").modal("hide"),isBusy=!1,LoadMedias($("#qbicleId").val()),cleanBookNotification.success(_L("ERROR_MSG_172"),"Operator"),n.trigger("reset")):t.msg&&(cleanBookNotification.error(t.msg,"Operator"),isBusy=!1);LoadingOverlayEnd()},error:function(){isBusy=!1;cleanBookNotification.error(_L("ERROR_MSG_EXCEPTION_SYSTEM"),"Operator");LoadingOverlayEnd()}})}):(LoadingOverlayEnd(),cleanBookNotification.error(_L("ERROR_MSG_154"),"Qbicles"))}})}function createDiscussion(){$("#frm-create-discussion").submit(function(n){n.preventDefault();$.LoadingOverlay("show");$.ajax({type:"post",url:"/Discussions/SaveDiscussionForPerformance",datatype:"json",data:{perfomanceId:$("#performanceTrackingId").val(),openingmessage:$("#ds_openingmessage").val(),isexpiry:$("#ds_isexpiry").prop("checked"),expirydate:$("#ds_expirydate").val()},beforeSend:function(){isBusy=!0},success:function(n){var t,i;n.result?($(".new-discuss").hide(),t=$("#btnJoinDiscussion"),n.Object.Id>0&&(i=t.attr("href")+"?disId="+n.Object.Id,t.attr("href",i),t.show()),cleanBookNotification.success(_L("ERROR_MSG_807"),"Operator"),$("#create-discussion").modal("hide")):n.msg&&cleanBookNotification.error(n.msg,"Operator");isBusy=!1;LoadingOverlayEnd()},error:function(){isBusy=!1;LoadingOverlayEnd()}})})}function LoadPerfomanceMeasures(){var t,n,i,r,u;if($(".text-timeframe").text($("#slTimeframe option:selected").text()),t=!0,$("#slTimeframe").val()=="2"){if($(".text-timeframe").text($("#txtCustomDate").val()),!$("#txtCustomDate").val())return;if(n=$("#txtCustomDate").data("daterangepicker"),i=n.startDate.add(12,"months").toDate(),n.endDate.toDate()>i){cleanBookNotification.error(_L("ERROR_MSG_706"),"Operator");return}r=n.startDate.add(31,"days").toDate();n.endDate.toDate()>r&&(t=!1)}u={performanceId:$("#performanceTrackingId").val(),timeframe:$("#slTimeframe").val(),customDate:$("#txtCustomDate").val(),isDay:t};$.ajax({type:"post",url:"/Operator/LoadPerfomanceMeasuresForChart",datatype:"json",data:u,success:function(n){n&&(animatestat(n.TotalProgressPerformance),n.ChartProcessMeasures&&$("#pagination-container").pagination({dataSource:n.ChartProcessMeasures,prevText:"<",nextText:">",pageSize:5,callback:function(n){var t=measuresTemplating(n);$(".records-h").html(t)}}),initChart(n.CharMonitorMeasures))},error:function(n){cleanBookNotification.error(n.responseText,"Qbicles")}}).always(function(){LoadingOverlayEnd()})}function animatestat(n){$("#performanceChartProcess").circleProgress({max:100,value:n,textFormat:"percent",animation:"easeInOutExpo",animationDuration:2600});animatedprogress()}function animatedprogress(){var n=500;$(".progress-bar").each(function(t){$(this).delay(n*t).animate({width:$(this).attr("aria-valuenow")+"%"},n)})}function initChart(n){var o;Chart.plugins.register({id:"paddingBelowLegends",beforeInit:function(n){n.legend.afterFit=function(){this.height=this.height+50}}});var t=document.getElementById("myChart").getContext("2d"),i=t.createLinearGradient(0,0,0,400),r=t.createLinearGradient(0,0,0,400);i.addColorStop(0,"#05e4b1");i.addColorStop(1,"#1dc7e6");r.addColorStop(0,"#05a8f4");r.addColorStop(1,"#049ef4");var f=[],e=[],u=[];$.each(n,function(t,o){o.key!="01/01"&&(f.push(o.key),e.push(o.processPercent),t!==n.length-1?u.push(r):u.push(i))});o=new Chart(t,{type:"line",data:{labels:f,datasets:[{label:"% progress towards Performace",data:e,backgroundColor:u,borderWidth:0}]},options:{legend:{display:!1},scales:{xAxes:[{gridLines:{color:"rgba(0, 0, 0, 0)"}}],yAxes:[{display:!0,ticks:{beginAtZero:!0,steps:10,stepValue:5,max:100}}]}}})}function measuresTemplating(n){var t="";return $.each(n,function(n,i){var r="started",u;for(i.Score==3?r="pending":i.Score<=2&&(r="overdue"),t+='<article class="'+r+'"><div class="record">',t+='<div class="col titleblock"><a href="#"> <p class="tasktitle" style="padding-left: 15px;">'+i.MeasureName+"<\/p><\/a><\/div>",t+='<div class="col text-right">',u=0;u<i.Score;u++)t+='<i class="fa fa-star yellow-text"><\/i>';t+="<\/div>";t+="<\/div><\/article>"}),t}function loadTabMeasuresContent(){var n,t,i,r;if($.LoadingOverlay("show"),$("#slTimeframe").val()=="2"){if(!$("#txtCustomDate").val())return;if(n=$("#txtCustomDate").data("daterangepicker"),t=n.startDate.add(12,"months").toDate(),n.endDate.toDate()>t){cleanBookNotification.error(_L("ERROR_MSG_706"),"Operator");return}i=n.startDate.add(31,"days").toDate();n.endDate.toDate()>i}r={performanceId:$("#performanceTrackingId").val(),timeframe:$("#slTimeframe").val(),customDate:$("#txtCustomDate").val(),search:$("#txtSearchMeasures").val()};$.ajax({type:"post",url:"/Operator/LoadTabPerformanceMeasures",datatype:"json",data:r,success:function(n){if(n){var t=$("#performance-measures");t.html(n);LoadingOverlayEnd()}},error:function(n){cleanBookNotification.error(n.responseText,"Qbicles");LoadingOverlayEnd()}})}function deletePerformanceMeasure(n){$.post("/Operator/DeletePerformanceMeasure",{id:n},function(t){t.result?$("#gm_"+n).remove():!t.result&&t.msg?cleanBookNotification.error(_L(t.msg),"Operator"):cleanBookNotification.error(_L("ERROR_MSG_EXCEPTION_SYSTEM"),"Operator")})}function ShowGroupMember(){$("#team-person-preview").load("/Operator/ShowListMemberForWorkGroup?performanceId="+$("#performanceId").val()+"&wgId="+$("#performanceWorkgroup").val())}function searchThrottle(n,t){var i=null;return function(){var r=this,u=arguments;clearTimeout(i);i=window.setTimeout(function(){n.apply(r,u)},t||800)}}var isBusy=!1;$(document).ready(function(){initModalMedia();createDiscussion();initDateRange();LoadPerfomanceMeasures();$("#slTimeframe").change(searchThrottle(function(){$(".text-timeframe").text($("#slTimeframe option:selected").text());$("#tabNavPerformance li.active a[data-target=#performance-overview]").length>0?LoadPerfomanceMeasures():loadTabMeasuresContent()}));$("#txtCustomDate").change(searchThrottle(function(){LoadPerfomanceMeasures()}));$("#txtSearchMeasures").keyup(searchThrottle(function(){loadTabMeasuresContent()}))});