function initMonibacManagePage(){loadConnectedBusinesses(!0);$("#business-keysearch").keyup(delay(function(){loadConnectedBusinesses(!1)},1e3));initPromotionFilterEvent();promotionsLoadMore();$("#moniback-get-code").on("hidden.bs.modal",function(){promotionsLoadMore();loadConnectedBusinesses(!1)})}function loadConnectedBusinesses(n){var r=$("#connected-businesses"),u=$("#business-keysearch").val(),t=$("#app-moniback-widget"),i;t.LoadingOverlay("show");n&&(businessTotalLoad+=10);i="/Monibac/ShowListConnectedBusiness?totalLoad="+businessTotalLoad+"&keysearch="+u;r.load(i);t.LoadingOverlay("hide")}function showBusinessContent(n){var i="/Monibac/GetMonibacInfor?contactKey="+n,t=$("#app-moniback-widget");t.LoadingOverlay("show");$("#store-detail").empty();$("#store-detail").load(i);leftSideShows("#store-detail");t.LoadingOverlay("hide")}function showPointExchangePartial(n){var r="/Monibac/ShowPointExchangePartialView?contactKey="+n,i=$("#app-moniback-widget"),t;i.LoadingOverlay("show");t=$("#point-exchange-detail");t.empty();t.load(r);leftSideShows("#point-exchange-detail");i.LoadingOverlay("hide")}function inputPointExchangeOnChange(){currencySetting||loadCurrencySettings();var r=$("#exchange-rate").val(),n=Number($("#point-balance").val()),t=Number($("#exchange-point").val());t>n&&($("#exchange-point").val(n),t=n);var i=Number(t*r),u=$("#credit-balance").val(),f=i+Number(u);$("#amount-after-exchange").text(currencySetting.CurrencySymbol+FormatNumber(f),currencySetting.CurrencySymbol);$("#credit-received").text("+"+FormatNumber(i),"")}function loadCurrencySettings(){$.ajax({url:"/Qbicles/GetCurrencySettingsByDomain",type:"get","async":!1,data:{domainId:$("#contact-domainid").val()},success:function(n){currencySetting=n?n:{currencyGroupSeparator:",",CurrencySymbol:"",SymbolDisplay:0,DecimalPlace:2}},error:function(){cleanBookNotification.error(_L("ERROR_MSG_EXCEPTION_SYSTEM"),"Qbicles")}})}function FormatNumber(n,t){return currencySetting||loadCurrencySettings(),t||(t=""),n=n?parseFloat(n.toString()):0,isNaN(n)&&(n=0),t+n.toFixed(currencySetting.DecimalPlace).replace(/(\d)(?=(\d{3})+\.)/g,"$1,")}function showAccountBalanceExchangePartial(n){var r="/Monibac/ShowAccountBalanceExchangePartialView?contactKey="+n,i=$("#app-moniback-widget"),t;i.LoadingOverlay("show");t=$("#point-exchange-detail");t.empty();t.load(r);leftSideShows("#point-exchange-detail");i.LoadingOverlay("hide")}function inputAccBalanceExchangeOnChange(){var n,t;currencySetting||loadCurrencySettings();n=Number($("#account-balance").val());t=Number($("#balance-exchange").val());t>n&&($("#balance-exchange").val(n),t=n);var i=Number(t),r=$("#credit-balance").val(),u=i+Number(r);$("#amount-after-exchange").text(currencySetting.CurrencySymbol+FormatNumber(u),currencySetting.CurrencySymbol);$("#credit-received").text("+"+FormatNumber(i),"")}function convertAccountBalanceToStoreCredit(n){var t=$("#app-moniback-widget"),i,r;t.LoadingOverlay("show");i=$("#balance-exchange").val();r="/Monibac/GenerateStoreCreditFromAccountBalance";$.ajax({method:"POST",dataType:"JSON",url:r,data:{contactKey:n,exchangeBalance:i},success:function(i){if(i.result){var r=i.Object;$("#pin-num").text(r);cleanBookNotification.updateSuccess();showAccountBalanceExchangePartial(n);t.LoadingOverlay("hide")}else cleanBookNotification.error(i.msg,"Qbicles"),t.LoadingOverlay("hide")},error:function(n){cleanBookNotification.error(n.msg);t.LoadingOverlay("hide")}})}function convertStorePointToStoreCredit(n){var t=$("#app-moniback-widget"),i,r;t.LoadingOverlay("show");i=$("#exchange-point").val();r="/Monibac/GenerateStoreCreditFromStorePoint";$.ajax({method:"POST",dataType:"JSON",url:r,data:{contactKey:n,exchangePoint:i},success:function(i){if(i.result){var r=i.Object;$("#pin-num").text(r);cleanBookNotification.updateSuccess();showPointExchangePartial(n);t.LoadingOverlay("hide")}else cleanBookNotification.error(i.msg,"Qbicles"),t.LoadingOverlay("hide")},error:function(n){cleanBookNotification.error(n.msg);t.LoadingOverlay("hide")}})}function generatePIN(){var n=$("#app-moniback-widget"),t;n.LoadingOverlay("show");t="/Monibac/GenerateStoreCreditPIN?createdReason=0";$.ajax({method:"POST",dataType:"JSON",url:t,success:function(t){if(t.result){var i=t.Object;$("#pin-num").text(i);cleanBookNotification.updateSuccess();n.LoadingOverlay("hide")}else cleanBookNotification.error(t.msg,"Qbicles"),n.LoadingOverlay("hide")},error:function(t){cleanBookNotification.error(t.msg,"Qbicles");n.LoadingOverlay("hide")}})}function promotionsLoadMore(){if(!isBusy){var n={keyword:$("#promotion-filters input[name=search]").val(),businessKey:$("#promotion-filters select[name=business]").val(),pageSize:promotionTotalLoad*promotionPagenumber,pageNumber:promotionPagenumber,isMyFavourites:$("#promotion-filters input[name=ismyfavourites]").prop("checked"),isLoadTotalRecord:!1,locationIds:$("#promotion-filters select[name=locations]").val()};promotionfirstLoad&&(n.isLoadTotalRecord=!0);n.locationIds||(n.locationIds=[]);$("#rewards").LoadingOverlay("show");$.ajax({url:"/Monibac/LoadPublishPromotions",data:{filterModel:n},type:"POST",beforeSend:function(){isBusy=!0},success:function(n){if(isBusy=!1,n){$("#content-promotion").append(n.htmlContent);promotionfirstLoad&&(promotionTotalRecords=n.totalRecords,promotionfirstLoad=!1);promotionTotalLoad=promotionTotalLoad+1;var t=promotionTotalRecords-promotionTotalLoad*promotionPagenumber;t<=0?$(".btn-loadmore").hide():$(".btn-loadmore").show();initCountDown()}$("#rewards").LoadingOverlay("hide",!0)},error:function(){isBusy=!1;$("#rewards").LoadingOverlay("hide",!0)}})}}function initPromotionFilterEvent(){$("#promotion-filters input[name=search]").keyup(delay(function(){resetPromotionLoad();promotionsLoadMore()},700));$("#promotion-filters select[name=business]").change(function(){resetPromotionLoad();loadLocationsByBusinessKey($(this).val())});$("#promotion-filters select[name=locations]").change(function(){clearTimeout(wto);wto=setTimeout(function(){resetPromotionLoad();promotionsLoadMore()},1e3)});$("#promotion-filters input[name=ismyfavourites]").change(function(){resetPromotionLoad();promotionsLoadMore()})}function loadLocationsByBusinessKey(n){n!="0"?($(".filter-local-box").show(),$.get("/Monibac/LoadLocationsByBusinessKey?businessKey="+n,function(n){$("#promotion-filters select[name=locations]").multiselect("dataprovider",n);promotionsLoadMore()})):($(".filter-local-box").hide(),$("#promotion-filters select[name=locations]").multiselect("dataprovider",[]),promotionsLoadMore())}function claimPromotion(n,t,i){$.post("/Monibac/ClaimPromotion",{promotionKey:n,businessKey:t},function(t){var r,u;t.result?(r=t.Object,r.canClaim==!1&&($("#button-claim-"+n).attr("disabled","disabled"),$("#button-claim-"+n).removeAttr("onclick")),u=parseInt($("#vouchers-valid-"+i).text())+1,$("#vouchers-valid-"+i).text(u),$("#moniback-get-code").modal("show"),$(".promotion-name").text(r.promoname),$(".promotion-code-received").text(r.promoreceived),$(".promotion-code").val(r.code),$(".promotion-locations").text(r.promolocations),$(".promotion-maxvoucher").text(r.promolimitvoucherpercus),$("#widget-codes-detail:visible").length>0&&searchVouchers(!0)):!t.result&&t.msg?cleanBookNotification.error(_L(t.msg),"Moniback"):cleanBookNotification.error(_L("ERROR_MSG_EXCEPTION_SYSTEM"),"Moniback")})}function setLikingUser(n,t,i){$.post("/Monibac/SetLikingUser",{promotionKey:t,IsLiked:i},function(r){r.result?i?($(n).addClass("red"),$(n).attr("onclick","setLikingUser(this,'"+t+"',"+!i+")")):($(n).removeClass("red"),$(n).attr("onclick","setLikingUser(this,'"+t+"',"+!i+")")):!r.result&&r.msg?cleanBookNotification.error(_L(r.msg),"Monibac"):cleanBookNotification.error(_L("ERROR_MSG_EXCEPTION_SYSTEM"),"Monibac")})}function markLikePromotion(n,t,i){isSettingIsLike!=!0&&(isSettingIsLike=!0,$.post("/Monibac/MarkLikePromotion",{promotionKey:t,IsLiked:i},function(r){isSettingIsLike=!1;var u=$(n).closest(".post-options").find(".liked-count").text();r.result?i?($(n).removeClass("fa fa-heart-o"),$(n).addClass("fa fa-heart"),$(n).attr("onclick","markLikePromotion(this,'"+t+"',"+!i+")"),$(n).closest(".post-options").find(".liked-count").text(Number(u)+1)):($(n).removeClass("fa fa-heart"),$(n).addClass("fa fa-heart-o"),$(n).attr("onclick","markLikePromotion(this,'"+t+"',"+!i+")"),$(n).closest(".post-options").find(".liked-count").text(Number(u)-1)):!r.result&&r.msg?cleanBookNotification.error(_L(r.msg),"Monibac"):cleanBookNotification.error(_L("ERROR_MSG_EXCEPTION_SYSTEM"),"Monibac")}))}function resetPromotionLoad(){promotionfirstLoad=!0;promotionTotalLoad=0;$("#content-promotion").empty()}function copyToClipboard(n){var t=$("<input>");$("body").append(t);t.val(n).select();document.execCommand("copy");t.remove()}function initCountDown(){$(".promotion-countdown").each(function(){var n=$(this),t=new Date(n.data("timestamp"));n.countdown(t,function(n){var t="";n.offset.totalDays>0&&(t="%-Dd, ");$(this).text(n.strftime(t+"%-Hh, %-Mm, %Ss remaining"))}).on("finish.countdown",function(){var n=$(this).parents(".deal-promo").find("button");n.length>0&&n.attr("disabled",!0);$(this).parent().html('<span style="top:0;">Offer expired<\/span>')})})}function showWidgetCodes(n){var i="/Monibac/ShowWidgetCodesPartialView?businessKey="+n,t=$("#app-moniback-widget");t.LoadingOverlay("show");$("#widget-codes-detail").empty();$("#widget-codes-detail").load(i,function(){leftSideShows("#widget-codes-detail");searchVouchers(!0);initVoucherFilterEvent();t.LoadingOverlay("hide")})}function initVoucherFilterEvent(){$("#widget-codes-detail input[name=search]").keyup(delay(function(){searchVouchers(!0)},700));$("#widget-codes-detail input[name=Redeemed]").change(function(){searchVouchers(!0)});$("#widget-codes-detail input[name=Expired]").change(function(){searchVouchers(!0)});$('#widget-codes-detail input[data-toggle="toggle"]').bootstrapToggle()}function showVoucherItemMore(n){var i="/Monibac/GetVoucherItemMore?voucherKey="+n,t=$("#voucher-item-more");t.empty();t.modal("show");t.load(i,function(){initCountDown()})}function removeVoucher(n,t){$.post("/Monibac/RemoveVoucher",{voucherKey:n},function(n){n.result?($(t).parent().parent().parent().remove(),cleanBookNotification.success(_L("UPDATE_MSG_SUCCESS"),"Moniback")):!n.result&&n.msg?cleanBookNotification.error(_L(n.msg),"Moniback"):cleanBookNotification.error(_L("ERROR_MSG_EXCEPTION_SYSTEM"),"Moniback")})}function searchVouchers(n){n&&($("#mobiback-left-sidebar").scrollTop(0),loadCountVourcher=0);setTimeout(function(){loadMoreVourchers(n)},200)}function loadMoreVourchers(n){var t,i;isBusy||(t={isRedeemed:$("#widget-codes-detail input[name=Redeemed]").prop("checked"),isExpired:$("#widget-codes-detail input[name=Expired]").prop("checked"),domainkey:$("#hdfDomainKey").val(),keyword:$("#widget-codes-detail input[name=search]").val(),pageSize:loadCountVourcher*vourcherPagenumber,pageNumber:vourcherPagenumber,isCountRecords:!1},n&&(loadCountVourcher=0,t.isCountRecords=!0),i="/Monibac/GetVouchersByUserAndShop",$.ajax({url:i,data:{filterModel:t},type:"POST","async":!1,beforeSend:function(){isBusy=!0},success:function(i){if(isBusy=!1,i){n&&$(".voucherlist").empty();$(".voucherlist").append(i.htmlContent);t.isCountRecords&&(vourcherTotalRecords=i.totalRecords);loadCountVourcher=loadCountVourcher+1;var r=loadCountVourcher*vourcherPagenumber,u=vourcherTotalRecords-r;u<=0?(previousShown=!0,$("#more-voucher-btn").addClass("hidden")):(previousShown=!1,$("#more-voucher-btn").removeClass("hidden"));$(".pager-info").html("Showing <strong>1-"+(u<=0?vourcherTotalRecords:r)+"<\/strong> of <strong>"+vourcherTotalRecords+"<\/strong>")}},error:function(){isBusy=!1}}))}function leftSideShows(n){$(".widget-content").hide();$(n).fadeIn()}function ShowSharingPromotionPartialView(n){LoadingOverlay();$("#share-content").empty();$("#share-content").load("/Monibac/PromotionSharePartialView",{promotionKey:n});$("#share-content").modal("show");LoadingOverlayEnd()}function SharePromotion(n){var r=$("#shared-promotion-key").val(),t=[],i="";n==1?$(".selected-contact").each(function(){t.push($(this).attr("userid"))}):n==2&&(i=$("input[name=new-member]").val());LoadingOverlay();$.ajax({method:"POST",dataType:"JSON",url:"/Monibac/SharePromotion",data:{type:n,email:i,sharedUserIds:JSON.stringify(t),promotionKey:r},success:function(n){n.result?(cleanBookNotification.success("This promotion has been successfully shared with your chosen contacts","Qbicles"),$("#share-content").modal("hide")):cleanBookNotification.error(n.msg,"Qbicles")},error:function(){cleanBookNotification.error("There was a problem sharing this promotion. Please try again","Qbicles")}}).done(function(){LoadingOverlayEnd()})}var businessTotalLoad=0,promotionTotalRecords=0,promotionTotalLoad=0,promotionfirstLoad=!0,promotionPagenumber=6,loadCountVourcher=0,vourcherPagenumber=4,vourcherTotalRecords=0,previousShown=!1,currencySetting,isBusy=!1,wto,isSettingLikingUser=!1,isSettingIsLike=!1;