function UpdateStatusApproval(n){$.LoadingOverlay("show");$.ajax({url:"/Qbicles/SetRequestStatusForApprovalRequest",type:"GET",dataType:"json",data:{appKey:n,status:$("#action_approval").val()},success:function(n){n.actionVal>0&&(LoadingOverlayEnd(),cleanBookNotification.updateSuccess(),setTimeout(function(){window.location.reload(!0)},500))},error:function(){LoadingOverlayEnd();cleanBookNotification.error(_L("ERROR_MSG_EXCEPTION_SYSTEM"),"Qbicles")}})}function ChangeContact(n){$.LoadingOverlay("show");$("#purchase-review-contact").empty();$("#purchase-review-contact").load("/TraderPurchases/TraderPurchaseReviewContact?id="+n);setTimeout(function(){LoadingOverlayEnd();$("#app-trader-purchase-contact").modal("toggle")},500)}function changeDelivery(){$("#contact_address_id").val(0);$(".delivery-stored").hide();$(".delivery-details").fadeIn()}function OnChangeDelivery(){$("#purchases_delivery").val()==="Delivery"?$(".delivery-stored").fadeIn():$(".delivery-stored").hide()}function SelectContactChange(n){$(n).val()!==""&&$.ajax({type:"get",url:"/TraderPurchases/GetContactById?id="+$(n).val(),dataType:"json",success:function(n){var t=n.Name+",<\/br>";n.Address&&(n.Address.AddressLine1&&(t+=",<\/br>"+n.Address.AddressLine1),n.Address.City&&(t+=",<\/br>"+n.Address.City),n.Address.AddressLine2&&(t+=",<\/br>"+n.Address.AddressLine2),n.Address.State&&(t+=",<\/br>"+n.Address.State),n.Address.Country&&(t+=",<\/br>"+n.Address.Country.CommonName),n.Address.PostCode&&(t+=",<\/br>"+n.Address.PostCode));$("#address_info").empty();$("#address_info").append(t)},error:function(){cleanBookNotification.error(_L("ERROR_MSG_EXCEPTION_SYSTEM"),"Qbicles")}})}function UpdateContact(){$.LoadingOverlay("show");var n={Id:$traderPurchaseId,DeliveryMethod:$("#purchases_delivery").val(),Vendor:{Id:$("#form_purchase_contact").val()}};$.ajax({type:"post",url:"/TraderPurchases/UpdateTraderPurchaseContact?countryName="+$("#form_contact_address_country").val(),data:{traderPurchase:n},dataType:"json",success:function(n){n.actionVal===1&&($("#purchase-review-contact-preview").empty(),$("#purchase-review-contact-preview").load("/TraderPurchases/TraderPurchaseReviewContactPreview?id="+$traderPurchaseId));setTimeout(function(){$("#app-trader-purchase-contact").modal("hide");LoadingOverlayEnd()},500)},error:function(){LoadingOverlayEnd();cleanBookNotification.error(_L("ERROR_MSG_EXCEPTION_SYSTEM"),"Qbicles")}})}function ChangeItems(n){$.LoadingOverlay("show");CheckStatus(n,"Purchase").then(function(t){LoadingOverlayEnd();t.result&&t.Object!=="PurchaseApproved"?($.LoadingOverlay("show"),$("#purchase-review-items").empty(),$("#purchase-review-items").load("/TraderPurchases/TraderPurchaseReviewItems?id="+n,function(){LoadingOverlayEnd();$("#purchase-review-items-modal").modal("toggle");var n=$("#purchase-item-workgroup-id").val(),t=$("#purchase-item-location-id").val();ResetItemSelected("tb_form_item","item-select-manage",undefined,n,t,!1,!1,!0)})):t.result&&t.Object==="PurchaseApproved"?(cleanBookNotification.error(_L("ERROR_MSG_272"),"Qbicles"),setTimeout(function(){window.location.reload()},1e3)):t.result===!1&&cleanBookNotification.error(_L("ERROR_MSG_380",[t.msg]),"Qbicles")})}function addRowItem(){var o=UniqueId(),u=$("#form_item_dimensions").val(),n,e;u||(u=[]);var s=$("#item_selected select").val(),r=$("#item-select-manage").find(":selected"),i=r.attr("itemId"),h=r.attr("itemName"),c=r.attr("itemImage"),l=r.attr("taxName"),a=r.attr("taxRate"),v=r.attr("costUnit"),t={Id:o,TraderItem:{Id:i,TaxName:l,ImageUri:c,Name:h,TaxRate:a,CostUnit:v},Discount:isNaN(parseFloat($("#form_item_discount").val()))?0:parseFloat($("#form_item_discount").val()),Dimensions:[],Quantity:parseFloat($("#form_item_quantity").val()),Unit:{},CostPerUnit:parseFloat($("#cpu").val()),Cost:0},f=parseFloat(t.CostPerUnit)*parseFloat(t.Quantity)*(1-parseFloat(t.Discount)/100)*(1+parseFloat(t.TraderItem.TaxRate)/100),y=f/(1+t.TraderItem.TaxRate/100),p=parseFloat(f-y).toFixed($decimalPlace);t.Cost=f.toFixed($decimalPlace);n=$("#tb_form_template tbody tr").clone();$(n).addClass("tr_id_"+i);$($(n).find("td.row_image div")).attr("style","background-image: url('"+$("#api_url").val()+t.TraderItem.ImageUri+"&size=T');");$($(n).find("td.row_name")).text(t.TraderItem.Name);$($(n).find("td.row_unit")).empty();e=$("#item_selected select").clone();$($(n).find("td.row_unit")).append(e);$($(n).find("td.row_unit select")).val(s);$($(n).find("td.row_unit select")).attr("onchange","rowUnitChange('"+i+"')");$($(n).find("td.row_costperunit input")).val(t.CostPerUnit);$($(n).find("td.row_costperunit input")).attr("onchange","updateCost('"+i+"')");$($(n).find("td.row_quantity input")).val(t.Quantity);$($(n).find("td.row_quantity input")).attr("onchange","updateCost('"+i+"')");$($(n).find("td.row_discount input")).val(t.Discount);$($(n).find("td.row_discount input")).attr("onchange","updateCost('"+i+"')");$($(n).find("td.row_taxrate")).text(t.TraderItem.TaxRate);$($(n).find("td.row_taxname")).html(showTaxRatesDetail(t.CostPerUnit,t.Quantity,t.Discount,t.TraderItem.TaxName));$($(n).find("td.row_dimensions select")).val(u);$($(n).find("td.row_cost input")).val(t.Cost).attr("onchange","updateTotalReviewItemCost("+i+")");$($(n).find("td.row_button button")).attr("onclick","removeRowItem('"+i+"')");$($(n).find("td.row_button input.traderItem")).val(i);$($(n).find("td.row_button input.row_id")).val(i);$($(n).find("td select")).not(".multi-select").select2();$("#tb_form_item tbody").append(n);setTimeout(function(){$("#form_add_transaction")[0].reset();$("#form_add_transaction select").not(".multi-select").select2();resetPurchaseForm()},100);setTimeout(function(){var n=$("#purchase-item-workgroup-id").val(),t=$("#purchase-item-location-id").val();ResetItemSelected("tb_form_item","item-select-manage",undefined,n,t,!1,!1,!0)},200)}function updateTotalReviewItemCost(n){var t=parseFloat($("#tb_form_item tbody tr.tr_id_"+n+" .row_quantity input").val()),i=isNaN(parseFloat($("#tb_form_item tbody tr.tr_id_"+n+" .row_discount input").val()))?0:parseFloat($("#tb_form_item tbody tr.tr_id_"+n+" .row_discount input").val()),u=parseFloat($("#tb_form_item tbody tr.tr_id_"+n+" .row_taxrate").text()),e=$("#tb_form_item tbody tr.tr_id_"+n+" .row_taxname .txt-taxname").val(),f=parseFloat($("#tb_form_item tbody tr.tr_id_"+n+" .row_cost input").val()),r;isNaN(t)||isNaN(i)||isNaN(f)||t==0||i==100||u==-100||(r=parseFloat(f/(t*(1-i/100)*(1+u/100))).toFixed(5),$("#tb_form_item tbody tr.tr_id_"+n+" .row_costperunit input").val(r),$("#tb_form_item tbody tr.tr_id_"+n+" .row_taxname").html(showTaxRatesDetail(r,t,i,e)))}function rowUnitChange(n){var i=$("#tb_form_item tbody tr.tr_id_"+n+" td.row_button input.traderItem").val().split(":"),t=$("#tb_form_item tbody tr.tr_id_"+n+" td.row_unit select").val().split(":");t[1]==="BaseUnit"?$("#tb_form_item tbody tr.tr_id_"+n+" td.row_costperunit input").val(i[3]):t[1]==="Conversion Unit"&&$("#tb_form_item tbody tr.tr_id_"+n+" td.row_costperunit input").val(parseFloat(i[3])*parseFloat(t[3]));updateCost(n)}function updateCost(n){var t=$("#tb_form_item tbody tr.tr_id_"+n+" td.row_costperunit input").val(),i=$("#tb_form_item tbody tr.tr_id_"+n+" td.row_quantity input").val(),r=$("#tb_form_item tbody tr.tr_id_"+n+" td.row_discount input").val(),u=$("#tb_form_item tbody tr.tr_id_"+n+" td.row_taxrate").text(),f,e;isNaN(parseFloat(t))||isNaN(parseFloat(i))||isNaN(parseFloat(r))||isNaN(parseFloat(u))||(f=parseFloat(t)*parseFloat(i)*(1-parseFloat(r)/100)*(1+parseFloat(u)/100),$("#tb_form_item tbody tr.tr_id_"+n+" td.row_cost input").val(f.toFixed($decimalPlace)),e=$("#tb_form_item tbody tr.tr_id_"+n+" td.row_taxname input.txt-taxname").val(),$("#tb_form_item tbody tr.tr_id_"+n+" td.row_taxname").html(showTaxRatesDetail(t,i,r,e)))}function removeRowItem(n){$("#tb_form_item tbody tr.tr_id_"+n).remove();var t=$("#purchase-item-workgroup-id").val(),i=$("#purchase-item-location-id").val();ResetItemSelected("tb_form_item","item-select-manage",undefined,t,i,!1,!1,!0)}function UpdateItems(){$.LoadingOverlay("show");CheckStatus($traderPurchaseId,"Purchase").then(function(n){var s,t,i,u,h,f,r,e,o,l,a,c;if(LoadingOverlayEnd(),n.result&&n.Object!=="PurchaseApproved"){if($.LoadingOverlay("show"),s=[],t=$("#tb_form_item tbody tr"),t.length>0)for(i=0;i<t.length;i++){if(u=$($(t[i]).find("td.row_quantity input")).val(),parseFloat(u).toString()==="NaN")return LoadingOverlayEnd(),cleanBookNotification.error(_L("ERROR_MSG_636"),"Qbicles"),!1;if(parseFloat(u)<=0)return LoadingOverlayEnd(),cleanBookNotification.error(_L("ERROR_MSG_637"),"Qbicles"),!1;if(h=parseInt($($(t[i]).find("td.row_button input.row_id")).val()),f={Id:0},$($(t[i]).find("td.row_button input.traderItem")).val()!==null?f.Id=$($(t[i]).find("td.row_button input.traderItem")).val():f=null,r=$($(t[i]).find("td.row_dimensions select")).val(),e=[],r&&r.length>0)for(o=0;o<r.length;o++)e.push({Id:r[o]});if(e.length===0)return LoadingOverlayEnd(),cleanBookNotification.error(_L("ERROR_MSG_635"),"Qbicles"),!1;l=$($(t[i]).find("td.row_unit select")).val().split("|");a={Id:isNaN(h)?0:h,TraderItem:f,Discount:stringToNumber($($(t[i]).find("td.row_discount input")).val()),Dimensions:e,Quantity:stringToNumber(u),Unit:{Id:l[1]},CostPerUnit:stringToNumber($($(t[i]).find("td.row_costperunit input")).val()),Cost:stringToNumber($($(t[i]).find("td.row_cost input")).val())};s.push(a)}c={Id:$traderPurchaseId,PurchaseItems:s,PurchaseTotal:PurchaseTotal()};$.ajax({type:"post",url:"/TraderPurchases/UpdateTraderPurchaseItems",data:{traderPurchase:c},dataType:"json",success:function(n){n.actionVal===1?($("#table-purchase-review-items-preview").empty(),$("#table-purchase-review-items-preview").load("/TraderPurchases/TraderPurchaseReviewItemsPreview?id="+$traderPurchaseId,function(){LoadingOverlayEnd()}),$("#purchase-total").text(toCurrencySymbol(c.PurchaseTotal,!1)),$("#purchase-review-items-modal").modal("hide")):n.actionVal===3&&cleanBookNotification.error(n.msg,"Qbicles")},error:function(){LoadingOverlayEnd();cleanBookNotification.error(_L("ERROR_MSG_EXCEPTION_SYSTEM"),"Qbicles")}})}else n.result&&n.Object==="PurchaseApproved"?(cleanBookNotification.error(_L("ERROR_MSG_272"),"Qbicles"),setTimeout(function(){window.location.reload()},1e3)):n.result===!1&&cleanBookNotification.error(_L("ERROR_MSG_380",[n.msg]),"Qbicles");LoadingOverlayEnd()})}function ShowGroupMember(){$("#app-trader-workgroup-preview").empty();$("#app-trader-workgroup-preview").load("/TraderTransfers/ShowListMemberForWorkGroup?wgId="+$("#transfer-workgroup-select").val())}function InitTransfer(n){$("#app-trader-purchase-transfer").empty();$("#app-trader-purchase-transfer").load("/TraderTransfers/InitPurchaseTransfer?key="+n)}function WorkGroupSelectedChange(){$(".preview-workgroup").show();var n=$("#transfer-workgroup-select").val();n&&n!==""?($.LoadingOverlay("show"),$("#transfer-workgroup-select + label.error").remove(),$.ajax({type:"get",url:"/TraderTransfers/getworkgroup?id="+n,dataType:"json",success:function(n){LoadingOverlayEnd();n.result?($(".preview-workgroup table tr td.location_name").text(n.Object.Location),$(".preview-workgroup table tr td.workgroup_process").text(n.Object.Process),$(".preview-workgroup table tr td.workgroup_qbicle").text(n.Object.Qbicle),$(".preview-workgroup table tr td.workgroup_member span").text(n.Object.Members)):($(".preview-workgroup table tr td.location_name").text(""),$(".preview-workgroup table tr td.workgroup_process").text(""),$(".preview-workgroup table tr td.workgroup_qbicle").text(""),$(".preview-workgroup table tr td.workgroup_member span").text(""))},error:function(n){LoadingOverlayEnd();cleanBookNotification.error("Have an error, detail: "+n.error,"Qbicles")}})):(LoadingOverlayEnd(),$(".preview-workgroup table tr td.location_name").text(""),$(".preview-workgroup table tr td.workgroup_process").text(""),$(".preview-workgroup table tr td.workgroup_qbicle").text(""),$(".preview-workgroup table tr td.workgroup_member span").text(""))}function SendToPickup(n){var r={Id:$("#transfer-workgroup-select").val()},t,f,e;if(r.Id===""||r.Id===null)return cleanBookNotification.error(_L("ERROR_MSG_168"),"Qbicles"),!1;var o={Id:$("#purchase-reference_id").val(),NumericPart:parseFloat($("#purchase-refedit").text()),Type:$("#purchase-reference_type").val(),Prefix:$("#purchase-reference_prefix").val(),Suffix:$("#purchase-reference_suffix").val(),Delimeter:$("#purchase-reference_delimeter").val(),FullRef:$("#purchase-reference_fullref").val()},u={Id:0,Status:n,Purchase:{Id:$("#TraderPurchaseId").val()},TransferItems:[],Workgroup:r,Reference:o},i=$("#transfer_purchase_table tbody tr"),s=$("#transfer_purchase_table tbody tr td");if(i.length>0&&s.length>1)for(t=0;t<i.length;t++)f=$($(i[t]).find("select.transfer_td_tran_unit")).val().split("|"),e={Id:$($(i[t]).find("input.transfer_td_id")).val(),TraderItem:{Id:$($(i[t]).find("input.purchaseitem_td_traderitem_id")).val()},Unit:{Id:f[1]},QuantityAtPickup:$($(i[t]).find("td.transfer_td_tran_quan input")).val(),TransactionItem:{Id:$($(i[t]).find("input.purchaseitem_td_id")).val()}},u.TransferItems.push(e);$.LoadingOverlay("show");$.ajax({type:"post",url:"/TraderTransfers/SaveTransfer",data:{transfer:u},dataType:"json",success:function(){$("#app-trader-purchase-transfer").modal("toggle");LoadingOverlayEnd();$("#app-trader-purchase-transfer").modal("hide");cleanBookNotification.createSuccess();reloadTableTransfer()},error:function(){LoadingOverlayEnd();cleanBookNotification.error(_L("ERROR_MSG_EXCEPTION_SYSTEM"),"Qbicles")}})}function resetPurchaseForm(){$("#cpu").attr("disabled","true");$("#addNowForm").attr("disabled",!0)}function ChangeSelectedUnit(){$.LoadingOverlay("show");$("#item_selected").empty();var n=$("#location-id").val(),t=$("#item-select-manage").find(":selected").attr("itemId");$("#item_selected").load("/Trader/TraderSaleSelectUnit?idLocation="+n+"&idTraderItem="+t,function(){LoadingOverlayEnd();$("#item-select-manage").val()!==""&&$("#item-select-manage").val()!=="0"&&($("#label_cost").text("Cost per <selected unit>"),$("#cpu").removeAttr("disabled"))})}function selectedUnit(n){var t=$(n);t?$("#label_cost").text("Cost per "+$(t.find("option:selected")).text()):$("#label_cost").text("Cost per <selected unit>")}function quantityChange(){var n=$("#form_item_quantity").val(),t=$("#cpu").val(),i=$("#conversionsunitid").val(),r=$("#form_item_discount").val();parseFloat(n).toString()!=="NaN"&&parseFloat(r)>100&&$("#form_item_discount").val(100);parseFloat(n).toString()!=="NaN"&&parseFloat(n)>0&&parseFloat(t).toString()!=="NaN"&&parseFloat(t)>0&&i!=""?$("#addNowForm").removeAttr("disabled"):$("#addNowForm").attr("disabled","true")}function SavePurchaseTransfer(n){var r={Id:$("#transfer-workgroup-select").val()},t,f,e;if(r.Id===""||r.Id===null)return cleanBookNotification.error(_L("ERROR_MSG_168"),"Qbicles"),!1;var o={Id:$("#purchase-reference_id").val(),NumericPart:parseFloat($("#purchase-refedit").text()),Type:$("#purchase-reference_type").val(),Prefix:$("#purchase-reference_prefix").val(),Suffix:$("#purchase-reference_suffix").val(),Delimeter:$("#purchase-reference_delimeter").val(),FullRef:$("#purchase-reference_fullref").val()},u={Id:$("#transfer_model_id").val(),Status:n,Purchase:{Id:$("#purchase_model_id").val()},TransferItems:[],Workgroup:r,Reference:o},i=$("#transfer_purchase_table tbody tr"),s=$("#transfer_purchase_table tbody tr td");if(i.length>0&&s.length>1)for(t=0;t<i.length;t++)f=$($(i[t]).find("select.transfer_td_tran_unit")).val().split("|"),e={Id:$($(i[t]).find("input.transfer_td_id")).val(),TraderItem:{Id:$($(i[t]).find("input.transfer_td_traderitem_id")).val()},Unit:{Id:f[1]},QuantityAtPickup:$($(i[t]).find("td.transfer_td_tran_quan input")).val(),TransactionItem:{Id:$($(i[t]).find("input.purchaseitem_td_id")).val()}},u.TransferItems.push(e);$.LoadingOverlay("show");$.ajax({type:"post",url:"/TraderTransfers/SaveTransfer",data:{transfer:u},dataType:"json",success:function(n){$("#app-trader-purchase-transfer").modal("toggle");LoadingOverlayEnd();n.actionVal===2&&($("#app-trader-purchase-transfer").modal("hide"),cleanBookNotification.updateSuccess(),reloadTableTransfer())},error:function(){LoadingOverlayEnd();cleanBookNotification.error(_L("ERROR_MSG_EXCEPTION_SYSTEM"),"Qbicles")}})}function reloadTableTransfer(){$("#table_transfer").empty();$("#table_transfer").load("/TraderTransfers/GetTablePurchaseTransfer?id="+$("#TraderPurchaseId").val())}function EditTransfer(n,t){$("#app-trader-purchase-transfer").empty();$("#app-trader-purchase-transfer").load("/TraderTransfers/EditPurchaseTransfer?id="+n+"&idPurchase="+t)}function ClearText(){$("#purchase-order-additions").val("")}function SavePurchaseOrder(n){$.LoadingOverlay("show");var t={Id:$("#reference_id").val(),NumericPart:parseFloat($("#refedit").text()),Type:$("#reference_type").val(),Prefix:$("#reference_prefix").val(),Suffix:$("#reference_suffix").val(),Delimeter:$("#reference_delimeter").val(),FullRef:$("#reference_fullref").val()},i={Purchase:{Id:n},AdditionalInformation:$("#purchase-order-additions").val(),Reference:t};$.ajax({type:"post",url:"/TraderPurchases/SavePurchaseOrder",datatype:"json",data:i,success:function(n){LoadingOverlayEnd();n.result&&(cleanBookNotification.createSuccess(),setTimeout(function(){window.location.href="/TraderPurchases/PurchaseOrder?id="+n.msgId},1e3))},error:function(n){LoadingOverlayEnd();cleanBookNotification.error(n.responseText,"Qbicles")}})}function loadBills(n){$("#table_bills").load("/TraderPurchases/ShowTableBillByPurchase?id="+n)}function AddEditTraderPurchaseBill(n,t){$.LoadingOverlay("show");$traderBillAttachmentExisted={AssociatedFiles:[]};$traderBillAttachments=[];$("#app-trader-bill-add").load("/TraderPurchases/AddEditTraderPurchaseBill?id="+n+"&purchaseId="+t,function(){initTableBill(t);LoadingOverlayEnd()})}function initTableBill(n){var t=$("table.purchase_item_table").DataTable({ajax:"/TraderPurchases/GetInvoiceItemsFromPurchase?purchaseId="+n,columns:[{data:"InvoiceChecked",orderable:!1,render:function(n){return'<div class="checkbox toggle"><label><input class="rowmask invoice_checked trackChecked" data-toggle="toggle" data-onstyle="success" data-on="True" data-off="False" type="checkbox" '+(n?"checked":"")+"><\/label><\/div>"}},{data:"TransItemUri",orderable:!1,render:function(n){return'<div class="table-avatar" style="background-image: url(\''+n+"');\"><\/div>"}},{data:"TransItemName"},{data:"TransItemUnitName"},{data:"TransItemQuantity"},{data:"TransItemDiscount"},{data:"TransItemHtmlTaxRates"},{data:"TransItemCost"},{data:"InvoiceQuantity",render:function(n,t,i){return'<input id="ivQuantityVal-'+i.TransItemId+'" type="text" onkeypress="numberKeyPress(event)" value="'+toCurrencyDecimalPlace(n)+'" name="invqty" min="0" maxlength="15" class="form-control invoice_quantity trackQuantity isnumber" style="width: 110px;">'}},{data:"InvoiceTaxes",render:function(n,t,i){return'<span id="ivTaxesVal-'+i.TransItemId+'">'+toCurrencyDecimalPlace(n)+"<\/span>"}},{data:"InvoiceDiscount",render:function(n,t,i){return'<span id="ivDiscountVal-'+i.TransItemId+'">'+toCurrencyDecimalPlace(n)+"<\/span>"}},{data:"InvoiceCost",render:function(n,t,i){return'<span id="ivCostVal-'+i.TransItemId+'">'+toCurrencyDecimalPlace(n)+"<\/span>"}}],drawCallback:function(){$(".trackChecked").on("change",function(){var n=$(this).parents("tr"),t=$("table.purchase_item_table").DataTable().row(n).data();t.InvoiceChecked=$(this).prop("checked")?!0:!1});$(".trackQuantity").on("change",function(){var t=$(this).parents("tr"),u=$("table.purchase_item_table").DataTable().row(t),n=u.data();let r=$(this).val().replace(/\,/g,"");n.InvoiceQuantity=parseFloat(r?r:0);n.InvoiceQuantity>n.TransItemQuantity&&(n.InvoiceQuantity=n.TransItemQuantity,$("#ivQuantityVal-"+n.TransItemId).val(toCurrencyDecimalPlace(n.InvoiceQuantity)));let i=n.PricePerUnit*n.InvoiceQuantity;n.InvoiceDiscount=i*(n.TransItemDiscount/100);n.InvoiceTaxes=(i-n.InvoiceDiscount)*n.TransItemSumValTaxRates;n.InvoiceCost=i*(1-n.TransItemDiscount/100)*(1+n.TransItemSumValTaxRates);$(t).LoadingOverlay("show");$("#ivTaxesVal-"+n.TransItemId).text(toCurrencyDecimalPlace(n.InvoiceTaxes));$("#ivDiscountVal-"+n.TransItemId).text(toCurrencyDecimalPlace(n.InvoiceDiscount));$("#ivCostVal-"+n.TransItemId).text(toCurrencyDecimalPlace(n.InvoiceCost));$(t).LoadingOverlay("hide")})}});t.on("draw.dt",function(){$(".invoice_checked").bootstrapToggle();$(".trackQuantity ").change()})}function SaveBill(n){var i,r;if($.LoadingOverlay("show"),i={Id:$("#transfer-workgroup-select").val()},i.Id===""||i.Id===null)return $("#form_bill_addedit").validate().showErrors({workgroup:"Workgroup is required."}),$('a[href="#setup"]').tab("show"),LoadingOverlayEnd(),!1;r={};r={Id:$("#app-trader-bill-add  #reference_id").val(),NumericPart:parseFloat($("#app-trader-bill-add  #refedit").text()),Type:$("#app-trader-bill-add  #reference_type").val(),Prefix:$("#app-trader-bill-add  #reference_prefix").val(),Suffix:$("#app-trader-bill-add  #reference_suffix").val(),Delimeter:$("#app-trader-bill-add  #reference_delimeter").val(),FullRef:$("#app-trader-bill-add  #reference_fullref").val()};var u=moment($("#bill_date").val(),$dateFormatByUser.toUpperCase()),f=moment(u).format("YYYY/MM/DD"),t={Id:$("#bill_id").val(),DueDate:f,InvoicePDF:"",Reference:r,PaymentDetails:$("#bill_notes").val(),Workgroup:i,Purchase:{Id:$("#bill_purchase").val()},Status:n,InvoiceItems:[]},e=$("table.purchase_item_table").DataTable();e.rows().every(function(){const n=this.data();if(n.InvoiceChecked){var i={Id:0,TransactionItem:{Id:n.TransItemId},InvoiceValue:n.InvoiceCost,InvoiceDiscountValue:n.InvoiceDiscount,InvoiceItemQuantity:n.InvoiceQuantity,InvoiceTaxValue:n.InvoiceTaxes};i.InvoiceValue&&i.InvoiceValue!==""||(i.InvoiceValue=0);t.InvoiceItems.push(i)}});$("#bill_upload_file").val()!==""?UploadMediaS3ClientSide("bill_upload_file").then(function(n){t.InvoicePDF=n.objectKey;$("#bill_invoicePDF").val(n.objectKey);BillProcessMedia(t)}):(t.InvoicePDF=$("#bill_invoicePDF").val(),BillProcessMedia(t))}function PurchaseBillAttachmentConfirmAddViewer(n){var u,i,t,e,r,o,f;for($traderBillAttachmentExisted={AssociatedFiles:[]},$traderBillAttachments=[],u="",i=$("#attachments-view-bill .attachments_"+n+" input.inputfile"),t=0;t<i.length;t++)$(".attachments_"+n+" .inputfilename"+(t+1)).val()===""&&i[t].files.length>0&&$(".attachments_"+n+" .inputfilename"+(t+1)).val(i[t].files[0].name.substr(0,i[t].files[0].name.lastIndexOf("."))),e=$(".file-id-input"+(t+1)).val(),i[t].files.length>0?(r=i[t].files[0],u=r.name.split(".").pop(),o=_.find($qbiclesFileTypes,function(n){return n.Extension===u}),f={Id:e,Name:r.name,Extension:r.name.split(".").pop(),Size:r.size,IconPath:o.IconPath,File:r},$("div.attachments_"+n+" .inputfilename"+(t+1)).val()!==""&&(f.Name=$("div.attachments_"+n+" .inputfilename"+(t+1)).val()+"."+u),$traderBillAttachments.push(f)):$("#file_id_"+(t+1)).length>0&&$traderBillAttachmentExisted.AssociatedFiles.push({Id:parseInt($("#file_id_"+(t+1)).val()),Name:$(".inputfilename"+(t+1)).val(),IconPath:$("#inputiconpath_edit"+(t+1)).val()});PurchaseBillLoadAttachmentListViewer()}function PurchaseBillLoadAttachmentListViewer(){$("ul.domain-change-list").empty();var n=$traderBillAttachmentExisted.AssociatedFiles.length+$traderBillAttachments.length;$("#trader-bill-attachment-manage").text(" Attachments ("+n+")");n>0&&$("#trader-bill-attachment-icon").removeClass("fa fa-plus").addClass("fa fa-paperclip");_.forEach($traderBillAttachmentExisted.AssociatedFiles,function(n){var t=" <li id='att-"+n.Id+'\'><input class="file-id" type="hidden" value="'+n.Id+"\" /><button class='btn btn-danger' onclick=\"PurchaseBillAttachmentRemove('"+n.Id+"')\"><i class='fa fa-trash'><\/i><\/button> <a href='javascript:void(0)'>";t+='<img src="'+n.IconPath+'" style="max-width: 80px; height: auto; padding-right: 10px;">';t+=n.Name+" <\/a> <\/li>";$("#transaction-attachments ul.domain-change-list").append(t)});_.forEach($traderBillAttachments,function(n){var t=" <li id='att-"+n.Id+'\'><input class="file-id" type="hidden" value="'+n.Id+"\" /><button class='btn btn-danger' onclick=\"PurchaseBillAttachmentRemove('"+n.Id+"')\"><i class='fa fa-trash'><\/i><\/button> <a href='javascript:void(0)'>";t+='<img src="'+n.IconPath+'" style="max-width: 80px; height: auto; padding-right: 10px;">';t+=n.Name+" <\/a> <\/li>";$("#transaction-attachments ul.domain-change-list").append(t)})}function PurchaseBillAttachmentChangeFile(n,t,i){var r=$(".attachments_"+i+" input.inputfilename"+t).val(),u,f;for($(n).length>0&&$(n)[0].files.length>0&&r.length===0&&(r=$(n)[0].files[0].name),u=$(".attachments_"+i+" input.inputfile"),f=0;f<u.length;f++)u[0]!==n&&$(u[0]).val()===$(n).val()&&($(n).val(""),cleanBookNotification.error(_L("ERROR_MSG_616",[r]),"Qbicles"),r="");$(".attachments_"+i+" .inputfilename"+t).val(r.split(".").slice(0,-1).join("."))}function PurchaseBillAttachmentAddAnother(n){var r=GenerateUUID(),i=$(".attachments_"+n+" input.inputfile"),t='<div class="row attachment_row att-id-'+r+'"> <div class="col-xs-12">';t+='<input type="hidden" class="file-id-input'+(i.length+1)+'" value="'+r+'"/>';t+='<div class="form-group"> <label for="name">Name<\/label> <input type="text" name="name" class="form-control inputfilename'+(i.length+1)+'">';t+='<\/div> <\/div> <div class="col-xs-12"> <div class="form-group"> <label for="file">File<\/label>';t+='<input type="file" name="file" onchange="PurchaseBillAttachmentChangeFile(this,'+(i.length+1)+","+n+')" class="form-control inputfile">  <\/div>  <\/div> <\/div>';$(".attachments_"+n+" div.repeater_wrap").append(t)}function PurchaseBillAttachmentRemove(n){$("#att-"+n).remove();$(".att-id-"+n).remove();_.remove($traderBillAttachments,function(t){return t.Id==n});_.remove($traderBillAttachmentExisted.AssociatedFiles,function(t){return t.Id==n});var t=$traderBillAttachmentExisted.AssociatedFiles.length+$traderBillAttachments.length;$("#trader-bill-attachment-manage").text(" Attachments ("+t+")")}function IssuePurchaseOrder(n){var t=$("#mail-addresses").val(),i;if(t.length>0&&(i=validateEmails(t),i.length>0)){cleanBookNotification.error("Email format is not correct:'\n'"+i,"Qbicles");return}$("#adding-other-mail-addresses").LoadingOverlay("show");$("#sale-order-template").removeClass("hidden");$.ajax({url:"/TraderPurchases/IssuePurchaseOrder",type:"POST",dataType:"json",data:{id:n,emails:t},success:function(n){n.result&&(cleanBookNotification.updateSuccess(),$("#adding-other-mail-addresses").modal("hide"))},error:function(n){$("#sale-order-template").addClass("hidden");cleanBookNotification.error(n.responseText,"Qbicles");cleanBookNotification.error(_L("ERROR_MSG_EXCEPTION_SYSTEM"),"Qbicles")}}).always(function(){$("#adding-other-mail-addresses").LoadingOverlay("hide")})}function OpenIssuePurchaseOrderModal(){$("#mail-addresses").text("");$("#mail-addresses").val("");$("#adding-other-mail-addresses").modal("show")}var $qbiclesFileTypes=[],$traderBillAttachments=[],$traderBillAttachmentExisted={AssociatedFiles:[]},$traderPurchaseId,$editMode,$transferRequirement;$(document).ready(function(){$qbiclesFileTypes=[];$.ajax({type:"post",url:"/FileTypes/GetFileTypes",dataType:"json",success:function(n){$qbiclesFileTypes=n},error:function(){}}).always(function(){LoadingOverlayEnd()})});$traderPurchaseId=$("#TraderPurchaseId").val();PurchaseTotal=function(){var t=$("#tb_form_item tbody tr"),r=$("#tb_form_item tbody tr td"),i=0,n;if(t.length===1&&r.length===1)return 0;for(n=0;n<t.length;n++)i+=stringToNumber($($(t[n]).find("td.row_cost input")).val());return i};$editMode="Purchase";$transferRequirement="";BillProcessMedia=function(n){$traderBillAttachments.length>0?UploadBatchMediasS3ClientSide($traderBillAttachments).then(function(){SubmitPurchaseBill(n)}):SubmitPurchaseBill(n)};SubmitPurchaseBill=function(n){var t=[];_.forEach($traderBillAttachments,function(n){n.File={};t.push(n)});$.ajax({type:"post",url:"/TraderPurchases/SaveBillInvoice",data:{invoice:n,traderBillAssociatedFiles:$traderBillAttachmentExisted,traderBillAttachments:t},dataType:"json",success:function(n){n.actionVal===1?($("#app-trader-bill-add").modal("hide"),cleanBookNotification.createSuccess(),loadBills($("#bill_purchase").val())):n.actionVal===2?($("#app-trader-bill-add").modal("hide"),cleanBookNotification.updateSuccess(),loadBills($("#bill_purchase").val())):cleanBookNotification.error(n.msg)},error:function(){cleanBookNotification.error(_L("ERROR_MSG_EXCEPTION_SYSTEM"),"Qbicles")}}).always(function(){LoadingOverlayEnd()})};