function addPurchase(){$("#app-trader-purchase-add").modal("show");$("#app-trader-purchase-add").empty();$("#app-trader-purchase-add").load("/TraderPurchases/TraderPurchaseAdd?locationId="+$slLocation.val())}function editPurchase(n){$("#app-trader-purchase-add").empty();$("#app-trader-purchase-add").load("/TraderPurchases/TraderPurchaseAdd?locationId="+$slLocation.val()+"&purchaseId="+n);$("#app-trader-purchase-add").modal("toggle")}function resetPurchaseForm(){$("#cpu").attr("disabled",!0);$("#addNowForm").attr("disabled",!0);$("#label_cost").text("Cost per <selected unit>")}function ChangeSelectedUnit(){$("#item_selected").empty();var n=$("#item-select-manage").find(":selected").attr("itemId");$("#item_selected").load("/Trader/TraderSaleSelectUnit?idLocation="+$slLocation.val()+"&idTraderItem="+(n?n:0),function(){$("#item-select-manage").val()!==""&&$("#item-select-manage").val()!=="0"&&($("#label_cost").text("Cost per <selected unit>"),$("#cpu").removeAttr("disabled"))})}function quantityChange(){var n=$("#form_item_quantity").val(),t=$("#cpu").val();parseFloat(n).toString()!=="NaN"&&parseFloat(n)>0&&parseFloat(t).toString()!=="NaN"&&parseFloat(t)>0?$("#addNowForm").removeAttr("disabled"):$("#addNowForm").attr("disabled","true")}function selectedUnit(n){var t=$(n);t?$("#label_cost").text("Cost per "+$(t.find("option:selected")).text()):$("#label_cost").text("Cost per <selected unit>")}function removeRowItem(n){$("#tb_form_item tbody tr.tr_id_"+n).remove();ResetSpanneredItemSelected("tb_form_item","item-select-manage")}function addRowItem(){var o=UniqueId(),u=$("#form_item_dimensions").val(),n,e;u||(u=[]);var s=$("#item_selected select").val(),r=$("#item-select-manage").find(":selected"),i=r.attr("itemId"),h=r.attr("itemName"),c=r.attr("itemImage"),l=r.attr("taxName"),a=r.attr("taxRate"),v=r.attr("costUnit"),t={Id:o,TraderItem:{Id:i,TaxName:l,ImageUri:c,Name:h,TaxRate:a,CostUnit:v},Discount:isNaN(parseInt($("#form_item_discount").val()))?0:parseInt($("#form_item_discount").val()),Dimensions:[],Quantity:parseInt($("#form_item_quantity").val()),Unit:{},CostPerUnit:parseFloat($("#cpu").val()),Cost:0},f=parseFloat(t.CostPerUnit)*parseFloat(t.Quantity)*(1-parseFloat(t.Discount)/100)*(1+parseFloat(t.TraderItem.TaxRate)/100),y=f/(1+t.TraderItem.TaxRate/100),p=parseFloat(f-y).toFixed($decimalPlace);t.Cost=f.toFixed($decimalPlace);n=$("#tb_form_template tbody tr").clone();$(n).addClass("tr_id_"+i);$($(n).find("td.row_image div")).attr("style","background-image: url('"+$("#api_url").val()+t.TraderItem.ImageUri+"&size=T');");$($(n).find("td.row_name")).text(t.TraderItem.Name);$($(n).find("td.row_unit")).empty();e=$("#item_selected select").clone();$($(n).find("td.row_unit")).append(e);$($(n).find("td.row_unit select")).val(s);$($(n).find("td.row_unit select")).attr("onchange","rowUnitChange('"+i+"')");$($(n).find("td.row_costperunit input")).val(t.CostPerUnit);$($(n).find("td.row_costperunit input")).attr("onchange","updateCost('"+i+"')");$($(n).find("td.row_quantity input")).val(t.Quantity);$($(n).find("td.row_quantity input")).attr("onchange","updateCost('"+i+"')");$($(n).find("td.row_discount input")).val(t.Discount);$($(n).find("td.row_discount input")).attr("onchange","updateCost('"+i+"')");$($(n).find("td.row_taxrate")).text(t.TraderItem.TaxRate);$($(n).find("td.row_taxname")).html(showTaxRatesDetail(t.CostPerUnit,t.Quantity,t.Discount,t.TraderItem.TaxName));$($(n).find("td.row_dimensions select")).val(u);$($(n).find("td.row_cost")).text(toCurrencySymbol(t.Cost,!1));$($(n).find("td.row_button button")).attr("onclick","removeRowItem('"+i+"')");$($(n).find("td.row_button input.traderItem")).val(i);$($(n).find("td.row_button input.row_id")).val(i);$($(n).find("td select")).not(".multi-select").select2();$("#tb_form_item tbody").append(n);setTimeout(function(){$("#form_add_transaction")[0].reset();$("#form_add_transaction select").not(".multi-select").select2();resetPurchaseForm()},100);ResetSpanneredItemSelected("tb_form_item","item-select-manage")}function rowUnitChange(n){var i=$("#tb_form_item tbody tr.tr_id_"+n+" td.row_button input.traderItem").val().split(":"),t=$("#tb_form_item tbody tr.tr_id_"+n+" td.row_unit select").val().split(":");t[1]==="BaseUnit"?$("#tb_form_item tbody tr.tr_id_"+n+" td.row_costperunit input").val(i[3]):t[1]==="Conversion Unit"&&$("#tb_form_item tbody tr.tr_id_"+n+" td.row_costperunit input").val(parseFloat(i[3])*parseFloat(t[3]));updateCost(n)}function updateCost(n){var t=$("#tb_form_item tbody tr.tr_id_"+n+" td.row_costperunit input").val(),i=$("#tb_form_item tbody tr.tr_id_"+n+" td.row_quantity input").val(),r=$("#tb_form_item tbody tr.tr_id_"+n+" td.row_discount input").val(),u=$("#tb_form_item tbody tr.tr_id_"+n+" td.row_taxrate").text(),f,e;isNaN(parseFloat(t))||isNaN(parseFloat(i))||isNaN(parseFloat(r))||isNaN(parseFloat(u))||(f=parseFloat(t)*parseFloat(i)*(1-parseFloat(r)/100)*(1+parseFloat(u)/100),$("#tb_form_item tbody tr.tr_id_"+n+" td.row_cost").text(toCurrencySymbol(f,!1)),e=$("#tb_form_item tbody tr.tr_id_"+n+" td.row_taxname input.txt-taxname").val(),$("#tb_form_item tbody tr.tr_id_"+n+" td.row_taxname").html(showTaxRatesDetail(t,i,r,e)))}function validateSendToReview(){var i=$("#form_sale_contact").val(),n=$("#tb_form_item tbody tr"),t=$("#tb_form_item tbody tr td");n.length>0&&t.length>1?($("#a_send_toreview_purchase").removeAttr("disabled"),$("#a_send_toreview_purchase").removeClass("disabled")):($("#a_send_toreview_purchase").attr("disabled"),$("#a_send_toreview_purchase").addClass("disabled"))}function nextToConfirm(){var n,e,i,r,u;$("#tb_confirm tbody").empty();var t=$("#tb_form_item tbody tr"),o=$("#tb_form_item tbody tr td"),f=0;if(t.length!==1||o.length!==1){for(n=0;n<t.length;n++){if(e=stringToNumber($($(t[n]).find("td.row_cost")).text()),f+=e,i="<tr> <td>"+$($(t[n]).find("td.row_image")).html()+"<\/td>",i+="<td>"+$($(t[n]).find("td.row_name")).text()+"<\/td> <td>"+$($(t[n]).find("td.row_unit select option:selected")).text()+"<\/td>",i+=" <td>"+$($(t[n]).find("td.row_quantity input")).val()+"<\/td> <td>"+$($(t[n]).find("td.row_discount input")).val()+"%<\/td> <td>"+$($(t[n]).find("td.row_taxname")).html()+"<\/td>",i+="<td>",r=$($(t[n]).find("td.row_dimensions select option:selected")),r.length>0)for(u=0;u<r.length;u++)i+='<span class="label label-info label-lg">'+$(r[u]).text()+"<\/span> ";i+="<\/td>";i+="<td>"+$($(t[n]).find("td.row_cost")).text()+"<\/td> <\/tr>";$("#tb_confirm tbody").append(i)}$("#total_id").text(toCurrencySymbol(f));validateSendToReview()}}function SavePurchaseDraft(){SavePurchase("Draft")}function SavePurchaseReview(){SavePurchase("PendingReview")}function SavePurchase(n){var h=[],i=$("#tb_form_item tbody tr"),t,s,u,r,f,e,c,o,l,a;if(i.length>0)for(t=0;t<i.length;t++){if(s=parseInt($($(i[t]).find("td.row_button input.row_id")).val()),u={Id:0},$($(i[t]).find("td.row_button input.traderItem")).val()!==null?u.Id=$($(i[t]).find("td.row_button input.traderItem")).val():u=null,r=$($(i[t]).find("td.row_dimensions select")).val(),f=[],r&&r.length>0)for(e=0;e<r.length;e++)f.push({Id:r[e]});if(n==="PendingReview"&&f.length===0)return cleanBookNotification.error(_L("ERROR_MSG_635"),"Qbicles"),$('.admintabs a[href="#sale-2"]').tab("show"),!1;if(c=$($(i[t]).find("td.row_unit select")).val().split("|"),o={Id:isNaN(s)?0:s,TraderItem:u,Discount:$($(i[t]).find("td.row_discount input")).val(),Dimensions:f,Quantity:$($(i[t]).find("td.row_quantity input")).val(),Unit:{Id:c[1]},CostPerUnit:stringToNumber($($(i[t]).find("td.row_costperunit input")).val()),Cost:stringToNumber($($(i[t]).find("td.row_cost")).text())},parseFloat(o.Quantity).toString()==="NaN")return $.LoadingOverlay("hide"),cleanBookNotification.error(_L("ERROR_MSG_636"),"Qbicles"),!1;if(parseFloat(o.Quantity)<=0)return $.LoadingOverlay("hide"),cleanBookNotification.error(_L("ERROR_MSG_637"),"Qbicles"),!1;h.push(o)}l={Id:$("#reference_id").val(),NumericPart:parseFloat($("#refedit").text()),Type:$("#reference_type").val(),Prefix:$("#reference_prefix").val(),Suffix:$("#reference_suffix").val(),Delimeter:$("#reference_delimeter").val(),FullRef:$("#reference_fullref").val()};a={Id:$("#tradersale_form_id").val(),Location:{Id:$slLocation.val()},PurchaseItems:h,Status:n,Reference:l,Workgroup:{Id:$("#trader_purchase_add_workgroup").val()},PurchaseTotal:stringToNumber($("#total_id").text()),Vendor:{Id:$("#form_sale_contact").val()},DeliveryMethod:$("#sales_delivery").val()};$.LoadingOverlay("show");$.ajax({type:"post",url:"/Spanneredfree/SaveTraderPurchaseAsset",data:{traderPurchase:a,assetId:$("#assetId").val()},dataType:"json",success:function(n){LoadingOverlayEnd();n.actionVal===1?($("#app-trader-purchase-add").modal("toggle"),cleanBookNotification.createSuccess(),ReloadRelatedPurchases()):n.actionVal===2?($("#app-trader-purchase-add").modal("toggle"),cleanBookNotification.updateSuccess(),ReloadRelatedPurchases()):n.actionVal===3&&cleanBookNotification.error(n.msg,"Qbicles")},error:function(){cleanBookNotification.error(_L("ERROR_MSG_EXCEPTION_SYSTEM"),"Qbicles");LoadingOverlayEnd()}})}function ReloadRelatedPurchases(){$("#asset-relatedpurchases div.spacing").load("/Spanneredfree/ReloadRelatedPurchases",{assetId:$("#assetId").val()},function(){$("#tblRelatedPurchases").DataTable()})}function ChangeWorkgroup(n){WorkGroupSelectedChange();$("#item-select-manage").empty().trigger("change");var t=$(n).val();$.ajax({type:"get",url:"/Spanneredfree/GetItemProductByWorkgroupIsBought?wgid="+t+"&locationId="+$slLocation.val()+"&assetId="+($("#assetId").val()?$("#assetId").val():0),dataType:"json",success:function(n){n.result&&(lstTraderItems=n.Object,ResetSpanneredItemSelected("tb_form_item","item-select-manage",$("#trader_purchase_add_workgroup").val()))},error:function(){}})}function WorkGroupSelectedChange(){$(".preview-workgroup").show();$workgroupId=$("#trader_purchase_add_workgroup").val();$workgroupId!==""?$.ajax({type:"get",url:"/TraderTransfers/getworkgroup?id="+$workgroupId,dataType:"json",success:function(n){n.result?($(".preview-workgroup table tr td.location_name").text(n.Object.Location),$(".preview-workgroup table tr td.workgroup_process").text(n.Object.Process),$(".preview-workgroup table tr td.workgroup_qbicle").text(n.Object.Qbicle),$(".preview-workgroup table tr td.workgroup_member span").text(n.Object.Members)):($(".preview-workgroup table tr td.location_name").text(""),$(".preview-workgroup table tr td.workgroup_process").text(""),$(".preview-workgroup table tr td.workgroup_qbicle").text(""),$(".preview-workgroup table tr td.workgroup_member span").text(""));EnableNextButton()},error:function(){cleanBookNotification.error(_L("ERROR_MSG_EXCEPTION_SYSTEM"),"Qbicles")}}):(DisableNextButton(),$(".preview-workgroup table tr td.location_name").text(""),$(".preview-workgroup table tr td.workgroup_process").text(""),$(".preview-workgroup table tr td.workgroup_qbicle").text(""),$(".preview-workgroup table tr td.workgroup_member span").text(""))}function ResetSpanneredItemSelected(n,t,i){var h,f,u,o,r;if((typeof i=="undefined"||i!==null)&&(h=!isNaN(i),$("#"+n)&&$("#"+t))){var e=$("#"+n+" tbody tr"),c=$("#"+n+" tbody tr td"),s=[];if(e.length>0&&c.length>1)for(f=0;f<e.length;f++)s.push($($(e[f]).find(" td input.traderItem")).val().split(":")[0]);for(u=jQuery.map(lstTraderItems,function(n){if(s.indexOf(n.Id.toString())===-1)return n}),o="<option value=''><\/option>",r=0;r<u.length;r++)o+="<option itemId='"+u[r].Id+"' itemName='"+u[r].Name+"' itemImage='"+u[r].ImageUri+"' taxName='"+u[r].TaxRateName+"' taxRate='"+u[r].TaxRateValue+"' costUnit ='"+u[r].CostUnit+"'value=\""+u[r].Id+'">'+u[r].Name+"<\/option>";$("#"+t).empty();$("#"+t).append(o);$("#"+t).not(".multi-select").select2({placeholder:"Please select"});qbicleLog("ResetItemSelected")}}function changeContact(n){$(n).val()!==""&&$.ajax({type:"get",url:"/TraderSales/GetContactById?id="+$(n).val(),dataType:"json",success:function(n){var t=n.Name+",<\/br>";n.Address&&($("#contact_address_id").val(n.Address.Id),n.Address.AddressLine1&&(t+=",<\/br>"+n.Address.AddressLine1),n.Address.City&&(t+=",<\/br>"+n.Address.City),n.Address.AddressLine2&&(t+=",<\/br>"+n.Address.AddressLine2),n.Address.State&&(t+=",<\/br>"+n.Address.State),n.Address.Country&&(t+=",<\/br>"+n.Address.Country.CommonName),n.Address.PostCode&&(t+=",<\/br>"+n.Address.PostCode));$("#address_info").empty();$("#address_info").append(t)},error:function(){cleanBookNotification.error(_L("ERROR_MSG_EXCEPTION_SYSTEM"),"Qbicles")}})}function ShowGroupMember(){$("#app-trader-workgroup-preview").empty();$("#app-trader-workgroup-preview").load("/TraderTransfers/ShowListMemberForWorkGroup?wgId="+$("#trader_purchase_add_workgroup").val()+"&title=Purchase team members");$("#app-trader-workgroup-preview").modal("toggle")}function EnableNextButton(){$workgroupId!==""&&$("#app-trader-purchase-add .btnNext").removeAttr("Disabled")}function DisableNextButton(){$("#app-trader-purchase-add .btnNext").attr("Disabled","Disabled")}function nextToItems(){$("#trader_purchase_add_workgroup").val()&&$("#form_sale_contact").val()?($("#form_add_transaction")[0].reset(),ResetSpanneredItemSelected("tb_form_item","item-select-manage",$("#trader_purchase_add_workgroup").val())):(arrayUpdate.push(1),setTimeout(function(){arrayUpdate.length>1&&($('.admintabs a[href="#sale-1"]').tab("show"),$("#form_sale_contact").val()||$("#form_specifics").validate().showErrors({contact:"Contact is required"}),$("#trader_purchase_add_workgroup").val()||$("#form_specifics").validate().showErrors({workgroup:"Workgroup is required"}),arrayUpdate=[])},500))}var isChecking=!1,isConfirm=!1,arrayUpdate=[];