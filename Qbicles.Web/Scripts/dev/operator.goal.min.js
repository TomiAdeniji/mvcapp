function initDateRange(){var n=$dateFormatByUser.toUpperCase();$("#txtCustomDate").daterangepicker({autoUpdateInput:!1,cancelClass:"btn-danger",opens:"right",locale:{cancelLabel:"Clear",format:n}});$("#txtCustomDate").on("apply.daterangepicker",function(t,i){$(this).val(i.startDate.format(n)+" - "+i.endDate.format(n));$(this).trigger("change")})}function LoadMedias(n){$.LoadingOverlay("show");var t=$("#sl-media-type").val();$.ajax({type:"post",url:"/Operator/LoadMedias",datatype:"json",data:{qid:n,fileType:t=="All"?"":t},success:function(n){if(n){var t=$("#goal-resources .flex-grid-thirds-lg");t.html(n);totop();LoadingOverlayEnd()}},error:function(n){cleanBookNotification.error(n.responseText,"Qbicles");LoadingOverlayEnd()}})}function initModalMedia(){var n=$("#form_media_smresource");n.validate({rules:{name:{required:!0,minlength:5},description:{required:!0}}});n.submit(function(t){if((t.preventDefault(),!isBusy)&&n.valid()){$.LoadingOverlay("show");var i=document.getElementById("goal-resource-file-input").files;i.length>0?UploadMediaS3ClientSide("goal-resource-file-input").then(function(t){if(t.objectKey==="no_image"||t.objectKey==="no-image"){LoadingOverlayEnd();cleanBookNotification.error(_L("ERROR_MSG_S3_UPLOAD"),"Qbicles");return}$("#goal-resource-file-object-key").val(t.objectKey);$("#goal-resource-file-object-name").val(t.fileName);$("#goal-resource-file-object-size").val(t.fileSize);var i=new FormData(n[0]);$.ajax({type:"POST",cache:!1,url:"/Operator/SaveResourceGoal",enctype:"multipart/form-data",data:i,processData:!1,contentType:!1,beforeSend:function(){isBusy=!0},success:function(t){t.result?($("#create-resource").modal("hide"),isBusy=!1,LoadMedias($("#qbicleId").val()),cleanBookNotification.success(_L("ERROR_MSG_172"),"Operator"),n.trigger("reset")):t.msg&&(cleanBookNotification.error(t.msg,"Operator"),isBusy=!1);LoadingOverlayEnd()},error:function(){isBusy=!1;cleanBookNotification.error(_L("ERROR_MSG_EXCEPTION_SYSTEM"),"Operator");LoadingOverlayEnd()}})}):(LoadingOverlayEnd(),cleanBookNotification.error(_L("ERROR_MSG_154"),"Qbicles"))}})}function animatestat(n){$("#goalChartProcess").circleProgress({max:100,value:n,textFormat:"percent",animation:"easeInOutExpo",animationDuration:2600});animatedprogress()}function animatedprogress(){var n=500;$(".progress-bar").each(function(t){$(this).delay(n*t).animate({width:$(this).attr("aria-valuenow")+"%"},n)})}function initChart(n){var o;Chart.plugins.register({id:"paddingBelowLegends",beforeInit:function(n){n.legend.afterFit=function(){this.height=this.height+50}}});var t=document.getElementById("myChart").getContext("2d"),i=t.createLinearGradient(0,0,0,400),r=t.createLinearGradient(0,0,0,400);r.addColorStop(0,"#05e4b1");r.addColorStop(1,"#1dc7e6");i.addColorStop(0,"#05a8f4");i.addColorStop(1,"#049ef4");var f=[],e=[],u=[];$.each(n,function(t,o){o.key!="01/01"&&(f.push(o.key),e.push(o.totalweight),n.length==t+1?u.push(r):u.push(i))});o=new Chart(t,{type:"line",data:{labels:f,datasets:[{label:"% progress towards Goal",data:e,backgroundColor:u,borderWidth:0}]},options:{legend:{display:!1},scales:{xAxes:[{gridLines:{color:"rgba(0, 0, 0, 0)"}}],yAxes:[{display:!0,ticks:{beginAtZero:!0,max:100}}]}}})}function createDiscussion(){$("#frm-create-discussion").submit(function(n){n.preventDefault();$.LoadingOverlay("show");$.ajax({type:"post",url:"/Discussions/SaveDiscussionForGoal",datatype:"json",data:{goalId:$("#goalId").val(),openingmessage:$("#ds_openingmessage").val(),isexpiry:$("#ds_isexpiry").prop("checked"),expirydate:$("#ds_expirydate").val()},beforeSend:function(){isBusy=!0},success:function(n){var t,i;n.result?($(".new-discuss").hide(),t=$("#btnJoinDiscussion"),n.Object.Id>0&&(i=t.attr("href")+"?disId="+n.Object.Id,t.attr("href",i),t.show()),cleanBookNotification.success(_L("ERROR_MSG_196"),"Operator"),$("#create-discussion").modal("hide")):n.msg&&cleanBookNotification.error(n.msg,"Operator");isBusy=!1;LoadingOverlayEnd()},error:function(){isBusy=!1;LoadingOverlayEnd()}})})}function LoadGoalMeasures(){var n,r,u;if($(".text-timeframe").text($("#slTimeframe option:selected").text()),n=!0,$("#slTimeframe").val()=="2"){if($(".text-timeframe").text($("#txtCustomDate").val()),!$("#txtCustomDate").val())return;var t=$("#txtCustomDate").data("daterangepicker").startDate.toDate(),i=$("#txtCustomDate").data("daterangepicker").endDate.toDate(),f=new moment(t).add(12,"months").toDate();if(i>f){cleanBookNotification.error(_L("ERROR_MSG_706"),"Operator");return}r=new moment(t).add(31,"days").toDate();i>r&&(n=!1)}u={goalId:$("#goalId").val(),timeframe:$("#slTimeframe").val(),customDate:$("#txtCustomDate").val(),isDay:n};$.ajax({type:"post",url:"/Operator/LoadGoalMeasuresForChart",datatype:"json",data:u,success:function(n){n&&(animatestat(n.TotalProgressGoal),n.ChartProcessMeasures&&$("#pagination-container").pagination({dataSource:n.ChartProcessMeasures,prevText:"<",nextText:">",pageSize:5,callback:function(n){var t=measuresTemplating(n);$(".records-h").html(t)}}),initChart(n.CharMonitorMeasures))},error:function(n){cleanBookNotification.error(n.responseText,"Qbicles");LoadingOverlayEnd()}})}function initGoalModal(){var n=$("#frmGoal");$tblLeadingIndicators=$("#tblLeadingIndicators").DataTable({destroy:!0,order:[[4,"desc"]],columnDefs:[{visible:!1,targets:0},{visible:!1,targets:1},{targets:4,render:function(n){return typeof n=="number"?n+"%":n.replace("%","")+"%"}},{targets:5,data:"Id",render:function(){return'<button class="btn btn-danger" type="button" onclick="deleteRowMeasure(\'tblLeadingIndicators\',this)"><i class="fa fa-trash"><\/i><\/button>'}}]});$tblGoalMeasures=$("#tblGoalMeasures").DataTable({destroy:!0,order:[[4,"desc"]],columnDefs:[{visible:!1,targets:0},{visible:!1,targets:1},{targets:4,render:function(n){return typeof n=="number"?n+"%":n.replace("%","")+"%"}},{targets:5,data:"Id",render:function(){return'<button class="btn btn-danger" onclick="deleteRowMeasure(\'tblGoalMeasures\',this)"><i class="fa fa-trash"><\/i><\/button>'}}]});$("#frmGoal select.select2").select2({placeholder:"Please select"});$("#frmGoal .checkmulti").multiselect({includeSelectAllOption:!1,enableFiltering:!1,buttonWidth:"100%",maxHeight:400,enableClickableOptGroups:!0});$(".btnNext").click(function(){var t=$(this).closest(".modal");n.valid()?$(t).find("#tabNavGoals .active").next("li").find("a").trigger("click"):$(t).find("#tabNavGoals .active").find("a").trigger("click")});$(".btnPrevious").click(function(){var n=$(this).closest(".modal");$(n).find("#tabNavGoals .active").prev("li").find("a").trigger("click")});$("#btnLMAdd").click(function(){if($("#frmGoal select[name=lm_measure]").val()!=""&&$("#frmGoal input[name=lm_weight]").valid()){var n=$("#frmGoal select[name=lm_measure] option:selected"),r=n.val(),u=n.text(),f=n.attr("desc"),i=parseInt($("#frmGoal input[name=lm_weight]").val()),e=$tblLeadingIndicators.rows().data(),t=i;if($.each(e,function(n,i){t+=typeof i[4]=="number"?i[4]:parseInt(i[4].replace("%",""))}),t>100){cleanBookNotification.error(_L("ERROR_MSG_703"),"Operator");return}$tblLeadingIndicators.row.add({0:0,1:r,2:u,3:f,4:i,5:0}).draw(!1);n.remove();$("#frmGoal select[name=lm_measure]").select2({placeholder:"Please select"});$("#btnLMAdd").attr("disabled",!0);$("#frmGoal select[name=lm_measure]").val("").trigger("change");$("#frmGoal input[name=lm_weight]").val("0")}});$("#btnGMAdd").click(function(){if($("#frmGoal select[name=gm_measure]").val()!=""&&$("#frmGoal input[name=gm_weight]").valid()){var n=$("#frmGoal select[name=gm_measure] option:selected"),r=n.val(),u=n.text(),f=n.attr("desc"),i=parseInt($("#frmGoal input[name=gm_weight]").val()),e=$tblGoalMeasures.rows().data(),t=i;if($.each(e,function(n,i){t+=typeof i[4]=="number"?i[4]:parseInt(i[4].replace("%",""))}),t>100){cleanBookNotification.error(_L("ERROR_MSG_703"),"Operator");return}$tblGoalMeasures.row.add({0:0,1:r,2:u,3:f,4:i,5:0}).draw(!1);n.remove();$("#frmGoal select[name=gm_measure]").select2({placeholder:"Please select"});$("#btnGMAdd").attr("disabled",!0);$("#frmGoal select[name=gm_measure]").val("").trigger("change");$("#frmGoal input[name=gm_weight]").val("0")}});n.validate({ignore:"",rules:{Name:{required:!0,maxlength:100},Summary:{required:!0,maxlength:500},Tags:{required:!0}}});n.submit(function(t){if(t.preventDefault(),n.valid()){$.LoadingOverlay("show");var i=document.getElementById("goal-featured-image").files;i.length>0?UploadMediaS3ClientSide("goal-featured-image").then(function(n){if(n.objectKey==="no_image"||n.objectKey==="no-image"){LoadingOverlayEnd("hide");cleanBookNotification.error(_L("ERROR_MSG_S3_UPLOAD"),"Qbicles");return}$("#operator-goal-feature-image-object-key").val(n.objectKey);$("#operator-goal-feature-image-object-name").val(n.fileName);$("#operator-goal-feature-image-object-size").val(n.fileSize);SaveOperatorGoal()}):($("#operator-goal-feature-image-object-key").val(""),$("#operator-goal-feature-image-object-name").val(""),$("#operator-goal-feature-image-object-size").val(""),SaveOperatorGoal())}})}function SaveOperatorGoal(){var t=new FormData($("#frmGoal")[0]),r=$tblLeadingIndicators.rows().data(),u=$tblGoalMeasures.rows().data(),i=[],n;if($.each(r,function(n,t){i.push({Id:t[0],MeasureId:t[1],Weight:typeof t[4]=="number"?t[4]:t[4].replace("%","")})}),n=[],$.each(u,function(t,i){n.push({Id:i[0],MeasureId:i[1],Weight:typeof i[4]=="number"?i[4]:i[4].replace("%","")})}),i.length>0)t.append("sLeadingIndicators",JSON.stringify(i));else{cleanBookNotification.error(_L("ERROR_MSG_704"),"Operator");$("#tabNavGoals a[href=#goal-2]").click();LoadingOverlayEnd();return}if(n.length>0)t.append("sGoalMeasures",JSON.stringify(n));else{cleanBookNotification.error(_L("ERROR_MSG_705"),"Operator");$("#tabNavGoals a[href=#goal-3]").click();LoadingOverlayEnd();return}$.ajax({type:"post",cache:!1,url:"/Operator/SaveGoal",data:t,enctype:"multipart/form-data",processData:!1,contentType:!1,beforeSend:function(){isBusy=!0},success:function(n){isBusy=!1;n.result?($("#app-operator-goal-addedit").modal("hide"),cleanBookNotification.success(_L("UPDATE_MSG_SUCCESS"),"Operator"),location.reload()):!n.result&&n.msg&&cleanBookNotification.error(_L(n.msg),"Operator");LoadingOverlayEnd()},error:function(){isBusy=!1;LoadingOverlayEnd();cleanBookNotification.error(_L("ERROR_MSG_EXCEPTION_SYSTEM"),"Operator")}})}function loadModalGoal(n){$("#app-operator-goal-addedit").modal("show");$("#app-operator-goal-addedit").load("/Operator/LoadModalGoal",{id:n},function(){initGoalModal()})}function searchThrottle(n,t){var i=null;return function(){var r=this,u=arguments;clearTimeout(i);i=window.setTimeout(function(){n.apply(r,u)},t||800)}}function deleteRowMeasure(n,t){var u=$(t).parents("tr"),s;if(u){var f=$("#"+n).DataTable().row(u),r=f.data(),i=r[1],e=r[2],o=r[3];n=="tblLeadingIndicators"?$("#frmGoal select[name=lm_measure] option[value="+i+"]").length==0&&(s=$("#frmGoal select[name=lm_measure]").append('<option value="'+i+'" desc="'+o.replace(/'/g,"\\'").replace(/"/g,"&#34;")+'">'+e+"<\/option>"),$("#frmGoal select[name=lm_measure]").select2({placeholder:"Please select"})):$("#frmGoal select[name=lm_measure] option[value="+i+"]").length==0&&(s=$("#frmGoal select[name=gm_measure]").append('<option value="'+i+'" desc="'+o.replace(/'/g,"\\'").replace(/"/g,"&#34;")+'">'+e+"<\/option>"),$("#frmGoal select[name=gm_measure]").select2({placeholder:"Please select"}));f.remove().draw()}}function measuresTemplating(n){var t="";return $.each(n,function(n,i){var r="started",u;for(i.Score==3?r="pending":i.Score<=2&&(r="overdue"),t+='<article class="'+r+'"><div class="record">',t+='<div class="col titleblock"><a href="#"> <p class="tasktitle" style="padding-left: 15px;">'+i.MeasureName+"<\/p><\/a><\/div>",t+='<div class="col text-right">',u=0;u<i.Score;u++)t+='<i class="fa fa-star yellow-text"><\/i>';t+="<\/div>";t+="<\/div><\/article>"}),t}function loadTabMeasuresContent(){var n,t,i,r;if($.LoadingOverlay("show"),$("#slTimeframe").val()=="2"){if(!$("#txtCustomDate").val())return;if(n=$("#txtCustomDate").data("daterangepicker"),t=n.startDate.add(12,"months").toDate(),n.endDate.toDate()>t){cleanBookNotification.error(_L("ERROR_MSG_706"),"Operator");return}i=n.startDate.add(31,"days").toDate();n.endDate.toDate()>i}r={goalId:$("#goalId").val(),timeframe:$("#slTimeframe").val(),customDate:$("#txtCustomDate").val(),search:$("txtSearchMeasures").val()};$.ajax({type:"post",url:"/Operator/LoadTabGoalMeasures",datatype:"json",data:r,success:function(n){if(n){var t=$("#goal-measures");t.html(n)}LoadingOverlayEnd()},error:function(n){cleanBookNotification.error(n.responseText,"Qbicles");LoadingOverlayEnd()}})}function deleteGoalMeasure(n){$.post("/Operator/DeleteGoalMeasure",{id:n},function(t){t.result?$("#gm_"+n).remove():!t.result&&t.msg?cleanBookNotification.error(_L(t.msg),"Operator"):cleanBookNotification.error(_L("ERROR_MSG_EXCEPTION_SYSTEM"),"Operator")})}var isBusy=!1,$tblLeadingIndicators,$tblGoalMeasures;$(document).ready(function(){initModalMedia();createDiscussion();initDateRange();LoadGoalMeasures();$("#slTimeframe").change(searchThrottle(function(){$(".text-timeframe").text($("#slTimeframe option:selected").text());$("#tabNavGoal li.active a[data-target=#goal-overview]").length>0?LoadGoalMeasures():loadTabMeasuresContent()}));$("#txtCustomDate").change(searchThrottle(function(){LoadGoalMeasures()}));$("#txtSearchMeasures").change(searchThrottle(function(){loadTabMeasuresContent()}))});