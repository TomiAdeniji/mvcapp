$(function(){var n=!1,i,t={$form_topic_addedit:$("#form_topic_addedit"),$form_topic_delete:$("#frm_topic_delete"),$form_topic_move:$("#frm_move_topic")};viewFunc={loadTopic:function(t){$.ajax({url:"/Topics/LoadTopicById",data:{id:t},type:"GET",dataType:"json",beforeSend:function(){n=!0}}).done(function(t){if(t.result&&t.Object){var i="#form_topic_addedit ";$(i+"input[name=Name]").val(t.Object.Name);$(i+"input[name=Summary]").val(t.Object.Summary);$(i+"input[name=Id]").val(t.Object.Id)}else cleanBookNotification.error(_L("ERROR_MSG_105"),"Qbicles");n=!1}).fail(function(){cleanBookNotification.error(_L("ERROR_MSG_EXCEPTION_SYSTEM"),"Qbicles");n=!1})},loadTopicManager:function(n){$("#topics").LoadingOverlay("show",{minSize:"70x60px"});i=n;$.ajax({url:"/Qbicles/GenerateTopicManager",data:{view:i,topics:[0]},type:"post",dataType:"html",success:function(n){$("#topics .spacing").html(n);$("#topics").LoadingOverlay("hide");totop()}}).fail(function(){cleanBookNotification.error(_L("ERROR_MSG_EXCEPTION_SYSTEM"),"Qbicles");$("#topics").LoadingOverlay("hide")})},resetFormTopic:function(){t.$form_topic_addedit.trigger("reset");$("#topic-add input.valid").removeClass("valid");$("#topic-add input.error").removeClass("error")},countAssociatedActivities:function(t){$.ajax({url:"/Topics/CountAssociatedActivities",data:{id:t},type:"GET",dataType:"json",beforeSend:function(){n=!0}}).done(function(t){var i;t.result&&t.Object?t.Object.countActivities>0?(i="The topic you are trying to delete has <strong>"+t.Object.countActivities+"<\/strong> associated activities. Please choose a new topic to assign these records to",$("#delete-topic .help-text p").html(i),$(".move-container").show()):(i="The topic you are trying to delete has <strong>"+t.Object.countActivities+"<\/strong> associated activities. Are you sure you want to delete this topic?",$("#delete-topic .help-text p").html(i),$(".move-container").hide()):cleanBookNotification.error(_L("ERROR_MSG_105"),"Qbicles");n=!1}).fail(function(){cleanBookNotification.error(_L("ERROR_MSG_EXCEPTION_SYSTEM"),"Qbicles");n=!1})},InitTopic:function(n,t,i){$.ajax({type:"post",url:"/Topics/GetTopicDelMoveByQbicle",datatype:"json",data:{key:n,topicId:i},success:function(n){n.result&&($("#"+t).empty().append(n.Object),$("#"+t).select2())},error:function(n){cleanBookNotification.error(n.responseText,"Qbicles")}})},deleteTopic:function(n){$('#delete-topic select[name=topicMoveId] option[value="'+n+'"]').hide();$("#topicDeleteId").val(n)},moveToTopicModal:function(){t.$form_topic_move.submit()},dragMoveToTopic:function(n,t,i){viewFunc.updateTopic(n,t,i,!1)},updateTopic:function(t,i,r,u){$.ajax({type:"Post",url:"/Topics/MoveAtivityTopic",data:{topicMoveId:t,topicCurrentId:i,activityId:r},dataType:"json","async":!1,beforeSend:function(){n=!0;$.LoadingOverlay("show")},success:function(i){n=!1;i.result?($("div[avid="+r+"]").attr("c-topicid",t),$("#move-to-group").modal("hide"),cleanBookNotification.success(_L("ERROR_MSG_106"),"Topic"),$("#move_cr_topicId").val(0),$("#move_cr_AvId").val(0),u&&$("div[avid="+r+"]").prependTo("div[topicid="+t+"]")):i.result===!1&&i.msg?cleanBookNotification.error(i.msg,"Qbicles"):cleanBookNotification.error(_L("ERROR_MSG_EXCEPTION_SYSTEM"),"Qbicles");LoadingOverlayEnd()},error:function(){n=!1;cleanBookNotification.error(_L("ERROR_MSG_EXCEPTION_SYSTEM"),"Qbicles");LoadingOverlayEnd()}})},ReSortable:function(){$("#topic-pipeline .column").sortable({connectWith:".column",handle:".portlet-content",revert:0,cancel:".portlet-toggle",placeholder:"portlet-placeholder ui-corner-all",receive:function(n,t){var i=t.item[0];if(i){var r=$(i).attr("avid"),u=$(i).attr("c-topicid"),f=$(i.parentElement).attr("topicid");viewFunc.dragMoveToTopic(f,u,r)}}})}};$(document).ready(function(){$.validator.addMethod("maxlen",function(n,t,i){return n==""||n.length<=i},"Please enter no more than 250 characters.");t.$form_topic_addedit.validate({rules:{Name:{required:!0,minlength:5,maxlength:50}}});t.$form_topic_move.submit(function(t){if(t.preventDefault(),!n){var i=$("#move_cr_topicId").val(),r=$("#move_cr_AvId").val();viewFunc.updateTopic($("#frm_move_topic select[name=topicMoveId]").val(),i,r,!0)}});t.$form_topic_delete.submit(function(t){if(t.preventDefault(),!n){if($("#topicDeleteId").val()=="1"){cleanBookNotification.error(_L("ERROR_MSG_107"),"Qbicles");return}$.LoadingOverlay("show");$.ajax({type:this.method,url:this.action,data:$(this).serialize(),dataType:"json","async":!1,beforeSend:function(){n=!0},success:function(t){if(n=!1,t.result){$("#delete-topic").modal("hide");var i=$("#table-topic-list").DataTable();i.row("#tp"+$("#topicDeleteId").val()).remove();i.draw();cleanBookNotification.success(_L("ERROR_MSG_107"),"Topic");$("#topicDeleteId").val(0)}else t.result===!1&&t.msg?cleanBookNotification.error(t.msg,"Qbicles"):cleanBookNotification.error(_L("ERROR_MSG_EXCEPTION_SYSTEM"),"Qbicles");LoadingOverlayEnd()},error:function(){n=!1;cleanBookNotification.error(_L("ERROR_MSG_EXCEPTION_SYSTEM"),"Qbicles");LoadingOverlayEnd()}})}});$("#topic-add").on("shown.bs.modal",function(){var t=parseInt($("#topicId").val()),n;t>0?($("#topic-add h5.modal-title").text("Edit Topic"),viewFunc.loadTopic(t)):($("#topic-add h5.modal-title").text("Add a Topic"),n="#form_topic_addedit ",$(n+"input[name=Name]").val(""),$(n+"input[name=Summary]").val(""),$(n+"input[name=Id]").val(0))});$("#delete-topic").on("shown.bs.modal",function(){var n=parseInt($("#topicDeleteId").val());n>0&&(viewFunc.countAssociatedActivities(n),viewFunc.InitTopic($("#tp_QbicleId").val(),"lst_topic_delete",n))});$("#move-to-group").on("shown.bs.modal",function(){viewFunc.InitTopic($("#move_tp_QbicleId").val(),"lst_move_topic",$("#move_cr_topicId").val())});t.$form_topic_addedit.submit(function(r){(r.preventDefault(),n)||t.$form_topic_addedit.valid()&&$.ajax({type:this.method,url:this.action,data:$(this).serialize(),dataType:"json","async":!1,beforeSend:function(){n=!0;$.LoadingOverlay("show")},success:function(r){var u,e,f,s,o;n=!1;r.result?($("#topic-add").modal("hide"),viewFunc.resetFormTopic(),cleanBookNotification.success(_L("ERROR_MSG_663"),"Topic"),u=r.Object,u&&(i=="list"?(e='<button class="btn btn-warning" data-toggle="modal" data-target="#topic-add" onclick="$(\'#topicId\').val('+u.Id+')"><i class="fa fa-pencil"><\/i><\/button>',u.Name.toLowerCase()!="general"&&(e+='&nbsp;<button class="btn btn-danger" data-toggle="modal" data-target="#delete-topic" onclick="$(\'#topicDeleteId\').val('+u.Id+');"><i class="fa fa-trash"><\/i><\/button>'),f=$("#table-topic-list").DataTable(),s=f.row.add([u.Name,u.Summary,u.CreatedDate,u.Creator,u.isTrader?'<span class="label label-lg label-info">Trader<\/span>':"",u.Instances,e]).node().id="tp"+u.Id,$("#tp"+u.Id).length>0&&f.row("#tp"+u.Id).remove(),f.draw()):(o='<div class="pipeline-block"><div class="topic-detail">'+u.Name+'<\/div><div class="horizontal-portlets">',o+='<div id="tp_line_'+u.Id+'" topicid="'+u.Id+'" class="column ui-sortable"><\/div><\/div><\/div>',$("#topic-pipeline div.pipeline").append(o),viewFunc.ReSortable()),addTopicToFilter(u.Id,u.Name))):r.result===!1&&r.msg?t.$form_topic_addedit.validate().showErrors({Name:r.msg}):cleanBookNotification.error(_L("ERROR_MSG_EXCEPTION_SYSTEM"),"Qbicles");LoadingOverlayEnd()},error:function(){n=!1;cleanBookNotification.error(_L("ERROR_MSG_EXCEPTION_SYSTEM"),"Qbicles");LoadingOverlayEnd()}})})})});