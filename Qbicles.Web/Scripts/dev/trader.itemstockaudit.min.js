function searchThrottle(n,t){var i=null;return function(){var r=this,u=arguments;clearTimeout(i);i=window.setTimeout(function(){n.apply(r,u)},t||500)}}function onSelectWorkgroupStockAudit(){reloadDataStockAudit()}function reloadDataStockAudit(){$("#stockaudit-table").DataTable().ajax.reload(null,!1)}function addStockAudit(n,t){n||(n=0);var i="/TraderStockAudits/AddStockAudit?id="+n+"&view="+t;$.LoadingOverlay("show");$("#app-trader-inventory-stock-audit").empty();$("#app-trader-inventory-stock-audit").load(i.trim().replace(/\s/g,""),function(){LoadingOverlayEnd()})}function GetProductItems(n,t){var i;n||(n=0);var t=$("#local-manage-select").val(),r="item",f="/Select2Data/GetStockAuditItemsByWorkgroup?workGroupId="+n+"&locationId="+t,e=$("#"+r+" option:not([selected])"),u=[];e.each(function(){var n=$(this);u.push({id:n.attr("value"),text:n.text()})});i={};$("#"+r).select2({ajax:{url:f,dataType:"json",delay:250,data:function(n){return i.keySearch=n.term,i},cache:!0,processResults:function(n){var t=[];return t=t.concat(n.Object),{results:t}}},defaultResults:u})}function ShowGroupMember(){$("#app-trader-workgroup-preview").empty();$("#app-trader-workgroup-preview").load("/TraderTransfers/ShowListMemberForWorkGroup?wgId="+$workgroupId);$("#app-trader-workgroup-preview").modal("toggle")}function WorkGroupSelectedChange(){$workgroupId=$("#workgroup-select").val();$workgroupId!==""&&($("#workgroup-select-error").remove(),RenderAuditWorkgroup(),GetProductItems($workgroupId,$("#local-manage-select").val()))}function addRowItem(){var u,f;$("#tb_form_item").LoadingOverlay("show");u=$("#tb_form_item tbody tr");f=$("#tb_form_item tbody tr td");u.length===1&&f.length===1&&$("#tb_form_item tbody").empty();var t=$("#stockaudit_isstart").val(),i=$("#item").val().split("|"),n={Id:0,Product:{Id:i[0],Name:i[1],SKU:i[2]},OpeningCount:0},r=UniqueId();$.ajax({type:"get",url:"/TraderItem/GetUnitsByItemId?itemId="+n.Product.Id,dataType:"json",success:function(i){var u="";u+='<tr class="tr_'+r+'">';u+='<td class="td_name">';u+='<input type="hidden" value="'+n.Product.Id+'" />';u+="<input type='hidden' id='item-row-id-"+r+"' value='"+n.Product.Id+"|"+n.Product.Name+"|"+n.Product.SKU+"'/>";u+="<span>"+n.Product.Name+"<\/span>";u+="<\/td>";u+='<td class="td_sku"><input type="hidden" value="'+n.Id+'"/><span>'+n.Product.SKU+"<\/span><\/td>";u+='<td class="td_unit">';t=="false"?(u+='<select class="form-control select-modal">',u+=i,u+="<\/select>"):(u+='<select disabled class="form-control select-modal">',u+="<\/select>");u+="<\/td>";u+='<td class="td_open_count">';u+=t=="true"?'<input type="number" name="opening-1" class="form-control" disabled value="'+n.OpeningCount+'">':'<input type="number" name="opening-1" class="form-control" value="'+n.OpeningCount+'">';u+="<\/td>";u+='<td class="td_button">';u+=t=="true"?'<button style="display: none" class="btn btn-danger"> <i class="fa fa-trash"><\/i><\/button> ':'<button style="display: block" onclick="removeRowItem(\''+r+"','"+n.Product.Name+'\')" class="btn btn-danger"> <i class="fa fa-trash"><\/i><\/button> ';u+="<\/td>";u+="<\/tr>";$("#tb_form_item tbody").append(u);$("#tb_form_item tr select").select2();RemoveOptionSelect2("item");document.getElementById("start-audit-button").disabled=!1},error:function(n){$(".preview-workgroup").hide();cleanBookNotification.error("Have an error, detail: "+n.error,"Qbicles")}}).always(function(){$("#tb_form_item").LoadingOverlay("hide",!0);var n=$("#workgroup-select").val();GetProductItems(n,$("#local-manage-select").val())})}function removeRowItem(n){$("#tb_form_item tbody tr.tr_"+n).remove();document.getElementById("start-audit-button").disabled=!0;var t=$("#workgroup-select").val();GetProductItems(t,$("#local-manage-select").val())}function ResetSelectedItems(){var f=$("#tb_form_item tbody tr"),e=$("#tb_form_item tbody tr td"),i,r,t,u,n;if(f.length>=1&&e.length>1){for(i=$("#tb_form_item tbody tr td.td_name input"),r=[],n=0;n<i.length;n++)r.push($(i[n]).val());if(i&&i.length>0){for(t=jQuery.map(lstTraderItems,function(n){if(r.indexOf(n.Id.toString())===-1)return n}),u="",n=0;n<t.length;n++)u+='<option value="'+t[n].Id+"|"+t[n].Name+"|"+t[n].SKU+'">'+t[n].Name+"<\/option>";$("#item").empty();$("#item").append(u)}document.getElementById("start-audit-button").disabled=!1}else document.getElementById("start-audit-button").disabled=!0;$("#item").val("");$("#item").not(".multi-select").select2({placeholder:"Please select"})}function validateForm(){var n=!0;return $("#workgroup-select").val()===""?(n=!1,$("#form_audit").validate().showErrors({workgroup:"Workgroup is required."})):$("#workgroup-select-error").remove(),$("#auditName").val()===""&&(n=!1,$("#form_audit").validate().showErrors({auditname:"Name is required."})),n}function getStockAudit(){var i={Id:$("#stockaudit_id").val(),Name:$("#auditName").val(),Notes:$("#stockaudit_notes").val(),Location:{Id:$("#local-manage-select").val()},WorkGroup:{Id:$("#workgroup-select").val()},ProductList:[],IsStarted:$("#stockaudit_isstart").val()=="true"?!0:!1,IsFinished:$("#stockaudit_isfinish").val()=="true"?!0:!1},t=$("#tb_form_item tbody tr"),r=$("#tb_form_item tbody tr td"),n,u;if(t.length>0&&r&&r.length>1)for(n=0;n<t.length;n++)u={Id:$($(t[n]).find(" td.td_sku input")).val(),Product:{Id:$($(t[n]).find(" td.td_name input")).val()},AuditUnit:{Id:$($(t[n]).find(" td.td_unit select")).val()},OpeningCount:$($(t[n]).find(" td.td_open_count input")).val()},i.ProductList.push(u);return i}function updateVariance(n){var t=parseFloat($("#tb_closing tr.tr_"+n+" td.td_expected").text().replace(/\s/g,"")),i=parseFloat($("#tb_closing tr.tr_"+n+" td.td_closing_count input").val());$("#tb_closing tr.tr_"+n+" td.td_variance span").text((t-i).toFixed(2))}function save(){if(validateForm()){var n=getStockAudit();$.LoadingOverlay("show");$.ajax({type:"post",url:"/TraderStockAudits/SaveStockAudit",data:{stockAudit:n},dataType:"json",success:function(n){LoadingOverlayEnd();n.actionVal===1?($("#app-trader-inventory-stock-audit").modal("toggle"),cleanBookNotification.createSuccess(),showStockAuditTable()):n.actionVal===2?($("#app-trader-inventory-stock-audit").modal("toggle"),cleanBookNotification.updateSuccess(),showStockAuditTable()):n.actionVal===3&&cleanBookNotification.error(_L("ERROR_MSG_EXCEPTION_SYSTEM"),"Qbicles")},error:function(){$.LoadingOverlay("hide");cleanBookNotification.error(_L("ERROR_MSG_EXCEPTION_SYSTEM"),"Qbicles")}})}}function startAudit(){if(validateForm()){var n=getStockAudit();$.LoadingOverlay("show");$.ajax({type:"post",url:"/TraderStockAudits/StartStockAudit",data:{stockAudit:n},dataType:"json",success:function(n){LoadingOverlayEnd();n.actionVal===1?($("#app-trader-inventory-stock-audit").modal("toggle"),cleanBookNotification.createSuccess(),showStockAuditTable()):n.actionVal===2?($("#app-trader-inventory-stock-audit").empty(),addStockAudit(n.msgId),cleanBookNotification.updateSuccess(),$("#app-trader-inventory-stock-audit").modal("toggle"),showStockAuditTable()):n.actionVal===3&&cleanBookNotification.error(n.msg,"Qbicles")},error:function(){$.LoadingOverlay("hide");cleanBookNotification.error(_L("ERROR_MSG_EXCEPTION_SYSTEM"),"Qbicles")}})}}function finishAudit(){var n,u;if(validateForm()){var i={Id:$("#stockaudit_id").val(),Name:$("#auditName").val(),Notes:$("#stockaudit_notes").val(),Location:{Id:$("#local-manage-select").val()},WorkGroup:{Id:$("#workgroup-select").val()},ProductList:[],IsStarted:$("#stockaudit_isstart").val()=="true"?!0:!1,IsFinished:$("#stockaudit_isfinish").val()=="true"?!0:!1},t=$("#tb_closing tbody tr"),r=$("#tb_closing tbody tr td");if(t.length>0&&r&&r.length>1)for(n=0;n<t.length;n++)u={Id:$($(t[n]).find(" td.td_name input")).val(),ClosingCount:$($(t[n]).find(" td.td_closing_count input")).val(),Variance:parseFloat($($(t[n]).find(" td.td_variance span")).text().replace(/\s/g,""))},i.ProductList.push(u);$.LoadingOverlay("show");$.ajax({type:"post",url:"/TraderStockAudits/FinishStockAudit",data:{stockAudit:i},dataType:"json",success:function(n){LoadingOverlayEnd();n.actionVal===1?($("#app-trader-inventory-stock-audit").modal("toggle"),cleanBookNotification.createSuccess(),showStockAuditTable()):n.actionVal===2?($("#app-trader-inventory-stock-audit").modal("toggle"),cleanBookNotification.updateSuccess(),showStockAuditTable()):n.actionVal===3&&cleanBookNotification.error(n.msg,"Qbicles")},error:function(){$.LoadingOverlay("hide");cleanBookNotification.error(_L("ERROR_MSG_EXCEPTION_SYSTEM"),"Qbicles")}})}}var $workgroupId="";$("#search_stockaudit").keyup(searchThrottle(function(){reloadDataStockAudit()}));RenderAuditWorkgroup=function(){var n=$("#workgroup-select").val();n!==""?$.ajax({type:"get",url:"/TraderTransfers/getworkgroup?id="+n,dataType:"json",success:function(n){$(".preview-workgroup").show();n.result?($(".preview-workgroup table tr td.location_name").text(n.Object.Location),$(".preview-workgroup table tr td.workgroup_process").text(n.Object.Process),$(".preview-workgroup table tr td.workgroup_qbicle").text(n.Object.Qbicle),$(".preview-workgroup table tr td.workgroup_member span").text(n.Object.Members)):($(".preview-workgroup table tr td.location_name").text(""),$(".preview-workgroup table tr td.workgroup_process").text(""),$(".preview-workgroup table tr td.workgroup_qbicle").text(""),$(".preview-workgroup table tr td.workgroup_member span").text(""))},error:function(n){$(".preview-workgroup").hide();cleanBookNotification.error("Have an error, detail: "+n.error,"Qbicles")}}):$(".preview-workgroup").hide()};