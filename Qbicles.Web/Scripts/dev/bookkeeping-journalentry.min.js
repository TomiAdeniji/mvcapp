function Random(){for(var n=Math.floor(Math.random()*1e3)*-1;lstNumberRandom.indexOf(n)!==-1;)n=Math.floor(Math.random()*1e3)*-1;return lstNumberRandom.push(n),n}function ClearRandom(){lstNumberRandom=[]}function debitChange(n){trSelect=n.parentElement.parentElement;var i=n,r=$(n).val(),u=$(trSelect).find("td.bkTransactionRowId input.row-index").val(),t=$("#new-journal-entry span.parenttransaction_"+u);t.length>0?$.ajax({type:"get",url:"/BKJournalEntries/GetTaxRate?id=",dataType:"json",success:function(n){var f,u,e,o;if(n!==null)for(f=0;f<t.length;f++)u=t[f].parentElement.parentElement,($(u).find("td.td_debit input").val()>0||$(u).find("td.td_debit input").val()===0&&$(u).find("td.td_credit input").val()===0&&f===0)&&(e=r*(n.Rate/100),$(u).find("td.td_debit input").val(e.toFixed($decimalPlace)),$(u).find("td.td_credit input").val(0)),($(u).find("td.td_credit input").val()>0||$(u).find("td.td_debit input").val()===0&&$(u).find("td.td_credit input").val()===0&&f===1)&&(o=r*(n.Rate/100),$(u).find("td.td_credit input").val(o.toFixed($decimalPlace)),$(u).find("td.td_debit input").val(0));sumDebit(i);sumCredit(null)}}):(sumDebit(i),sumCredit(null))}function creditChange(n){trSelect=n.parentElement.parentElement;var i=$(n).val(),r=n,u=$(trSelect).find("td.bkTransactionRowId input.row-index").val(),t=$("#new-journal-entry span.parenttransaction_"+u);t.length>0?$.ajax({type:"get",url:"/BKJournalEntries/GetTaxRate?id=",dataType:"json",success:function(n){var f,u,e,o;if(n!==null)for(f=0;f<t.length;f++)u=t[f].parentElement.parentElement,($(u).find("td.td_debit input").val()>0||$(u).find("td.td_debit input").val()===0&&$(u).find("td.td_credit input").val()===0&&f===0)&&(e=i*(n.Rate/100),$(u).find("td.td_debit input").val(e.toFixed($decimalPlace)),$(u).find("td.td_credit input").val(0)),($(u).find("td.td_credit input").val()>0||$(u).find("td.td_debit input").val()===0&&$(u).find("td.td_credit input").val()===0&&f===1)&&(o=i*(n.Rate/100),$(u).find("td.td_credit input").val(o.toFixed($decimalPlace)),$(u).find("td.td_debit input").val(0));sumCredit(r);sumDebit(null)}}):(sumCredit(r),sumDebit(null))}function tdchange(){setTimeout(function(){$("tr select").not(".multi-select").select2()},1)}function getAccount(n,t){$.ajax({type:"get",url:"/BKJournalEntries/GetDimensionByAccountId?id="+n,dataType:"html",success:function(n){n!==""&&($(t.children[0]).val(JSON.parse(n)),$("table.datatable select").not(".multi-select").select2())},error:function(n){console.error(n)}});var r=$(trSelect).find("td.bkTransactionRowId input.row-index").val(),i=$("#new-journal-entry span.parenttransaction_"+r);i.length>0&&$.ajax({type:"get",url:"/BKJournalEntries/GetByAccountId?id="+n,dataType:"json",success:function(n){if(n!==""){var t=i[0].parentElement.parentElement;$(t).find("td.td_account input").val(n.Id);$(t).find("td.td_account p").text(n.Name);$(t).find("td.td_account p").removeClass("hidden");$(t).find("td.td_account button.btn-edit").removeClass("hidden");$(t).find("td.td_account button.btn-add").addClass("hidden")}},error:function(n){console.error(n);cleanBookNotification.error("Have an error, detail: "+n.error,"Qbicles")}})}function selectedAccount(n,t,i){td=n;trSelect=td.parentElement;t&&i!==null||(t=0);(t||t===0)&&$.ajax({type:"post",url:"/Bookkeeping/TreeViewAccountByNodeIdPartial",data:{id:t,number:0},dataType:"html",success:function(n){$("#app-bookkeeping-treeview div#templateAccount").empty();$("#app-bookkeeping-treeview div#templateAccount").append(n);loadTreeAccount();t>0&&$.ajax({type:"post",url:"/BKJournalEntries/GetListCoANodeParentId",data:{id:t},dataType:"json",success:function(n){setTimeout(function(){selectNode(n.Object)},100)},error:function(n){return console.error(n),[]}})},error:function(n){return console.error(n),[]}})}function loadTreeAccount(){$(".jstree").jstree({core:{themes:{dots:!0,stripes:!1,variant:"large"}},search:{case_insensitive:!0,show_only_matches:!0},plugins:["themes","search","html_data","ui","wholerow"]});$(".jstree").on("select_node.jstree",function(n,t){t.instance.toggle_node(t.node)}).on("select_node.jstree",function(n,t){t.instance.get_node(t.node,!0).children("a").attr("href")!=="#"&&(document.location=t.instance.get_node(t.node,!0).children("a").attr("href"))});$(".jstree").on("select_node.jstree",function(n,t){var i=t.node.data.node,r=t.node.data.value;selectedNote=t.node.data;i==="BKAccount"&&td!==null&&($($(td).find("input")[0]).val(r),$($(td).find("p")[0]).removeClass("hidden"),$($(td).find("p")[0]).text(selectedNote.name),$($(td).find("button.btn-edit")[0]).removeClass("hidden"),$($(td).find("button.btn-add")[0]).addClass("hidden"))});var n=function(){$(".treeview").fadeIn(800)};setTimeout(n,200);$(".search-tree").keyup(function(){var n=$(this).val();$(".jstree").jstree("search",n)})}function selectNode(n){$("div#jstree_id").jstree("close_all");for(var t=0;t<n.length;t++)t===n.length-1?($("div#jstree_id").jstree("select_node",".groupaccount_"+n[t]),$("div#jstree_id").jstree("open_node",".groupaccount_"+n[t])):$("div#jstree_id").jstree("open_node",".groupaccount_"+n[t])}function selectAccount(n,t){var i=$(td)[0].parentElement.children[7];getAccount(t,i);setTimeout(function(){$("#app-bookkeeping-treeview").modal("toggle");td=null},500)}function initSelectedAccount(){}function sumDebit(n){var r,f,t,u,i,e,o,s;if(n!==null&&(r=n.parentElement.parentElement,f=$(r.children[4].children[0]).val(),f.length>0?$(r.children[5].children[0]).attr("disabled",!0):f.length===0&&$(r.children[5].children[0]).attr("disabled",!1)),t=$("#transaction_table td.td_debit input.table-transaction-debit"),u=0,t.length>0){for(i=0;i<t.length;i++)e=$(t[i]).val()===""?0:$(t[i]).val(),u+=checkformatnumber(e);$("span.sumDedit").text(u.toFixed($decimalPlace))}else $("span.sumDedit").text("0");o=checkformatnumber(u.toFixed($decimalPlace));s=$($("span.sumCredit")[0]).text()==="0"||$($("span.sumCredit")[0]).text()===""?0:checkformatnumber($($("span.sumCredit")[0]).text());o-s==0?($("button.savetemplate").attr("disabled",!1),$("button.submitforreview").attr("disabled",!1)):($("button.savetemplate").attr("disabled",!0),$("button.submitforreview").attr("disabled",!0))}function sumCredit(n){var r,f,t,u,i,e,o,s;if(n!==null&&(r=n.parentElement.parentElement,f=$(r.children[5].children[0]).val(),f.length>0?$(r.children[4].children[0]).attr("disabled",!0):f.length===0&&$(r.children[4].children[0]).attr("disabled",!1)),t=$("#transaction_table td.td_credit input"),u=0,t.length>0){for(i=0;i<t.length;i++)e=$(t[i]).val()===""?0:$(t[i]).val(),u+=checkformatnumber(e);$("span.sumCredit").text(u.toFixed($decimalPlace))}else $("span.sumCredit").text("0");o=checkformatnumber(u.toFixed($decimalPlace));s=$($("span.sumDedit")[0]).text()==="0"||$($("span.sumDedit")[0]).text()===""?0:checkformatnumber($($("span.sumDedit")[0]).text());s-o==0?($("button.savetemplate").attr("disabled",!1),$("button.submitforreview").attr("disabled",!1)):($("button.savetemplate").attr("disabled",!0),$("button.submitforreview").attr("disabled",!0))}function DeleteAllBkTransactionRows(){for(var t,n,i=$("#new-journal-entry table.journal-transactions tbody tr.isSelectedTaxRate_tr"),r=0;n<i.length;r++)i[r].remove();if($("#transaction_table tbody tr").length>2){for(t=$("#transaction_table tbody tr"),n=t.length-1;n>=0;n--)$(t[n]).remove(),$("#attachments-view-"+(n+1)).remove(),sumDebit(null),sumCredit(null);AddNewBkTransactionRow(!0)}}function validAccount(n){for(var r,i,u=$("#transaction_table td.td_account input"),t=0;t<u.length;t++)if($(u[t]).val()==="0")return cleanBookNotification.error(_L("ERROR_MSG_455",[t+1]),"Qbicles"),!1;if(!n)for(r=$("#transaction_table td.td_memo input"),i=0;i<r.length;i++)if($(r[i]).val()==="")return cleanBookNotification.error(_L("ERROR_MSG_456",[t+1]),"Qbicles"),!1;return!0}function checknumber(n,t){var s=$(n).val(),i=t.which,f=!1,r,o,u,e;t.key==="."&&(f=s.indexOf(".")!==-1);r=0;o=n.value.split(".");n.createTextRange?(u=document.selection.createRange().duplicate(),u.moveEnd("character",n.value.length),u.text===""&&(r=n.value.length),r=n.value.lastIndexOf(u.text)):r=n.selectionStart;e=n.value.indexOf(".");r>e&&e>-1&&o[1].length>1&&(f=!0);(i!==8||i===32)&&(i<48&&i!==46||i>57||f)&&t.preventDefault()}function SelectedTaxRate(n){selectedTaxRate=n}function selectedChange(){selectedTaxRate=null}function checkformatnumber(n){if(parseFloat(n)!==0&&(n.indexOf(".")>-1||n.indexOf(",")>-1)){var t=parseFloat(n.replace(",",".")),i=parseFloat(n.replace(".",","));return parseFloat(n)>0?t>i?t:i:t>i?i:t}return parseFloat(n)}function CheckDeleteAllBkTransations(){var n=$("#new-journal-entry table.journal-transactions tbody tr").length,t=$("#new-journal-entry table.journal-transactions tbody tr.isSelectedTaxRate_tr").length;n-t>2?($("#clearAll").attr("disabled",!1),$(".delete_row").attr("disabled",!1)):($("#clearAll").attr("disabled",!0),$(".delete_row").attr("disabled",!0))}function SubmitJournalEntryToReview(){$("#new-journal-entry").valid()&&VerifyJournalPostedDate($("#journal-posted-date-select").val(),1).then(function(n){if(!n.result){LoadingOverlayEnd();return}validAccount()&&$submitReviewModal.modal("toggle")})}function SaveJournalEntryTemplate(){validAccount("template")&&$("#journal-template-modal").modal("toggle")}function SendJournalEntryToReview(){$("#new-journal-entry").valid()&&BkTransactoinProcessForm()}function VerifyJournalPostedDate(n,t){var i=new $.Deferred,e=n,u,f,r,o,s;for((n===null||typeof n=="undefined")&&(e=$("#journal-posted-date-select").val()),u=[],f=$("#transaction_table tbody tr"),r=0;r<f.length;r++)o=f[r],s=$(o).find("td.td_date input").val(),u.push(s);return $.ajax({type:"post",url:"/Bookkeeping/VerifyJournalPostedDate?journalPostedDate="+e,dataType:"json",data:{bkPostedDates:u.toString()},success:function(n){var r,u;if(n.result){if(t===1)return i.resolve(n),!0;r=new Date(Date.parse($("#closed-book-date").val()));r.setDate(r.getDate()+1);$("#journalEntry_PostedDate").data("daterangepicker").remove();$("#journalEntry_PostedDate").daterangepicker({singleDatePicker:!0,minDate:r,timePicker:!0,showDropdowns:!0,autoUpdateInput:!0,cancelClass:"btn-danger",opens:"left",locale:{cancelLabel:"Clear",format:$dateFormatByUser.toUpperCase()+" HH:mm"}}).on("apply.daterangepicker",function(n,t){var i=t.startDate.format($dateFormatByUser.toUpperCase()+" HH:mm");$("#journal-posted-date-select").val(i);VerifyJournalPostedDate(i,1)}).on("cancel.daterangepicker",function(){});return i.resolve(n),!0}cleanBookNotification.warning("Journal date must be constrained to be later than or equal to the latest date time selected for any transaction in the Journal Entry ("+n.msg+")","Qbicles");u=new Date(Date.parse(convertStringToDate(n.msg,getDateTimeFormat())));$("#journalEntry_PostedDate").data("daterangepicker").remove();$("#journalEntry_PostedDate").daterangepicker({singleDatePicker:!0,minDate:new Date(Date.parse(u)),startDate:new Date(Date.parse(u)),timePicker:!0,showDropdowns:!0,autoUpdateInput:!0,cancelClass:"btn-danger",opens:"left",locale:{cancelLabel:"Clear",format:$dateFormatByUser.toUpperCase()+" HH:mm"}}).on("apply.daterangepicker",function(n,t){var i=t.startDate.format($dateFormatByUser.toUpperCase()+" HH:mm");$("#journal-posted-date-select").val(i);VerifyJournalPostedDate(i,1)}).on("cancel.daterangepicker",function(){});return i.resolve(n),!1},error:function(n){console.error(n);i.resolve("");cleanBookNotification.error("Have an error, detail: "+n.error,"Qbicles")}}).always(function(){LoadingOverlayEnd()}),i.promise()}function JournalEntryAddEditConfirmAdd(n){var t=JournalEntryAddEditGetFiles(n);t&&t.length>0?($("#attachments-view-"+n+" ul.domain-change-list").empty(),_.forEach(t,function(t){var i=" <li> <a href='javascript:void(0)'>";i+='<img src="'+t.IconPath+'" style="max-width: 80px; height: auto; padding-right: 10px;">';i+=t.Name+" <\/a> <\/li>";$("#attachments-view-"+n+" ul.domain-change-list").append(i)})):$("ul.domain-change-list").empty()}function JournalEntryAddEditAddAnother(n){var i=$(".attachments_"+n+" input.inputfile"),t='<div class="row attachment_row"> <div class="col-xs-12">';t+='<div class="form-group"> <label for="name">Name<\/label> <input type="text" name="name" class="form-control inputfilename'+(i.length+1)+'">';t+='<\/div> <\/div> <div class="col-xs-12"> <div class="form-group"> <label for="file">File<\/label>';t+='<input type="file" name="file" onchange="JournalEntryAddEditChangeFile(this,'+(i.length+1)+","+n+')" class="form-control inputfile">  <\/div>  <\/div> <\/div>';$(".attachments_"+n+" div.repeater_wrap").append(t)}function JournalEntryAddEditChangeFile(n,t,i){var r=$(".attachments_"+i+" input.inputfilename"+t).val(),u,f;for($(n).length>0&&$(n)[0].files.length>0&&r.lenght===0&&(r=$(n)[0].files[0].name),u=$(".attachments_"+i+" input.inputfile"),f=0;f<u.length;f++)u[0]!==n&&$(u[0]).val()===$(n).val()&&($(n).val(""),r="");$(".attachments_"+i+" .inputfilename"+t).val(r)}function AddNewBkTransactionRow(n){var t,i;$.LoadingOverlay("show");t=$("#new-journal-entry table.journal-transactions tbody tr").length;n?($("#new-journal-entry table.journal-transactions tbody").empty(),t=0):t===1&&$("#new-journal-entry table.journal-transactions tbody tr.odd").length===1?(t=0,$("#new-journal-entry table.journal-transactions tbody").empty()):t=parseInt($($("#new-journal-entry table.journal-transactions tbody tr")[t-1].children[0]).text());i=GenerateUUID();$.ajax({type:"get",url:"/BKJournalEntries/AddNewTableRow?index="+(t+1)+"&rowNewId="+i,dataType:"html",success:function(r){$("#new-journal-entry table.journal-transactions tbody").append(r);$.ajax({type:"get",url:"/BKJournalEntries/AttachmentViewPartial?index="+(t+1)+"&rowNewId="+i,dataType:"html",success:function(t){$("#new-journal-entry").append(t);n&&(n=!1,AddNewBkTransactionRow())},error:function(n){console.error(n)}})},error:function(n){console.error(n)}}).always(function(){CheckDeleteAllBkTransations();LoadingOverlayEnd()})}function SetBkTransactionAttachmentRow(n){td=n;$(n).addClass("currentRowAttachment")}function TrashBkTransactionRow(n,t){var u=$(n).find("td.bkTransactionRowId input").val(),r=$("#new-journal-entry span.parenttransaction_"+u),i;if(r.length)for(i=0;i<r.length;i++)$(r[i].parentElement.parentElement).remove();$("#transaction_table tbody tr").length>2&&($(n).remove(),$("#attachments-view-"+t).remove(),sumDebit(null),sumCredit(null),setTimeout(function(){CheckDeleteAllBkTransations()},100))}function JournalEntryAddEditGetFiles(n){for(var i,e,r,o,u=$("#attachments-view-"+n+" .attachments_"+n+" input.inputfile"),f=[],t=0;t<u.length;t++)u[t].files.length>0?(i=u[t].files[0],fileExtension=i.name.split(".").pop(),e=_.find($qbiclesFileTypes,function(n){return n.Extension===fileExtension}),r={Id:GenerateUUID(),Name:i.name,Extension:i.name.split(".").pop(),Size:i.size,IconPath:e.IconPath,File:i},$("div.attachments_"+n+" .inputfilename"+(t+1)).val()!==""&&(r.Name=$("div.attachments_"+n+" .inputfilename"+(t+1)).val()+"."+fileExtension),f.push(r),$bkTransactionAttachmentsUpload.push(r)):$("#fileid-"+n+"-"+(t+1)).length>0&&(o={Id:$("#fileid-"+n+"-"+(t+1)).val(),Name:$(".inputfilename"+(t+1)).val(),IconPath:$("#inputiconpath_edit"+(t+1)).val()},f.push(o));return f}function BkTransactoinProcessForm(){var r,t,u,o;for($.LoadingOverlay("show"),$bkTransactionAttachmentsUpload=[],$bkTransactions=[],r=$("#transaction_table tbody tr"),t=0;t<r.length;t++){var n=r[t],f=$(n).find("td.td_dimension input.parentid-transaction").val(),s=convertStringToDate($(n).find("td.td_date input").val()),e=$(n).find("td.bkTransactionRowId input").val(),h=e,i={Id:h,Account:{Id:$(n).find("td.td_account input").val()},Reference:$(n).find("td.td_reference input").val(),PostedDate:s,Debit:$(n).find("td.td_debit input").val().replace(",",charDot).replace(".",charDot),Credit:$(n).find("td.td_credit input").val().replace(",",charDot).replace(".",charDot),Memo:$(n).find("td.td_memo input").val(),Dimensions:[],AssociatedFiles:[]};f!==0&&(i.Parent={Id:f});u=$(n).find("td.td_dimension select").val();u!==null&&u.forEach(function(n){i.Dimensions.push({Id:n})});o=JournalEntryAddEditGetFiles(e);i.AssociatedFiles=o;$bkTransactions.push(i)}$bkTransactionAttachmentsUpload.length>0?UploadBatchMediasS3ClientSide($bkTransactionAttachmentsUpload).then(function(){SaveJournalEntry()}):SaveJournalEntry()}function SaveJournalEntry(){var t={Id:$("#journalEntryId").val(),Description:$("#journalEntry_desciption").val(),PostedDate:convertStringToDate($("#journalEntry_PostedDate").val()),Group:{Id:$("#journalEntry_Group").val()},WorkGroup:{Id:$("#bk-worgroup-select").val()}},n=[];_.forEach($bkTransactions,function(t){_.forEach(t.AssociatedFiles,function(n){n.File={}});n.push(t)});$.ajax({type:"post",url:"/BKJournalEntries/SaveJournalEntry",data:{jEntry:t,bKTransactions:n},dataType:"json",success:function(n){n.actionVal===1||n.actionVal===2?($(".qbicle-detail *").prop("disabled",!0),$submitReviewModal.modal("hide"),n.actionVal===1?cleanBookNotification.createSuccess():n.actionVal===2&&cleanBookNotification.updateSuccess(),setTimeout(function(){window.location.href="/Bookkeeping/JournalEntries"},1500)):(console.log(n.msg),cleanBookNotification.error(n.msg,"Qbicles"))},error:function(n){return console.error(n),cleanBookNotification.error("Have an error: "+n.error,"Qbicles"),[]}}).always(function(){LoadingOverlayEnd()})}var td=null,trSelect=null,lstNumberRandom=[],keyword_taxrate="",charDot=".",showtree,selectedTaxRate,$workgroupId,$submitReviewModal,$bkTransactions,$bkTransactionAttachmentsUpload,$qbiclesFileTypes;if(jQuery().jstree){$(".jstree").jstree({core:{themes:{dots:!0,stripes:!1,variant:"large"}},search:{case_insensitive:!0,show_only_matches:!0},plugins:["themes","search","html_data","ui","wholerow"]});$(".jstree").on("select_node.jstree",function(n,t){t.instance.toggle_node(t.node)}).on("select_node.jstree",function(n,t){t.instance.get_node(t.node,!0).children("a").attr("href")!=="#"&&(document.location=t.instance.get_node(t.node,!0).children("a").attr("href"))});showtree=function(){$(".treeview").fadeIn(800)};setTimeout(showtree,200);$(".search-tree").keyup(function(){var n=$(this).val();$(".jstree").jstree("search",n)})}$(".jstree").on("select_node.jstree",function(n,t){var i=t.node.data.node,r=t.node.data.value;selectedNote=t.node.data;i==="BKAccount"&&td!==null&&($($(td).find("input")[0]).val(r),$($(td).find("p")[0]).removeClass("hidden"),$($(td).find("p")[0]).text(selectedNote.name),$($(td).find("button.btn-edit")[0]).removeClass("hidden"),$($(td).find("button.btn-add")[0]).addClass("hidden"))});$("table.datatable select").not(".multi-select").select2();selectedTaxRate=null;$workgroupId=0;ChangeBKWorkgroup=function(){$workgroupId=$("#bk-worgroup-select").val();$workgroupId!==""?($(".submit-for-review").empty(),$.ajax({type:"get",url:"/Bookkeeping/getworkgroup?id="+$workgroupId,dataType:"json",success:function(n){$(".preview-workgroup").show();n.result?($(".preview-workgroup table tr td.workgroup_process").text(n.Object.Process),$(".preview-workgroup table tr td.workgroup_qbicle").text(n.Object.Qbicle),$(".preview-workgroup table tr td.workgroup_member").text(n.Object.Members)):($(".preview-workgroup table tr td.workgroup_process").text(""),$(".preview-workgroup table tr td.workgroup_qbicle").text(""),$(".preview-workgroup table tr td.workgroup_member").text(""));$(".submit-for-review").empty().append(n.msg)},error:function(n){console.error(n);$(".preview-workgroup").hide();cleanBookNotification.error("Have an error, detail: "+n.error,"Qbicles")}})):$(".preview-workgroup").hide()};$submitReviewModal=$("#submit-for-review");$bkTransactions=[];$bkTransactionAttachmentsUpload=[];$qbiclesFileTypes=[];$(document).ready(function(){$qbiclesFileTypes=[];$.ajax({type:"post",url:"/FileTypes/GetFileTypes",dataType:"json",success:function(n){$qbiclesFileTypes=n},error:function(n){console.log(n)}}).always(function(){LoadingOverlayEnd()})});