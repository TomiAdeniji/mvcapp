function UpdateStatusApproval(n){var t=$("#action_approval_default").val();$.LoadingOverlay("show");$("#btn-transfer-approval").prop("disabled",!0);$("#confirm-button-approval").hide();$.ajax({url:"/Qbicles/SetPurchaseTransferApprovalRequest",type:"GET",dataType:"json",data:{appKey:n,status:$("#action_approval").val()},success:function(n){n.actionVal>0&&($("#confirm-button-approval").hide(),location.reload())},error:function(){cleanBookNotification.error(_L("ERROR_MSG_EXCEPTION_SYSTEM"),"Qbicles")}}).always(function(){LoadingOverlayEnd()})}function ShowEditTransfer(n,t){$.LoadingOverlay("show");CheckStatus(t,"Transfer").then(function(i){if(LoadingOverlayEnd(),i.result&&(i.Object=="Pending"||i.Object=="PendingPickup")){var r="/TraderTransfers/TraderTransferAddEdit?locationId="+n+"&id="+t+"&onPage=manage";$.LoadingOverlay("show");$("#app-trader-edit-items").empty();$("#app-trader-edit-items").load(r,function(){LoadingOverlayEnd()})}else i.result&&i.Object!="Pending"&&i.Object!="PendingPickup"?(cleanBookNotification.error(_L("ERROR_MSG_272"),"Qbicles"),setTimeout(function(){window.location.reload()},1e3),$("#app-trader-edit-items").modal("hide")):i.result==!1&&cleanBookNotification.error(_L("ERROR_MSG_380",[i.msg]),"Qbicles")})}function ChangeSelectedUnit(){if($("#item-select").val()===null||$("#item-select").val()===""){resetFormTransfer();return}$("#item_selected").empty();$("#item_selected").load("/TraderTransfers/UnitsSelectByItem?idTraderItem="+$("#item-select").val().split(":")[0])}function InitMessageLocation(){$("#tranfer_form_id").val()==="0"?$("#transfer_type_add").val()==="#outbound"?($("#span-from").text($("#local-manage-select option:selected").text()),$("#span-to").text($("#in-out-location option:selected").text())):$("#transfer_type_add").val()==="#inbound"&&($("#span-to").text($("#local-manage-select option:selected").text()),$("#span-from").text($("#in-out-location option:selected").text())):($("#span-from").text($("#originating-location-select option:selected").text()),$("#span-to").text($("#destination-location-select option:selected").text()));$("#p-confirm-message").removeClass("hidden")}function addRowTransferItem(){var r,u,t,n,f,i;$("#form_add_transaction").valid()&&(r=UniqueId(),u=$("#item_selected select").val(),checkQuantityTransItem($("#form_item_quantity")),t={Id:r,TraderItem:{Id:$("#item-select").val().split(":")[0],ImageUri:$("#item-select option:selected").attr("itemimage"),Name:$("#item-select option:selected").text()},Quantity:parseFloat($("#form_item_quantity").val())},n=$("#tb_form_template tbody tr").clone(),$(n).addClass("tr_id_"+t.Id),$($(n).find("td.row_image div")).attr("style","background-image: url('"+$("#api_url").val()+t.TraderItem.ImageUri+"&size=T');"),$($(n).find("td.row_name")).text(t.TraderItem.Name),$($(n).find("td.row_unit")).empty(),f=$("#item_selected select").clone(),$($(n).find("td.row_unit")).append(f),$($(n).find("td.row_unit select")).val(u),$($(n).find("td.row_unit select")).attr("onchange","rowUnitChange('"+t.Id+"')"),i=$($(n).find("td.row_quantity input")),i.val(t.Quantity),i.attr("onchange","checkQuantityTransItem(this,"+t.TraderItem.Id+")"),$($(n).find("td.row_button button")).attr("onclick","removeRowItem('"+t.Id+"')"),$($(n).find("td.row_button input.traderItem")).val($("#item-select").val()),$($(n).find("td.row_button input.row_id")).val(t.Id),$($(n).find("td select")).not(".multi-select").select2(),$("#tb_form_item tbody").append(n),setTimeout(function(){$("#form_add_transaction")[0].reset();$("#form_add_transaction").validate().resetForm()},100),$("#item-select").val("").trigger("change"),resetFormTransfer())}function checkQuantityTransItem(n,t){var r=$("#transfer_type_add").val();if(r==="#outbound"){var u=$("#destination-location-select").val(),f=$(n).val(),i=$("#item-select").val();i=i&&!t?i.split(":")[0]:t;$.ajax({type:"post",url:"/TraderTransfers/GetCurrentInventory",data:{locationId:u,itemId:i},dataType:"json","async":!1,success:function(t){if(t&&t.currentInventory<f)return cleanBookNotification.error(_L("ERROR_MSG_382",[t.currentInventory]),"Qbicles"),$(n).val(t.currentInventory),$(n).focus(),!1}})}}function nextToItemsTransfer(){setTimeout(function(){$("#form_add_transaction")[0].reset();$("#form_add_transaction select").not(".multi-select").select2();InitTransferItemSelect2Ajax("item-select",$("#trader-group-select").val(),$("#originating-location-select").val())},100)}function nextToConfirm(){loadDataTableConfirm()}function loadDataTableConfirm(){var n,r,t,i;if($("#tb_confirm tbody").empty(),n=$("#tb_form_item tbody tr"),r=$("#tb_form_item tbody tr td"),n.length!==1||r.length!==1)for(t=0;t<n.length;t++)i="<tr> <td>"+$($(n[t]).find("td.row_image")).html()+"<\/td>",i+="<td>"+$($(n[t]).find("td.row_name")).text()+"<\/td> <td>"+$($(n[t]).find("td.row_unit select option:selected")).text()+"<\/td>",i+=" <td>"+$($(n[t]).find("td.row_quantity input")).val()+"<\/td> ",i+="<\/tr>",$("#tb_confirm tbody").append(i)}function removeRowItem(n){$("#tb_form_item tbody tr.tr_id_"+n).remove()}function rowUnitChange(n){var i=$("#tb_form_item tbody tr.tr_id_"+n+" td.row_button input.traderItem").val().split(":"),t=$("#tb_form_item tbody tr.tr_id_"+n+" td.row_unit select").val().split(":");t[1]==="BaseUnit"?$("#tb_form_item tbody tr.tr_id_"+n+" td.row_costperunit input").val(i[3]):t[1]==="Conversion Unit"&&$("#tb_form_item tbody tr.tr_id_"+n+" td.row_costperunit input").val(parseFloat(i[3])*parseFloat(t[3]));updateCost(n)}function SaveTransfer(n){var u=$("#tranfer_form_id").val(),c=!0,e,t,i,f,r,l,a,v,h,p;if($.LoadingOverlay("show"),CheckStatus(u,"Transfer").then(function(n){if(LoadingOverlayEnd(),n.result&&n.Object!="PendingPickup"){cleanBookNotification.error(_L("ERROR_MSG_272"),"Qbicles");$("#btn_change_"+u).addClass("hidden");$("#app-trader-edit-items").modal("hide");c=!1;return}}),c){if(e=[],t=$("#tb_form_item tbody tr"),t.length>0)for(i=0;i<t.length;i++){if(u=parseInt($($(t[i]).find("td.row_button input.row_id")).val()),f={Id:0},$($(t[i]).find("td.row_button input.traderItem")).val().split(":").length>=1?f.Id=$($(t[i]).find("td.row_button input.traderItem")).val().split(":")[0]:f=null,r=$(t[i]).find("td.row_quantity input"),l=$(r).val(),checkQuantityTransItem(r,f.Id),l!=$(r).val()){$(r).focus();$('.admintabs a[href="#transfer-2"]').tab("show");return}a=$($(t[i]).find("td.row_unit select")).val().split("|");v={Id:isNaN(u)?0:u,TraderItem:f,QuantityAtPickup:$(r).val(),Unit:{Id:a[1]}};e.push(v)}if(e.length==0&&n=="PendingPickup"){cleanBookNotification.error("Please add product item.","Qbicles");$('.admintabs a[href="#transfer-2"]').tab("show");return}$.LoadingOverlay("show");var y={},o={},s={};y={Id:$("#trader-group-select").val()};h=$("#tranfer_form_id").val();h==="0"?$("#transfer_type_add").val()==="#inbound"?(o={Id:$("#local-manage-select").val()},s={Id:$("#in-out-location").val()}):$("#transfer_type_add").val()==="#outbound"&&(s={Id:$("#local-manage-select").val()},o={Id:$("#in-out-location").val()}):(s={Id:$("#destination-location-select").val()},o={Id:$("#originating-location-select").val()});p={Id:h,TransferItems:e,Status:n,OriginatingLocation:o,DestinationLocation:s,Workgroup:y};$.ajax({type:"post",url:"/TraderTransfers/SaveTransfer",data:{transfer:p},dataType:"json",success:function(n){LoadingOverlayEnd();n.actionVal===1?($("#app-trader-purchase-transfer").modal("hide"),cleanBookNotification.createSuccess(),setTimeout(function(){window.location.reload(!0)},500)):n.actionVal===2?($("#app-trader-purchase-transfer").modal("hide"),cleanBookNotification.updateSuccess(),setTimeout(function(){window.location.reload(!0)},500)):n.actionVal===3&&cleanBookNotification.error(n.msg,"Qbicles")},error:function(){LoadingOverlayEnd();cleanBookNotification.error(_L("ERROR_MSG_EXCEPTION_SYSTEM"),"Qbicles")}})}}function SavePurchaseTransfer(n){var r,t,f,e;if($.LoadingOverlay("show"),r={},r={Id:$("#transfer-workgroup-select").val()},r.Id==""||r.Id==null)return cleanBookNotification.error(_L("ERROR_MSG_244"),"Qbicles"),!1;var o={Id:$("#purchase-reference_id").val(),NumericPart:parseFloat($("#purchase-refedit").text()),Type:$("#purchase-reference_type").val(),Prefix:$("#purchase-reference_prefix").val(),Suffix:$("#purchase-reference_suffix").val(),Delimeter:$("#purchase-reference_delimeter").val(),FullRef:$("#purchase-reference_fullref").val()},u={Id:$("#transfer_model_id").val(),Status:n,Purchase:{Id:$("#purchase_model_id").val()},TransferItems:[],Workgroup:r,Reference:o},i=$("#transfer_purchase_table tbody tr"),s=$("#transfer_purchase_table tbody tr td");if(i.length>0&&s.length>1)for(t=0;t<i.length;t++)f=$($(i[t]).find("select.transfer_td_tran_unit")).val().split("|"),e={Id:$($(i[t]).find("input.transfer_td_id")).val(),TraderItem:{Id:$($(i[t]).find("input.transfer_td_traderitem_id")).val()},Unit:{Id:f[1]},QuantityAtPickup:$($(i[t]).find("td.transfer_td_tran_quan input")).val(),TransactionItem:{Id:$($(i[t]).find("input.purchaseitem_td_id")).val()}},u.TransferItems.push(e);$.ajax({type:"post",url:"/TraderTransfers/SaveTransfer",data:{transfer:u},dataType:"json",success:function(n){$("#app-trader-purchase-transfer").modal("toggle");LoadingOverlayEnd();n.actionVal===2&&($("#app-trader-purchase-transfer").modal("hide"),cleanBookNotification.updateSuccess(),setTimeout(function(){window.location.reload(!0)},500))},error:function(){LoadingOverlayEnd();cleanBookNotification.error(_L("ERROR_MSG_EXCEPTION_SYSTEM"),"Qbicles")}})}function ShowEditPurchaseTransfer(n,t){var i=$("#transfer_id").val();$.LoadingOverlay("show");CheckStatus(i,"Transfer").then(function(i){if(LoadingOverlayEnd(),i.result&&(i.Object=="Pending"||i.Object=="PendingPickup")){$editMode="Purchase";var r="/TraderTransfers/EditPurchaseTransfer?id="+n+"&idPurchase="+t+"&onPage=manage";$.LoadingOverlay("show");$("#app-trader-purchase-transfer").empty();$("#app-trader-purchase-transfer").load(r,function(){LoadingOverlayEnd()})}else i.result&&i.Object!="Pending"&&i.Object!="PendingPickup"?(cleanBookNotification.error(_L("ERROR_MSG_272"),"Qbicles"),setTimeout(function(){window.location.reload()},1e3),$("#app-trader-purchase-transfer").modal("hide")):i.result==!1&&cleanBookNotification.error(_L("ERROR_MSG_380",[i.msg]),"Qbicles")})}function ShowEditSaleTransfer(n){$editMode="Sale";var t="/TraderTransfers/InitSaleTransfer?key="+n;$.LoadingOverlay("show");$("#app-trader-sale-transfer").empty();$("#app-trader-sale-transfer").load(t,function(){LoadingOverlayEnd()})}function ShowEditSaleTransfer(n,t){$.LoadingOverlay("show");CheckStatus(n,"Transfer").then(function(i){if(LoadingOverlayEnd(),i.result&&(i.Object==="Pending"||i.Object==="PendingPickup")){$editMode="Sale";var r="/TraderTransfers/EditSaleTransfer?id="+n+"&keySale="+t+"&onPage=manage";$.LoadingOverlay("show");$("#app-trader-sale-transfer").empty();$("#app-trader-sale-transfer").load(r,function(){LoadingOverlayEnd()})}else i.result&&i.Object!="PendingPickup"?(cleanBookNotification.error(_L("ERROR_MSG_272"),"Qbicles"),setTimeout(function(){window.location.reload()},1e3),$("#app-trader-sale-transfer").modal("hide")):i.result==!1&&cleanBookNotification.error(_L("ERROR_MSG_EXCEPTION_SYSTEM",[i.msg]),"Qbicles")})}function EditSaleSendToPickup(n){var r={},t,f,e;if(r={Id:$("#transfer-workgroup-select").val()},r.Id==""||r.Id==null)return cleanBookNotification.error(_L("ERROR_MSG_168"),"Qbicles"),!1;var u={Id:$("#transfer_model_id").val(),Status:n,Sale:{Key:$("#sale_model_key").val()},TransferItems:[],Workgroup:r},i=$("#transfer_sale_table tbody tr"),o=$("#transfer_sale_table tbody tr td");if(i.length>0&&o.length>1)for(t=0;t<i.length;t++)f=$($(i[t]).find("select.transfer_td_tran_unit")).val().split("|"),e={Id:$($(i[t]).find("input.transfer_td_id")).val(),TraderItem:{Id:$($(i[t]).find("input.saleitem_td_traderitem_id")).val()},Unit:{Id:f[1]},QuantityAtPickup:$($(i[t]).find("td.transfer_td_tran_quan input")).val(),TransactionItem:{Id:$($(i[t]).find("input.saleitem_td_id")).val()}},u.TransferItems.push(e);$.LoadingOverlay("show");$.ajax({type:"post",url:"/TraderTransfers/SaveTransfer",data:{transfer:u},dataType:"json",success:function(n){$("#app-trader-sale-transfer").modal("toggle");LoadingOverlayEnd();n.actionVal===2&&($("#app-trader-sale-transfer").modal("hide"),cleanBookNotification.updateSuccess(),setTimeout(function(){window.location.reload(!0)},500))},error:function(n){LoadingOverlayEnd();cleanBookNotification.error("Have an error, detail: "+n.error,"Qbicles")}})}function SendToPickup(n){var r,t,f,e;if($.LoadingOverlay("show"),r={Id:$("#transfer-workgroup-select").val()},r.Id==""||r.Id==null)return cleanBookNotification.error(_L("ERROR_MSG_244"),"Qbicles"),!1;var o={Id:$("#sale-reference_id").val(),NumericPart:parseFloat($("#sale-refedit").text()),Type:$("#sale-reference_type").val(),Prefix:$("#sale-reference_prefix").val(),Suffix:$("#sale-reference_suffix").val(),Delimeter:$("#sale-reference_delimeter").val(),FullRef:$("#sale-reference_fullref").val()},u={Id:$("#transfer_model_id").val(),Status:n,Sale:{Key:$("#sale_model_key").val()},TransferItems:[],Workgroup:r,Reference:o},i=$("#transfer_sale_table tbody tr"),s=$("#transfer_sale_table tbody tr td");if(i.length>0&&s.length>1)for(t=0;t<i.length;t++)f=$($(i[t]).find("select.transfer_td_tran_unit")).val().split("|"),e={Id:$($(i[t]).find("input.transfer_td_id")).val(),TraderItem:{Id:$($(i[t]).find("input.saleitem_td_traderitem_id")).val()},Unit:{Id:f[1]},QuantityAtPickup:$($(i[t]).find("td.transfer_td_tran_quan input")).val(),TransactionItem:{Id:$($(i[t]).find("input.saleitem_td_id")).val()}},u.TransferItems.push(e);$.ajax({type:"post",url:"/TraderTransfers/SaveTransfer",data:{transfer:u},dataType:"json",success:function(n){LoadingOverlayEnd();$("#app-trader-sale-transfer").modal("hide");n.actionVal===2?($("#app-trader-purchase-transfer").modal("hide"),cleanBookNotification.updateSuccess(),window.location.reload(!0)):n.actionVal===1&&(cleanBookNotification.createSuccess(),window.location.reload(!0))},error:function(){LoadingOverlayEnd();cleanBookNotification.error(_L("ERROR_MSG_EXCEPTION_SYSTEM"),"Qbicles")}})}function WorkGroupSelectedChange(){$(".preview-workgroup").show();var n=$("#transfer-workgroup-select").val();n!==""?($.LoadingOverlay("show"),$.ajax({type:"get",url:"/TraderTransfers/getworkgroup?id="+n,dataType:"json",success:function(n){LoadingOverlayEnd();n.result?($(".preview-workgroup table tr td.location_name").text(n.Object.Location),$(".preview-workgroup table tr td.workgroup_process").text(n.Object.Process),$(".preview-workgroup table tr td.workgroup_qbicle").text(n.Object.Qbicle),$(".preview-workgroup table tr td.workgroup_member span").text(n.Object.Members)):($(".preview-workgroup table tr td.location_name").text(""),$(".preview-workgroup table tr td.workgroup_process").text(""),$(".preview-workgroup table tr td.workgroup_qbicle").text(""),$(".preview-workgroup table tr td.workgroup_member span").text(""))},error:function(n){LoadingOverlayEnd();cleanBookNotification.error("Have an error, detail: "+n.error,"Qbicles")}})):($(".preview-workgroup table tr td.location_name").text(""),$(".preview-workgroup table tr td.workgroup_process").text(""),$(".preview-workgroup table tr td.workgroup_qbicle").text(""),$(".preview-workgroup table tr td.workgroup_member span").text(""))}function ShowGroupMember(){$("#app-trader-workgroup-preview").empty();$("#app-trader-workgroup-preview").load("/TraderTransfers/ShowListMemberForWorkGroup?wgId="+$("#transfer-workgroup-select").val())}function nextToConfirmP2PEdit(){var n,t,r,i;if($("#tranfer_form_id").val()==="0"?$("#transfer_type_add").val()==="#outbound"?($("#span-from").text($("#local-manage-select option:selected").text()),$("#span-to").text($("#in-out-location option:selected").text())):$("#transfer_type_add").val()==="#inbound"&&($("#span-to").text($("#local-manage-select option:selected").text()),$("#span-from").text($("#in-out-location option:selected").text())):($("#span-from").text($("#originating-location-select option:selected").text()),$("#span-to").text($("#destination-location-select option:selected").text())),$("#p-confirm-message").removeClass("hidden"),$("#div-confirm").empty(),n="<table id='tb_confirm' class='datatable table-hover' style='width: 100%; background: #fff;' data-order='[[1, \"asc\"]]'>",n+="<thead><tr><th data-orderable='false'><\/th><th>Name<\/th><th>Unit<\/th><th>Quantity<\/th><\/tr><\/thead><tbody>",t=$("#tb_form_item tbody tr"),r=$("#tb_form_item tbody tr td"),t.length!==1||r.length!==1){for(i=0;i<t.length;i++)n+="<tr> <td>"+$($(t[i]).find("td.row_image")).html()+"<\/td>",n+="<td>"+$($(t[i]).find("td.row_name")).text()+"<\/td> ",n+="<td>"+$($(t[i]).find("td.row_unit select option:selected")).text()+"<\/td>",n+=" <td>"+$($(t[i]).find("td.row_quantity input")).val()+"<\/td> ",n+="<\/tr>";n+="<\/tbody><\/table>";$("#div-confirm").append(n);$("#tb_confirm").DataTable({responsive:!0,lengthChange:!0,pageLength:10,columnDefs:[{targets:3,orderable:!1}],order:[]})}}function resetPurchaseForm(){$("#cpu").attr("disabled",!0);$("#addNowForm").attr("disabled",!0);$("#label_cost").text("Cost per <selected unit>")}function InitTransferItemSelect2Ajax(n,t,i=0){var r;t==null&&(t=$("select[name=workgroup]").val());t==null&&(t=0);var f="/Select2Data/GetPoint2PointTransferItemsByWorkgroup?workGroupId="+t+"&locationId="+i,e=$("#"+n+" option:not([selected])"),u=[];e.each(function(){var n=$(this);u.push({id:n.attr("value"),text:n.text()})});r={};$("#"+n).not(".multi-select").select2({ajax:{url:f,dataType:"json",delay:250,data:function(n){return r.keySearch=n.term,r},cache:!0,processResults:function(n){var t=[];return t=t.concat(n.Object),n.Object.forEach(function(n){t.push({text:n.Name,itemId:n.Id,itemName:n.Name,itemImage:n.ImageUri,taxName:n.TaxRateName,taxRate:n.TaxRateValue,costUnit:n.CostUnit,value:n.Id,id:n.Id,newTag:!0})}),{results:t}}},defaultResults:u}).on("select2:selecting",function(t){var i=t.params.args.data,r="<option itemId='"+i.itemId+"' selected value='"+i.itemId+"' itemName='"+i.itemName+"' itemImage='"+i.itemImage+"' itemUnit=''>"+i.text+"<\/option>";$("#"+n).html(r);t.preventDefault();$("#"+n).select2("close").trigger("change")}).val(0).trigger("change")}function EditTransferChangeGroup(){InitTransferItemSelect2Ajax("item-select",$("#trader-group-select").val(),$("#originating-location-select").val())}var $traderSaleId=$("#TraderSaleId").val(),$transferId=$("#transfer_id").val(),pageType="purchase",$editMode="Sale",$transferRequirement="";validateItemsInTable=function(){var n=$("#tb_form_item tbody tr");n===null||n.length===0?$(".btnNextConfirm").attr("Disabled","Disabled"):$(".btnNextConfirm").removeAttr("Disabled")};