function UpdateStatusApproval(n){$.LoadingOverlay("show");$.ajax({url:"/Qbicles/SetRequestStatusForApprovalRequest",type:"GET",dataType:"json",data:{appKey:n,status:$("#action_approval").val()},success:function(n){n.actionVal>0&&($.LoadingOverlay("hide"),cleanBookNotification.updateSuccess(),setTimeout(function(){window.location.reload(!0)},500))},error:function(){LoadingOverlayEnd();cleanBookNotification.error(_L("ERROR_MSG_EXCEPTION_SYSTEM"),"Qbicles")}})}function ChangeContact(n){$.LoadingOverlay("show");$("#sale-review-contact").empty();$("#sale-review-contact").load("/TraderSales/TraderSaleReviewContact?id="+n);setTimeout(function(){LoadingOverlayEnd();$("#app-trader-sale-contact").modal("toggle")},500)}function changeDelivery(){$("#contact_address_id").val(0);$(".delivery-stored").hide();$(".delivery-details").fadeIn()}function OnChangeDelivery(){$("#sales_delivery").val()==="Delivery"?$(".delivery-stored").fadeIn():$(".delivery-stored").hide()}function SelectContactChange(n){$(n).val()!==""&&$.ajax({type:"get",url:"/TraderSales/GetContactById?id="+$(n).val(),dataType:"json",success:function(n){var t=n.Name+",<\/br>";n.Address&&(n.Address.AddressLine1&&(t+=",<\/br>"+n.Address.AddressLine1),n.Address.City&&(t+=",<\/br>"+n.Address.City),n.Address.AddressLine2&&(t+=",<\/br>"+n.Address.AddressLine2),n.Address.State&&(t+=",<\/br>"+n.Address.State),n.Address.Country&&(t+=",<\/br>"+n.Address.Country.CommonName),n.Address.PostCode&&(t+=",<\/br>"+n.Address.PostCode));$("#address_info").empty();$("#address_info").append(t)},error:function(){cleanBookNotification.error(_L("ERROR_MSG_EXCEPTION_SYSTEM"),"Qbicles")}})}function UpdateContact(){var n,t;$.LoadingOverlay("show");n={Id:$("#contact_address_id").val()};n.Id==="0"&&(n.AddressLine1=$("#form_contact_address_1").val(),n.AddressLine2=$("#form_contact_address_2").val(),n.City=$("#form_contact_address_city").val(),n.State=$("#form_contact_address_state").val(),n.Country={CommonName:$("#form_contact_address_country").val()},n.PostCode=$("#form_contact_address_postcode").val());t={Id:$traderSaleId,DeliveryAddress:n,DeliveryMethod:$("#sales_delivery").val(),Purchaser:{Id:$("#form_sale_contact").val()}};$.ajax({type:"post",url:"/TraderSales/UpdateTraderSaleContact?countryName="+$("#form_contact_address_country").val(),data:{traderSale:t},dataType:"json",success:function(n){n.actionVal===1&&($("#sale-review-contact-preview").empty(),$("#sale-review-contact-preview").load("/TraderSales/TraderSaleReviewContactPreview?id="+$traderSaleId),setTimeout(function(){$("#app-trader-sale-contact").modal("hide");$.LoadingOverlay("hide")},500));LoadingOverlayEnd()},error:function(){LoadingOverlayEnd();cleanBookNotification.error(_L("ERROR_MSG_EXCEPTION_SYSTEM"),"Qbicles")}})}function ChangeItems(n){$.LoadingOverlay("show");CheckStatus(n,"Sale").then(function(t){LoadingOverlayEnd();t.result&&t.Object==="PendingReview"?($.LoadingOverlay("show"),$("#sale-review-items").empty(),$("#sale-review-items").load("/TraderSales/TraderSaleReviewItems?id="+n,function(){var n=$("#sale-item-workgroup-id").val(),t=$("#sale-item-location-id").val();ResetItemSelected("tb_form_item","item-select-manage",undefined,n,t,!1,!0,!1);$("#sale-review-items-modal").modal("toggle");LoadingOverlayEnd()})):t.result&&t.Object!=="PendingReview"?(cleanBookNotification.error(_L("ERROR_MSG_647"),"Qbicles"),setTimeout(function(){window.location.reload()},1e3)):t.result===!1&&(cleanBookNotification.error(_L("ERROR_MSG_380",[t.msg]),"Qbicles"),window.location.reload())})}function ChangeSelectedUnit(){var t=$("#location-id").val(),n;$("#item_selected").empty();n=$("#item-select-manage").find(":selected").attr("itemId");$("#item_selected").load("/Trader/TraderSaleSelectUnit?idLocation="+t+"&idTraderItem="+n+"&issale=true",function(){GetPriceSale(t,n);$("#form_item_quantity").val("0");$("#form_item_discount").val("0");$("#form_item_dimensions").val([]);$("#form_item_dimensions").not(".multi-select").select2({placeholder:"Please select."})})}function GetPriceSale(n,t){isNaN(t)||($.LoadingOverlay("show"),$.ajax({type:"get",url:"/TraderSales/GetPriceByLocationIdItemId?locationId="+n+"&itemId="+t,dataType:"json",success:function(n){LoadingOverlayEnd();$("#price_id").val(n.Id);$("#price_value").val(n.NetPrice);$("#priceSale").val(n.NetPrice);selectedUnit($("#conversionsunitid option:first").val())},error:function(){LoadingOverlayEnd();selectedUnit($("#conversionsunitid option:first").val())}}))}function selectedUnit(){var n=$("#conversionsunitid").val(),t,i;n===null||n===""?($("#cpu").val(""),$("#label_cost").text("Cost per <selected unit>"),$("#label_price").text("Price per <selected unit>")):(n=$("#conversionsunitid").val().split("|"),$("#label_cost").text("Cost per "+n[2]),$("#label_price").text("Price per "+n[2]),t=0,i=0,n[5]==="true"?(t=parseFloat(n[4]),i=$("#price_value").val(),$("#item_selected input.costunitbase").val(t)):(t=parseFloat(n[3])*parseFloat($("#item_selected input.costunitbase").val()),i=parseFloat(n[3])*parseFloat($("#price_value").val())),isNaN(t)&&(t=0),isNaN(i)&&(i=0),$("#priceSale").val(i),$("#cpu").val(t));enableBtnAddRowTraderItem(!0)}function enableBtnAddRowTraderItem(){var n=$("#conversionsunitid").val(),t=parseFloat($("#form_item_quantity").val());n&&t>0?$("#btnAddRowItem").prop("disabled",!1):$("#btnAddRowItem").prop("disabled",!0)}function addRowItem(){var s=UniqueId(),h=$("#form_item_dimensions").val(),c=$("#item_selected select").val(),r=$("#item-select-manage").find(":selected"),i=r.attr("itemId"),l=r.attr("itemName"),a=r.attr("itemImage"),v=r.attr("taxName"),y=r.attr("taxRate"),p=r.attr("costUnit"),t={Id:s,TraderItem:{Id:i,TaxName:v,ImageUri:a,Name:l,TaxRate:y,CostUnit:p},Discount:isNaN(parseFloat($("#form_item_discount").val()))?0:parseFloat($("#form_item_discount").val()),Dimensions:[],Quantity:parseFloat($("#form_item_quantity").val()),SalePricePerUnit:parseFloat($("#priceSale").val()),Unit:{},PriceBookPrice:{Id:$("#price_id").val(),Value:$("#price_value").val()},CostPerUnit:parseFloat($("#cpu").val().replace(/\,/g,"")),Cost:0,Price:0},w=parseFloat($("#item_selected input.costunitbase").val()),n,f,e,o;t.Cost=(t.CostPerUnit*t.Quantity*(1-t.Discount/100)).toFixed($decimalPlace);var u=parseFloat(t.SalePricePerUnit)*parseFloat(t.Quantity)*(1-parseFloat(t.Discount)/100)*(1+parseFloat(t.TraderItem.TaxRate)/100),b=u/(1+t.TraderItem.TaxRate/100),k=parseFloat(u-b).toFixed($decimalPlace);t.Price=u;n=$("#tb_form_template tbody tr").clone();$(n).attr("id","tr_id_"+i);$($(n).find("td.row_image div")).attr("style","background-image: url('"+$("#api_url").val()+t.TraderItem.ImageUri+"&size=T');");$($(n).find("td.row_name")).text(t.TraderItem.Name);$($(n).find("td.row_unit")).empty();f=$("#item_selected select").clone();$($(n).find("td.row_unit")).append(f);e='<input type="hidden" class="costunitbase" value="'+w+'" />';$($(n).find("td.row_unit")).append(e);$($(n).find("td.row_unit select")).val(c);$($(n).find("td.row_unit select")).attr("onchange","rowUnitChange('#tr_id_"+i+"')");$($(n).find("td.row_costperunit input")).val(t.CostPerUnit);$($(n).find("td.row_costperunit input")).attr("onchange","UpdateCost('#tr_id_"+i+"')");$($(n).find("td.row_costprice input")).val(t.SalePricePerUnit);$($(n).find("td.row_quantity input")).val(t.Quantity);$($(n).find("td.row_quantity input")).attr("onchange","UpdateCost('#tr_id_"+i+"')");$($(n).find("td.row_discount input")).val(t.Discount);$($(n).find("td.row_discount input")).attr("onchange","UpdateCost('#tr_id_"+i+"')");$($(n).find("td.row_taxrate")).text(t.TraderItem.TaxRate);$($(n).find("td.row_taxname")).html(showTaxRatesDetail(t.SalePricePerUnit,t.Quantity,t.Discount,t.TraderItem.TaxName));$($(n).find("td.row_dimensions select")).val(h);$($(n).find("td.row_cost")).text(toCurrencySymbol(t.Cost,!1));$($(n).find("td.row_price input")).val(t.Price.toFixed($decimalPlace)).attr("onchange","UpdateSaleItemReviewedPrice("+i+")");$($(n).find("td.row_button button")).attr("onclick","removeRowItem('#tr_id_"+i+"')");$($(n).find("td.row_button input.traderItem")).val(i);$($(n).find("td.row_button input.row_id")).val(t.Id);$($(n).find("td.row_button input.price_id")).val(t.PriceBookPrice.Id);$($(n).find("td.row_button input.price_Value")).val(t.PriceBookPrice.Value);$($(n).find("td select")).not(".multi-select").select2();o=$("#tb_form_item tbody tr#tr_id_"+i);o.length===0?$("#tb_form_item tbody").append(n):cleanBookNotification.error(_L("ERROR_MSG_373"),"Qbicles");setTimeout(function(){$("#form_add_transaction")[0].reset();$("#form_add_transaction select").not(".multi-select").select2();$("#conversionsunitid").val("");$("#conversionsunitid").select2({placeholder:"Please select"})},100);$("#btnAddRowItem").prop("disabled",!0);setTimeout(function(){var n=$("#sale-item-workgroup-id").val(),t=$("#sale-item-location-id").val();ResetItemSelected("tb_form_item","item-select-manage",undefined,n,t,!1,!0,!1)},200)}function UpdateSaleItemReviewedPrice(n){var i=$("#tb_form_item tbody tr#tr_id_"+n+" td.row_quantity input").val(),r=isNaN($("#tb_form_item tbody tr#tr_id_"+n+" td.row_discount input").val())?0:$("#tb_form_item tbody tr#tr_id_"+n+" td.row_discount input").val(),f=$("#tb_form_item tbody tr#tr_id_"+n+" td.row_taxrate").text(),s=$("#tb_form_item tbody tr#tr_id_"+n+" td.row_taxname .txt-taxname").val(),u=$("#tb_form_item tbody tr#tr_id_"+n+" td.row_price input").val(),e=$("#tb_form_item tbody tr#tr_id_"+n+" td.row_costprice input").val(),t,o;isNaN(i)||isNaN(r)||isNaN(u)||i==0||r==100||f==-100||(t=r,u==0?(t=100,$("#tb_form_item tbody tr#tr_id_"+n+" td.row_discount input").val(t)):(o=Number(i)*Number(e)*(1+f/100),t=((1-Number(u)/o)*100).toFixed($decimalPlace),$("#tb_form_item tbody tr#tr_id_"+n+" td.row_discount input").val(t)),$("#tb_form_item tbody tr#tr_id_"+n+" td.row_taxname").html(showTaxRatesDetail(e,i,t,s)))}function rowUnitChange(n){var u,t,i,r;isNaN(parseFloat(n.toString()))||(n="#tr_id_"+n);u=$("#tb_form_item tbody tr"+n+" td.row_button input.traderItem").val().split("|");t=$("#tb_form_item tbody tr"+n+" td.row_unit select").val().split("|");t[1]==="BaseUnit"?$("#tb_form_item tbody tr"+n+" td.row_costperunit input").val(u[3]):t[1]==="Conversion Unit"&&$("#tb_form_item tbody tr"+n+" td.row_costperunit input").val(parseFloat(u[3])*parseFloat(t[3]));i=0;r=0;t[5]==="true"?(i=parseFloat(t[4]),r=$("#tb_form_item tbody tr"+n+" td.row_button input.price_Value").val(),$("#tb_form_item tbody tr"+n+" td.row_unit input.costunitbase").val(i)):(i=parseFloat(t[3])*parseFloat($("#tb_form_item tbody tr"+n+" td.row_unit input.costunitbase").val()),r=parseFloat(t[3])*parseFloat($("#tb_form_item tbody tr"+n+" td.row_button input.price_Value").val()));$("#tb_form_item tbody tr"+n+" td.row_costperunit input").val(i);$("#tb_form_item tbody tr"+n+" td.row_costprice input").val(r);UpdateCost(n)}function UpdateCost(n){var t=$("#tb_form_item tbody tr"+n+" td.row_costprice input").val(),i=$("#tb_form_item tbody tr"+n+" td.row_quantity input").val(),r=$("#tb_form_item tbody tr"+n+" td.row_discount input").val(),f=$("#tb_form_item tbody tr"+n+" td.row_taxrate").text(),u,e;isNaN(parseFloat(t))||isNaN(parseFloat(i))||isNaN(parseFloat(r))||isNaN(parseFloat(f))||(u=parseFloat(t)*parseFloat(i)*(1-parseFloat(r)/100)*(1+parseFloat(f)/100),$("#tb_form_item tbody tr"+n+" td.row_cost").text(toCurrencyDecimalPlace(u)),$("#tb_form_item tbody tr"+n+" td.row_price input").val(u.toFixed($decimalPlace)),e=$("#tb_form_item tbody tr"+n+" td.row_taxname input.txt-taxname").val(),$("#tb_form_item tbody tr"+n+" td.row_taxname").html(showTaxRatesDetail(t,i,r,e)))}function updatePriceCost(n){var t=$("#tb_form_item tbody tr"+n+" td.row_costprice input").val(),i=$("#tb_form_item tbody tr"+n+" td.row_quantity input").val(),r=$("#tb_form_item tbody tr"+n+" td.row_discount input").val(),f=$("#tb_form_item tbody tr"+n+" td.row_taxrate").text(),u,e;isNaN(parseFloat(t))||isNaN(parseFloat(i))||isNaN(parseFloat(r))||isNaN(parseFloat(f))||(u=parseFloat(t)*parseFloat(i)*(1-parseFloat(r)/100)*(1+parseFloat(f)),$("#tb_form_item tbody tr"+n+" td.row_cost").text(toCurrencySymbol(u,!1)),$("#tb_form_item tbody tr"+n+" td.row_price input").text(u.toFixed($decimalPlace)),e=$("#tb_form_item tbody tr"+n+" td.row_taxname input.txt-taxname").val(),$("#tb_form_item tbody tr"+n+" td.row_taxname").html(showTaxRatesDetail(t,i,r,e)))}function removeRowItem(n){$("#tb_form_item tbody tr"+n).remove();var t=$("#sale-item-workgroup-id").val(),i=$("#sale-item-location-id").val();ResetItemSelected("tb_form_item","item-select-manage",undefined,t,i,!1,!0,!1)}function UpdateItems(){$.LoadingOverlay("show");var n=$("#TraderSaleId").val();CheckStatus(n,"Sale").then(function(n){var o,t,i,s,u,h,r,f,e,c,l,a;if(LoadingOverlayEnd(),n.result&&n.Object==="PendingReview"){if($.LoadingOverlay("show"),o=[],t=$("#tb_form_item tbody tr"),t.length>0)for(i=0;i<t.length;i++){if(s=parseInt($($(t[i]).find("td.row_button input.row_id")).val()),u={Id:0},$($(t[i]).find("td.row_button input.traderItem")).val()!==null?u.Id=$($(t[i]).find("td.row_button input.traderItem")).val():u=null,h=$($(t[i]).find("td.row_quantity input")).val(),parseFloat(h)<=0){$.LoadingOverlay("hide");cleanBookNotification.error(_L("ERROR_MSG_637"),"Qbicles");return}if(r=$($(t[i]).find("td.row_dimensions select")).val(),f=[],r&&r.length>0)for(e=0;e<r.length;e++)f.push({Id:r[e]});if(f.length===0){$.LoadingOverlay("hide");cleanBookNotification.error(_L("ERROR_MSG_635"),"Qbicles");return}c=$($(t[i]).find("td.row_unit select")).val().split("|");l={Id:isNaN(s)?0:s,TraderItem:u,Discount:stringToNumber($($(t[i]).find("td.row_discount input")).val()),Dimensions:f,Quantity:stringToNumber(h),Unit:{Id:c[1]},CostPerUnit:stringToNumber($(t[i]).find("td.row_costperunit input").val()),SalePricePerUnit:stringToNumber($($(t[i]).find("td.row_costprice input")).val()),Cost:stringToNumber($($(t[i]).find("td.row_cost")).text()),Price:stringToNumber($($(t[i]).find("td.row_price input")).val()),PriceBookPrice:{Id:$($(t[i]).find("td.row_button input.price_id")).val()},PriceBookPriceValue:$($(t[i]).find("td.row_button input.price_Value")).val()};o.push(l)}a={Id:$traderSaleId,SaleItems:o,SaleTotal:SaleTotal()};$.ajax({type:"post",url:"/TraderSales/UpdateTraderSaleItems",data:{traderSale:a},dataType:"json",success:function(n){n.actionVal===1?($("#table-sale-review-items-preview").empty(),$("#table-sale-review-items-preview").load("/TraderSales/TraderSaleReviewItemsPreview?id="+$traderSaleId),setTimeout(function(){LoadingOverlayEnd();$("#sale-review-items-modal").modal("hide")},500),$("#sale-total h3").text(toCurrencySymbol(SaleTotal()))):n.actionVal===3?(LoadingOverlayEnd(),cleanBookNotification.error(n.msg,"Qbicles")):LoadingOverlayEnd()},error:function(){LoadingOverlayEnd();cleanBookNotification.error(_L("ERROR_MSG_EXCEPTION_SYSTEM"),"Qbicles")}})}else n.result&&n.Object!=="PendingReview"?cleanBookNotification.error(_L("ERROR_MSG_272"),"Qbicles"):n.result===!1&&cleanBookNotification.error(_L("ERROR_MSG_380",n.msg),"Qbicles")})}function ShowGroupMember(){$("#app-trader-workgroup-preview").empty();$("#app-trader-workgroup-preview").load("/TraderTransfers/ShowListMemberForWorkGroup?wgId="+$("#transfer-workgroup-select").val())}function InitTransfer(n){$("#app-trader-sale-transfer").empty();$("#app-trader-sale-transfer").load("/TraderTransfers/InitSaleTransfer?key="+n)}function EditTransfer(n,t){$("#app-trader-sale-transfer").empty();$("#app-trader-sale-transfer").load("/TraderTransfers/EditSaleTransfer?id="+n+"&keySale="+t)}function WorkGroupSelectedChange(){$(".preview-workgroup").show();var n=$("#transfer-workgroup-select").val();n!==""?($.LoadingOverlay("show"),$.ajax({type:"get",url:"/TraderTransfers/getworkgroup?id="+n,dataType:"json",success:function(n){n.result?($(".preview-workgroup table tr td.location_name").text(n.Object.Location),$(".preview-workgroup table tr td.workgroup_process").text(n.Object.Process),$(".preview-workgroup table tr td.workgroup_qbicle").text(n.Object.Qbicle),$(".preview-workgroup table tr td.workgroup_member span").text(n.Object.Members)):($(".preview-workgroup table tr td.location_name").text(""),$(".preview-workgroup table tr td.workgroup_process").text(""),$(".preview-workgroup table tr td.workgroup_qbicle").text(""),$(".preview-workgroup table tr td.workgroup_member span").text(""));LoadingOverlayEnd()},error:function(){LoadingOverlayEnd();cleanBookNotification.error(_L("ERROR_MSG_EXCEPTION_SYSTEM"),"Qbicles")}})):($(".preview-workgroup table tr td.location_name").text(""),$(".preview-workgroup table tr td.workgroup_process").text(""),$(".preview-workgroup table tr td.workgroup_qbicle").text(""),$(".preview-workgroup table tr td.workgroup_member span").text(""))}function SendToPickup(n){var r={},t,f,e;if(r={Id:$("#transfer-workgroup-select").val()},r.Id===""||r.Id===null)return cleanBookNotification.error(_L("ERROR_MSG_168"),"Qbicles"),!1;var o={Id:$("#sale-reference_id").val(),NumericPart:parseFloat($("#sale-refedit").text()),Type:$("#sale-reference_type").val(),Prefix:$("#sale-reference_prefix").val(),Suffix:$("#sale-reference_suffix").val(),Delimeter:$("#sale-reference_delimeter").val(),FullRef:$("#sale-reference_fullref").val()},u={Id:$("#transfer_model_id").val(),Status:n,Sale:{Key:$("#sale_model_key").val()},TransferItems:[],Reference:o,Workgroup:r},i=$("#transfer_sale_table tbody tr"),s=$("#transfer_sale_table tbody tr td");if(i.length>0&&s.length>1)for(t=0;t<i.length;t++)f=$($(i[t]).find("select.transfer_td_tran_unit")).val().split("|"),e={Id:$($(i[t]).find("input.transfer_td_id")).val(),TraderItem:{Id:$($(i[t]).find("input.saleitem_td_traderitem_id")).val()},Unit:{Id:f[1]},QuantityAtPickup:$($(i[t]).find("td.transfer_td_tran_quan input")).val(),TransactionItem:{Id:$($(i[t]).find("input.saleitem_td_id")).val()}},u.TransferItems.push(e);$.LoadingOverlay("show");$.ajax({type:"post",url:"/TraderTransfers/SaveTransfer",data:{transfer:u},dataType:"json",success:function(n){LoadingOverlayEnd();reloadTableTransfer();$("#app-trader-sale-transfer").modal("hide");n.actionVal===2?($("#app-trader-purchase-transfer").modal("hide"),cleanBookNotification.updateSuccess()):n.actionVal===1&&cleanBookNotification.createSuccess()},error:function(){LoadingOverlayEnd();cleanBookNotification.error(_L("ERROR_MSG_EXCEPTION_SYSTEM"),"Qbicles")}})}function reloadTableTransfer(){$("#table_transfer").empty();$("#table_transfer").load("/TraderTransfers/GetTableTransfer?id="+$("#TraderSaleId").val()+"&callBack=true")}function checknumber(n,t,i){var r=t.which,u=$(n).val().trim(),f=!1;r===48&&(f=!0);r===46&&u.indexOf(".")>0?t.preventDefault():r>=48&&r<=57||r===8||r===32||r===44||r===46?r===44&&u.indexOf(".")>0?t.preventDefault():ChangeInvoiceValue(n,i,0)||t.preventDefault():t.preventDefault()}function AddInvoice(n,t){$.LoadingOverlay("show");$("#app-trader-invoice-add").empty();$("#app-trader-invoice-add").load("/TraderSales/InitSaleInvoice?id="+n+"&saleKey="+t,function(){initTableInvoice(t,n);LoadingOverlayEnd()})}function initTableInvoice(n,t){var i=$("#table_invoiceitems").DataTable({ajax:"/TraderSales/GetInvoiceItemsFromSale?saleKey="+n+"&invoiceId="+t,columns:[{data:"InvoiceChecked",orderable:!1,render:function(n){return'<div class="checkbox toggle"><label><input class="rowmask invoice_checked trackChecked" data-toggle="toggle" data-onstyle="success" data-on="True" data-off="False" type="checkbox" '+(n?"checked":"")+"><\/label><\/div>"}},{data:"TransItemUri",orderable:!1,render:function(n){return'<div class="table-avatar" style="background-image: url(\''+n+"');\"><\/div>"}},{data:"TransItemName"},{data:"TransItemUnitName"},{data:"PricePerUnit",render:function(n){return toCurrencyDecimalPlace(n)}},{data:"TransItemQuantity"},{data:"TransItemDiscount"},{data:"TransItemHtmlTaxRates"},{data:"TransItemCost"},{data:"InvoiceQuantity",render:function(n,t,i){return'<input id="ivQuantityVal-'+i.TransItemId+'" type="text" onkeypress="numberKeyPress(event)" value="'+toCurrencyDecimalPlace(n)+'" name="invqty" min="0" maxlength="15" class="form-control invoice_quantity trackQuantity isnumber" style="width: 110px;">'}},{data:"InvoiceTaxes",render:function(n,t,i){return'<span id="ivTaxesVal-'+i.TransItemId+'">'+toCurrencyDecimalPlace(n)+"<\/span>"}},{data:"InvoiceDiscount",render:function(n,t,i){return'<span id="ivDiscountVal-'+i.TransItemId+'">'+toCurrencyDecimalPlace(n)+"<\/span>"}},{data:"InvoiceCost",render:function(n,t,i){return'<span id="ivCostVal-'+i.TransItemId+'">'+toCurrencyDecimalPlace(n)+"<\/span>"}}],drawCallback:function(){$(".trackChecked").on("change",function(){var n=$(this).parents("tr"),t=$("#table_invoiceitems").DataTable().row(n).data();t.InvoiceChecked=$(this).prop("checked")?!0:!1});$(".trackQuantity").on("change",function(){var t=$(this).parents("tr"),u=$("#table_invoiceitems").DataTable().row(t),n=u.data();let r=$(this).val().replace(/\,/g,"");n.InvoiceQuantity=parseFloat(r?r:0);n.InvoiceQuantity>n.TransItemQuantity&&(n.InvoiceQuantity=n.TransItemQuantity,$("#ivQuantityVal-"+n.TransItemId).val(toCurrencyDecimalPlace(n.InvoiceQuantity)));let i=n.PricePerUnit*n.InvoiceQuantity;n.InvoiceDiscount=i*(n.TransItemDiscount/100);n.InvoiceTaxes=(i-n.InvoiceDiscount)*n.TransItemSumValTaxRates;n.InvoiceCost=i*(1-n.TransItemDiscount/100)*(1+n.TransItemSumValTaxRates);$(t).LoadingOverlay("show");$("#ivTaxesVal-"+n.TransItemId).text(toCurrencyDecimalPlace(n.InvoiceTaxes));$("#ivDiscountVal-"+n.TransItemId).text(toCurrencyDecimalPlace(n.InvoiceDiscount));$("#ivCostVal-"+n.TransItemId).text(toCurrencyDecimalPlace(n.InvoiceCost));$(t).LoadingOverlay("hide")})}});i.on("draw.dt",function(){$(".invoice_checked").bootstrapToggle()})}function EditInvoice(n,t){$.LoadingOverlay("show");$("#app-trader-invoice-add").empty();$("#app-trader-invoice-add").load("/TraderSales/InitSaleInvoice?id="+n+"&saleKey="+t,function(){initTableInvoice(t,n);LoadingOverlayEnd()})}function SaveInvoice(n){var t={};if(t={Id:$("#transfer-workgroup-select").val()},t.Id===""||t.Id===null)return cleanBookNotification.error(_L("ERROR_MSG_168"),"Qbicles"),!1;$.LoadingOverlay("show");var r=moment($("#invoice_dueDate").val(),$dateFormatByUser.toUpperCase()),u=moment(r).format("YYYY/MM/DD"),f={Id:$("#referenceInvoice_id").val(),NumericPart:parseFloat($("#refeditInvoice").text()),Type:$("#referenceInvoice_type").val(),Prefix:$("#referenceInvoice_prefix").val(),Suffix:$("#referenceInvoice_suffix").val(),Delimeter:$("#referenceInvoice_delimeter").val(),FullRef:$("#referenceInvoice_fullref").val()},i={Key:$("#invoice_key").val(),Status:n,Sale:{Key:$("#sale_key").val()},InvoiceItems:[],DueDate:u,Reference:f,InvoiceAddress:$("#invoice_address").val(),PaymentDetails:$("#invoice_paymentdetails").val(),Workgroup:t},e=$("#table_invoiceitems").DataTable();e.rows().every(function(){const n=this.data();if(n.InvoiceChecked){var t={Id:n.Id,TransactionItem:{Id:n.TransItemId},InvoiceValue:n.InvoiceCost,InvoiceDiscountValue:n.InvoiceDiscount,InvoiceItemQuantity:n.InvoiceQuantity,InvoiceTaxValue:n.InvoiceTaxes};t.InvoiceValue&&t.InvoiceValue!==""||(t.InvoiceValue=0);i.InvoiceItems.push(t)}});$.ajax({type:"post",url:"/TraderSales/SaveSaleInvoice?saleKey="+$("#sale_key").val(),data:{invoice:i},dataType:"json",success:function(n){LoadingOverlayEnd();$("#app-trader-invoice-add").modal("toggle");n.actionVal===1?cleanBookNotification.createSuccess():n.actionVal===2&&cleanBookNotification.updateSuccess();reloadTableInVoice()},error:function(){LoadingOverlayEnd();cleanBookNotification.error(_L("ERROR_MSG_EXCEPTION_SYSTEM"),"Qbicles")}})}function reloadTableInVoice(){$("#table_invoice").empty();$("#table_invoice").load("/TraderSales/GetTableInvoice?key="+$("#TraderSaleKey").val()+"&callBack=true")}function ClearText(){$("#sale-order-additions").val("")}function SaveSaleOrder(n){$.LoadingOverlay("show");var t={Id:$("#referenceSale_id").val(),NumericPart:parseFloat($("#refeditSale").text()),Type:$("#referenceSale_type").val(),Prefix:$("#referenceSale_prefix").val(),Suffix:$("#referenceSale_suffix").val(),Delimeter:$("#referenceSale_delimeter").val(),FullRef:$("#referenceSale_fullref").val()},i={Sale:{Id:n},AdditionalInformation:$("#sale-order-additions").val(),Reference:t};$.ajax({type:"post",url:"/TraderSales/SaveSaleOrder",datatype:"json",data:i,success:function(n){LoadingOverlayEnd();n.result&&(cleanBookNotification.createSuccess(),setTimeout(function(){window.location.href="/TraderSales/SaleOrder?id="+n.msgId},1e3))},error:function(n){LoadingOverlayEnd();cleanBookNotification.error(n.responseText,"Qbicles")}})}function IssueSaleOrder(n){var t=$("#mail-addresses").val(),i;if(t.length>0&&(i=validateEmails(t),i.length>0)){cleanBookNotification.error("Email format is not correct:'\n'"+i,"Qbicles");return}$("#adding-other-mail-addresses").LoadingOverlay("show");setTimeout(function(){$("#sale-order-template").removeClass("hidden");$.ajax({url:"/TraderSales/IssueSaleOrder",type:"POST",dataType:"json",data:{id:n,emails:t},success:function(n){n.result&&(cleanBookNotification.updateSuccess(),$("#adding-other-mail-addresses").modal("hide"))},error:function(n){$("#sale-order-template").addClass("hidden");cleanBookNotification.error(n.responseText,"Qbicles");cleanBookNotification.error(_L("ERROR_MSG_EXCEPTION_SYSTEM"),"Qbicles")}}).always(function(){$("#adding-other-mail-addresses").LoadingOverlay("hide")})},500)}function OpenIssueSaleOrderModal(){$("#mail-addresses").text("");$("#mail-addresses").val("");$("#adding-other-mail-addresses").modal("show")}var $editMode="Sale",$transferRequirement="",$traderSaleId=$("#TraderSaleId").val();SaleTotal=function(){var t=$("#tb_form_item tbody tr"),r=$("#tb_form_item tbody tr td"),i=0,n;if(t.length===1&&r.length===1)return 0;for(n=0;n<t.length;n++)i+=stringToNumber($($(t[n]).find("td.row_price input")).val());return i};