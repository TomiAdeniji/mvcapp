function SaveQbicleSettingsEdit(){if($form.valid()){var n=$("#qbicId"),t=$("#qbicName");$.ajax({url:"/Qbicles/DuplicateQbicleNameCheck",data:{key:n.val(),qbicName:t.val()},type:"GET",dataType:"json","async":!1}).done(function(n){n.result?$form.validate().showErrors({Name:_L("ERROR_MSG_50")}):ProcessQbicleLogoEdit()}).fail(function(){$form.validate().showErrors({Name:_L("ERROR_MSG_42")})})}}function QbiclesSettingsSubmitEdit(){var n=new FormData(document.getElementById("form_qbicle_addedit"));$.ajax({type:"post",cache:!1,url:"/Qbicles/SaveQbicle",enctype:"multipart/form-data",data:n,processData:!1,contentType:!1,beforeSend:function(){},success:function(n){n.result?($qbicleModal.modal("toggle"),cleanBookNotification.updateSuccess(),location.reload()):cleanBookNotification.error(_L("ERROR_MSG_EXCEPTION_SYSTEM"),"Qbicles")},error:function(){cleanBookNotification.error(_L("ERROR_MSG_EXCEPTION_SYSTEM"),"Qbicles")}}).always(function(){LoadingOverlayEnd()})}function ProcessQbicleLogoEdit(){$.LoadingOverlay("show");var n=document.getElementById("qbicle-upload-logo").files;n&&n.length>0?UploadMediaS3ClientSide("qbicle-upload-logo").then(function(n){if(n.objectKey==="no_image"||n.objectKey==="no-image"){LoadingOverlayEnd("hide");cleanBookNotification.error(_L("ERROR_MSG_S3_UPLOAD"),"Qbicles");return}$("#qbicle-logo-uri").val(n.objectKey);QbiclesSettingsSubmitEdit()}):QbiclesSettingsSubmitEdit()}function GetQbicle(n){return $.ajax({url:"/Qbicles/GetQbicle",type:"GET",dataType:"json",data:{key:n}})}var $qbicleModal=$("#edit-qbicle"),$form=$("#form_qbicle_addedit");$(document).ready(function(){function n(n,t){if(n.files&&n.files[0]){var i=new FileReader;i.onload=function(n){$(t).attr("src",n.target.result)};i.readAsDataURL(n.files[0])}}function t(n){if(!n.id)return n.text;var t=n.element.attributes.avatarUrl.value;return $('<div class="select2imgwrap"><div class="select2img" style="background-image: url(\''+t.toLowerCase()+'\');"><\/div> <span class="select2text">'+n.text+"<\/span><\/div>")}function i(n){if(!n.id)return n.text;var t=n.element.attributes.avatarUrl.value;return $('<div class="select2imgwrap"><div class="select2img mini" style="background-image: url(\''+t.toLowerCase()+'\');"><\/div> <span class="select2text">'+n.text+"<\/span><\/div>")}$(".previewimg").change(function(){var t=$(this).data("target");n(this,t);$(t).fadeIn()});$(".select2avatar-setting").select2({placeholder:"Please select",templateResult:t,templateSelection:i});$qbicleModal.on("show.bs.modal",function(){var f=$("#qbicId"),n=$("#qbicName"),e=$("#qbicleImg"),t=$("#qbicDescription"),o=$(".qbicle-title"),i=$("#qbicUserDomainSelect"),r=$("#qbicOwnerSelect"),u=$("#loadingSettings");n.hide();t.hide();$("#q-name").hide();$("#q-des").hide();$("#qbicle-upload-logo").hide();$("#q-i-change").hide();$("#q-i-pre").hide();i.next().hide();u.show();GetQbicle(f.val()).done(function(f){var a,v,s,c,l,h;if(f.QbicleKey){if(f.IsMemberQbicle?(n.show(),t.show(),$("#qbicle-upload-logo").show(),$("#q-i-change").show()):($("#q-name").show(),$("#q-i-pre").show(),$("#q-des").show()),$("#q-name").text(f.Name),$("#q-des").text(f.Description),n.val(f.Name),t.val(f.Description),e.attr("src",f.LogoUri),o.text(f.Name),a=f.CubeUser.split(","),i.val(a).change(),v=$("#api-uri").val(),s=f.QbicManager,s.length>0){for(c="",$("#qbicOwnerSelect option").remove(),l='<option value=""><\/option>',h=0;h<s.length;++h)c=s[h].Id==f.Manager?"selected":"",l+="<option "+c+' avatarUrl="'+v+""+s[h].ProfilePic+'" value="'+s[h].Id+'">'+s[h].Forename+" "+s[h].Surname+"<\/option>";r.append(l)}r.val(f.Manager).change();i.next().show();u.hide();$form.valid();$form.validate().resetForm()}})})});