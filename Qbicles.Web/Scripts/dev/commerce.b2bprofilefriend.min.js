function toggleCollapse(){var n=$(this).attr("aria-expanded");n=="true"?($('a[data-toggle="collapse"]').attr("aria-expanded","false"),$(this).attr("aria-expanded","false")):($('a[data-toggle="collapse"]').attr("aria-expanded","false"),$(this).attr("aria-expanded","true"))}function initFormPartnershipLogistics(){$frmpartnershiplogistics.validate({rules:{ConsumerLocations:{required:!0},ProviderLocations:{required:!0}}});$frmpartnershiplogistics.submit(function(n){(n.preventDefault(),isBusy)||$frmpartnershiplogistics.valid()&&($.LoadingOverlay("show"),$.ajax({type:this.method,cache:!1,url:this.action,data:$(this).serialize(),dataType:"json",beforeSend:function(){isBusy=!0},success:function(n){n.result?($("#b2b-form-partnership-logistics").modal("hide"),$(".aboutreq").hide(),$(".reqsent").fadeIn(),cleanBookNotification.success(_L("UPDATE_MSG_SUCCESS"),"Commerce")):!n.result&&n.msg?cleanBookNotification.error(n.msg,"Trader"):cleanBookNotification.error(_L("ERROR_MSG_EXCEPTION_SYSTEM"),"Commerce");isBusy=!1;LoadingOverlayEnd()},error:function(){isBusy=!1;cleanBookNotification.error(_L("ERROR_MSG_EXCEPTION_SYSTEM"),"Commerce");LoadingOverlayEnd()}}))})}function initTradingItems(){var n=$("#tblB2bTradingItems");n.on("processing.dt",function(t,i,r){$("#processingIndicator").css("display","none");r?n.LoadingOverlay("show"):n.LoadingOverlay("hide",!0)}).dataTable({destroy:!0,serverSide:!0,paging:!0,searching:!1,autoWidth:!0,pageLength:10,deferLoading:30,order:[[0,"asc"]],ajax:{url:"/Commerce/GetTradingItems",data:function(n){var t=$('select[name="tradingitem-filter-groups"]').val(),i=[];return t?t.length!=$('select[name="tradingitem-filter-groups"] option').length&&(i=t):i.push(0),$.extend({},n,{relationshipId:$("#hdfrelationshipid").val(),keyword:$('input[name="tradingitem-filter-search"]').val(),groupIds:JSON.stringify(i),status:$('select[name="tradingitem-filter-status"]').val()})}},columns:[{data:"Item",orderable:!0},{data:"TradingName",orderable:!0,render:function(n,t,i){return'<input type="text" class="form-control" onchange="updateTradingName('+i.Id+',this)" value="'+fixQuoteCode(n)+'">'}},{data:"SKU",orderable:!0},{data:"ProductGroup",orderable:!0},{data:"Unit",orderable:!0},{data:"Locations",orderable:!1},{data:"Status",orderable:!1,render:function(n){var t='<span class="label label-lg label-warning">Hidden<\/span>';return n&&(t='<span class="label label-lg label-success">Shown<\/span>'),t}},{data:"Id",orderable:!1,render:function(n,t,i){var r='<div class="btn-group options">';return r+='<button type="button" class="btn btn-success dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">',r+='Options &nbsp; <i class="fa fa-angle-down"><\/i><\/button>',r+=i.Status?'<ul class="dropdown-menu dropdown-menu-right" style="right: 0;"><li><a href="javascript:updateTradingItemStatus('+n+',false)">Hide from catalogue<\/a><\/li><\/ul>':'<ul class="dropdown-menu dropdown-menu-right" style="right: 0;"><li><a href="javascript:updateTradingItemStatus('+n+',true)">Show in catalogue<\/a><\/li><\/ul>',r+"<\/div>"}}]})}function reloadTblTradingItems(){$.fn.DataTable.isDataTable("#tblB2bTradingItems")?$("#tblB2bTradingItems").DataTable().ajax.reload():setTimeout(function(){$("#tblB2bTradingItems").DataTable().ajax.reload()},1e3)}function initSearch(){$("input[name=tradingitem-filter-search]").keyup(delay(function(){reloadTblTradingItems()},400));$("select[name=tradingitem-filter-groups]").change(function(){reloadTblTradingItems()});$("select[name=tradingitem-filter-status]").change(function(){reloadTblTradingItems()});$("input[name=tradingitemparnership-filter-search]").keyup(delay(function(){loadTradingItemsParnership()},400));$("select[name=tradingitemparnership-filter-groups]").change(function(){loadTradingItemsParnership()});$("input[name=tradingitemrelationship-filter-search]").keyup(delay(function(){reloadTblTradingItemsOfRelationship()},400));$("select[name=tradingitemrelationship-filter-islinked]").change(function(){reloadTblTradingItemsOfRelationship()})}function updateTradingItemStatus(n,t){$.post("/Commerce/UpdateTradingItemStatus",{id:n,isShown:t},function(n){n.result?reloadTblTradingItems():cleanBookNotification.error(_L("ERROR_MSG_EXCEPTION_SYSTEM"),"Commerce")})}function updateTradingName(n,t){var i=$(t).val();i&&$.post("/Commerce/UpdateTradingName",{id:n,tradingName:i},function(n){n.result?cleanBookNotification.updateSuccess():!n.result&&n.msg?cleanBookNotification.error(refModel.msg,"Commerce"):cleanBookNotification.error(_L("ERROR_MSG_EXCEPTION_SYSTEM"),"Commerce")})}function orderbyTblTradingItems(n,t){var i=$(t).data("order"),r=$("#tblB2bTradingItems").DataTable();r.order([[n,i]]).draw();$(t).data("order",i=="asc"?"desc":"asc")}function publishCatalogue(n,t,i){$.LoadingOverlay("show");$.post("/Commerce/PublishCatalogue",{relationshipId:t,isPublish:i},function(t){var r;$.LoadingOverlay("hide",!0);t.result?(cleanBookNotification.updateSuccess(),i?($(".menu-catalogue-ispublish").show(),$(n).toggleClass("btn-success btn-danger").html("Unpublish"),r=$(n).attr("onclick"),$(n).attr("onclick",r.replace(i,"false"))):($(".menu-catalogue-ispublish").hide(),$(n).toggleClass("btn-danger btn-success").html("Publish now"),r=$(n).attr("onclick"),$(n).attr("onclick",r.replace(i,"true")))):!t.result&&t.msg?cleanBookNotification.error(refModel.msg,"Commerce"):cleanBookNotification.error(_L("ERROR_MSG_EXCEPTION_SYSTEM"),"Commerce")})}function loadTradingItemsParnership(n){var t=$('select[name="tradingitemparnership-filter-groups"]').val(),i=[],r;t?t.length!=$('select[name="tradingitemparnership-filter-groups"] option').length&&(i=t):i.push(0);r={relationshipId:$("#hdfrelationshipid").val(),keyword:$("input[name=tradingitemparnership-filter-search]").val(),groupIds:i,domainParnershipId:domainParnershipId,orderByString:n?"":"TradingName asc"};$("#content-tradingitems-parnership").empty();$("#content-tradingitems-parnership").LoadingOverlay("show");$("#content-tradingitems-parnership").load("/Commerce/GetTradingItemsPartnership",r,function(){$("#content-tradingitems-parnership").LoadingOverlay("hide",!0)})}function orderbyTblTradingItemsParnership(n,t){var i=$(t).data("order");$(t).data("order",i=="asc"?"desc":"asc");loadTradingItemsParnership(n)}function showProductMore(n){var t={tradingItemId:n};$(modalUiSelector.b2bproductmore).empty();$(modalUiSelector.b2bproductmore).modal("show");$(modalUiSelector.b2bproductmore).load("/Commerce/LoadProductMoreModal",t,function(){initSelectModal(modalUiSelector.b2bproductmore);$(modalUiSelector.el_b2bproductmore_item).select2({ajax:{url:"/Commerce/Select2TraderItemsByDomainId",delay:250,data:function(n){return{keyword:n.term,domainId:0,isSell:!1,page:n.page||1}},cache:!0},minimumInputLength:1});$(modalUiSelector.el_b2bproductmore_item).on("select2:select",function(n){var t=n.params.data;$.get("/Commerce/ItemSelectedById?id="+t.id,function(n){$(modalUiSelector.el_b2bproductmore_unit).empty();$(modalUiSelector.el_b2bproductmore_unit).select2({data:n.Units?n.Units:[]});$(modalUiSelector.el_b2bproductmore_unit).on("select2:select",function(n){var t=n.params.data;$(modalUiSelector.el_b2bproductmore_unit).valid()});$(modalUiSelector.el_b2bproductmore_locations).empty();n.Locations&&n.Locations.length>0&&n.Locations.forEach(function(n){$(modalUiSelector.el_b2bproductmore_locations).append('<option value="'+n.id+'">'+fixQuoteCode(n.text)+"<\/option>")});$(modalUiSelector.el_b2bproductmore_locations).multiselect("destroy");$(modalUiSelector.el_b2bproductmore_locations).multiselect({includeSelectAllOption:!1,enableFiltering:!1,buttonWidth:"100%",maxHeight:400,enableClickableOptGroups:!0});$(modalUiSelector.el_b2bproductmore_SKU).val(n.SKU);var t=n.Units.find(n=>n.selected);t&&$(modalUiSelector.el_b2bproductmore_unit).valid()})});initFormLinkConsumerItem()})}function initFormLinkConsumerItem(){var n=$("#frmlinkconsumeritem");n.validate({ignore:"",rules:{ConsumerItemId:{required:!0},TradingName:{required:!0},ConsumerLocations:{required:!0},ConsumerUnitId:{required:!0}}});n.submit(function(t){(t.preventDefault(),isBusy)||n.valid()&&($.LoadingOverlay("show"),$.ajax({type:this.method,url:this.action,datatype:"json",data:$(this).serialize(),success:function(n){n.result?($(modalUiSelector.b2bproductmore).modal("hide"),cleanBookNotification.createSuccess(),loadTradingItemsParnership()):!n.result&&n.msg?cleanBookNotification.error(n.msg,"Commerce"):cleanBookNotification.error(_L("ERROR_MSG_EXCEPTION_SYSTEM"),"Commerce");$.LoadingOverlay("hide")},error:function(n){cleanBookNotification.error(n.responseText,"Qbicles");$.LoadingOverlay("hide")}}))})}function initSelectModal(n){$(n+" .checkmulti").multiselect({includeSelectAllOption:!1,enableFiltering:!1,buttonWidth:"100%",maxHeight:400,enableClickableOptGroups:!0});$(n+" .select2").select2({placeholder:"Please select"})}function initTradingItemsOfRelationship(){var n=$("#tblTradingItemsOfRelationship");n.on("processing.dt",function(t,i,r){$("#processingIndicator").css("display","none");r?n.LoadingOverlay("show"):n.LoadingOverlay("hide",!0)}).dataTable({destroy:!0,serverSide:!0,paging:!0,searching:!1,autoWidth:!0,pageLength:10,deferLoading:30,order:[[0,"asc"]],ajax:{url:"/Commerce/GetTradingItemsOfRelationship",data:function(n){return $.extend({},n,{relationshipId:$("#hdfrelationshipid").val(),keyword:$('input[name="tradingitemrelationship-filter-search"]').val(),isLinked:$('select[name="tradingitemrelationship-filter-islinked"]').val()})}},columns:[{data:"TradingName",orderable:!0},{data:"Unit",orderable:!0},{data:"SKU",orderable:!0},{data:"IsLinked",orderable:!0,render:function(n){var t='<i class="fa fa-check green"><\/i> &nbsp; Ready';return n||(t='<i class="fa fa-remove red"><\/i> &nbsp; Not ready'),t}},{data:"Id",orderable:!1,render:function(n,t,i){var r="";return i.IsLinked||i.DomainId!=domainParnershipId||(r+='<button class="btn btn-success" onclick="showProductMore('+n+')"><i class="fa fa-link"><\/i> &nbsp; Link an item<\/button>'),r}}]})}function reloadTblTradingItemsOfRelationship(){$.fn.DataTable.isDataTable("#tblTradingItemsOfRelationship")?$("#tblTradingItemsOfRelationship").DataTable().ajax.reload():setTimeout(function(){$("#tblTradingItemsOfRelationship").DataTable().ajax.reload()},1e3)}var isBusy=!1,$frmpartnershiplogistics=$("#frmpartnershiplogistics"),modalUiSelector={b2bproductmore:"#b2b-product-more",el_b2bproductmore_item:"#frmlinkconsumeritem select[name=ConsumerItemId]",el_b2bproductmore_locations:"#frmlinkconsumeritem select[name=ConsumerLocations]",el_b2bproductmore_unit:"#frmlinkconsumeritem select[name=ConsumerUnitId]",el_b2bproductmore_SKU:"#frmlinkconsumeritem input[name=SKU]"},domainParnershipId=0;$(document).ready(function(){domainParnershipId=$("#hdfdomainParnershipId").val();$(".checkmulti").multiselect({numberDisplayed:1,includeSelectAllOption:!0,enableFiltering:!1,buttonWidth:"100%",maxHeight:400,enableClickableOptGroups:!0});$frmpartnershiplogistics.length>0&&initFormPartnershipLogistics();$('a[data-toggle="collapse"]').on("click",toggleCollapse);initTradingItems();initTradingItemsOfRelationship();initSearch()});