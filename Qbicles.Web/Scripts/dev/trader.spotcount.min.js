function searchThrottle(n,t){var i=null;return function(){var r=this,u=arguments;clearTimeout(i);i=window.setTimeout(function(){n.apply(r,u)},t||500)}}function addSpotCount(n){n||(n=0);var t="/TraderSpotCount/AddEditSpotCount?id="+n;$.LoadingOverlay("show");$("#app-trader-inventory-spot-count").empty();$("#app-trader-inventory-spot-count").load(t.trim().replace(/\s/g,""),function(){var n=$("#transfer-workgroup-select").val(),t=$("#local-manage-select").val();ResetSpotCountItemSelected("tb_form_item","item",n,t,!1);LoadingOverlayEnd()})}function editSpotCount(n){n||(n=0);var t="/TraderSpotCount/AddEditSpotCount?id="+n;$.LoadingOverlay("show");$("#app-trader-inventory-spot-count").empty();$("#app-trader-inventory-spot-count").load(t.trim().replace(/\s/g,""),function(){var n=$("#transfer-workgroup-select").val(),t=$("#local-manage-select").val();ResetSpotCountItemSelected("tb_form_item","item",n,t,!1);LoadingOverlayEnd()})}function validateSpecificsFormAdjust(){var n=!0;return $("#spotCount_name").val()===""&&(n=!1,$("#form_tabspec").validate().showErrors({spot_name:"Name is required."})),$("#spotCount_Description").val()===""&&(n=!1,$("#form_tabspec").validate().showErrors({spot_description:"Description is required."})),$("#transfer-workgroup-select").val()===""?(n=!1,$("#form_tabspec").validate().showErrors({workgroup:"Work group is required."})):$("#transfer-workgroup-select-error").remove(),n}function btnSpotCountNext(){validateSpecificsFormAdjust()?$('a[href="#spot-tab2"]').tab("show"):setTimeout(function(){$('a[href="#spot-tab1"]').tab("show")},500)}function saveSpot(n){var r={Id:$("#spotcount_id").val(),Name:$("#spotCount_name").val(),Description:$("#spotCount_Description").val(),Location:{Id:$("#local-manage-select").val()},ProductList:[],Workgroup:{Id:$("#transfer-workgroup-select").val()},Status:n},i=$("#tb_form_item tbody tr"),u=$("#tb_form_item tbody tr td"),t;if(i.length>0&&u.length>1)for(t=0;t<i.length;t++){var f=$($(i[t]).find("td.td_spot_name input.spot_id")).val(),e={Id:f,Product:{Id:$($(i[t]).find("td.td_spot_sku input.spot_item_id")).val()},CountUnit:{Id:$($(i[t]).find("td.td_spot_unit select")).val()},SpotCountValue:$($(i[t]).find("td.td_spot_invoice span.demo")).text(),SavedInventoryCount:$($(i[t]).find("td.td_spot_invoice span.demo")).text(),Notes:$($(i[t]).find("td.td_spot_note input")).val()},o=$($(i[t]).find("td.td_spot_unit select")).val();if(o==null){cleanBookNotification.error("The units of all items are required!","Qbicles");LoadingOverlayEnd();return}r.ProductList.push(e)}$.LoadingOverlay("show");$.ajax({type:"post",url:"/TraderSpotCount/SaveSpotCount",data:{spotCount:r},dataType:"json",success:function(n){$.LoadingOverlay("hide");n.actionVal===1||n.actionVal===2?(cleanBookNotification.createSuccess(),$("#app-trader-inventory-spot-count").modal("toggle"),$("#search_spot_count").val(""),$("#spot-list-table").DataTable().ajax.reload()):n.actionVal==3&&cleanBookNotification.error(n.msg,"Qbicles")},error:function(){$.LoadingOverlay("hide");cleanBookNotification.error(_L("ERROR_MSG_EXCEPTION_SYSTEM"),"Qbicles")}})}function ChangeSelectedUnit(){$("#tb_form_template tbody tr td.td_spot_unit").empty();var n="/Trader/TraderSaleSelectUnit?idLocation="+$("#local-manage-select").val()+"&idTraderItem="+$("#item").val().split(":")[0]+"&spotcount=true";$("#tb_form_template tbody tr td.td_spot_unit").load(n,function(){$("#addrowitem").removeClass("disabledTab");$("#addrowitem").prop("disabled",!1)})}function removeItem(n){if($("#spotcount_id").val()==0){$("#tb_form_item tbody tr.tr_spot_item_"+n).remove();var t=$("#transfer-workgroup-select").val(),i=$("#local-manage-select").val();ResetSpotCountItemSelected("tb_form_item","item",t,i,!1)}else UpdateSpotCountProduct(n,!0)}function addRowItemSpot(){var n=$("#item").val().split(":"),t;$("#tb_form_item").LoadingOverlay("show");t=parseInt(n[4]);$.ajax({type:"post",url:"/Select2Data/GetUnusedInventoryQuantity",data:{inventoryId:t},dataType:"json",success:function(t){var r={Id:n[0],ImageUri:n[1],Name:n[2],SKU:n[3],Level:t},i=$("#tb_form_template tbody tr").clone(),u,f,e;$(i).attr("class","tr_spot_item_"+r.Id);$($(i).find("td.td_spot_name span")).text(r.Name);$($(i).find("td.td_spot_name input")).val(0);$($(i).find("td.td_spot_sku span")).text(r.SKU);$($(i).find("td.td_spot_sku input")).val(r.Id);$($(i).find("td.td_spot_invoice span.demo")).text(r.Level);$($(i).find("td.td_spot_note")).val("");$($(i).find("td.td_spot_unit select")).not(".multi-select").select2();$($(i).find("td.td_spot_button button")).attr("onclick","removeItem('"+r.Id+"')");u=$("#tb_form_item tbody trtr_spot_item_"+r.Id);u.length==0?$("#tb_form_item tbody").append(i):cleanBookNotification.error(_L("ERROR_MSG_373"),"Qbicles");$("#item").val("");$("#item").select2({placeholder:"Please select"});$("#addrowitem").prop("disabled",!0);f=$("#transfer-workgroup-select").val();e=$("#local-manage-select").val();ResetSpotCountItemSelected("tb_form_item","item",f,e,!1);$("#spotcount_id").val()>0&&UpdateSpotCountProduct(r.Id,!1)},error:function(){}}).always(function(){$("#tb_form_item").LoadingOverlay("hide",!0)})}function WorkGroupSelectedChange(){$workgroupId=$("#transfer-workgroup-select").val();$workgroupId!==""?($.LoadingOverlay("show"),$.ajax({type:"get",url:"/TraderTransfers/getworkgroup?id="+$workgroupId,dataType:"json",success:function(n){$(".preview-workgroup").show();changeItemByWorkGroup();LoadingOverlayEnd();n.result?($(".preview-workgroup table tr td.location_name").text(n.Object.Location),$(".preview-workgroup table tr td.workgroup_process").text(n.Object.Process),$(".preview-workgroup table tr td.workgroup_qbicle").text(n.Object.Qbicle),$(".preview-workgroup table tr td.workgroup_member span").text(n.Object.Members)):($(".preview-workgroup table tr td.location_name").text(""),$(".preview-workgroup table tr td.workgroup_process").text(""),$(".preview-workgroup table tr td.workgroup_qbicle").text(""),$(".preview-workgroup table tr td.workgroup_member span").text(""));$("#transfer-workgroup-select-error").remove()},error:function(){LoadingOverlayEnd();cleanBookNotification.error(_L("ERROR_MSG_EXCEPTION_SYSTEM"),"Qbicles")}})):$(".preview-workgroup").attr("style","display: none;")}function changeItemByWorkGroup(){var n=$("#transfer-workgroup-select").val(),t=$("#local-manage-select").val();ResetSpotCountItemSelected("tb_form_item","item",n,t,!1)}function ShowGroupMember(){$("#app-trader-workgroup-preview").empty();$("#app-trader-workgroup-preview").load("/TraderTransfers/ShowListMemberForWorkGroup?wgId="+$workgroupId);$("#app-trader-workgroup-preview").modal("toggle")}function ResetSpotCountItemSelected(n,t,i,r=0){var u,o;if($("#spotcount_id").val()>0)initSelect2MethodAJAX(t,"/Select2Data/GetSpotCountItemsById?spotCountId="+$("#spotcount_id").val()+"&workGroupId="+i+"&locationId="+r);else{var f=$("#"+n+" tbody tr"),s=$("#"+n+" tbody tr td"),e=[];if(f.length>0&&s.length>1)for(u=0;u<f.length;u++)e.push($($(f[u]).find(" td.td_spot_sku input.spot_item_id")).val());o=e.join(",");initSelect2MethodAJAX(t,"/Select2Data/GetSpotCountWasteItemsByWorkgroup?workGroupId="+i+"&locationId="+r+"&itemIds="+o,{},!1)}}function tableSpotCountLoad(){var n=$("#spot-list-table");$.fn.DataTable.isDataTable("#spot-list-table")&&n.DataTable().destroy();n.on("processing.dt",function(n,t,i){$("#processingIndicator").css("display","none");i&&$(".loadingoverlay").length===0?$(n.currentTarget).LoadingOverlay("show"):$(n.currentTarget).LoadingOverlay("hide",!0)}).dataTable({destroy:!0,dom:'<"top"fl<"clear">>rt<"bottomtable"ip<"clear">>',serverSide:!0,info:!1,stateSave:!1,bLengthChange:!0,paging:!0,searching:!1,responsive:!0,scrollX:!1,autoWidth:!0,deferLoading:30,lengthMenu:[[10,20,50,100],[10,20,50,100]],pageLength:10,order:[[1,"desc"]],ajax:{url:"/TraderSpotCount/GetByLocationPagination",type:"POST",data:function(n){var t=$("#spotcount-workgroup-filter").val(),i=$("#spotcount-status-filter").val();return $.extend({},n,{keyword:$("#search_spot_count").val(),datetime:$("#spotcount-datetimerange").val(),workgroups:_.isNull(t)?[-1]:t,status:_.isNull(i)?[-1]:i})}},columns:[{title:"Name",data:"Name",searchable:!0,orderable:!0},{title:"Date",data:"Date",searchable:!0,orderable:!0},{title:"Created",data:"CreatedBy",searchable:!0,orderable:!0},{title:"Workgroup",data:"WorkgroupName",searchable:!0,orderable:!0},{title:"Items",data:"ItemsCount",searchable:!0,orderable:!1},{title:"Description",data:"Description",searchable:!0,orderable:!0},{title:"Status",data:"Status",searchable:!1,orderable:!0},{title:"Options",data:"Id",searchable:!1,orderable:!1},],columnDefs:[{targets:6,data:"Status",render:function(n){var t="";switch(n){case 0:t='<span class="label-lg">Initiated<\/span>';break;case 1:t='<span class="label label-lg label-primary">Draft<\/span>';break;case 2:t='<span class="label label-lg label-warning">Count Started<\/span>';break;case 3:t='<span class="label label-lg label-info">Count Completed<\/span>';break;case 4:t='<span class="label label-lg label-success">Stock Adjusted<\/span>';break;case 5:t='<span class="label label-lg label-danger">Discarded<\/span>';break;default:t='<span class="label label-lg label-danger">Denied<\/span>'}return t}},{targets:7,data:"Id",render:function(n,t,i){return i.Status!=1?'<button class="btn btn-primary" onclick="window.location.href=\'/TraderSpotCount/SpotCountMaster?id='+n+'\';"><i class="fa fa-eye"><\/i> &nbsp; Manage<\/button>':'<button class="btn btn-info" data-toggle="modal" data-target="#app-trader-inventory-spot-count" onclick="editSpotCount('+n+')"><i class="fa fa-pencil"><\/i> &nbsp; Continue<\/button>'}}],rowId:function(n){return"spotcount_"+n.Id},initComplete:function(){$("#spot-list-table").DataTable().ajax.reload()}});$("#spotlist-table_filter").hide()}function UpdateSpotCountProduct(n,t){if($("#spotcount_id").val()!=0){$("#tb_form_item").LoadingOverlay("show");var i=$("#tb_form_item tbody tr.tr_spot_item_"+n),r={SpotCount:{Id:$("#spotcount_id").val()},Id:$($(i).find("td.td_spot_name input.spot_id")).val(),Product:{Id:$($(i).find("td.td_spot_sku input.spot_item_id")).val()},CountUnit:{Id:$($(i).find("td.td_spot_unit select")).val()},SpotCountValue:0,SavedInventoryCount:$($(i).find("td.td_spot_invoice span.demo")).text(),Notes:$($(i).find("td.td_spot_note input")).val()};$.ajax({type:"post",url:"/TraderSpotCount/UpdateSpotCountProduct",data:{spotCountItem:r,isDelete:t},dataType:"json",success:function(n){if(n.result==!1){cleanBookNotification.error(n.msg,"Qbicles");return}$("#tb_form_item").DataTable().ajax.reload(null,!1);var t=$("#transfer-workgroup-select").val(),i=$("#local-manage-select").val();ResetSpotCountItemSelected("tb_form_item","item-select",t,i);$("#spot-list").DataTable().ajax.reload(null,!1)},error:function(){cleanBookNotification.error(err,"Qbicles")}}).always(function(){$("#tb_form_item").LoadingOverlay("hide",!0)})}}$('.manage-columns input[type="checkbox"]').on("change",function(){var t=$("#spot-list-table").DataTable(),n=t.column($(this).attr("data-column"));n.visible(!n.visible())});$(function(){$("#search_spot_count").keyup(searchThrottle(function(){$("#spot-list-table").DataTable().search($(this).val()).draw()}));$("#spotcount-workgroup-filter,#spotcount-status-filter").on("change",function(){$("#spot-list-table").DataTable().ajax.reload()});$("#spotcount-workgroup-filter,#spotcount-status-filter").multiselect({includeSelectAllOption:!0,enableFiltering:!0,buttonWidth:"100%",maxHeight:400,enableClickableOptGroups:!0});$("#spotcount-datetimerange").daterangepicker({autoUpdateInput:!0,timePicker:!0,cancelClass:"btn-danger",opens:"right",autoUpdateInput:!1,locale:{cancelLabel:"Clear",format:$dateTimeFormatByUser}});$("#spotcount-datetimerange").on("apply.daterangepicker",function(n,t){$(this).val(t.startDate.format($dateTimeFormatByUser)+" - "+t.endDate.format($dateTimeFormatByUser));$("#spotcount-datetimerange").html(t.startDate.format($dateTimeFormatByUser)+" - "+t.endDate.format($dateTimeFormatByUser));$("#spot-list-table").DataTable().ajax.reload()});$("#spotcount-datetimerange").on("cancel.daterangepicker",function(){$(this).val(null);$("#spotcount-datetimerange").html("full history");$("#spot-list-table").DataTable().ajax.reload()});tableSpotCountLoad()});