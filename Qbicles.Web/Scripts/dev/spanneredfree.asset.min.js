function getCurrencySettings(){$.ajax({url:"/Qbicles/GetCurrencySettings",type:"get","async":!1,success:function(n){currencySetting=n?n:{CurrencySymbol:"",SymbolDisplay:0,DecimalPlace:2}},error:function(){cleanBookNotification.error(_L("ERROR_MSG_EXCEPTION_SYSTEM"),"Qbicles")}})}function initSpannered(){$('a[data-target="#asset-tasks"]').trigger("click");$("#searchMeterName").keyup(searchThrottle(function(){searchMeters()}));checkPermissionAddEdit("Assets",$("#workgroupId").val());checkPermissionAddEdit("Asset Tasks",$("#workgroupId").val());checkPermissionAddEdit("Meters",$("#workgroupId").val());$("#txtFilterPurchaseSearch").keyup(function(){$("#tblRelatedPurchases").DataTable().search(this.value).draw()});$("#slFilterPurchaseStatus").change(function(){$("#tblRelatedPurchases").DataTable().search(this.value).draw()});$("#txtFilterInventorySearch").keyup(function(){$("#tblAssetInventories").DataTable().search(this.value).draw()});$("#slFilterInventoryPurpose").change(function(){var n=$(this).val()?$(this).val():[];n=n.join("|");$("#tblAssetInventories").DataTable().columns(5).search(n,!0,!1).draw()})}function checkPermissionAddEdit(n,t){$.post("/Spanneredfree/CheckPermissionAddEdit",{process:n,workgroupId:t},function(t){t.result?n==="Assets"?($("#options-assets button").show(),$("a[href='#app-spannered-asset-edit']").show()):n==="Asset Tasks"?$("#task-options button").show():n==="Meters"&&$("#meter-options button").show():n==="Assets"?($("#options-assets button").hide(),$("a[href='#app-spannered-asset-edit']").hide()):n==="Asset Tasks"?$("#task-options button").hide():n==="Meters"&&$("#meter-options button").hide()})}function initFormMedia(){$form_media_smresource.validate({rules:{name:{required:!0,minlength:5},description:{required:!0}}})}function LoadMedias(n,t){$.LoadingOverlay("show");var i=$("#sl-media-type").val();$.ajax({type:"post",url:"/Spanneredfree/LoadMedias",datatype:"json",data:{fid:n,qid:t,fileType:i=="All"?"":i},success:function(n){if(n){var t=$("#asset-resources .flex-grid-thirds-lg");t.html(n);totop();LoadingOverlayEnd()}},error:function(n){cleanBookNotification.error(n.responseText,"Qbicles");LoadingOverlayEnd()}})}function submitTask(){$.LoadingOverlay("show");var t=new FormData($form_task_addedit[0]),i=$("#tblTaskInventoryCPS").DataTable().rows().data(),n=[];$.each(i,function(t,i){var r=0,u;i.Allocated?r=i.Allocated:(u=$(i[6]).val(),r=u?u:0);n.push({Id:i[0],AssetInventoryId:i[1],Allocated:r})});n.length>0&&t.append("inventoriescps",JSON.stringify(n));$.ajax({type:"POST",url:"/Spanneredfree/SaveQbicleTask",data:t,cache:!1,enctype:"multipart/form-data",processData:!1,contentType:!1,beforeSend:function(){isBusyAddTaskForm=!0},success:function(n){n.result?($("#app-spannered-task-add").modal("hide"),cleanBookNotification.success(_L("ERROR_MSG_199"),"Spannered"),SearchAssetTask(),ResetTask()):!n.result&&n.msg?cleanBookNotification.error(_L(n.msg),"Spannered"):cleanBookNotification.error(_L("ERROR_MSG_EXCEPTION_SYSTEM"),"Spannered");isBusyAddTaskForm=!1;LoadingOverlayEnd()},error:function(){isBusyAddTaskForm=!1;LoadingOverlayEnd();cleanBookNotification.error(_L("ERROR_MSG_EXCEPTION_SYSTEM"),"Spannered")}})}function saveTask(){if($("#taskName").val()==""||$("#taskProgrammedStart").val()==""||$("#taskDuration").val()=="0"){cleanBookNotification.error(_L("ERROR_MSG_361"),"Task");return}var n=task_validtabs();if(n){if(!ValidateStepsWeight()){cleanBookNotification.error(_L("ERROR_MSG_360"),"Task");$('#taskTabs a[href="#create-task-checklist"]').tab("show");return}isBusyAddTaskForm||($form_task_addedit.data("validator").settings.ignore=$("input[name=isSteps]").prop("checked")?"":":hidden",$form_task_addedit.valid()?(ReDataStep(),$.ajax({url:"/Tasks/DuplicateTaskNameCheck",data:{cubeId:$("#taskQbicleId").val(),taskKey:$("#taskKey").val(),taskName:$("#taskName").val()},type:"GET",dataType:"json","async":!1}).done(function(n){if(n.result)$form_task_addedit.validate().showErrors({Name:_L("ERROR_MSG_111")}),task_validtabs();else if($("#taskAttachments").val()){var t=checkfile($("#taskAttachments").val());t.stt?submitTask():$form_task_addedit.validate().showErrors({taskAttachments:t.err})}else submitTask()}).fail(function(){$("#form_task_addedit").validate().showErrors({Name:_L("ERROR_MSG_112")})})):task_validtabs())}}function LoadAssetTasks(){$("#tblAssetTaskCompleted").on("processing.dt",function(n,t,i){$("#processingIndicator").css("display","none");i?$("#tblAssetTaskCompleted").LoadingOverlay("show"):$("#tblAssetTaskCompleted").LoadingOverlay("hide",!0)}).DataTable({destroy:!0,serverSide:!0,paging:!0,searching:!1,responsive:!0,lengthMenu:[[10,20,50,100],[10,20,50,100]],pageLength:10,order:[[0,"desc"]],ajax:{url:"/Spanneredfree/LoadAssetTasks",type:"POST",data:function(n){return $.extend({},n,{assetId:$("#assetId").val(),status:$("#assetTaskStatus").val(),assigneeId:$("#assetTaskAssignee").val(),searchName:$("#assetTaskSearch").val()})}},columns:[{data:null,orderable:!0,width:"200px",render:function(n,t,i){return i.Id+" - "+i.Name}},{data:"Created",orderable:!1},{data:"Assignee",orderable:!1},{data:"Due",orderable:!1},{data:"MeterThreshold",orderable:!1,width:"120px",render:function(n){return n?n.toLocaleString():""}},{data:"Status",render:function(){return'<span class="label label-success label-lg">Complete<\/span>'}}]});$("#tblAssetTaskUnCompleted").on("processing.dt",function(n,t,i){$("#processingIndicator").css("display","none");i?$("#tblAssetTaskUnCompleted").LoadingOverlay("show"):$("#tblAssetTaskUnCompleted").LoadingOverlay("hide",!0)}).DataTable({destroy:!0,serverSide:!0,paging:!0,searching:!1,responsive:!0,lengthMenu:[[10,20,50,100],[10,20,50,100]],pageLength:10,order:[[0,"desc"]],ajax:{url:"/Spanneredfree/LoadAssetTasks",type:"POST",data:function(n){return $.extend({},n,{assetId:$("#assetId").val(),status:$("#assetTaskStatus").val(),assigneeId:$("#assetTaskAssignee").val(),searchName:$("#assetTaskSearch").val()})}},columns:[{data:null,orderable:!0,width:"200px",render:function(n,t,i){return i.Id+" - "+i.Name}},{data:"Created",orderable:!1,width:"120px"},{data:"Assignee",orderable:!1},{data:"Due",orderable:!1,width:"120px"},{data:"MeterThreshold",orderable:!1,width:"120px",render:function(n){return n?n.toLocaleString():""}},{data:"Status",orderable:!1,render:function(n,t,i){return i.Status==="Pending"?'<span class="label label-info label-lg">Pending<\/span>':i.Status==="In progress"?'<span class="label label-warning label-lg">In progress<\/span>':i.Status==="Overdue"?'<span class="label label-danger label-lg">Overdue<\/span>':""}},{data:null,width:"110px",orderable:!1,render:function(n,t,i){return'<div class="btn-group options"><button type="button" class="btn btn-success dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">Options &nbsp; <i class="fa fa-angle-down"><\/i><\/button><ul class="dropdown-menu dropdown-menu-right" style="right: 0;"><li><a href="javascript:void(0)" onclick="ShowTaskPage('+i.ActivityKey+')">Manage<\/a><\/li><li style="display: '+(i.IsAllowEdit?"block":"none")+'"><a href="#app-spannered-task-add" data-toggle="modal" data-target="#app-spannered-task-add" onclick="LoadModalAssetTask('+i.Id+", "+$("#assetId").val()+')">Edit<\/a><\/li><\/ul><\/div>'}},]})}function LoadMeterHistoryModal(n){$("#app-spannered-meter-history").load("/Spanneredfree/LoadMeterHistoryModal",{id:n},function(){})}function LoadModalMeter(){$("#app-spannered-meter-add").load("/Spanneredfree/LoadModalMeter",{},function(){$("#form_meter_addedit").trigger("reset");$("#form_meter_addedit").validate({ignore:"",rules:{Name:{required:!0,maxlength:250},Unit:{required:!0,maxlength:50},Description:{required:!0,maxlength:500}}});$("#form_meter_addedit").submit(function(n){if(n.preventDefault(),$("#form_meter_addedit").valid()){$.LoadingOverlay("show");var t=new FormData($("#form_meter_addedit")[0]);t.append("assetId",$("#assetId").val());$.ajax({type:this.method,cache:!1,url:this.action,data:t,processData:!1,contentType:!1,beforeSend:function(){isBusy=!0},success:function(n){isBusy=!1;n.result?($("#app-spannered-meter-add").modal("hide"),searchMeters(),cleanBookNotification.success(_L("UPDATE_MSG_SUCCESS"),"Spannered")):cleanBookNotification.error(_L("ERROR_MSG_EXCEPTION_SYSTEM"),"Spannered");LoadingOverlayEnd()},error:function(){isBusy=!1;LoadingOverlayEnd();cleanBookNotification.error(_L("ERROR_MSG_EXCEPTION_SYSTEM"),"Spannered")}})}else return})})}function searchMeters(){$.LoadingOverlay("show");$("#asset-meters").load("/Spanneredfree/LoadMeters",{name:$("#searchMeterName").val(),assetId:$("#assetId").val()},function(){LoadingOverlayEnd()})}function ShowTaskPage(n){var t=window.location.href;$.ajax({type:"post",url:"/Tasks/SetTaskSelected",datatype:"json",data:{key:n,goBack:t},success:function(n){n.result&&(window.location.href="/Qbicles/Task")},error:function(){cleanBookNotification.error(_L("ERROR_MSG_EXCEPTION_SYSTEM"),"Qbicles")}})}function SearchAssetTask(n){n&&(activeTaskTab=n,n==="History"?($("#assetTaskStatus").val("Complete").trigger("change"),$("#assetTaskStatus").attr("disabled","disabled")):($("#assetTaskStatus").val(" ").trigger("change"),$("#assetTaskStatus").removeAttr("disabled")));activeTaskTab==="Open"?$("#assetTaskStatus").val()=="Complete"?(activeTaskTab="History",$('.tab-pane a[href="#tasks-1"]').tab("show"),$("#assetTaskStatus").val("Complete").trigger("change"),$("#assetTaskStatus").attr("disabled","disabled")):$("#tblAssetTaskUnCompleted").DataTable().ajax.reload():$("#tblAssetTaskCompleted").DataTable().ajax.reload()}function checkAndUpdateValueOfUnit(n){$("#valueOfUnit_"+n).val()?$.ajax({type:"post",url:"/Spanneredfree/UpdateValueOfUnit",datatype:"json",data:{meterId:n,valueOfUnit:$("#valueOfUnit_"+n).val()},success:function(t){t.result?($(".addreading_"+n).hide(),$(".meter-options_"+n).fadeIn(),cleanBookNotification.success(_L("UPDATE_MSG_SUCCESS"),"Spannered"),searchMeters()):cleanBookNotification.error(_L("ERROR_MSG_EXCEPTION_SYSTEM"),"Spannered")},fail:function(){cleanBookNotification.error(_L("ERROR_MSG_EXCEPTION_SYSTEM"),"Spannered")}}):cleanBookNotification.error("Value of unit cannot be empty!","Spannered")}function isOnToggle(n){var t="";return $("select[name='ActivitiesRelate'] option").each(function(){if($(this).val()==n)return t="checked",!1}),t}function LoadModalAssetTask(n,t){$.LoadingOverlay("show");$("#app-spannered-task-add form").load("/Spanneredfree/LoadModalAssetTask",{taskId:n,assetId:t},function(){LoadingOverlayEnd();$("select.select2").select2({placeholder:"Please select"});$(".select2avatartask").select2({placeholder:"Please select",templateResult:SformatOptions,templateSelection:SformatSelected});$(".single-date").daterangepicker({singleDatePicker:!0,timePicker:!0,autoApply:!0,showDropdowns:!0,autoUpdateInput:!0,cancelClass:"btn-danger",opens:"left",locale:{cancelLabel:"Clear",format:$dateTimeFormatByUser}});$("#sortable").sortable();$("#sortable").disableSelection();$('input[name="isSteps"],#chkIncludeOutOfStock').bootstrapToggle();$("#rlActivities").on("processing.dt",function(n,t,i){$("#processingIndicator").css("display","none");i?$("#rlActivities").LoadingOverlay("show"):$("#rlActivities").LoadingOverlay("hide",!0)}).dataTable({destroy:!0,serverSide:!0,processing:!0,paging:!0,searching:!0,ajax:{url:"/Tasks/AtivitiesRelated",data:function(n){return $.extend({},n,{currentQbicleId:$("#taskQbicleId").val(),currentActivityKey:$("#taskKey").val()})}},columns:[{title:"Name",data:"Name",searchable:!0},{title:"Type",data:"Type",searchable:!0},null],columnDefs:[{targets:2,data:"Id",render:function(n,t,i){return'<input class="chktoggle" data-toggle="toggle" data-on="Yes" '+isOnToggle(n)+' data-off="No" data-onstyle="success" onchange="AddRemoveAtvRelated('+n+",'"+i.Name.replace("'","")+'\',this)"  type="checkbox" value="'+n+'">'}}],drawCallback:function(){$(".chktoggle").bootstrapToggle()}});$("#tblTaskInventoryCPS").DataTable({destroy:!0,autoWidth:!1,columnDefs:[{targets:0,visible:!1},{targets:1,visible:!1}],drawCallback:function(){$(".trackInput").on("change",function(){var n=$(this).parents("tr"),t=$("#tblTaskInventoryCPS").DataTable().row(n).data();t.Allocated=$(this).val()})}});$("#txtFilterTaskCSPKeywork").keyup(function(){$("#tblTaskInventoryCPS").DataTable().search(this.value).draw()});$("#slFilterTaskCSPPurpose").change(function(){$("#tblTaskInventoryCPS").DataTable().columns(2).search($(this).val()).draw()});$.fn.dataTable.ext.search.push(function(n,t){if(n.sTableId=="tblTaskInventoryCPS"){var i=stringToNumber(t[5]);return!$("#chkIncludeOutOfStock").prop("checked")&&i>0?!0:$("#chkIncludeOutOfStock").prop("checked")?!0:!1}return!0});$("#chkIncludeOutOfStock").change(function(){$("#tblTaskInventoryCPS").DataTable().draw()})})}function SformatOptions(n){if(!n.id)return n.text;var t=n.element.attributes.avatarUrl.value;return $('<div class="select2imgwrap"><div class="select2img" style="background-image: url(\''+t.toLowerCase()+'\');"><\/div> <span class="select2text">'+n.text+"<\/span><\/div>")}function SformatSelected(n){if(!n.id)return n.text;var t=n.element.attributes.avatarUrl.value;return $('<div class="select2imgwrap"><div class="select2img mini" style="background-image: url(\''+t.toLowerCase()+'\');"><\/div> <span class="select2text">'+n.text+"<\/span><\/div>")}function LoadPeopleTabByQbicleId(n){$("#create-task-people").load("/Spanneredfree/LoadPeopleTabByQbicleId",{qbicleId:n},function(){$(".select2avatartask").select2({placeholder:"Please select",templateResult:SformatOptions,templateSelection:SformatSelected});$("#assigneeId").val()&&($("select[name='Assignee']").val($("#assigneeId").val()),$("select[name='Assignee']").trigger("change"));$("#watcherId").val()&&($("select[name='Watchers']").val($("#watcherId").val()),$("select[name='Watchers']").trigger("change"))})}function searchThrottle(n,t){var i=null;return function(){var r=this,u=arguments;clearTimeout(i);i=window.setTimeout(function(){n.apply(r,u)},t||800)}}function LoadTopicsByQbicleId(n){var i=$('select[name="WorkgroupId"] option:selected'),t=i.data("qbicleid"),n=n!=0?n:i.data("topicid");$.getJSON("/Topics/GetTopicByQbicleId",{qbicleId:t?t:0,currentTopicId:n},function(n){$("#taskTopicId").select2({placeholder:"Please select",data:n})});$("#qbicleId").val(t);LoadPeopleTabByQbicleId(t)}function ShowTraderItemAdditional(n){var t="/TraderItem/GetTraderItem?id="+n;LoadingOverlay();$("#app-trader-item-additional").empty();$("#app-trader-item-additional").load(t,function(){LoadingOverlayEnd()})}function ShowPurchaseItems(n){var t="/Spanneredfree/LoadPurchaseItems?purchaseId="+n;LoadingOverlay();$("#app-spannered-purchase-detail").empty();$("#app-spannered-purchase-detail").load(t,function(){$("#app-spannered-purchase-detail .datatable").DataTable();LoadingOverlayEnd()})}function removeFromSpannered(n,t){bootbox.confirm({show:!0,backdrop:!0,closeButton:!0,animate:!0,title:"Spannered",message:_L("ERROR_MSG_708"),callback:function(i){if(i){$.post("/Spanneredfree/RemoveItemSpanneredByAIId",{aiId:n},function(n){n.result?$(t).closest("tr").remove():!n.result&&n.msg?cleanBookNotification.error(response.msg,"Spannered"):cleanBookNotification.error(_L("ERROR_MSG_EXCEPTION_SYSTEM"),"Spannered")});return}}})}function loadTeamsWorkgroupSpannered(n){$("#team-view").empty();$("#team-view").modal("show");$("#team-view").load("/Spanneredfree/LoadTeamsByWorkgroupId?wgId="+n)}var $form_media_smresource=$("#form_media_smresource"),activeTaskTab="Open",isBusy=!1,$slLocation=$("#locationId");$(document).ready(function(){getCurrencySettings();LoadAssetTasks();initFormMedia();initSpannered()});SaveSpanneredResource=function(){$form_media_smresource.valid()&&ProcessMediaSpanneredResource()};ProcessMediaSpanneredResource=function(){$.LoadingOverlay("show");var n=document.getElementById("spannered-resource-file-upload").files;n&&n.length>0?UploadMediaS3ClientSide("spannered-resource-file-upload").then(function(n){if(n.objectKey==="no_image"||n.objectKey==="no-image"){LoadingOverlayEnd("hide");cleanBookNotification.error(_L("ERROR_MSG_S3_UPLOAD"),"Qbicles");return}$("#spannered-resource-object-key").val(n.objectKey);$("#spannered-resource-object-name").val(n.fileName);$("#spannered-resource-object-size").val(n.fileSize);SubmitSaveSpanneredResource()}):SubmitSaveSpanneredResource()};SubmitSaveSpanneredResource=function(){var n=new FormData($form_media_smresource[0]);n.append("qbicleId",$("#taskQbicleId").val());$.ajax({type:"post",cache:!1,url:"/Spanneredfree/SpanneredFreeSaveResource",enctype:"multipart/form-data",data:n,processData:!1,contentType:!1,beforeSend:function(){},success:function(n){n.result?($("#create-resource").modal("hide"),isBusy=!1,LoadMedias($("#mediaFolderId").val(),$("#taskQbicleId").val()),cleanBookNotification.success(_L("ERROR_MSG_172"),"Spannered"),$form_media_smresource.trigger("reset")):n.msg&&(cleanBookNotification.error(n.msg,"Spannered"),isBusy=!1)},error:function(){cleanBookNotification.error(_L("ERROR_MSG_EXCEPTION_SYSTEM"),"Spannered")}}).always(function(){LoadingOverlayEnd()})};