function UpdateStatusApproval(n){var t=$("#action_approval_default").val();$.LoadingOverlay("show");$.ajax({url:"/Qbicles/SetPurchaseTransferApprovalRequest",type:"GET",dataType:"json",data:{appKey:n,status:$("#action_approval").val()},success:function(n){LoadingOverlayEnd();n.actionVal>0&&RenderContentUpdated(!0)},error:function(){LoadingOverlayEnd();cleanBookNotification.error(_L("ERROR_MSG_EXCEPTION_SYSTEM"),"Qbicles")}})}function RenderContentUpdated(n){LoadingOverlay();$("#purchasereview_content").empty();$("#purchasereview_content").load("/TraderPurchases/PurchaseReviewContent?id="+$traderPurchaseId,function(){LoadingOverlayEnd();n&&setTimeout(function(){cleanBookNotification.updateSuccess()},400)})}function ChangeContact(n){$.LoadingOverlay("show");$("#purchase-review-contact").empty();$("#purchase-review-contact").load("/TraderPurchases/TraderPurchaseReviewContact?id="+n);setTimeout(function(){LoadingOverlayEnd();$("#app-trader-purchase-contact").modal("toggle")},500)}function changeDelivery(){$("#contact_address_id").val(0);$(".delivery-stored").hide();$(".delivery-details").fadeIn()}function OnChangeDelivery(){$("#purchases_delivery").val()==="Delivery"?$(".delivery-stored").fadeIn():$(".delivery-stored").hide()}function SelectContactChange(n){$(n).val()!==""&&$.ajax({type:"get",url:"/TraderPurchases/GetContactById?id="+$(n).val(),dataType:"json",success:function(n){var t=n.Name+",<\/br>";n.Address&&(n.Address.AddressLine1&&(t+=",<\/br>"+n.Address.AddressLine1),n.Address.City&&(t+=",<\/br>"+n.Address.City),n.Address.AddressLine2&&(t+=",<\/br>"+n.Address.AddressLine2),n.Address.State&&(t+=",<\/br>"+n.Address.State),n.Address.Country&&(t+=",<\/br>"+n.Address.Country.CommonName),n.Address.PostCode&&(t+=",<\/br>"+n.Address.PostCode));$("#address_info").empty();$("#address_info").append(t)},error:function(){cleanBookNotification.error(_L("ERROR_MSG_EXCEPTION_SYSTEM"),"Qbicles")}})}function UpdateContact(){$.LoadingOverlay("show");var n={Id:$traderPurchaseId,DeliveryMethod:$("#purchases_delivery").val(),Vendor:{Id:$("#form_purchase_contact").val()}};$.ajax({type:"post",url:"/TraderPurchases/UpdateTraderPurchaseContact?countryName="+$("#form_contact_address_country").val(),data:{traderPurchase:n},dataType:"json",success:function(n){n.actionVal===1&&($("#purchase-contact-preview").empty(),$("#purchase-contact-preview").append(n.msg));setTimeout(function(){$("#app-trader-purchase-contact").modal("toggle");LoadingOverlayEnd()},500)},error:function(){LoadingOverlayEnd();cleanBookNotification.error(_L("ERROR_MSG_EXCEPTION_SYSTEM"),"Qbicles")}})}function ChangeItems(n){$.LoadingOverlay("show");CheckStatus(n,"Purchase").then(function(t){LoadingOverlayEnd();t.result&&t.Object!="PurchaseApproved"?($.LoadingOverlay("show"),$("#purchase-review-items").empty(),$("#purchase-review-items").load("/TraderPurchases/TraderPurchaseReviewItems?id="+n,function(){LoadingOverlayEnd();$("#purchase-review-items-modal").modal("toggle");var n=$("#purchase-item-workgroup-id").val(),t=$("#purchase-item-location-id").val();ResetItemSelected("tb_form_item","item-select-manage",undefined,n,t,!1,!1,!0)})):t.result&&t.Object=="PurchaseApproved"?(cleanBookNotification.error(_L("ERROR_MSG_272"),"Qbicles"),setTimeout(function(){window.location.reload()},1e3)):t.result==!1&&cleanBookNotification.error(_L("ERROR_MSG_380",[t.msg]),"Qbicles")})}function addRowItem(){var o=UniqueId(),u=$("#form_item_dimensions").val(),n,e;u||(u=[]);var s=$("#item_selected select").val(),r=$("#item-select-manage").find(":selected"),i=r.attr("itemId"),h=r.attr("itemName"),c=r.attr("itemImage"),l=r.attr("taxName"),a=r.attr("taxRate"),v=r.attr("costUnit"),t={Id:o,TraderItem:{Id:i,TaxName:l,ImageUri:c,Name:h,TaxRate:a,CostUnit:v},Discount:isNaN(parseFloat($("#form_item_discount").val()))?0:parseFloat($("#form_item_discount").val()),Dimensions:[],Quantity:parseFloat($("#form_item_quantity").val()),Unit:{},CostPerUnit:parseFloat($("#cpu").val()),Cost:0},f=parseFloat(t.CostPerUnit)*parseFloat(t.Quantity)*(1-parseFloat(t.Discount)/100)*(1+parseFloat(t.TraderItem.TaxRate)/100),y=f/(1+t.TraderItem.TaxRate/100),p=parseFloat(f-y).toFixed($decimalPlace);t.Cost=f.toFixed($decimalPlace);n=$("#tb_form_template tbody tr").clone();$(n).addClass("tr_id_"+i);$($(n).find("td.row_image div")).attr("style","background-image: url('"+$("#api_url").val()+t.TraderItem.ImageUri+"');");$($(n).find("td.row_name")).text(t.TraderItem.Name);$($(n).find("td.row_unit")).empty();e=$("#item_selected select").clone();$($(n).find("td.row_unit")).append(e);$($(n).find("td.row_unit select")).val(s);$($(n).find("td.row_unit select")).attr("onchange","rowUnitChange('"+i+"')");$($(n).find("td.row_costperunit input")).val(t.CostPerUnit);$($(n).find("td.row_costperunit input")).attr("onchange","updateCost('"+i+"')");$($(n).find("td.row_quantity input")).val(t.Quantity);$($(n).find("td.row_quantity input")).attr("onchange","updateCost('"+i+"')");$($(n).find("td.row_discount input")).val(t.Discount);$($(n).find("td.row_discount input")).attr("onchange","updateCost('"+i+"')");$($(n).find("td.row_taxrate")).text(t.TraderItem.TaxRate);$($(n).find("td.row_taxname")).html(showTaxRatesDetail(t.CostPerUnit,t.Quantity,t.Discount,t.TraderItem.TaxName));$($(n).find("td.row_dimensions select")).val(u);$($(n).find("td.row_cost input")).val(t.Cost).attr("onchange","updateTotalReviewItemCost("+i+")");$($(n).find("td.row_button button")).attr("onclick","removeRowItem('"+i+"')");$($(n).find("td.row_button input.traderItem")).val(i);$($(n).find("td.row_button input.row_id")).val(i);$($(n).find("td select")).not(".multi-select").select2();$("#tb_form_item tbody").append(n);setTimeout(function(){$("#form_add_transaction")[0].reset();$("#form_add_transaction select").not(".multi-select").select2();resetPurchaseForm()},100);setTimeout(function(){var n=$("#purchase-item-workgroup-id").val(),t=$("#purchase-item-location-id").val();ResetItemSelected("tb_form_item","item-select-manage",undefined,n,t,!1,!1,!0)},200)}function updateTotalReviewItemCost(n){var t=parseFloat($("#tb_form_item tbody tr.tr_id_"+n+" .row_quantity input").val()),i=isNaN(parseFloat($("#tb_form_item tbody tr.tr_id_"+n+" .row_discount input").val()))?0:parseFloat($("#tb_form_item tbody tr.tr_id_"+n+" .row_discount input").val()),u=parseFloat($("#tb_form_item tbody tr.tr_id_"+n+" .row_taxrate").text()),e=$("#tb_form_item tbody tr.tr_id_"+n+" .row_taxname .txt-taxname").val(),f=parseFloat($("#tb_form_item tbody tr.tr_id_"+n+" .row_cost input").val()),r;isNaN(t)||isNaN(i)||isNaN(f)||t==0||i==100||u==-100||(r=parseFloat(f/(t*(1-i/100)*(1+u/100))).toFixed(5),$("#tb_form_item tbody tr.tr_id_"+n+" .row_costperunit input").val(r),$("#tb_form_item tbody tr.tr_id_"+n+" .row_taxname").html(showTaxRatesDetail(r,t,i,e)))}function rowUnitChange(n){var i=$("#tb_form_item tbody tr.tr_id_"+n+" td.row_button input.traderItem").val().split(":"),t=$("#tb_form_item tbody tr.tr_id_"+n+" td.row_unit select").val().split(":");t[1]==="BaseUnit"?$("#tb_form_item tbody tr.tr_id_"+n+" td.row_costperunit input").val(i[3]):t[1]==="Conversion Unit"&&$("#tb_form_item tbody tr.tr_id_"+n+" td.row_costperunit input").val(parseFloat(i[3])*parseFloat(t[3]));updateCost(n)}function rowUnitChange(n){var i=$("#tb_form_item tbody tr.tr_id_"+n+" td.row_button input.traderItem").val().split(":"),t=$("#tb_form_item tbody tr.tr_id_"+n+" td.row_unit select").val().split(":");t[1]==="BaseUnit"?$("#tb_form_item tbody tr.tr_id_"+n+" td.row_costperunit input").val(i[3]):t[1]==="Conversion Unit"&&$("#tb_form_item tbody tr.tr_id_"+n+" td.row_costperunit input").val(parseFloat(i[3])*parseFloat(t[3]));updateCost(n)}function updateCost(n){var t=$("#tb_form_item tbody tr.tr_id_"+n+" td.row_costperunit input").val(),i=$("#tb_form_item tbody tr.tr_id_"+n+" td.row_quantity input").val(),r=$("#tb_form_item tbody tr.tr_id_"+n+" td.row_discount input").val(),u=$("#tb_form_item tbody tr.tr_id_"+n+" td.row_taxrate").text(),f,e;isNaN(parseFloat(t))||isNaN(parseFloat(i))||isNaN(parseFloat(r))||isNaN(parseFloat(u))||(f=parseFloat(t)*parseFloat(i)*(1-parseFloat(r)/100)*(1+parseFloat(u)/100),$("#tb_form_item tbody tr.tr_id_"+n+" td.row_cost input").val(f.toFixed($decimalPlace)),e=$("#tb_form_item tbody tr.tr_id_"+n+" td.row_taxname input.txt-taxname").val(),$("#tb_form_item tbody tr.tr_id_"+n+" td.row_taxname").html(showTaxRatesDetail(t,i,r,e)))}function removeRowItem(n){$("#tb_form_item tbody tr.tr_id_"+n).remove();var t=$("#purchase-item-workgroup-id").val(),i=$("#purchase-item-location-id").val();ResetItemSelected("tb_form_item","item-select-manage",undefined,t,i,!1,!1,!0)}function resetPurchaseForm(){$("#cpu").attr("disabled","true");$("#addNowForm").attr("disabled",!0)}function ChangeSelectedUnit(){$.LoadingOverlay("show");$("#item_selected").empty();var n=$("#location-id").val(),t=$("#item-select-manage").find(":selected").attr("itemId");$("#item_selected").load("/Trader/TraderSaleSelectUnit?idLocation="+n+"&idTraderItem="+t,function(){LoadingOverlayEnd();$("#item-select-manage").val()!==""&&$("#item-select-manage").val()!=="0"&&($("#label_cost").text("Cost per <selected unit>"),$("#cpu").removeAttr("disabled"))})}function selectedUnit(n){var t=$(n);t?$("#label_cost").text("Cost per "+$(t.find("option:selected")).text()):$("#label_cost").text("Cost per <selected unit>")}function quantityChange(){var n=$("#form_item_quantity").val(),t=$("#cpu").val(),i=$("#conversionsunitid").val(),r=$("#form_item_discount").val();parseFloat(n).toString()!=="NaN"&&parseFloat(r)>100&&$("#form_item_discount").val(100);parseFloat(n).toString()!=="NaN"&&parseFloat(n)>0&&parseFloat(t).toString()!=="NaN"&&parseFloat(t)>0&&i!=""?$("#addNowForm").removeAttr("disabled"):$("#addNowForm").attr("disabled","true")}function UpdateItems(){$.LoadingOverlay("show");CheckStatus($traderPurchaseId,"Purchase").then(function(n){var s,t,i,u,h,f,r,e,o,l,a,c;if(LoadingOverlayEnd(),n.result&&n.Object!="PurchaseApproved"){if($.LoadingOverlay("show"),s=[],t=$("#tb_form_item tbody tr"),t.length>0)for(i=0;i<t.length;i++){if(u=$($(t[i]).find("td.row_quantity input")).val(),parseFloat(u).toString()==="NaN")return LoadingOverlayEnd(),cleanBookNotification.error(_L("ERROR_MSG_636"),"Qbicles"),!1;if(parseFloat(u)<=0)return LoadingOverlayEnd(),cleanBookNotification.error(_L("ERROR_MSG_637"),"Qbicles"),!1;if(h=parseInt($($(t[i]).find("td.row_button input.row_id")).val()),f={Id:0},$($(t[i]).find("td.row_button input.traderItem")).val()!==null?f.Id=$($(t[i]).find("td.row_button input.traderItem")).val():f=null,r=$($(t[i]).find("td.row_dimensions select")).val(),e=[],r&&r.length>0)for(o=0;o<r.length;o++)e.push({Id:r[o]});if(e.length===0)return $.LoadingOverlay("hide"),cleanBookNotification.error(_L("ERROR_MSG_635"),"Qbicles"),!1;l=$($(t[i]).find("td.row_unit select")).val().split("|");a={Id:isNaN(h)?0:h,TraderItem:f,Discount:stringToNumber($($(t[i]).find("td.row_discount input")).val()),Dimensions:e,Quantity:stringToNumber(u),Unit:{Id:l[1]},CostPerUnit:stringToNumber($($(t[i]).find("td.row_costperunit input")).val()),Cost:stringToNumber($($(t[i]).find("td.row_cost input")).val())};s.push(a)}c={Id:$traderPurchaseId,PurchaseItems:s,PurchaseTotal:PurchaseTotal()};$.ajax({type:"post",url:"/TraderPurchases/UpdateTraderPurchaseItems",data:{traderPurchase:c},dataType:"json",success:function(n){n.actionVal===1?($("#table-purchase-review-items-preview").empty(),$("#table-purchase-review-items-preview").load("/TraderPurchases/TraderPurchaseReviewItemsPreview?id="+$traderPurchaseId,function(){LoadingOverlayEnd()}),$("#purchase-total").text(c.PurchaseTotal.toLocaleString()),$("#purchase-review-items-modal").modal("hide"),$("#purchase-items-total-price h3").text(toCurrencySymbol(PurchaseTotal()))):n.actionVal===3&&(LoadingOverlayEnd(),cleanBookNotification.error(n.msg,"Qbicles"))},error:function(n){LoadingOverlayEnd();cleanBookNotification.error("Have an error, detail: "+n.error,"Qbicles")}})}else n.result&&n.Object=="PurchaseApproved"?(cleanBookNotification.error(_L("ERROR_MSG_272"),"Qbicles"),setTimeout(function(){window.location.reload()},1e3)):n.result==!1&&cleanBookNotification.error(_L("ERROR_MSG_380",[n.msg]),"Qbicles")})}var $traderPurchaseId=$("#TraderPurchaseId").val();PurchaseTotal=function(){var t=$("#tb_form_item tbody tr"),r=$("#tb_form_item tbody tr td"),i=0,n;if(t.length===1&&r.length===1)return i;for(n=0;n<t.length;n++)i+=stringToNumber($($(t[n]).find("td.row_cost input")).val());return i};