function selectTab(){var n=getLocalStorage(contactmanage);n&&$('a[href="#'+n+'"]').tab("show");removeLocalStorage(contactmanage)}function UpdateStatusApproval(n,t){var r=$("#action_approval_default").val(),i;$.LoadingOverlay("show");i={Name:$("#contact-name").val(),Id:$("#contact-id").val(),Email:$("#contact-email").val()};$.ajax({method:"POST",dataType:"JSON",url:"/TraderContact/CheckExistedApprovedContact",data:{contact:i}}).done(function(i){i.result?CheckStatusApproval(n).then(function(i){LoadingOverlayEnd();i.result&&i.Object.toLocaleLowerCase()==r.toLocaleLowerCase()?($.LoadingOverlay("show"),$.ajax({url:"/Qbicles/SetRequestStatusForApprovalRequest",type:"GET",dataType:"json",data:{appKey:n,status:$("#action_approval").val()},success:function(n){if($.LoadingOverlay("hide"),$("#pagemode").val())return window.location.reload(),!1;n.actionVal>0&&RenderContentUpdated(!0)},error:function(){$.LoadingOverlay("hide");cleanBookNotification.error(_L("ERROR_MSG_EXCEPTION_SYSTEM"),"Qbicles")}})):(cleanBookNotification.error(_L("ERROR_MSG_247"),"Qbicles"),t&&t==="CreditNote"&&window.location.reload(!0),setTimeout(function(){RenderContentUpdated()},1500))}):cleanBookNotification.error(i.msg,"Qbicles")}).fail(function(){cleanBookNotification.error("Error checking existing Approved Trader Contact","Qbicles")}).always(function(){LoadingOverlayEnd()})}function RenderContentUpdated(n){LoadingOverlay();$contactid=$("#contact_id").val();$("#contact-content").empty();$("#contact-content").load("/TraderContact/ContactReview?id="+$contactid+"&isReload=true",function(){LoadingOverlayEnd();n&&setTimeout(function(){cleanBookNotification.updateSuccess()},400)})}function selectAccount(n,t){var i=$(".accountid-"+t).data("name");$(".selectaccount").removeClass("selectaccount");$(n).addClass("selectaccount");BKAccount={Id:t,Name:i};$("#accountId").val(t);closeSelected();SaveContact();$("#app-bookkeeping-treeview").modal("toggle")}function closeSelected(){BKAccount.Id?($(".accountInfo").empty(),$(".accountInfo").append(BKAccount.Name)):$(".accountInfo").empty();$(".accountInfo").text().length>0?($(".addbtnaccount").attr("style","display:none;"),$(".editbtnaccount").removeAttr("style")):$(".accountInfo").text().length===0&&($(".editbtnaccount").attr("style","display:none;"),$(".addbtnaccount").removeAttr("style"))}function showChangeAccount(){setTimeout(function(){CollapseAccount()},1)}function CollapseAccount(){$(".jstree").jstree("close_all")}function initSelectedAccount(){setTimeout(function(){$(".selectaccount").removeClass("selectaccount");$(".accountid-"+BKAccount.Id).addClass("selectaccount")},1)}function changeImageLogo(n){if(ValidateFileImage(n)){var t=$("#trader-contact-avatar-upload");reader.onload=function(n){$(".contact-avatar").attr("src",n.target.result)};reader.readAsDataURL(t[0].files[0]);ChangeContactLogo()}}function ChangeContactLogo(){var n=document.getElementById("trader-contact-avatar-upload").files;n&&n.length>0&&UploadMediaS3ClientSide("trader-contact-avatar-upload").then(function(n){if(n.objectKey==="no_image"||n.objectKey==="no-image"){LoadingOverlayEnd("hide");cleanBookNotification.error(_L("ERROR_MSG_S3_UPLOAD"),"Qbicles");return}$.ajax({type:"post",url:"/TraderContact/ChangeContactLogo?id="+$("#contact-id").val()+"&mediaObjectKey="+n.objectKey,contentType:!1,processData:!1,dataType:"json",success:function(){cleanBookNotification.updateSuccess()},error:function(){cleanBookNotification.error(_L("ERROR_MSG_EXCEPTION_SYSTEM"),"Qbicles")}})})}function SaveContact(){$.LoadingOverlay("show");CheckStatus($("#contact-id").val(),"Contact").then(function(n){if(LoadingOverlayEnd(),n.result&&n.Object!="ContactApproved"){$("#group-contact-id").val()===null&&(cleanBookNotification.error(_L("ERROR_MSG_262"),"Qbicles"),$("#contact-group-label").addClass("text-red"));$("#group-workgroup-id").val()===null&&cleanBookNotification.error(_L("ERROR_MSG_263"),"Qbicles");var i={Id:$("#group-contact-id").val()},r={Id:$("#group-workgroup-id").val()},t={ContactGroup:i,Workgroup:r,Name:$("#contact-name").val(),Id:$("#contact-id").val(),Email:$("#contact-email").val()};if($("#form_contact_add").valid()){if($("#group-contact-id").val()===null)return;if($("#group-workgroup-id").val()===null)return;$.ajax({url:"/TraderContact/TraderContactNameCheck",data:{contact:t},type:"POST",dataType:"json"}).done(function(n){n.result?$("#form_contact_add").validate().showErrors({Name:"Name of Contact already exists."}):$.ajax({method:"POST",dataType:"JSON",url:"/TraderContact/CheckExistedApprovedContact",data:{contact:t}}).done(function(n){n.result?$("#form_contact_add").trigger("submit"):cleanBookNotification.error(n.msg,"Qbicles")}).fail(function(){cleanBookNotification.error("Error checking existing Approved Trader Contact","Qbicles")}).always(function(){LoadingOverlayEnd()})}).fail(function(){$("#form_contact_add").validate().showErrors({Name:"Error checking existing name of Contact."})})}}else n.result&&n.Object=="ContactApproved"?(cleanBookNotification.error(_L("ERROR_MSG_272"),"Qbicles"),setLocalStorage(contactmanage,$("ul.app_subnav li.active a").attr("href").replace("#","")),setTimeout(function(){window.location.reload()},1e3)):n.result==!1&&cleanBookNotification.error(_L("ERROR_MSG_EXCEPTION_SYSTEM"),"Qbicles")})}function OnFocusOutControl(n){strValueChanged=n;strValueChanged!==strValueOld&&SaveContact()}function OnFocusControl(n){strValueOld=n}function getNewContactRef(){$.ajax({type:"get",url:"/TraderContact/GetNewContactRef",dataType:"json",success:function(n){n&&($("#contactReferenceId").val(n.Id),$("#numberRef").text(n.Reference))},error:function(){cleanBookNotification.error(_L("ERROR_MSG_EXCEPTION_SYSTEM"),"Qbicles")}}).always(function(){})}function selectWorkGroupContact(){var n=$("#group-workgroup-id option:selected");$(".domain_name").text(n.attr("domain")+"-")}var $contactid=$("#contact-id").val(),contactmanage="contactmanage",BKAccount,reader,strValueOld,strValueChanged;$(function(){selectTab()});BKAccount={};reader=new FileReader;$("#group-workgroup-id").on("change",function(){SaveContact()});$("#group-contact-id").on("change",function(){SaveContact()});$("#CountryName").on("change",function(){SaveContact()});$("#form_contact_add").submit(function(n){n.preventDefault();document.getElementById("form_contact_add").style.cursor="not-allowed";var t=$("#AddressLine1").val()+" "+$("#AddressLine2").val()+" "+$("#City").val()+" "+$("#CountryName").val();fetch("https://maps.googleapis.com/maps/api/geocode/json?address="+t+"&key="+$("#map-key").val()).then(n=>n.json()).then(n=>{$("#contact-Latitude").val(n.results[0].geometry.location.lat),$("#contact-longitude").val(n.results[0].geometry.location.lng),$.ajax({type:this.method,cache:!1,url:this.action,enctype:"multipart/form-data",data:new FormData(this),processData:!1,contentType:!1,beforeSend:function(){},success:function(n){n.result&&(cleanBookNotification.updateSuccess(),document.getElementById("form_contact_add").style.cursor="default",ClearError())},error:function(){cleanBookNotification.error(_L("ERROR_MSG_EXCEPTION_SYSTEM"),"Qbicles");document.getElementById("form_contact_add").style.cursor="default"}})})});strValueOld="";strValueChanged="";