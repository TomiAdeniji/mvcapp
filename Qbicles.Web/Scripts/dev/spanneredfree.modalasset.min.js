function loadModalAsset(n){$("#app-spannered-asset-add").empty();$("#app-spannered-asset-add").modal("show");$("#app-spannered-asset-add").load("/Spanneredfree/LoadModalAsset",{id:n,lid:$slLocation.val()},function(){initModalAsset()})}function initModalAsset(){var t=$("#frmSpanneredAsset"),n;$("select.select2").select2({placeholder:"Please select"});$("#frmSpanneredAsset .btnNext").click(function(){var n=$(this).closest(".modal");$(n).find("#tabNavAsset .active").next("li").find("a").trigger("click")});$("#frmSpanneredAsset .btnPrevious").click(function(){var n=$(this).closest(".modal");$(n).find("#tabNavAsset .active").prev("li").find("a").trigger("click")});_table=$("#tblMeters").DataTable({destroy:!0,columnDefs:[{targets:0,visible:!1},{render:function(){return'<button type="button" class="btn btn-warning btn-edit-meter"><i class="fa fa-pencil"><\/i><\/button> <button type="button" class="btn btn-danger btn-delete-meter"><i class="fa fa-trash"><\/i><\/button>'},targets:4}],rowId:function(){return"meter-id-"+UniqueId()}});$("#tblMeters tbody").on("click","button.btn-edit-meter",function(){var t=$(this).parents("tr"),n=_table.row(t).data();$("#asset-4 input[name=rid]").val(t.attr("id"));$("#asset-4 input[name=mid]").val(n[0]);$("#asset-4 input[name=mname]").val(n[1]);$("#asset-4 input[name=munit]").val(n[2]);$("#asset-4 input[name=mdesc]").val(n[3]);$("#btnUpdateMeter").show();$("#btnAddMeter").hide()});$("#tblMeters tbody").on("click","button.btn-delete-meter",function(){_table.row($(this).parents("tr")).remove().draw()});$("#btnAddMeter").on("click",function(){var n=$("#asset-4 input[name=mname]").val(),t=$("#asset-4 input[name=munit]").val(),i=$("#asset-4 input[name=mdesc]").val();n&&t&&i&&(_table.row.add([0,n,t,i,UniqueId(),]).draw(!1),$("#btnAddMeter").attr("disabled",!0),$("#asset-4 input[name=mname]").val(""),$("#asset-4 input[name=munit]").val(""),$("#asset-4 input[name=mdesc]").val(""))});_tblAssociatedItems=$("#tblTraderItem").DataTable({destroy:!0,serverSide:!0,processing:!0,paging:!0,searching:!1,deferLoading:30,ajax:{url:"/Spanneredfree/GetListAssociatedTraderItem",data:function(n){return $.extend({},n,{locationId:$slLocation.val(),keyword:$("#asset-2 input[name=search]").val(),groupId:$("#asset-2 select[name=group]").val(),itemLink:$("#hdfTraderItemIdLink").val(),spwgid:$("#asset-1 select[name=WorkgroupId]").val()?$("#asset-1 select[name=WorkgroupId]").val():0})}},columns:[{title:"Id",data:"Id",searchable:!1},{title:"Item",data:"Item",searchable:!0},{title:"Barcode",data:"Barcode",searchable:!0},{title:"SKU",data:"SKU",searchable:!0},{title:"Group",data:"Group",searchable:!0},null],columnDefs:[{targets:0,visible:!1},{targets:1,data:"Item",render:function(n){return'<a href="#">'+n+"<\/a>"}},{targets:5,data:"Id",render:function(n,t,i){return i.Islink?'<button class="btn btn-danger" type="button" onclick="linkTraderItemWithAsset(false,0)"><i class="fa fa-unlink"><\/i> &nbsp; Unlink<\/button>':'<button class="btn btn-success" type="button" onclick="linkTraderItemWithAsset(true,'+n+')" style="display: inline-block;"><i class="fa fa-link"><\/i> &nbsp; Link<\/button>'}}]});$("#asset-2 input[name=search]").keyup(searchThrottle(function(){$("#hdfTraderItemIdLink").val(0);_tblAssociatedItems.ajax.reload()}));$("#asset-2 select[name=group]").change(function(){$("#hdfTraderItemIdLink").val(0);_tblAssociatedItems.ajax.reload()});n=$("#select-traderitems").select2({ajax:{url:"/Spanneredfree/GetListTraderItem",delay:250,data:function(n){return{search:n.term,locationId:$slLocation.val(),spwgid:$("#asset-1 select[name=WorkgroupId]").val()?$("#asset-1 select[name=WorkgroupId]").val():0}},cache:!0,processResults:function(n){return{results:n.Object}}},minimumInputLength:1});n.on("select2:select",function(n){var t=n.params.data;$("#asset-3 select[name=unit]").empty();$("#asset-3 select[name=unit]").select2({data:t.units?t.units:[]})});_tableAssetInventory=$("#tblAssetInventory").DataTable({destroy:!0,columnDefs:[{targets:6,visible:!1},{targets:7,visible:!1},{targets:8,visible:!1},{targets:9,visible:!1},{render:function(){return'<button type="button" class="btn btn-warning btn-edit-assetinventory"><i class="fa fa-pencil"><\/i><\/button> <button type="button" class="btn btn-danger btn-delete-assetinventory"><i class="fa fa-trash"><\/i><\/button>'},targets:5},{render:function(n){return'<span class="label label-lg label-info">'+n+"<\/span>"},targets:4}],rowId:function(){return"ain-id-"+UniqueId()}});$("#tblAssetInventory tbody").on("click","button.btn-edit-assetinventory",function(){var t=$(this).parents("tr"),n=_tableAssetInventory.row(t).data();$("#asset-3 input[name=rid]").val(t.attr("id"));$("#asset-3 input[name=atid]").val(n[9]);$("#select-traderitems").val(n[6]).change();$("#asset-3 select[name=unit]").val(n[7]).change();$("#asset-3 select[name=purpose]").val(n[8]).change();$("#btnUpdateAssetInventory").show();$("#btnAddAssetInventory").hide();$.ajax({type:"GET",url:"/Spanneredfree/GetListTraderItem",data:{search:"",locationId:$slLocation.val(),spwgid:$("#asset-1 select[name=WorkgroupId]").val()?$("#asset-1 select[name=WorkgroupId]").val():0,itemId:n[6]}}).then(function(n){n=n.Object;currentItemData=n;var t=new Option(n.text,n.id,!0,!0);$("#select-traderitems").empty().append(t).trigger("change");$("#select-traderitems").trigger({type:"select2:select",params:{data:n}});inventoryInfoValid()})});$("#tblAssetInventory tbody").on("click","button.btn-delete-assetinventory",function(){_tableAssetInventory.row($(this).parents("tr")).remove().draw()});$("#btnAddAssetInventory").on("click",function(){var n=getDataInventoryCPS();if(n.item&&checkItemInventoryCPS(n.item.id)){cleanBookNotification.error(_L("ERROR_DATA_EXISTED",[n.item.text]),"Spannered");return}n.item&&n.unitid&&n.purposeid&&(_tableAssetInventory.row.add([n.item.itemname,n.item.barcode,n.item.sku,n.unittext,n.purposetext,null,n.item.id,n.unitid,n.purposeid,n.id]).draw(!1),resetInventoryCPS())});t.validate({ignore:"",rules:{Title:{required:!0,maxlength:200},Identification:{required:!0,maxlength:200},Description:{required:!0,maxlength:500},WorkgroupId:{required:!0},FeaturedImage:{filesize:!0}}})}function saveSpanneredAsset(){if(!$("#frmSpanneredAsset").valid()){$("#tabNavAsset a[href=#asset-1]").tab("show");return}processMediaSpanneredAsset()}function processMediaSpanneredAsset(){$.LoadingOverlay("show");var n=document.getElementById("spannered-asset-image-upload").files;n&&n.length>0?UploadMediaS3ClientSide("spannered-asset-image-upload").then(function(n){if(n.objectKey==="no_image"||n.objectKey==="no-image"){LoadingOverlayEnd();cleanBookNotification.error(_L("ERROR_MSG_S3_UPLOAD"),"Qbicles");return}$("#spannered-asset-object-key").val(n.objectKey);$("#spannered-asset-object-name").val(n.fileName);$("#spannered-asset-object-size").val(n.fileSize);confirmSaveSpanneredAsset()}):confirmSaveSpanneredAsset()}function confirmSaveSpanneredAsset(){var t={Id:$("#spn-id").val(),Title:$("#spn-title").val(),Identification:$("#spn-identification").val(),Description:$("#spn-description").val(),WorkgroupId:$("#spn-workgroupId").val(),LocationId:$slLocation.val(),Tags:$("#spn-tags").val(),OtherAssets:$("#spn-otherAssets").val(),Meters:[],LinkTraderItemId:"",AssetInventories:[],MediaObjectKey:$("#spannered-asset-object-key").val(),MediaObjectName:$("#spannered-asset-object-name").val(),MediaObjectSize:$("#spannered-asset-object-size").val()},r=_table.rows().data(),n,i;$.each(r,function(n,i){t.Meters.push({Id:i[0],Name:i[1],Unit:i[2],ValueOfUnit:0,Description:i[3]})});n=_tblAssociatedItems.rows().data();n=n?n[0]:null;n&&n.Islink&&(t.LinkTraderItemId=n.Id);i=_tableAssetInventory.rows().data();$.each(i,function(n,i){t.AssetInventories.push({ItemId:i[6],UnitId:i[7],Purpose:i[8],Id:i[9]})});$.ajax({type:"post",cache:!1,url:"/Spanneredfree/SpanneredFreeSaveAsset",data:{asset:t},beforeSend:function(){isBusy=!0},success:function(n){isBusy=!1;n.result?($("#app-spannered-asset-add").modal("hide"),window.location.href.includes("Asset")?location.reload():(isInitpagination=!1,loadAssets(0)),cleanBookNotification.success(_L("UPDATE_MSG_SUCCESS"),"Spannered")):!n.result&&n.msg&&cleanBookNotification.error(_L(n.msg),"Spannered")},error:function(){isBusy=!1;cleanBookNotification.error(_L("ERROR_MSG_EXCEPTION_SYSTEM"),"Spannered")}}).always(function(){LoadingOverlayEnd()})}function linkTraderItemWithAsset(n,t){n?$("#hdfTraderItemIdLink").val(t):$("#hdfTraderItemIdLink").val(0);$("#tblTraderItem").DataTable().ajax.reload()}function updateinventoryCPS(){var i=document.getElementById($("#asset-3 input[name=rid]").val()),t=$("#tblAssetInventory").DataTable().row(i).data(),n=getDataInventoryCPS();if(n.item&&checkItemInventoryCPS(n.item.id)&&t[6]!=n.item.id){cleanBookNotification.error(_L("ERROR_DATA_EXISTED",[n.item.text]),"Spannered");return}t[0]=n.item.itemname;t[1]=n.item.barcode;t[2]=n.item.sku;t[3]=n.unittext;t[4]=n.purposetext;t[6]=n.item.id;t[7]=n.unitid;t[8]=n.purposeid;$("#tblAssetInventory").DataTable().row(i).data(t).draw();resetInventoryCPS()}function resetInventoryCPS(){$("#asset-3 input[name=rid]").val("");$("#asset-3 input[name=atid]").val(0);$("#select-traderitems").val("").change();$("#asset-3 select[name=purpose]").val("").change();$("#btnAddAssetInventory").attr("disabled",!0);$("#btnUpdateAssetInventory").hide();$("#btnAddAssetInventory").show();currentItemData=null}function getDataInventoryCPS(){var t=$("#asset-3 input[name=atid]").val(),n=$("#select-traderitems").select2("data");!currentItemData||n[0].itemname&&n[0].barcode&&n[0].sku||(n[0].itemname=currentItemData.itemname,n[0].barcode=currentItemData.barcode,n[0].sku=currentItemData.sku);var i=$("#asset-3 select[name=unit]").val(),r=$("#asset-3 select[name=unit] option:selected").text(),u=$("#asset-3 select[name=purpose]").val(),f=$("#asset-3 select[name=purpose] option:selected").text();return{id:t,item:n[0],unitid:i,unittext:r,purposeid:u,purposetext:f}}function checkItemInventoryCPS(n){var i=$("#tblAssetInventory").DataTable().rows().data(),t=!1;return $.each(i,function(i,r){if(n==r[6]){t=!0;return}}),t}function inventoryInfoValid(){var n=$("#select-traderitems").val(),t=$("#asset-3 select[name=unit]").val(),i=$("#asset-3 select[name=purpose]").val();n&&t&&i?$("#asset-3 .btnvalid").removeAttr("disabled"):$("#asset-3 .btnvalid").attr("disabled",!0)}function updateMeter(){var t=document.getElementById($("#asset-4 input[name=rid]").val()),n=$("#tblMeters").DataTable().row(t).data();n[1]=$("#asset-4 input[name=mname]").val();n[2]=$("#asset-4 input[name=munit]").val();n[3]=$("#asset-4 input[name=mdesc]").val();$("#tblMeters").DataTable().row(t).data(n).draw();$("#asset-4 input[name=rid]").val("");$("#asset-4 input[name=mid]").val("");$("#asset-4 input[name=mname]").val("");$("#asset-4 input[name=munit]").val("");$("#asset-4 input[name=mdesc]").val("");$("#btnUpdateMeter").hide();$("#btnAddMeter").show()}function meterInfoValid(){var n=$("#asset-4 input[name=mname]").val(),t=$("#asset-4 input[name=munit]").val(),i=$("#asset-4 input[name=mdesc]").val();n&&t&&i?$("#asset-4 .btnvalid").removeAttr("disabled"):$("#asset-4 .btnvalid").attr("disabled",!0)}function workgroupSelect(n){if($(n).valid()){var t=$("option:selected",n).attr("detail-info");t=t.split(";");$(".prv-process").text(t[2]);$(".prv-qbicle").text(t[0]);$(".prv-members").text(t[1]);$(".prv-members").closest("button").attr("onclick","loadTeamsWorkgroupSpannered("+$(n).val()+")")}}var currentItemData=null,_tblAssociatedItems,_tableAssetInventory,_table;