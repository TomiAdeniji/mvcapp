function InitChangeEvent(){$("#location-selector, #channel-selector, #completed-shown-input").on("change",function(){$("#order-mngt-table").DataTable().ajax.reload()});$("#daterange-input").daterangepicker({timePicker:!0,showDropdowns:!0,autoUpdateInput:!0,cancelClass:"btn-danger",startDate:moment().startOf("day"),endDate:moment().endOf("day"),opens:"right",locale:{cancelLabel:"cancel",format:$dateTimeFormatByUser}});$("#daterange-input").on("cancel.daterangepicker",function(){$(this).val(null);$("#order-mngt-table").DataTable().ajax.reload()});$("#daterange-input").on("apply.daterangepicker",function(n,t){$(this).val(t.startDate.format($dateTimeFormatByUser)+" - "+t.endDate.format($dateTimeFormatByUser));$(".reporting_period").text(t.startDate.format($dateTimeFormatByUser)+" - "+t.endDate.format($dateTimeFormatByUser));$("#order-mngt-table").DataTable().ajax.reload()});$("#orderref-input").keyup(delay(function(){$("#order-mngt-table").DataTable().ajax.reload()},500))}function AddEditDiscussion(n){LoadingOverlay();$("#create-discussion-pos").empty();$("#create-discussion-pos").load("/TraderReports/AddDiscussion?id="+n,function(){LoadingOverlayEnd()})}function saveDiscussion(){for(var u,n={Id:$("#queue-discussionId").val(),Topic:{Id:$("#discussion-topic").val()},Summary:$("#discussion-summary").val(),Name:$("#discussion-name").val()},i=$("#discussion-contact").val(),r=[],t=0;t<i.length;t++)r.push({Id:i[t]});n.ActivityMembers=r;$("#expiryDate")[0].checked&&(n.ExpiryDate=$("#discussion-expirydate").val());u={Id:$("#queueId").val(),Discussion:n};LoadingOverlay();$.ajax({type:"post",url:"/TraderReports/SaveDiscussion",datatype:"json",data:{queueOrder:u},success:function(n){n.actionVal===1?(cleanBookNotification.createSuccess(),$("#create-discussion-pos").modal("toggle")):n.actionVal===2?(cleanBookNotification.updateSuccess(),$("#create-discussion-pos").modal("toggle")):cleanBookNotification.error(n.msg,"Qbicles")},error:function(){cleanBookNotification.error(_L("ERROR_MSG_EXCEPTION_SYSTEM"),"Qbicles")}}).always(function(){LoadingOverlayEnd()})}function pad(n,t){for(var i=""+n;i.length<t;)i="0"+i;return i}function formatTime(n){var t=Math.floor(n/monthToMilisecond),i=Math.floor(n/weekToMilisecond-t*30.4368),r=Math.floor(n/dayToMilisecond-t*30.4368-i*7),u=Math.floor(n/hourToMilisecond-(t*30.4368+i*7+r)*24),f=Math.floor(n/minuteToMilisecond-((t*30.4368+i*7+r)*1440+u*60)),c=Math.floor(n/secondToMilisecond-((t*30.4368+i*7+r)*86400+u*3600+f*60)),e="",o="",s="",h="";return t>0&&(e=t+"m "),i>0&&(o=i+"w "),r>0&&(s=r+"d "),u>0&&(h=pad(u,2)+"h "),e+o+s+h+(f>0?pad(f,2):"00")+"m "+pad(c,2)+"s"}function getMilliseconds(n){if(!n||n.split(":").length<6)return 0;var t=n.split(":");return parseInt(t[0])*monthToMilisecond+parseInt(t[1])*weekToMilisecond+parseInt(t[2])*dayToMilisecond+parseInt(t[3])*hourToMilisecond+parseInt(t[4])*minuteToMilisecond+parseInt(t[5])*secondToMilisecond}function initTimer(){(array.push("runTimer"),array.length>1)||(example=new function(){function r(){for(var u,r=0;r<n.length;r++)t[r]||(t[r]=getMilliseconds($(n[r]).text())),u=formatTime(t[r]),$(n[r]).html(u),t[r]+=i+i/20}var n,i=70,t=[];$(function(){n=$(".timer-order");example.Timer=$.timer(r,i,!0);array=[]});this.resetStopwatch=function(){if(n)for(var i=0;i<n.length;i++)t[i]=0;example.Timer.stop().once()}})}function uncheck(){$('input[name="check"]').each(function(){$(this).prop("checked",!1)});$(".alert_matches.projects").removeClass("active");$("#checked").html("0")}function multiselected(){var n=$('input[name="check"]:checked').length;$("#checked").html(n);n>=1?$(".alert_matches.projects").addClass("active"):$(".alert_matches.projects").removeClass("active")}function bulkChecking(){var n=$("input[name='bulk-check']").is(":checked");n?($('input[name="check"]').each(function(){$(this).prop("checked",!0)}),multiselected()):uncheck()}function showPosOrder(n){LoadingOverlay();$("#pos-order-summary").empty();$("#pos-order-summary").load("/TraderReports/ShowQueueOrderSummary?queueOrderId="+n,function(){LoadingOverlayEnd()})}function loadOrderManagementDT(){if(!isBusy)var n=$("#order-mngt-table").on("processing.dt",function(n,t,i){$("#processingIndicator").css("display","none");i?isDataUpdating?$("#refreshing").show():$("#order-mngt-table").LoadingOverlay("show"):(isDataUpdating&&($("#refreshing").hide(),$("#refreshed").show(),setTimeout(function(){$("#refreshed").fadeOut()},2e3)),initTimer(),isDataUpdating=!1)}).DataTable({destroy:!0,serverSide:!0,paging:!0,searching:!1,responsive:!0,lengthMenu:[[10,20,50,100],[10,20,50,100]],pageLength:10,order:[[0,"desc"]],beforeSend:function(){isBusy=!0},drawCallback:function(){$("input[name='bulk-check']").prop("checked",!1);uncheck();$('input[name="check"]').bind("click",function(){multiselected()});$("#filterColumn ul li").on("change",function(){var t=$("#order-mngt-table"),i=$(this).find("input[type=checkbox]").val(),n=t.DataTable().column(i);n.visible(!n.visible())});isBusy=!1;$("#order-mngt-table").LoadingOverlay("hide",!0)},ajax:{url:"/OrderManagement/GetOrderTableContent",type:"POST",data:function(n){return $.extend({},n,{locationId:$("#location-selector").val(),saleChannelStr:JSON.stringify($("#channel-selector").val()),daterange:$("#daterange-input").val(),keyword:$("#orderref-input").val(),isCompletedShownOnly:$("#completed-shown-input").is(":checked")})}},columns:[{data:"Id",orderable:!1,render:function(n,t,i){return""+("<input type='checkbox' id='"+i.Id+"' onclick='$(\"#bulk\").removeAttr(\"disabled\");' name='check'>")}},{data:"OrderRef",orderable:!0},{data:"LocationName",orderable:!0},{data:"SaleChannel",orderable:!0},{data:"ItemCount",orderable:!1,render:function(n,t,i){return""+('<button class="btn btn-info" onclick="showPosOrder(\''+i.Id+'\')" data-toggle="modal" data-target="#pos-order-summary"><i class="fa fa-list"><\/i> &nbsp; '+i.ItemCount+"<\/button>")}},{data:"TotalStr",orderable:!1},{data:"Status",orderable:!0,render:function(n,t,i){var r="";return i.Status!=""&&(r+='<span class="label label-lg label-primary">'+i.Status+"<\/span>"),r}},{data:"QueuedInfo",orderable:!1},{data:"Pending",orderable:!1},{data:"Preparing",orderable:!1},{data:"Completion",orderable:!1},{data:"DeliveryStatus",orderable:!1},{data:"PaidStatus",orderable:!1,render:function(n,t,i){return""+i.PaidStatusHtml}},{orderable:!1,render:function(n,t,i){var r="";return r+='<div class="btn-group dropdown">',r+='    <button class="btn btn-primary dropdown-toggle" data-toggle="dropdown">',r+='        Options &nbsp; <i class="fa fa-angle-down"><\/i>',r+="    <\/button>",r+='    <ul class="dropdown-menu primary dropdown-menu-right">',r+='        <li><a href="#" onclick="openUdpateStatusModal(\''+i.Id+"')\">Change status<\/a><\/li>",r+='        <li><a href="javascript:void(0)" data-toggle="modal" data-target="#create-discussion-pos" onclick="AddEditDiscussion(\''+i.Id+"')\">Discuss<\/a><\/li>",r+="    <\/ul>",r+"<\/div>"}},]})}function updatPrepQueueOrderStatus(n){var t=[],i,r;n==null?$('input[name="check"]:checked').each(function(){t.push($(this).attr("id"))}):t.push(n);i="/OrderManagement/UpdatePrepQueueOrderStatus";r=$('select[name="order-status"]').val();$.ajax({type:"POST",datatype:"JSON",url:i,data:{lstOrderIdsStr:JSON.stringify(t),upcomingStatus:Number(r),problemDescription:$("#problem-description").val()},success:function(n){n.result?(cleanBookNotification.updateSuccess(),$("#order-status-change-batch").modal("hide"),$("#order-mngt-table").DataTable().ajax.reload()):cleanBookNotification.error(n.msg,"Qbicles")},error:function(n){cleanBookNotification.error(n.msg,"Qbicles")}})}function openUdpateStatusModal(n){if(n==null){var t=$('input[name="check"]:checked').length;if(t==0)return;$("#check-count").text(t);$("#order-status-change-batch .help-text").show();$("#order-status-change-batch button[name='change-status-confirm-btn']").attr("onclick","updatPrepQueueOrderStatus(null)")}else n!=null&&($("#order-status-change-batch .help-text").hide(),$("#order-status-change-batch button[name='change-status-confirm-btn']").attr("onclick","updatPrepQueueOrderStatus("+n+")"));$("#problem-description").val("");$("#order-status-change-batch").modal("show")}function toggleShowingProblemDescription(){var n=$('select[name="order-status"]').val();n==5?$("#problem-description-container").show():$("#problem-description-container").hide()}var example=null,array=[],isDataUpdating=!1,isBusy=!1,monthToMilisecond=864e5*30.4368,weekToMilisecond=6048e5,dayToMilisecond=864e5,hourToMilisecond=36e5,minuteToMilisecond=6e4,secondToMilisecond=1e3;$(function(){initTimer();InitChangeEvent();loadOrderManagementDT();$(".checkmulti").multiselect({includeSelectAllOption:!1,selectAllJustVisible:!0,includeResetOption:!1,enableFiltering:!1,buttonWidth:"100%",maxHeight:400,enableClickableOptGroups:!0,enableFiltering:!0,enableCaseInsensitiveFiltering:!0})});