function onSelectWorkgroup(n){filter.Workgroup=$(n).val();setTimeout(function(){searchOnTableContact()},200)}function onSelectContactGroup(n){filter.Contactgroup=$(n).val();setTimeout(function(){searchOnTableContact()},200)}function onKeySearchChanged(n){filter.Key=$(n).val();setTimeout(function(){searchOnTableContact()},200)}function searchOnTableContact(){$("#trader-contact-list").DataTable().ajax.reload()}function selectAccount(n,t){var i=$(".accountid-"+t).data("name");$(".selectaccount").removeClass("selectaccount");$(n).addClass("selectaccount");BKAccount={Id:t,Name:i};$("#hdfcontactaccountId").val(t);closeSelected();$("#app-bookkeeping-treeview").modal("toggle")}function closeSelected(){BKAccount.Id?($(".accountInfo").empty(),$(".accountInfo").append(BKAccount.Name)):$(".accountInfo").empty();$(".accountInfo").text().length>0?($(".addbtnaccount").attr("style","display:none;"),$(".editbtnaccount").removeAttr("style")):$(".accountInfo").text().length===0&&($(".editbtnaccount").attr("style","display:none;"),$(".addbtnaccount").removeAttr("style"))}function showChangeAccount(){setTimeout(function(){CollapseAccount()},1)}function CollapseAccount(){$(".jstree").jstree("close_all")}function initSelectedAccount(){setTimeout(function(){$(".selectaccount").removeClass("selectaccount");$(".accountid-"+BKAccount.Id).addClass("selectaccount")},1)}function clickAddNew(n){$("#contact-group-label").removeClass("text-red");n==="form_contact_add"&&(getNewContactRef(),$("#modal-title-contact").text("Add a contact"),BKAccount={},$(".accountInfo").text(""),$(".accountInfo").text().length>0?($(".addbtnaccount").attr("style","display:none;"),$(".editbtnaccount").removeAttr("style")):$(".accountInfo").text().length===0&&($(".editbtnaccount").attr("style","display:none;"),$(".addbtnaccount").removeAttr("style")));ResetFormControl(n);$("#contact-id").val(0);$("#hdfcontactaccountId").val(0);$("#group-contact-id").trigger("change");$("#group-workgroup-id").trigger("change");$("#contact-address-id").val(0)}function selectWorkGroupContact(){var n=$("#group-workgroup-id option:selected");$(".domain_name").text(n.attr("domain")+"-")}function getNewContactRef(){$.ajax({type:"get",url:"/TraderContact/GetNewContactRef",dataType:"json",success:function(n){n&&($("#contactReferenceId").val(n.Id),$("#numberRef").text(n.Reference))},error:function(){cleanBookNotification.error(_L("ERROR_MSG_EXCEPTION_SYSTEM"),"Qbicles")}}).always(function(){})}function addgroup(n){$("#form_group_add").valid()&&$.ajax({type:"post",url:"/TraderContact/SaveGroup",data:{Name:$("#addnew-group-name").val(),saleChannelGroup:n},dataType:"json",success:function(n){n.result===!0?n.actionVal===1?(cleanBookNotification.createSuccess(),reloadgroup(n),$("#app-group-generic-add").modal("toggle")):n.actionVal===3&&$("#app-group-generic-add").validate().showErrors({Name:n.msg}):cleanBookNotification.error(_L("ERROR_MSG_EXCEPTION_SYSTEM"),"Qbicles")},error:function(){cleanBookNotification.error(_L("ERROR_MSG_EXCEPTION_SYSTEM"),"Qbicles")}}).always(function(){})}function EditContact(n){$("#modal-title-contact").text("Edit contact");ResetFormControl("form_contact_add");$(".domain_name").text("");$.ajax({type:"get",url:"/TraderContact/GetContactById",data:{id:n},dataType:"json",success:function(n){$("#contact-name").val(n.Name);$("#contact-company").val(n.CompanyName);$("#contact-job").val(n.JobTitle);$("#contact-phone").val(n.PhoneNumber);n.ContactRef&&($("#contactReferenceId").val(n.ContactRef.Id),$("#numberRef").text(n.ContactRef.Reference),$("#newrefnum").val(n.ContactRef.ReferenceNumber));$("#contact-email").val(n.Email);$("#group-contact-id").select2("destroy");$("#group-contact-id").val(n.ContactGroup.Id);$("#group-contact-id").select2();$("#group-contact-id").trigger("change");$("#group-workgroup-id").select2("destroy");$("#group-workgroup-id").val(n.Workgroup.Id);$("#group-workgroup-id").select2();$("#group-workgroup-id").trigger("change");$("#contact-id").val(n.Id);$("#contact-address-id").val(n.Address.Id);$("#PostCode").val(n.Address.PostCode);n.Address.Country!==null&&$("#CountryName").val(n.Address.Country.CommonName).trigger("change");$("#State").val(n.Address.State);$("#City").val(n.Address.City);$("#AddressLine2").val(n.Address.AddressLine2);$("#AddressLine1").val(n.Address.AddressLine1);$("#contact-longitude").val(n.Address.Longitude);$("#contact-Latitude").val(n.Address.Latitude);n.CustomerAccount.Id>0?(BKAccount={Id:n.CustomerAccount.Id,Name:n.CustomerAccount.Name},$("#hdfcontactaccountId").val(BKAccount.Id),$(".accountInfo").text(BKAccount.Name)):(BKAccount={},$("#hdfcontactaccountId").val(0),$(".accountInfo").text(""));$(".accountInfo").text().length>0?($(".addbtnaccount").attr("style","display:none;"),$(".editbtnaccount").removeAttr("style")):$(".accountInfo").text().length===0&&($(".editbtnaccount").attr("style","display:none;"),$(".addbtnaccount").removeAttr("style"));$($(".domain_name")[0]).text().replace(/\s/g,"")===""&&selectWorkGroupContact();($("#numberRef").text()===""||$("#numberRef").text()==="0")&&getNewContactRef()},error:function(){cleanBookNotification.error(_L("ERROR_MSG_EXCEPTION_SYSTEM"),"Qbicles")}})}function ConfirmDeleteContact(n,t){$("#label-confirm-contact").text("Do you want delete contact: "+t);$("#id-itemcontact-delete").val(n)}function DeleteContact(){$.ajax({type:"POST",url:"/TraderContact/DeleteContact",data:{id:$("#id-itemcontact-delete").val()},dataType:"json",success:function(n){n==="OK"?(cleanBookNotification.removeSuccess(),searchOnTableContact()):n==="Fail"&&cleanBookNotification.removeFail()},error:function(){cleanBookNotification.error(_L("ERROR_MSG_EXCEPTION_SYSTEM"),"Qbicles")}})}function initContactForm(){$("#form_contact_add").validate({rules:{Name:{required:!0,maxlength:71}}})}function SaveTraderContact(n){$("#contact-status").val(n);var t={Id:$("#group-contact-id").val()},i={Id:$("#group-workgroup-id").val()},r={ContactGroup:t,Workgroup:i,Name:$("#contact-name").val(),Id:$("#contact-id").val()};if($("#form_contact_add").valid()){if($("#group-contact-id").val()===null){cleanBookNotification.error(_L("ERROR_MSG_262"),"Qbicles");$("#contact-group-label").addClass("text-red");return}if($("#group-workgroup-id").val()===null){cleanBookNotification.error(_L("ERROR_MSG_263"),"Qbicles");return}if($("#contactAvatar").val()===""&&$("#contact-id").val()==="0"){cleanBookNotification.error(_L("ERROR_MSG_264"),"Qbicles");return}if($("#group-contact-id").val()===null)return;if($("#group-workgroup-id").val()===null)return;$.ajax({url:"/TraderContact/TraderContactNameCheck",data:{contact:r},type:"POST",dataType:"json"}).done(function(n){n.result?$("#form_contact_add").validate().showErrors({Name:_L("ERROR_MSG_251")}):ProcessContactMedia()}).fail(function(){$("#form_contact_add").validate().showErrors({Name:_L("ERROR_MSG_252")})})}}function ShowTableContactValue(){$.LoadingOverlay("show");$("#trader-contact-content").load("/TraderContact/ShowContactContent",function(){LoadingOverlayEnd();searchOnTableContact()})}function numberWithCommas(n){return n.toString().replace(/\B(?=(\d{3})+(?!\d))/g,",")}function LoadContactContent(){$("#trader-contact-list").on("processing.dt",function(n,t,i){$("#processingIndicator").css("display","none");i&&$(".loadingoverlay").length===0?$("#trader-contact-content").LoadingOverlay("show"):$("#trader-contact-content").LoadingOverlay("hide",!0)}).DataTable({destroy:!0,dom:'<"top"fl<"clear">>rt<"bottomtable"ip<"clear">>',serverSide:!0,info:!0,stateSave:!1,bLengthChange:!0,paging:!0,searching:!1,responsive:!0,scrollX:!1,autoWidth:!0,pageLength:10,lengthMenu:[[10,20,50,100],[10,20,50,100]],pageLength:10,ajax:{url:"/TraderContact/LoadContactContent",type:"POST",data:function(n){return $.extend({},n,{search:$("#trader_search_contact").val(),groupId:$("#filter-group").val().split(","),contactGroupId:$("#filter-contact-group").val()})}},columns:[{data:"Reference",orderable:!0},{data:"Avatar",orderable:!1,render:function(n,t,i){return'<div class="table-avatar" style="background-image: url('+$("#api-uri").val()+i.Avatar+'&size=T);">&nbsp;<\/div>'}},{data:"Name",orderable:!0},{data:"ContactGroup",orderable:!0},{data:"Workgroup",orderable:!0},{data:"AccountBalance",orderable:!1},{data:"BillBalance",orderable:!1},{data:"InvoiceBalance",orderable:!1},{data:"Status",orderable:!0,render:function(n,t,i){var r="";switch(i.Status){case"Draft":r='<span class="label label-lg label-primary">Draft<\/span>';break;case"PendingReview":r='<span class="label label-lg label-warning">Awaiting Review<\/span>';break;case"PendingApproval":r='<span class="label label-lg label-warning">Awaiting Approval<\/span>';break;case"ContactDenied":r='<span class="label label-lg label-danger">Denied<\/span>';break;case"ContactApproved":r='<span class="label label-lg label-success">Approved<\/span>';break;case"ContactDiscarded":r='<span class="label label-lg label-danger">Discarded<\/span>'}return r}},{data:"Action",orderable:!1,width:200,render:function(n,t,r){var u=r.Action.split(","),f="";for(i=0;i<u.length;i++)u[i]=="1"?f+='<button class="btn btn-info" onclick="EditContact('+r.Id+')" data-toggle="modal" data-target="#app-trader-modal-contact" style="margin-right: 3px"><i class="fa fa-pencil"><\/i> &nbsp; Continue<\/button>':u[i]=="2"?f+='<button class="btn btn-primary" onclick="window.location.href=\'/TraderContact/ContactMaster?key='+r.Key+'\'" style="margin-right:3px"><i class="fa fa-eye"><\/i> &nbsp; Manage<\/button>':u[i]=="3"&&(f+='<button class="btn btn-danger"'+(r.IsDisabled?"disabled":"")+' data-toggle="modal" data-target="#app-contact-confirm" onclick="ConfirmDeleteContact('+r.Id+", '"+r.Name+'\')" > <i class="fa fa-trash"><\/i>&nbsp; Delete<\/button >');return f}}],order:[[0,"asc"],[2,"asc"],[3,"asc"],[4,"asc"]]})}var BKAccount={},filter={Contactgroup:"",Workgroup:"",Key:""},oTable;$("#filter-group").on("change",function(){var n=$(this).val();$("#trader-contact-list").DataTable().search(n,!0,!1,!0).draw()});$("#filter-contact-group").on("change",function(){var n=$(this).val();$("#trader-contact-list").DataTable().search(n,!0,!1,!0).draw()});oTable=$("#trader-contact-list");$('.manage-columns input[type="checkbox"]').on("change",function(){var t=$("#trader-contact-list").DataTable(),n=t.column($(this).attr("data-column"));n.visible(!n.visible())});$('.manage-columns.v2 input[type="checkbox"]').on("change",function(){var t=$.closest($("#trader-contact-list")).DataTable(),n=t.column($(this).attr("data-column"));n.visible(!n.visible())});reloadgroup=function(n){$("#filter-group").append(n.msg);$("#group-contact-id").append(n.msgName)};ProcessContactMedia=function(){$.LoadingOverlay("show");var n=document.getElementById("trader-contact-avatar-upload").files;n&&n.length>0?UploadMediaS3ClientSide("trader-contact-avatar-upload").then(function(n){if(n.objectKey==="no_image"||n.objectKey==="no-image"){LoadingOverlayEnd("hide");cleanBookNotification.error(_L("ERROR_MSG_S3_UPLOAD"),"Qbicles");return}$("#trader-contact-object-key").val(n.objectKey);$("#trader-contact-object-name").val(n.fileName);$("#trader-contact-object-size").val(n.fileSize);SubmitTraderContact()}):SubmitTraderContact()};SubmitTraderContact=function(){var n=new FormData($("#form_contact_add")[0]),t={Id:n.get("Id"),Email:n.get("Email")};$.ajax({method:"POST",dataType:"JSON",url:"/TraderContact/CheckExistedApprovedContact",data:{contact:t}}).done(function(t){t.result?$.ajax({type:"post",cache:!1,url:"/TraderContact/SaveTraderContact",enctype:"multipart/form-data",data:n,processData:!1,contentType:!1,beforeSend:function(){},success:function(n){$.LoadingOverlay("hide");n.result?($("#app-trader-modal-contact").modal("toggle"),n.actionVal===1?cleanBookNotification.createSuccess():cleanBookNotification.updateSuccess(),searchOnTableContact()):n.msgId==2?cleanBookNotification.error(n.msg,"Qbicles"):cleanBookNotification.error(_L("ERROR_MSG_EXCEPTION_SYSTEM"),"Qbicles")},error:function(){cleanBookNotification.error(_L("ERROR_MSG_EXCEPTION_SYSTEM"),"Qbicles")}}).always(function(){LoadingOverlayEnd()}):cleanBookNotification.error(t.msg,"Qbicles")}).fail(function(){cleanBookNotification.error("Error checking existing Approved Trader Contact","Qbicles")}).always(function(){LoadingOverlayEnd()})};$(function(){LoadContactContent()});